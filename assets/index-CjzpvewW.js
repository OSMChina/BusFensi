var Pn=Object.defineProperty;var In=(e,t,n)=>t in e?Pn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var C=(e,t,n)=>In(e,typeof t!="symbol"?t+"":t,n);import{c as ut,j as a,m as G,r as m,u as q,d as Ln,F as R,l as me,a as Dn,C as On,b as Fn,e as Nt,D as Bn,f as Hn,S as Wn,v as $n,g as Un,s as Vn,K as qn,P as Xn,h as Kn,i as zn}from"./react-vk9qkqx3.js";import{d as mt,e as Gn,f as Wt,h as $t,j as Yn,k as ye,l as Zn,m as Ut,n as Jn,o as Qn,q as eo,r as to,t as Vt,u as qt,v as Xt,w as no,x as oo,y as Kt,z as so,A as zt,B as pt,C as ao,D as ro,E as io,F as co,G as lo,H as Gt,I as Yt,J as uo,K as mo,L as ft,M as po,N as fo,O as ho,P as Zt,Q as xo,R as bo,S as go,T as yo,U as Jt,V as wo,W as Qt,X as _o,Y as jo,Z as So,_ as vo,$ as No}from"./fazustand-C0Mx1jtz.js";import{a as en,f as tt,d as ko,c as tn,b as nt,s as kt,g as Mo,h as Eo,j as Co,k as nn,t as Ro}from"./vendor-DwCH174u.js";import{i as on,j as To,L as De,k as Oe,c as Ge,l as ge,m as $e,G as sn,n as Ao,o as Mt,R as Po}from"./pixi-rwhc4Uqq.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const Io={lon:-122.431297,lat:37.773972},Lo=17,Do={viewpoint:Io,zoom:Lo},Oo=e=>({setViewpoint:t=>e(()=>({viewpoint:t})),setZoom:t=>e(()=>({zoom:t})),setStage:(t,n)=>e({width:t,height:n}),setStageApp:t=>e({stage:t}),setSelectionRect:t=>e({selectionRect:t})}),Et=()=>new URLSearchParams(window.location.search),Fo=e=>{const t=e.toString(),n=t?"?":"";window.history.replaceState(null,"",`${location.pathname}${n}${t}`)},Bo=e=>(t,n,s)=>{const o=e(t,n,s),r={},i=Et(),c=i.get("lat"),l=i.get("lon"),d=i.get("zoom");c&&l&&(r.viewpoint={lat:parseFloat(c),lon:parseFloat(l)}),d&&(r.zoom=parseFloat(d));const p={...o,...r};return t(p,!0,"mapViewURLPersist/hydrate"),s.subscribe((f,x)=>{var h,w,g,_,j,M,I,k,E;const y=Et();let b=!1;((h=f.viewpoint)==null?void 0:h.lat)!==((w=x.viewpoint)==null?void 0:w.lat)&&(y.set("lat",((_=(g=f.viewpoint)==null?void 0:g.lat)==null?void 0:_.toString())||""),b=!0),((j=f.viewpoint)==null?void 0:j.lon)!==((M=x.viewpoint)==null?void 0:M.lon)&&(y.set("lon",((k=(I=f.viewpoint)==null?void 0:I.lon)==null?void 0:k.toString())||""),b=!0),f.zoom!==x.zoom&&(y.set("zoom",((E=f.zoom)==null?void 0:E.toString())||""),b=!0),b&&Fo(y)}),p},X=ut()(mt(Bo((...e)=>({...Do,...Oo(...e)})),{name:"MapView"})),Ho={lon:-122.431297,lat:37.773972};Ye(Ho);const we=256,Fe={XMIN:-2003750834e-2,YMIN:-200489661e-1,XMAX:2003750834e-2,YMAX:200489661e-1,EQUATOR:4007501668e-2};function Wo(e){const[t,n]=en("EPSG:3857","EPSG:4326",[e.x,e.y]);return{lon:t,lat:n}}function Ye(e){const[t,n]=en("EPSG:4326","EPSG:3857",[e.lon,e.lat]);return{x:t,y:n}}function an(e,t){const n=Math.pow(2,t)*we,s=Fe.EQUATOR/n,o=(e.x-Fe.XMIN)/s,r=(Fe.XMAX-e.y)/s;return{x:o,y:r}}function rn(e,t){return an(Ye(e),t)}function cn(e,t,n,s,o){const r=an(Ye(t),n),i=s?s/2:0,c=o?o/2:0;return{x:Math.floor(e.x+i-r.x),y:Math.floor(e.y+c-r.y)}}function ht(e,t,n,s,o){return cn(rn(e,n),t,n,s,o)}function ae(e,t,n,s,o){const r=Math.pow(2,n)*we,i=Fe.EQUATOR/r,c=Ye(t),l=Math.floor(s/2),d=Math.floor(o/2),p=(e.x-l)*i,u=(e.y-d)*i,f={x:c.x+p,y:c.y-u};return Wo(f)}function ln(e,t,n,s){const{lon:o,lat:r}=ae({x:0,y:0},e,t,n,s),{lon:i,lat:c}=ae({x:n,y:s},e,t,n,s);return{left:o,bottom:c,right:i,top:r}}function dn(e,t,n,s,{from:o,to:r}){const i={x:Math.min(o.x,r.x),y:Math.min(o.y,r.y)},c={x:Math.max(o.x,r.x),y:Math.max(o.y,r.y)};console.debug("getBoundsByRect, p1 p2",i,c,"vp zoom w h",e,t,n,s,{from:o,to:r});const{lon:l,lat:d}=ae(i,e,t,n,s),{lon:p,lat:u}=ae(c,e,t,n,s);return{left:l,bottom:u,right:p,top:d}}const xt=e=>t=>e.x!==0&&e.y!==0?ae(e,t.viewpoint,t.zoom,t.width,t.height):void 0;function pe(e){return JSON.parse(JSON.stringify(e))}const un=e=>Object.keys(e);class $o{constructor(){C(this,"timers",new Map)}debounce(t,n,s,o=!1){return(...r)=>{const i=o&&!this.timers.has(s);this.timers.has(s)&&clearTimeout(this.timers.get(s));const c=setTimeout(()=>{this.timers.delete(s),o||t(...r)},n);this.timers.set(s,c),i&&t(...r)}}cancel(t){this.timers.has(t)&&(clearTimeout(this.timers.get(t)),this.timers.delete(t))}cancelAll(){for(const t of this.timers.values())clearTimeout(t);this.timers.clear()}}function F(e){return e?Array.isArray(e)?e:[e]:[]}const Q=(...e)=>e.filter(Boolean).join(" ");class H{constructor(t){C(this,"name");C(this,"next",[]);this.name=t}appendNext(t,n){const s=t instanceof H?t:t.entry;if(n.isEpsilon)this.next.push({isEpsilon:!0,state:s});else{if(!n.transform)throw new Error("Non-ε transition requires a transform function.");this.next.push({isEpsilon:!1,transform:n.transform,state:s})}}}const ze=class ze{constructor(t){C(this,"name");C(this,"entry");C(this,"current");C(this,"accept");C(this,"debouncer");C(this,"context");this.name="base",this.context={store:t},this.debouncer=new $o}appendNext(t,n){this.accept.forEach(s=>s.appendNext(t,n))}computeEpsilonClosure(t){const n=new Set,s=[t];for(;s.length;){const o=s.pop();if(!n.has(o)){n.add(o);for(const{state:r,isEpsilon:i}of o.next)i&&s.push(r)}}return Array.from(n)}transform(t){const n=this.computeEpsilonClosure(this.current);for(const s of n)for(const o of s.next)if(!o.isEpsilon&&o.transform(t)){this.current=o.state;return}}debouncedTransform(t){this.debouncer.debounce(this.transform.bind(this),ze.DEBOUNCE_DELAY,t.type,!0)(t)}};C(ze,"DEBOUNCE_DELAY",20);let J=ze;function le(e,t,n){const{stage:s}=n.store.view.getState(),o=s.view.getBoundingClientRect(),r=e-o.x,i=t-o.y;return console.debug("getLocalPosistion, x y",e,t," convert to ",r,i),{x:r,y:i}}const Ue=(e,t,n)=>{var y;const{height:s,width:o,viewpoint:r,zoom:i,stage:c}=n.store.view.getState();if(!s||!o||!c)return;const l=c.view.getBoundingClientRect(),d=e-l.x,p=t-l.y,{modifyFeatureMetaNC:u}=n.store.meta.getState(),f=ae({x:d,y:p},r,i,o,s),x=ht(f,r,i,o,s);if(console.log("on component drag",{x:e,y:t},{x:d,y:p},x),(y=n.componentTarget)!=null&&y.id&&n.componentTarget.type==="node"){const{type:b,id:h}=n.componentTarget;u(b,h,w=>{w["@_lon"]=f.lon,w["@_lat"]=f.lat})}else throw new Error(`context.componentTarget should not be ${JSON.stringify(n.componentTarget)} at point move`)};class Uo extends J{constructor(n){super(n);C(this,"idle");C(this,"componentHover");C(this,"componentMousedown");C(this,"pointDrag");this.idle=new H("component-idle"),this.componentHover=new H("component-hover"),this.componentMousedown=new H("component-mousedown"),this.pointDrag=new H("component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:s=>{const o=this.context;if(["pointerover","pointerenter"].includes(s.type)&&"componentTarget"in s&&s.componentTarget){o.componentTarget=s.componentTarget;const{id:r,type:i}=o.componentTarget;console.log("ComponentStateMachine: component hover triggered",i,r);const{modifyFeatureStateNC:c}=o.store.meta.getState();return c(i,r,l=>l.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:s=>{const o=this.context;if(s.type==="mousedown"&&o.componentTarget){console.log("ComponentStateMachine: transition to mousedown");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:c}=o.store.meta.getState();return c(i,r,l=>l.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:s=>{const o=this.context;if(["pointerleave","pointerout"].includes(s.type)&&o.componentTarget){console.log("ComponentStateMachine: transition to idle");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:c}=o.store.meta.getState();return c(i,r,l=>l.hovered=!1),o.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:s=>{var r;const o=this.context;if(s.type==="pointermove"&&((r=o.componentTarget)==null?void 0:r.type)==="node"){console.log("ComponentStateMachine: start dragging");const{clientX:i,clientY:c}=s,{commit:l}=o.store.meta.getState();return l(),Ue(i,c,o),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:s=>{const o=this.context;if((s.type==="mouseup"||s.type==="mouseupoutside")&&o.componentTarget){const{selectFeature:r,unSelectFeature:i}=o.store.meta.getState(),{id:c,type:l}=o.componentTarget;if(typeof c=="string")s.ctrlKey?i(l,c):(r(l,c,!s.shiftKey),console.log("selected id",c,o.store.meta.getState().selectFeature)),o.componentTarget=void 0;else throw new Error(`id ${c} is invalid for component`);return!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:s=>s.type==="mouseup"||s.type==="mouseuppoutside"?(console.log("ComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:s=>{if(s.type==="pointermove"){const{clientX:o,clientY:r}=s;return Ue(o,r,this.context),!0}return!1}})}}var _e=(e=>(e[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(_e||{});class je extends J{constructor(n,s){super(n);C(this,"idle");C(this,"rightMousedown");C(this,"mapDrag");this.idle=new H("mapview-idle"),this.mapDrag=new H("mapview-mapDrag"),this.rightMousedown=new H("mapview-right-mousedown"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="wheel"){const c=r.deltaY<0,{zoom:l,setZoom:d}=i.store.view.getState(),p=l+(c?1:-1),u=i.store.settings.getState();return p>=0&&p<=u.view.MAX_ZOOM&&d(p),!0}return!1}}),this.idle.appendNext(this.mapDrag,{transform:r=>{const i=this.context;if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===_e.LEFT){const{clientX:c,clientY:l}=r;return i.startPoint={x:c,y:l},i.viewpointBeforeDrag=i.store.view.getState().viewpoint,console.log("MapViewStateMachine: 开始地图拖拽",i.startPoint),!0}return!1}}),this.idle.appendNext(this.rightMousedown,{transform:r=>{if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===_e.RIGHT){const{clientX:i,clientY:c}=r;return this.context.startPoint={x:i,y:c},this.context.viewpointBeforeDrag=this.context.store.view.getState().viewpoint,!0}return!1}}),this.rightMousedown.appendNext(this.idle,{transform:r=>r.type==="mouseup"?(s&&s.rightClickHandeler(r),this.context.startPoint=void 0,this.context.viewpointBeforeDrag=void 0,!0):!1});const o=r=>{var c,l;const i=this.context;if(r.type==="pointermove"){const{clientX:d,clientY:p}=r,[u,f]=[d,p];if(typeof((c=i.startPoint)==null?void 0:c.x)!="number"||typeof((l=i.startPoint)==null?void 0:l.y)!="number")throw new Error("context.startPoint.x must be number when map drag");const[x,y]=[i.startPoint.x-u,i.startPoint.y-f];console.log("moving to",x,y);const{zoom:b,setViewpoint:h,width:w,height:g}=i.store.view.getState(),_=w,j=g,M=i.viewpointBeforeDrag,I=ae({x:x+_/2,y:y+j/2},M,b,_,j);return h(I),!0}return!1};this.rightMousedown.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="mouseup"||r.type==="mouseupoutside"){if(i.startPoint=void 0,i.viewpointBeforeDrag=void 0,i.store.meta.getState().autoload){const{viewpoint:c,zoom:l,width:d,height:p}=i.store.view.getState(),u=d,f=p,{loadbbox:x}=i.store.meta.getState(),y=i.store.settings.getState();x({width:u,height:f,zoom:l,viewpoint:c},y.osmAPI.BASEURL)}return!0}return!1}})}}function Vo(e,t,n){const s=nt();kt(s,n,t);const o=Mo(s);if(o===0)return tn(t);const r=nt();kt(r,e,t);const i=Eo(r,s)/o,c=Math.max(0,Math.min(1,i)),l=nt();return Co(l,t,s,c),l}function mn(e,t){let n=null,s=null,o=1/0;const r=tt(e.lon,e.lat);for(let i=0;i<t.length-1;i++){const c=tt(t[i]["@_lon"],t[i]["@_lat"]),l=tt(t[i+1]["@_lon"],t[i+1]["@_lat"]),d=Vo(r,c,l),p=ko(r,d);p<o&&(o=p,n=tn(d),s=t[i])}if(s===null)throw new Error("point is not insertable for polyline");return{nearestPoint:n?{lon:n[0],lat:n[1]}:e,insertAfter:s}}class ce extends J{constructor(n){super(n);C(this,"idle");this.idle=new H("undo-redo-idle"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}})}}class qo extends J{constructor(n){super(n);C(this,"idle");C(this,"undoRedo");C(this,"addNode");C(this,"addNodeOnWay");C(this,"splitWay");this.idle=new H("node-idle"),this.addNode=new H("add-node"),this.addNodeOnWay=new H("add-node-on-way"),this.splitWay=new H("split-way"),this.undoRedo=new ce(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}}),this.idle.appendNext(this.addNode,{transform:s=>s.type==="add-node"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.addNodeOnWay,{transform:s=>s.type==="add-node-on-way"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.splitWay,{transform:s=>s.type==="split-way"?(console.log("to split way state"),!0):!1}),this.addNode.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0){const{viewpoint:r,zoom:i,width:c,height:l}=this.context.store.view.getState(),d=c,p=l,{clientX:u,clientY:f}=o,x=ae({x:u,y:f},r,i,d,p);this.context.store.meta.getState().createLocalNode(x),console.log("added node")}return!0}return!1}}),this.addNodeOnWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="way"){const{viewpoint:r,zoom:i,width:c,height:l}=this.context.store.view.getState(),d=c,p=l,{meta:u,createLocalNode:f,modifyFeatureMetaNC:x,commit:y}=this.context.store.meta.getState(),{clientX:b,clientY:h}=o,w=ae({x:b,y:h},r,i,d,p),g=u.way[o.componentTarget.id],_=g.nd.map(E=>u.node[E["@_ref"]]),{nearestPoint:j,insertAfter:M}=mn(w,_),I=f(j),k=Array.from(g.nd);k.splice(g.nd.findIndex(E=>E["@_ref"]===M["@_id"])+1,0,{"@_ref":I}),y(),x(o.componentTarget.type,o.componentTarget.id,E=>E.nd=k),console.log("nodeid",I,k),console.log("added node")}return!0}return!1}}),this.splitWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="node"){const{meta:r,splitWay:i}=this.context.store.meta.getState(),c=r.node[o.componentTarget.id];i(c["@_id"]),console.log("splited way")}return!0}return!1}})}}class Xo extends J{constructor(n){super(n);C(this,"idle");C(this,"componentSubMachine");C(this,"mapViewSubMachine");C(this,"uiStateSubMachine");this.idle=new H("common-edit-idle"),this.componentSubMachine=new Uo(n),this.mapViewSubMachine=new je(n),this.uiStateSubMachine=new qo(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.uiStateSubMachine,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.uiStateSubMachine.appendNext(this.idle,{isEpsilon:!0})}}const Ko={routeEdit:{step:0,stops:[],path:[]}},zo={commitCounter:1},Go={selectedRef:[],activeRef:void 0},Yo={meta:{node:{},way:{},relation:{}},deletedMeta:{node:{},way:{},relation:{}},_create_feature_counter:-1},Zo={bbox:[],autoload:!0},pn={...zo,...Go,...Yo,...Zo,...Ko};function U(e){e.commitCounter++}const Jo=e=>({commit:()=>e(t=>U(t))}),Qo=e=>{const{node:t,way:n,relation:s}=e,o={elems:{node:{},way:{},relation:{}},roots:{node:{},way:{},relation:{}}},r=(i,c)=>{Object.keys(c).forEach(l=>{const d=l;o.elems[i][d]={id:d,type:i,fathers:{node:[],way:[],relation:[]},childs:{node:[],way:[],relation:[]}},o.roots[i][d]=!0})};return r("node",t),r("way",n),r("relation",s),Object.values(n).forEach(i=>{const c=o.elems.way[i["@_id"]];if(!c)throw new Error(`${i["@_id"]} !`);i.nd.forEach(l=>{const d=o.elems.node[l["@_ref"]];d&&(d.fathers.way.push(c.id),c.childs.node.push(d.id),delete o.roots.node[d.id])})}),Object.values(s).forEach(i=>{const c=o.elems.relation[i["@_id"]];if(!c)throw new Error(`${i["@_id"]} !`);i.member.forEach(l=>{const d=o.elems[l["@_type"]][l["@_ref"]];d&&(d.fathers.relation.push(c.id),c.childs[l["@_type"]].push(d.id),delete o.roots[l["@_type"]][d.id])})}),o},es=Gn.createComputed(e=>({tree:Qo(e.meta)}));function Ct(e,t,n,s){const o=e.meta[t][n]["@_localStates"];o&&s(o)}function xe(e,t,n){e.meta[t][n]["@_localStates"]={visible:!0,highlighted:!1,hovered:!1,selected:!1,active:!1}}function ts(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)&&(e.selectedRef=e.selectedRef.filter(o=>!s(o))),e.activeRef&&s(e.activeRef)&&(e.activeRef=void 0),delete e.meta[t][n]["@_localStates"]}function fn(e,t,n){if(e.activeRef){const{type:s,id:o}=e.activeRef;e.meta[s][o]["@_localStates"]&&(e.meta[s][o]["@_localStates"].active=!1)}e.activeRef={type:t,id:n},e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!0)}function hn(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)||(e.selectedRef.push({type:t,id:n}),e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].selected=!0))}function be(e){if(e.activeRef){const{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1),e.activeRef=void 0}e.selectedRef.forEach(({id:t,type:n})=>e.meta[n][t]["@_localStates"]&&(e.meta[n][t]["@_localStates"].selected=!1)),e.selectedRef=[]}function de(e,t,n){hn(e,t,n),fn(e,t,n)}function Rt(e,t,n){hn(e,t,n)}function ot(e,t,n){const s=e.meta[t][n]["@_localStates"];if(s!=null&&s.active&&(s.active=!1,e.activeRef=void 0),s!=null&&s.selected&&(s.selected=!1,e.selectedRef=e.selectedRef.filter(o=>!(o.id===n&&o.type===t))),!e.activeRef&&e.selectedRef.length>0){const{type:o,id:r}=e.selectedRef[0];fn(e,o,r)}}const ns=(e,t)=>({"@_id":`${e._create_feature_counter--}`,"@_lat":t.lat,"@_lon":t.lon,"@_visible":"true"}),xn=(e,t)=>({"@_id":`${e._create_feature_counter--}`,nd:[...t],"@_visible":"true"}),os=(e,t)=>({"@_id":`${e._create_feature_counter--}`,member:[...t],"@_visible":"true"});function Be(e,t,n){const s=n["@_id"];if(e.meta[t][s]&&console.debug(`Can't add feature ${t} ${s}: already exsits! Ignoring this attempt`),t==="node"){const o=n;o["@_lon"]=Number(o["@_lon"]),o["@_lat"]=Number(o["@_lat"]),e.meta[t][s]=o}else e.meta[t][s]=n;xe(e,t,s)}function ss(e,t,n){return F(n).forEach(s=>Be(e,t,s))}function bn(e,t){const n=ns(e,t);return e.meta.node[n["@_id"]]=n,xe(e,"node",n["@_id"]),n["@_id"]}function as(e,t){const n=xn(e,t);return e.meta.way[n["@_id"]]=n,xe(e,"way",n["@_id"]),n["@_id"]}function dt(e,t){const n=os(e,t);return e.meta.relation[n["@_id"]]=n,xe(e,"relation",n["@_id"]),n["@_id"]}const se=(e,t,n,s)=>{const o=e.meta[t][n];o&&(s(o),o["@_action"]="modify")};function rs(e,t,n){const s=t.elems.node[n].fathers.way.map(r=>e.meta.way[r]);let o=null;return s==null||s.forEach(r=>{const i=r.nd,c=i.findIndex(l=>l["@_ref"]===n);if(c!==0&&c!==i.length-1){if(c===-1)throw new Error(`way ${r} must contain node ${n}, the feature tree is broken.`);const l=i.slice(c);r.nd=i.slice(0,c+1),r["@_action"]="modify";const d=xn(e,l);o=d["@_id"],d.tag=r.tag&&[...r.tag],e.meta.way[d["@_id"]]=d,xe(e,"way",d["@_id"]);const p=t.elems.way[r["@_id"]].fathers.relation.map(u=>e.meta.relation[u]);p==null||p.forEach(u=>{const f=u.member,x=f.findIndex(y=>y["@_ref"]===r["@_id"]);if(x===-1)throw new Error(`relation ${u} must contain way ${r}, the feature tree is broken.`);f.splice(x+1,0,{"@_ref":d["@_id"],"@_type":"way","@_role":f[x]["@_role"]}),u.member=f,u["@_action"]="modify"})}}),o}function Ve(e,t,n){if(!e.meta[t][n])throw new Error(`Can't delete feature ${t} ${n}: not exsit!`);e.deletedMeta[t][n]=e.meta[t][n],e.deletedMeta[t][n]["@_action"]="delete",ts(e,t,n),delete e.meta[t][n]}function is(e,t,n){const{way:s,relation:o}=t.elems.node[n].fathers;s.forEach(r=>{se(e,"way",r,i=>{i.nd=i.nd.filter(c=>c["@_ref"]!==n)}),e.meta.way[r].nd.length<=1&&gn(e,t,r)}),o.forEach(r=>{se(e,"relation",r,i=>{i.member=i.member.filter(c=>c["@_type"]==="node"&&c["@_ref"]===n)})}),Ve(e,"node",n)}function gn(e,t,n){e.meta.way[n].nd.forEach(o=>{const r=o["@_ref"],{way:i,relation:c}=t.elems.node[r].fathers;i.length>1||c.length>0||Ve(e,"node",r)});const{relation:s}=t.elems.way[n].fathers;s.forEach(o=>{se(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="way"&&i["@_ref"]===n)})}),Ve(e,"way",n)}function cs(e,t,n){const{relation:s}=t.elems.relation[n].fathers;s.forEach(o=>{se(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="relation"&&i["@_ref"]===n)})}),Ve(e,"relation",n)}function ls(e,t,n,s){if(n==="node")is(e,t,s);else if(n==="way")gn(e,t,s);else if(n==="relation")cs(e,t,s);else throw new Error(`Type ${n} not allowed.`)}const ds=["tag","nd","member","node","way","relation"];async function fe(e,t){const n=`${e}${t}`,s=await fetch(n);if(!s.ok)throw new Error(`Error on fetching ${n}: ${s.statusText}`);const o=await s.text(),i=new nn.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",isArray:(c,l,d,p)=>!p&&ds.includes(c)}).parse(o);return console.log(`Get ${n}`,JSON.stringify(i),i),i}async function us(e,t,n,s,o){const r=await fe(e,`/api/0.6/map?bbox=${t},${n},${s},${o}`);return r.osm.bounds["@_maxlat"]=Number(r.osm.bounds["@_maxlat"]),r.osm.bounds["@_minlat"]=Number(r.osm.bounds["@_minlat"]),r.osm.bounds["@_maxlon"]=Number(r.osm.bounds["@_maxlon"]),r.osm.bounds["@_minlon"]=Number(r.osm.bounds["@_minlon"]),r.osm.node=F(r.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i.tag&&(i.tag=F(i.tag)),i)),r}async function ms(e,t){const s=(await fe(e,`/api/0.6/node/${t}`)).osm.node;return s["@_lon"]=Number(s["@_lon"]),s["@_lat"]=Number(s["@_lat"]),s}async function ps(e,t){return(await fe(e,`/api/0.6/way/${t}`)).osm.way}async function fs(e,t){return(await fe(e,`/api/0.6/relation/${t}`)).osm.relation}async function st(e,t){if(t.length===0)return[];const s=`/api/0.6/nodes?nodes=${t.join(",")}`,o=await fe(e,s);return F(o.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i))}async function hs(e,t){if(t.length===0)return[];const s=`/api/0.6/ways?ways=${t.join(",")}`,o=await fe(e,s);return F(o.osm.way)}async function xs(e,t){if(t.length===0)return[];const s=`/api/0.6/relations?relations=${t.join(",")}`,o=await fe(e,s);return F(o.osm.relation)}async function bs(e,{viewpoint:t,zoom:n,width:s,height:o},r){const{left:c,bottom:l,right:d,top:p}=ln(t,n,s,o),u=f=>f.osm.bounds["@_minlon"]<=c+1e-7&&f.osm.bounds["@_minlat"]<=l+1e-7&&f.osm.bounds["@_maxlon"]>=d-1e-7&&f.osm.bounds["@_maxlat"]>=p-1e-7;return e.some(u)?(console.log("requested bbox is already cached"),null):(console.log(`osm load data, faild to get cache: ${c} ${l} ${d} ${p}`,t,n),console.log("state bboxs",e),await us(r,c,l,d,p))}function yn(e,t,n){const s=bn(e,t);return se(e,"node",s,n),s}function Tt(e,t,n,s){let o="0";return se(e,"way",s,r=>{const i=r.nd.map(d=>e.meta.node[d["@_ref"]]),{nearestPoint:c,insertAfter:l}=mn(t,i);o=yn(e,c,n),r.nd.splice(r.nd.findIndex(d=>d["@_ref"]===l["@_id"])+1,0,{"@_ref":o})}),o}const gs=e=>({modifyFeatureStateNC:(t,n,s)=>e(o=>{Ct(o,t,n,s)}),modifyFeatureStateBatchNC:t=>e(n=>{t.forEach(({type:s,id:o,modify:r})=>{Ct(n,s,o,r)})}),selectFeature:(t,n,s)=>e(o=>{U(o),s&&be(o),de(o,t,n)}),selectFeatureWithoutActive:(t,n,s)=>e(o=>{U(o),s&&be(o),Rt(o,t,n)}),unSelectFeature:(t,n)=>e(s=>{U(s),ot(s,t,n)}),toggleFeature:(t,n,s)=>e(o=>{var r;U(o),(r=o.meta[t][n]["@_localStates"])!=null&&r.selected?ot(o,t,n):(s&&be(o),de(o,t,n))}),toggleFeatureWithoutActive:(t,n,s)=>e(o=>{var r;U(o),(r=o.meta[t][n]["@_localStates"])!=null&&r.selected?ot(o,t,n):(s&&be(o),Rt(o,t,n))}),clearSelect:()=>e(t=>{U(t),be(t)})}),ys=(e,t)=>({addFeatureMetaBatch:(n,s)=>e(o=>ss(o,n,s)),createLocalNode:n=>{let s="0";return e(o=>{U(o),s=bn(o,n)}),s},createLocalWay:n=>{let s="0";return e(o=>{U(o),s=as(o,n)}),s},createLocalRelation:n=>{let s="0";return e(o=>{U(o),s=dt(o,n)}),s},modifyFeatureMetaNC:(n,s,o)=>e(r=>{se(r,n,s,o)}),deleteFeature:(n,s)=>e(o=>{U(o),ls(o,t().tree,n,s)}),splitWay:n=>e(s=>{U(s);const o=rs(s,t().tree,n);o&&de(s,"way",o)}),restoreDeletedFeature:(n,s)=>e(o=>{const r=o.deletedMeta[n][s];r&&(o.meta[n][s]={...r},delete o.deletedMeta[n][s],xe(o,n,s))})});function Y(e,t){if(!t)return null;const n=F(t);for(let s=0;s<n.length;s++){const o=n[s];if(o["@_k"]===e)return o["@_v"]}return null}const bt=(e,t,n,s,o,r)=>{const i=(c,l)=>{if(l==="relation"){const d=r[c];if(!d)return;n[c]||(n[c]=!0),F(d.member).forEach(p=>{const u=p["@_ref"],f=p["@_type"];f==="node"?!e[u]&&s[u]&&(e[u]=!0):f==="way"?!t[u]&&o[u]&&i(u,"way"):f==="relation"&&!n[u]&&r[u]&&i(u,"relation")})}else if(l==="way"){const d=o[c];if(!d)return;t[c]||(t[c]=!0),F(d.nd).forEach(p=>{const u=p["@_ref"];!e[u]&&s[u]&&(e[u]=!0)})}else if(l==="node"){if(!s[c])return;e[c]||(e[c]=!0)}};return i};function ws(e,t,n){const s={},o={},r={},i=bt(s,o,r,e,t,n);return Object.values(n).forEach(c=>{(Y("type",c.tag)==="route_master"&&Y("route_master",c.tag)==="bus"||Y("type",c.tag)==="route"&&Y("public_transport:version",c.tag)==="2")&&i(c["@_id"],"relation")}),Object.values(n).forEach(c=>{Y("type",c.tag)==="route"&&Y("public_transport:version",c.tag)==="2"&&Y("roundtrip",c.tag)==="yes"&&i(c["@_id"],"relation")}),{node:s,way:o,relation:r}}function _s(e,t,n){const s={},o={},r={},i=bt(s,o,r,e,t,n);return Object.values(n).forEach(c=>{Y("highway",c.tag)&&i(c["@_id"],"relation")}),Object.values(t).forEach(c=>{Y("highway",c.tag)&&i(c["@_id"],"way")}),Object.values(e).forEach(c=>{Y("highway",c.tag)&&i(c["@_id"],"node")}),{node:s,way:o,relation:r}}function js(e,t,n){const s={},o={},r={},i=bt(s,o,r,e,t,n);return Object.values(n).forEach(c=>{Number(c["@_id"])<0&&i(c["@_id"],"relation")}),Object.values(t).forEach(c=>{Number(c["@_id"])<0&&i(c["@_id"],"way")}),Object.values(e).forEach(c=>{Number(c["@_id"])<0&&i(c["@_id"],"node")}),{node:s,way:o,relation:r}}const Ss=e=>{const t=(...l)=>l.reduce((d,p)=>(Object.assign(d.node,p.node),Object.assign(d.way,p.way),Object.assign(d.relation,p.relation),d),{node:{},way:{},relation:{}}),{node:n,way:s,relation:o}=e,r=ws(n,s,o),i=_s(n,s,o),c=js(n,s,o);return{ptv2:r,highway:i,created:c,global:t(r,i)}};function he(e,t){const n={};for(const[s,o]of Object.entries(e))t(o)&&(n[s]=o);return n}const vs=(e,t)=>({loadbbox:async(n,s)=>{const{bbox:o,meta:r}=t();if(!(n.zoom<=16))try{const i=await bs(o||[],n,s);if(i===null)return;const{node:c,way:l,relation:d}=pe(r),p=[],u=[],f=[];i.osm.node.forEach(g=>{const _=g["@_id"];c[_]||(c[_]=g,p.push(g))}),i.osm.way.forEach(g=>{const _=g["@_id"];l[_]||(l[_]=g,u.push(g))}),i.osm.relation.forEach(g=>{const _=g["@_id"];d[_]||(d[_]=g,f.push(g))});const x=Ss({node:c,way:l,relation:d}),y={nodesId:new Set(Object.keys(x.global.node)),waysId:new Set(Object.keys(x.global.way)),relationsId:new Set(Object.keys(x.global.relation))},b=p.filter(g=>y.nodesId.has(g["@_id"])),h=u.filter(g=>y.waysId.has(g["@_id"])),w=f.filter(g=>y.relationsId.has(g["@_id"]));e(g=>{U(g),b.forEach(_=>{g.meta.node[_["@_id"]]||Be(g,"node",_)}),h.forEach(_=>{g.meta.way[_["@_id"]]||Be(g,"way",_)}),w.forEach(_=>{g.meta.relation[_["@_id"]]||Be(g,"relation",_)}),g.bbox.push({...i,osm:{...i.osm,node:[],way:[],relation:[]}})})}catch(i){console.log(i)}},loadFeature:async(n,s,o)=>{const{meta:r,addFeatureMetaBatch:i}=t();if(n==="node")r.node[s]||i("node",await ms(o,s));else if(n==="way"){const c=await ps(o,s),l=await st(o,c.nd.map(d=>d["@_ref"]));i("node",l.filter(d=>!r.node[d["@_id"]])),r.way[s]||i("way",c)}else n==="relation"&&(r.relation[s]||i("relation",await fs(o,s)))},loadFeatureBatch:async(n,s)=>{const{meta:o,addFeatureMetaBatch:r}=t(),i=n.filter(d=>d.type==="node"&&!o.node[d.id]).map(d=>d.id),c=n.filter(d=>d.type==="way"&&!o.way[d.id]).map(d=>d.id),l=n.filter(d=>d.type==="relation"&&!o.relation[d.id]).map(d=>d.id);if(c.length>0){const d=await hs(s,c),p=d.map(f=>f.nd.map(x=>x["@_ref"]).filter(x=>!o.node[x])).flat(),u=await st(s,p);r("node",u),r("way",d)}if(i.length>0){const d=await st(s,i);r("node",d)}if(l.length>0){const d=await xs(s,l);r("relation",d)}},setAutoloadNC:n=>e(s=>{s.autoload=typeof n=="function"?n():n})}),At=e=>{var t,n;return e["@_type"]==="node"||((t=e["@_role"])==null?void 0:t.startsWith("stop"))||((n=e["@_role"])==null?void 0:n.startsWith("platform"))},Ns=e=>({createBusStopSel:(t,n)=>e(s=>{U(s);const o=yn(s,t,r=>{r.tag=n});de(s,"node",o)}),createStopPositionSel:(t,n,s)=>e(o=>{U(o);const r=Tt(o,t,i=>{i.tag=n},s);de(o,"node",r)}),createNodeOnWay:(t,n,s)=>e(o=>{U(o),Tt(o,t,r=>{r.tag=n},s)}),createStopAreaSel:(t,n)=>e(s=>{U(s);const o=dt(s,n||[]);se(s,"relation",o,r=>{r.tag=t}),de(s,"relation",o)}),createEditRoute:(t,n)=>e(s=>{U(s);const o=dt(s,n||[]);se(s,"relation",o,l=>{l.tag=t}),de(s,"relation",o);const r=n||[],i=r.map((l,d)=>At(l)?d:-1),c=i.lastIndexOf(Math.max(...i));s.routeEdit.editing=o,s.routeEdit.step=0,s.routeEdit.stops=r.slice(0,c+1),s.routeEdit.path=r.slice(c+1,r.length)}),setEditRoute:t=>e(n=>{var i;U(n);const s=((i=n.meta.relation)==null?void 0:i[t].member)||[],o=s.map((c,l)=>At(c)?l:-1),r=o.lastIndexOf(Math.max(...o));n.routeEdit.editing=t,n.routeEdit.step=0,n.routeEdit.stops=s.slice(0,r+1),n.routeEdit.path=s.slice(r+1,s.length)}),cancelEditRoute:()=>e(t=>{U(t),t.routeEdit.editing=void 0,t.routeEdit.step=0,t.routeEdit.stops=[],t.routeEdit.path=[]}),setRouteStop:t=>e(n=>{U(n),n.routeEdit.stops=t}),setRoutePath:t=>e(n=>{U(n),n.routeEdit.path=t}),setEditStepNC:t=>e(n=>{n.routeEdit.step=t}),saveEditRoute:()=>e(t=>{const{editing:n,stops:s,path:o}=t.routeEdit;n&&(U(t),se(t,"relation",n,r=>{r.tag=[...r.tag||[]],r.member=[...s,...o]}),t.routeEdit.editing=void 0,t.routeEdit.stops=[],t.routeEdit.path=[],t.routeEdit.selectedMaster=void 0)}),setSelectedMaster:t=>e(n=>{n.routeEdit.selectedMaster=t}),clearSelectedMaster:()=>e(t=>{t.routeEdit.selectedMaster=void 0})}),ks=e=>({reset:()=>{e({...pn})}}),S=ut()(mt(Wt(es(Ro(Yn((...e)=>({...pn,...Jo(...e),...gs(...e),...ys(...e),...vs(...e),...Ns(...e),...ks(...e)})),{partialize:e=>{const{tree:t,...n}=e;return n},equality:(e,t)=>e.commitCounter===t.commitCounter})),{name:"OSMMapStateStore",storage:$t(()=>localStorage),partialize:e=>{const{tree:t,...n}=e;return n}}),{name:"OSMMapState"})),Ms=e=>({updateSettingsAction:t=>e(()=>t)}),Es={osmAPI:{BASEURL:"https://api.openstreetmap.org",TILE_SOURCE:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"},view:{MAX_ZOOM:19},pixiRender:{zIndex:{LINE:10,POINT:20,MASK:30}}},Cs={name:"settingStore",storage:$t(()=>localStorage)},Z=ut()(mt(Wt((...e)=>({...Es,...Ms(...e)}),Cs),{name:"Settings"}));function Rs(e,t,n,s){return e.replace("{z}",String(s)).replace("{x}",String(t)).replace("{y}",String(n))}function Ts({source:e,x:t,y:n,mapViewStatus:{zoom:s,width:o,height:r,viewpoint:i}}){const c=Rs(e,t,n,s),l={x:t*we,y:n*we},d=cn(l,i,s,o,r);return a.jsx(G.Sprite,{image:c,position:d})}function Se(e){const{width:t,height:n}=e,s=Z(l=>l.osmAPI.TILE_SOURCE),o=X(),{viewpoint:r,zoom:i}=o,c=()=>{const{x:l,y:d}=rn(r,i),[p,u,f,x]=[l-(t>>1),d-(n>>1),l+(t>>1),d+(n>>1)].map(b=>Math.floor(b/we)),y=[];for(let b=p;b<=f;b++)for(let h=u;h<=x;h++)y.push(a.jsx(Ts,{source:s,x:b,y:h,mapViewStatus:{...e,...o}},`${b}-${h}`));return y};return a.jsx(G.Container,{children:c()})}function As(e,t){return[e[0]+t[0],e[1]+t[1]]}function Ps(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function Te(e,t,n=0){return Math.abs(e[0]-t[0])<=n&&Math.abs(e[1]-t[1])<=n}function He(e,t){const n=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(n*n+s*s)}function Is(e,t={}){const s=[e[0],e[1]],o=[e[e.length-2],e[e.length-1]],r=Te(s,o,1e-4),i=new on(e);t.native=!1,i.closeStroke=!1;const c={shape:i,lineStyle:t},l={closePointEps:1e-4,indices:[],points:[],uvs:[]};To.buildLine(c,l);const d=l.points,p=l.indices,u=new Map,f=[],x=[];let y=[NaN,NaN],b=[NaN,NaN],h=0,w=0,g=[NaN,NaN],_=[NaN,NaN],j=[NaN,NaN],M=NaN,I=NaN,k=NaN;for(let T=0;T<p.length;T+=3){const P=p[T],D=p[T+1],K=p[T+2],z=[d[P*2],d[P*2+1]],oe=[d[D*2],d[D*2+1]],B=[d[K*2],d[K*2+1]];if(T===0)u.set(P,!0),u.set(D,!1),u.set(K,!0),f.push(z),x.push(oe),f.push(B),b=oe,y=B,h=He(z,B);else{let v=u.get(P),A=u.get(D),O=u.get(K);v===void 0&&Te(z,g,1e-4)&&(v=u.get(M),u.set(P,v)),A===void 0&&Te(oe,_,1e-4)&&(A=u.get(I),u.set(D,A)),O===void 0&&Te(B,j,1e-4)&&(O=u.get(k),u.set(K,O));let W,V,re;v===void 0&&(W=P,V=z,re=!O),A===void 0&&(W=D,V=oe,re=!v),O===void 0&&(W=K,V=B,re=!A),W!==void 0&&(u.set(W,re),re===!0?(f.push(V),h+=He(y,V),y=V):(x.push(V),w+=He(b,V),b=V))}g=z,_=oe,j=B,M=P,I=D,k=K}const E={},$=f.length+x.length+1,L=new Array($*2);let N=0;for(let T=0;T<f.length;++N,++T)L[N*2]=f[T][0],L[N*2+1]=f[T][1];for(let T=x.length-1;T>=0;++N,--T)L[N*2]=x[T][0],L[N*2+1]=x[T][1];if(L[N*2]=f[0][0],L[N*2+1]=f[0][1],E.perimeter=L,r){const T=w>h?x:f,P=new Array((T.length+1)*2);for(let D=0;D<T.length;++D)P[D*2]=T[D][0],P[D*2+1]=T[D][1];P[T.length*2]=T[0][0],P[T.length*2+1]=T[0][1],E.outer=P}return E}function Pt(e,t,n=!1,s=!1){let r=t,i;const c=[];for(let l=0;l<e.length;l++){const d=e[l];if(i){let p=He(i,d)-r;if(p>=0){const u=Ps(i,d),f=t*Math.cos(u),x=t*Math.sin(u);let y=0,b=0;n&&(y=7*Math.cos(u+Math.PI/2),b=7*Math.sin(u+Math.PI/2));let h=[i[0]+r*Math.cos(u)+y,i[1]+r*Math.sin(u)+b];const w=[i,h];for(s&&p>=t*100&&(t=Math.floor(p/100)),p-=t;p>=0;p-=t)h=As(h,[f,x]),w.push(h);w.push(d),c.push({coords:w.slice(1,-1),angle:u+(n?Math.PI/2:0)})}r=-p}i=d}return c}function Ae(e){return e==="butt"?De.BUTT:e==="square"?De.SQUARE:De.ROUND}function Pe(e){return e==="bevel"?Oe.BEVEL:e==="miter"?Oe.MITER:Oe.ROUND}Ge.from("src/location-pin.svg");const Ls=Ge.from("src/circle.svg"),Ds=Ge.from("src/bus.svg"),It=Ge.from("src/arrow-right-long.svg"),Os={proposed:!0,planned:!0,construction:!0,disused:!0,abandoned:!0,was:!0,dismantled:!0,razed:!0,demolished:!0,destroyed:!0,removed:!0,obliterated:!0,intermittent:!0};function Fs(e){const t=e.split(":");return t.length===1?e:t[0]in Os?e.slice(t[0].length+1):e}const Lt={aerialway:{chair_lift:!0,drag_lift:!0,"j-bar":!0,magic_carpet:!0,mixed_lift:!0,platter:!0,rope_tow:!0,"t-bar":!0,zip_line:!0},highway:{motorway:!0},junction:{circular:!0,roundabout:!0},man_made:{goods_conveyor:!0,"piste:halfpipe":!0},"piste:type":{downhill:!0,sled:!0,yes:!0},roller_coaster:{track:!0},"seamark:type":{"two-way_route":!0,recommended_traffic_lane:!0,separation_lane:!0,separation_roundabout:!0},waterway:{canal:!0,ditch:!0,drain:!0,fish_pass:!0,flowline:!0,pressurised:!0,river:!0,spillway:!0,stream:!0,tidal_channel:!0}},Ie={natural:{cliff:!0,coastline:!0},barrier:{retaining_wall:!0,kerb:!0,guard_rail:!0,city_wall:!0},man_made:{embankment:!0},waterway:{weir:!0}};function Bs(e){const t={yes:!0,1:!0,"-1":!0,reversible:!0,alternating:!0,no:!1,0:!1};let n=null;return e.forEach(s=>{s["@_k"]==="oneway"&&t[s["@_v"]]&&(n=t[s["@_v"]])}),n!==null?n:(e.forEach(s=>{s["@_k"]in Lt&&s["@_v"]in Lt[s["@_k"]]&&(n=!0)}),!!n)}function Hs(e){const t=()=>{for(let n=0;n<e.length;n++){const s=e[n]["@_k"],o=e[n]["@_v"],r=Fs(s);if(r in Ie&&o in Ie[r])return Ie[r][o]?r:Ie[r][o]}return null};return e.some(n=>n["@_k"]==="two_sided"&&n["@_v"]==="yes")?!1:t()!==null}const Ws={surface:{paved:!0,asphalt:!0,concrete:!0,chipseal:!0,"concrete:lanes":!0,"concrete:plates":!0},tracktype:{grade1:!0}},$s=new Set(["motorway","trunk","primary","secondary","tertiary","residential","motorway_link","trunk_link","primary_link","secondary_link","tertiary_link","unclassified","road","service","track","living_street","bus_guideway","busway"]),We=new Set(["abandoned","construction","demolished","destroyed","dismantled","disused","intermittent","obliterated","planned","proposed","razed","removed","was"]),Us=new RegExp("^("+Array.from(We).join("|")+"):"),at={DEFAULTS:{fill:{width:2,color:11184810,alpha:.3},casing:{width:5,color:4473924,alpha:1,cap:"round",join:"round"},stroke:{width:3,color:13421772,alpha:1,cap:"round",join:"round"}},LIFECYCLE:{casing:{alpha:0},stroke:{dash:[7,3],cap:"butt"}},red:{fill:{color:14708319,alpha:.3}},green:{fill:{color:9228383,alpha:.3}},blue:{fill:{color:7853278,alpha:.3}},yellow:{fill:{color:16777108,alpha:.25}},gold:{fill:{color:12893721,alpha:.3}},orange:{fill:{color:14059546,alpha:.3}},pink:{fill:{color:14918901,alpha:.3}},teal:{fill:{color:10084778,alpha:.3}},lightgreen:{fill:{color:12511295,alpha:.3}},tan:{fill:{color:16112826,alpha:.3}},darkgray:{fill:{color:9211020,alpha:.5}},lightgray:{fill:{color:11184810,alpha:.3}},motorway:{casing:{width:10,color:7354159},stroke:{width:8,color:13574273}},trunk:{casing:{width:10,color:7354159},stroke:{width:8,color:14495522}},primary:{casing:{width:10,color:7354159},stroke:{width:8,color:16357382}},secondary:{casing:{width:10,color:7354159},stroke:{width:8,color:15987474}},tertiary:{casing:{width:10,color:7354159},stroke:{width:8,color:16775603}},unclassified:{casing:{width:10,color:4473924},stroke:{width:8,color:14535850}},residential:{casing:{width:10,color:4473924},stroke:{width:8,color:16777215}},living_street:{casing:{width:7,color:16777215},stroke:{width:5,color:13421772}},service:{casing:{width:7,color:4473924},stroke:{width:5,color:16777215}},special_service:{casing:{width:7,color:4473924},stroke:{width:5,color:14535850}},track:{casing:{width:7,color:7630703},stroke:{width:5,color:12957087}},pedestrian:{casing:{width:7,color:16777215},stroke:{width:5,color:10061960,dash:[8,8],cap:"butt"}},path:{casing:{width:5,color:14535850},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},footway:{casing:{width:5,color:16777215},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},crossing_marked:{casing:{width:5,color:14535850},stroke:{width:3,color:4998212,dash:[6,3],cap:"butt"}},crossing_unmarked:{casing:{width:5,color:14535850},stroke:{width:3,color:7826026,dash:[6,4],cap:"butt"}},cycleway:{casing:{width:5,color:16777215},stroke:{width:3,color:5810669,dash:[6,6],cap:"butt"}},bridleway:{casing:{width:5,color:16777215},stroke:{width:3,color:14708063,dash:[6,6],cap:"butt"}},corridor:{casing:{width:5,color:16777215},stroke:{width:3,color:9228383,dash:[2,8],cap:"round"}},steps:{casing:{width:5,color:16777215},stroke:{width:3,color:8507996,dash:[3,3],cap:"butt"}},river:{fill:{color:7853278,alpha:.3},casing:{width:10,color:4473924},stroke:{width:8,color:7855581}},stream:{fill:{color:7853278,alpha:.3},casing:{width:7,color:4473924},stroke:{width:5,color:7855581}},ridge:{stroke:{width:2,color:9228383}},runway:{casing:{width:10,color:0,cap:"butt"},stroke:{width:8,color:16777215,dash:[24,48],cap:"butt"}},taxiway:{casing:{width:7,color:4473924},stroke:{width:5,color:16776960}},railway:{casing:{width:7,color:5592405,cap:"butt"},stroke:{width:2,color:15658734,dash:[12,12],cap:"butt"}},ferry:{casing:{alpha:0},stroke:{width:3,color:5810669,dash:[12,8],cap:"butt"}},boundary:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:16777215,dash:[20,5,5,5],cap:"butt"}},boundary_park:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:11592344,dash:[20,5,5,5],cap:"butt"}},barrier:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_wall:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_hedge:{fill:{color:9228383,alpha:.3},casing:{alpha:0},stroke:{width:3,color:9228383,dash:[10,5,2,5],cap:"round"}},tree_row:{casing:{width:7,color:4473924},stroke:{width:5,color:9228383}},construction:{casing:{width:10,color:16777215},stroke:{width:8,color:16542740,dash:[10,10],cap:"butt"}},pipeline:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[80,2],cap:"butt"}},roller_coaster:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[10,1],cap:"butt"}}},Vs={aeroway:{runway:"runway",taxiway:"taxiway"},amenity:{childcare:"yellow",college:"yellow",fountain:"blue",kindergarten:"yellow",parking:"darkgray",research_institute:"yellow",school:"yellow",university:"yellow"},building:{"*":"red"},barrier:{city_wall:"barrier_wall",hedge:"barrier_hedge",retaining_wall:"barrier_wall",wall:"barrier_wall","*":"barrier"},boundary:{protected_area:"boundary_park",national_park:"boundary_park","*":"boundary"},crossing:{marked:"crossing_marked",traffic_signals:"crossing_marked",uncontrolled:"crossing_marked",zebra:"crossing_marked","*":"crossing_unmarked"},golf:{green:"lightgreen"},highway:{bridleway:"bridleway",bus_guideway:"railway",busway:"special_service",corridor:"corridor",construction:"construction",cycleway:"cycleway",footway:"footway",living_street:"living_street",living_street_link:"living_street",motorway:"motorway",motorway_link:"motorway",path:"path",pedestrian:"pedestrian",primary:"primary",primary_link:"primary",residential:"residential",residential_link:"residential",secondary:"secondary",secondary_link:"secondary",service:"service",service_link:"service",steps:"steps",tertiary:"tertiary",tertiary_link:"tertiary",track:"track",trunk:"trunk",trunk_link:"trunk",unclassified:"unclassified",unclassified_link:"unclassified"},landuse:{cemetery:"lightgreen",commercial:"orange",construction:"gold",farmland:"lightgreen",farmyard:"tan",flowerbed:"green",forest:"green",grass:"green",industrial:"pink",landfill:"orange",meadow:"lightgreen",military:"orange",orchard:"lightgreen",quarry:"darkgray",railway:"darkgray",recreation_ground:"green",residential:"gold",retail:"orange",village_green:"green",vineyard:"lightgreen"},leisure:{garden:"green",golf_course:"green",nature_reserve:"green",park:"green",pitch:"green",swimming_pool:"blue",track:"yellow"},man_made:{adit:"darkgray",breakwater:"barrier_wall",groyne:"barrier_wall",pipeline:"pipeline"},military:{"*":"orange"},natural:{bare_rock:"darkgray",bay:"blue",beach:"yellow",cave_entrance:"darkgray",cliff:"darkgray",glacier:"lightgray",ridge:"ridge",rock:"darkgray",sand:"yellow",scree:"darkgray",scrub:"yellow",shingle:"darkgray",stone:"darkgray",strait:"blue",tree_row:"tree_row",water:"blue",wetland:"teal","*":"green"},power:{plant:"pink"},railway:{platform:"footway","*":"railway"},roller_coaster:{track:"roller_coaster"},route:{ferry:"ferry"},sport:{baseball:"yellow",basketball:"darkgray",beachvolleyball:"yellow",skateboard:"darkgray",softball:"yellow"},type:{waterway:"river"},waterway:{river:"river",dam:"DEFAULTS",weir:"DEFAULTS","*":"stream"},service:{alley:"special_service",driveway:"special_service","drive-through":"special_service",parking_aisle:"special_service","*":"special_service"}};function qs(e){var b,h,w,g,_,j,M,I,k,E,$,L;const t=at.DEFAULTS,n={};for(const N of e)n[N["@_k"]]=N["@_v"];let s=t,o=999,r;for(const[N,T]of Object.entries(n)){const P=Vs[N];if(!P||!T||N==="service"&&n.highway===void 0)continue;const D=P[T]??P["*"];let K=Object.keys(P).length;if(We.has(T)&&(K=999),D&&K<=o){const z=at[D];if(!z){console.error(`invalid styleID: ${D}`);continue}if(s=z,o=K,r=N,o===1)break}}let i=!1;for(const[N,T]of Object.entries(n))if(We.has(N)&&T!=="no"){i=!0;break}else if((!r||N===r)&&We.has(T)){i=!0;break}else if(!r&&Us.test(N)&&T!=="no"){i=!0;break}const c={};for(const N of["fill","casing","stroke"]){c[N]={};const T=(b=s[N])==null?void 0:b.width;if(T!==void 0&&typeof T=="number")c[N].width=T;else{const B=(h=t[N])==null?void 0:h.width;B!==void 0&&(c[N].width=B)}const P=(w=s[N])==null?void 0:w.color;if(P!==void 0&&typeof P=="number")c[N].color=P;else{const B=(g=t[N])==null?void 0:g.color;B!==void 0&&(c[N].color=B)}const D=(_=s[N])==null?void 0:_.alpha;if(D!==void 0&&typeof D=="number")c[N].alpha=D;else{const B=(j=t[N])==null?void 0:j.alpha;B!==void 0&&(c[N].alpha=B)}const K=(M=s[N])==null?void 0:M.cap;if(K!==void 0&&typeof K=="string")c[N].cap=K;else{const B=(I=t[N])==null?void 0:I.cap;B!==void 0&&(c[N].cap=B)}const z=(k=s[N])==null?void 0:k.join;if(z!==void 0&&typeof z=="string")c[N].join=z;else{const B=(E=t[N])==null?void 0:E.join;B!==void 0&&(c[N].join=B)}const oe=($=s[N])==null?void 0:$.dash;if(oe!==void 0&&Array.isArray(oe))c[N].dash=oe;else{const B=(L=t[N])==null?void 0:L.dash;B!==void 0&&(c[N].dash=B)}}const l=n.bridge,d=n.cutting,p=n.embankment,u=n.highway,f=n.tracktype,x=n.tunnel;let y=n.surface;if(u==="track"&&f!=="grade1"&&(y=y||"dirt"),(l||p||d)&&(c.casing.width=(c.casing.width||0)+7,c.casing.color=0,c.casing.cap="butt",(p||d)&&(c.casing.dash=[2,4])),x&&(c.stroke.alpha=.5),y&&u&&$s.has(u)&&!Ws.surface[y]&&(l||(c.casing.color=13421772),c.casing.cap="butt",c.casing.dash=[4,4]),i){const N=at.LIFECYCLE;for(const T of["fill","casing","stroke"])if(N[T])for(const[P,D]of Object.entries(N[T]))c[T][P]=D}return c}const Dt=35;function Xs({line:e,nodePath:t,mapViewStatus:{viewpoint:n,zoom:s,width:o,height:r},status:{visible:i,hovered:c,selected:l,highlighted:d},layerRef:p,...u}){const f=s>=16&&i,x=t.map(k=>ht({lon:k["@_lon"],lat:k["@_lat"]},n,s,o,r)),y=m.useRef(null),b=m.useRef(null),h=qs(F(e.tag)),w=m.useMemo(()=>{var L;const k=Math.max(3,((L=h==null?void 0:h.casing)==null?void 0:L.width)||0),E=x.flatMap(N=>[N.x,N.y]),$={alignment:.5,color:0,width:k+10,alpha:1,join:Oe.BEVEL,cap:De.BUTT};return Is(E,$)},[x,h]),g=m.useCallback(k=>{k.clear();const E=h.casing||{};E.dash?k=new ge(k,{dash:E.dash,color:E.color,width:E.width,alpha:E.alpha||1,join:Pe(E.join),cap:Ae(E.cap)}):k.lineStyle({color:E.color,width:E.width,alpha:E.alpha||1,join:Pe(E.join),cap:Ae(E.cap)});const[$,...L]=x;k.moveTo($.x,$.y),L.forEach(N=>{k.lineTo(N.x,N.y)})},[x,h.casing]),_=m.useCallback(k=>{k.clear();const E=h.stroke||{};E.dash?k=new ge(k,{dash:E.dash,color:E.color,width:E.width,alpha:E.alpha||1,join:Pe(E.join),cap:Ae(E.cap)}):k.lineStyle({color:E.color,width:E.width,alpha:E.alpha||1,join:Pe(E.join),cap:Ae(E.cap)});const[$,...L]=x;k.moveTo($.x,$.y),L.forEach(N=>{k.lineTo(N.x,N.y)})},[x,h]),j=m.useCallback(()=>{y.current&&w.perimeter&&(y.current.hitArea=new on(w.perimeter))},[y,w]);m.useEffect(()=>{const k=y.current;if(k!==null){const E=()=>{j()},$=()=>{const L=f&&c,N=f&&l,T=f&&d;if(L){if(!k.filters){const P=new $e({distance:15,outerStrength:3,color:16776960});P.resolution=2,k.filters=[P]}}else if(T){if(!k.filters){const P=new $e({distance:15,outerStrength:3,color:7377663});P.resolution=2,k.filters=[P]}}else k.filters&&(k.filters=null);if(N&&p.current){b.current||(b.current=new sn,p.current.addChild(b.current));const P={alpha:.9,dash:[6,3],width:2,color:16711680};b.current.clear();const D=new ge(b.current,P);w&&(w.outer&&w.inner?(D.drawPolygon(w.outer),D.drawPolygon(w.inner)):D.drawPolygon(w.perimeter))}else b.current&&(b.current.destroy({children:!0}),b.current=null)};E(),$()}},[d,c,l,f,j,w,p]),m.useEffect(()=>()=>{b.current&&(b.current.destroy({children:!0}),b.current=null)},[]);const M=Bs(F(e.tag)),I=Hs(F(e.tag));return a.jsxs(G.Container,{visible:f,position:{x:0,y:0},ref:y,...u,children:[a.jsx(G.Graphics,{draw:g}),a.jsx(G.Graphics,{draw:_}),M&&Pt(x.map(k=>[k.x,k.y]),Dt,!1,!0).map((k,E)=>k.coords.map(([$,L],N)=>a.jsx(G.Sprite,{eventMode:"none",width:8,height:8,texture:It,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:$,y:L},rotation:k.angle,tint:0},`${E}-${N}`))).flat(),I&&Pt(x.map(k=>[k.x,k.y]),Dt,!0,!0).map((k,E)=>k.coords.map(([$,L],N)=>a.jsx(G.Sprite,{eventMode:"none",width:8,height:8,texture:It,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:$,y:L},rotation:k.angle,tint:0},`${E}-${N}`))).flat()]})}var qe=(e=>(e.BUS_STOP="bus stop",e.STOP_POSITION="stop posistion",e))(qe||{}),wn=(e=>e)(wn||{}),Xe=(e=>(e.ROUTE="route",e.ROUTE_MASTER="route master",e.STOP_AREA="stop area",e))(Xe||{});({...qe,...wn,...Xe});function Ze(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="platform")&&e.some(t=>t["@_k"]==="highway"&&t["@_v"]==="bus_stop")}function gt(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="stop_position")}function ee(e){var t;return e=e||[],(t=e.find(n=>n["@_k"]==="name"))==null?void 0:t["@_v"]}function Je(e){if(e){if(Ze(e))return qe.BUS_STOP;if(gt(e))return qe.STOP_POSITION}}function Ks({node:e,mapViewStatus:{width:t,height:n,viewpoint:s,zoom:o},status:{visible:r,hovered:i,selected:c,highlighted:l},layerRef:d,...p}){const u=o>=16&&r,f=m.useRef(null),x=m.useRef(null),y=Ze(F(e.tag)),b="dot",h=ht({lon:e["@_lon"],lat:e["@_lat"]},s,o,t,n),w=m.useMemo(()=>ee(e.tag),[e.tag]),g=m.useMemo(()=>y?16:8,[y]),_=11;return m.useEffect(()=>{const j=f.current;if(j){const M=()=>{if(!u)return;const k=20,E=new Mt(0,0,Math.max(k/2,g/2+5));j.hitArea=E},I=()=>{const k=u&&i,E=u&&l,$=u&&c;if(k){if(!j.filters){const L=new $e({distance:15,outerStrength:3,color:16776960});L.resolution=2,j.filters=[L]}}else if(E){if(!j.filters){const L=new $e({distance:15,outerStrength:3,color:7377663});L.resolution=2,j.filters=[L]}}else j.filters&&(j.filters=null);if($&&d.current){console.log("show select"),x.current||(x.current=new sn,d.current.addChild(x.current));const L={alpha:.9,dash:[6,3],width:3,color:16711680};x.current.clear();const N=j.hitArea;N instanceof Mt?(new ge(x.current,L).drawCircle(N.x+h.x,N.y+h.y,N.radius,20),console.log(x.current)):N instanceof Po&&new ge(x.current,L).drawRect(N.x+h.x,N.y+h.y,N.width,N.height)}else x.current&&(x.current.destroy({children:!0}),x.current=null)};M(),I()}},[o,l,i,u,b,c,d,h]),m.useEffect(()=>()=>{x.current&&(x.current.destroy({children:!0}),x.current=null)},[]),m.useEffect(()=>{const j=f.current;j&&(o<16||(o<17?j.scale.set(.8,.8):j.scale.set(1,1)))},[o]),o<16?null:a.jsxs(G.Container,{...p,position:h,visible:u,ref:f,children:[a.jsx(G.Sprite,{eventMode:"none",sortableChildren:!1,visible:!0,texture:Ls,anchor:{x:.5,y:.5},width:g,height:g}),y&&a.jsx(G.Sprite,{eventMode:"none",texture:Ds,anchor:{x:.5,y:.5},width:_,height:_}),w&&o>16&&a.jsx(G.Text,{text:w,anchor:.5,x:0,y:y?24:16,style:new Ao({align:"center",fontFamily:'"Source Sans Pro", Helvetica, sans-serif',fontSize:12,fontWeight:"400",fill:"#ffffff",stroke:"#000000",strokeThickness:2,dropShadow:!0,dropShadowColor:"#ccced2",dropShadowBlur:3,dropShadowAngle:Math.PI/6,dropShadowDistance:2,wordWrap:!0,wordWrapWidth:440})})]})}const zs=m.forwardRef(function({view:{width:t,height:n,viewpoint:s,zoom:o},meta:{node:r,way:i},pointRenderer:c,wayRenderer:l,...d},p){const{left:u,bottom:f,right:x,top:y}=m.useMemo(()=>ln(s,o,t,n),[s,o,t,n]),b=m.useCallback(({"@_lon":h,"@_lat":w})=>u<=h&&h<=x&&f<=w&&w<=y,[u,f,x,y]);return o<16?null:a.jsxs(G.Container,{ref:p,...d,children:[Object.values(i).filter(h=>h.nd.map(w=>r[w["@_ref"]]).some(b)).map(l),Object.values(r).filter(b).map(c)]})});function Gs({selectionRect:e}){if(!e)return null;const{from:t,to:n}=e,s=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);return a.jsx(G.Graphics,{draw:c=>{c.clear(),c.beginFill(16753920,.5),c.drawRect(s,o,r,i),c.endFill()}})}function Ys({node:e,stateMachine:t,...n}){const s=e["@_localStates"],o=e["@_id"];return a.jsx(Ks,{...n,node:e,status:s,eventMode:"static",mousedown:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),mouseup:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerover:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerout:r=>t.transform({...r,componentTarget:{id:o,type:"node"}})})}function Zs({way:e,node:t,stateMachine:n,...s}){const o=e["@_localStates"],r=e["@_id"],i=m.useMemo(()=>e.nd.map(c=>t[c["@_ref"]]),[t,e.nd]);return a.jsx(Xs,{...s,line:e,nodePath:i,status:o,eventMode:"static",pointerover:c=>n.transform({...c,componentTarget:{id:r,type:"way"}}),pointerout:c=>n.transform({...c,componentTarget:{id:r,type:"way"}}),mousedown:c=>n.transform({...c,componentTarget:{id:r,type:"way"}}),mouseup:c=>n.transform({...c,componentTarget:{id:r,type:"way"}})})}function ve({width:e,height:t,stateMachine:n}){const[s,o,r]=X(q(d=>[d.viewpoint,d.zoom,d.selectionRect])),{node:i,way:c}=S(d=>d.meta),l=m.useRef(null);return a.jsxs(a.Fragment,{children:[a.jsx(zs,{view:{viewpoint:s,zoom:o,width:e,height:t},meta:{node:i,way:c},ref:l,wayRenderer:d=>a.jsx(Zs,{way:d,node:i,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:l},d["@_id"]),pointRenderer:d=>a.jsx(Ys,{node:d,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:l},d["@_id"])}),a.jsx(Gs,{selectionRect:r})]})}function _n(e,t,n){const s={"?xml":{"@_version":"1.0","@_encoding":"UTF-8"},osm:{bounds:{"@_minlat":n.reduce((i,c)=>Math.min(i,c.osm.bounds["@_minlat"]),1/0),"@_minlon":n.reduce((i,c)=>Math.min(i,c.osm.bounds["@_minlon"]),1/0),"@_maxlat":n.reduce((i,c)=>Math.max(i,c.osm.bounds["@_maxlat"]),-1/0),"@_maxlon":n.reduce((i,c)=>Math.max(i,c.osm.bounds["@_maxlon"]),-1/0),"@_origin":"v0.0.2-BusFensi"},node:Object.values({...e.node,...t.node}),way:Object.values({...e.way,...t.way}),relation:Object.values({...e.relation,...t.relation}),"@_version":.6,"@_generator":"BusFensi"}};console.log(s,e);const r=new nn.XMLBuilder({ignoreAttributes:["localStates"],attributeNamePrefix:"@_",suppressBooleanAttributes:!1}).build(s);return console.log(r),r}function Js({stateMachine:e}){const{createLocalWay:t,createLocalRelation:n,deleteFeature:s,selectFeature:o,clearSelect:r,selectedRef:i,meta:c,bbox:l,deletedMeta:d}=S(q(M=>M)),{updateSettingsAction:p,...u}=Z(),[f,x]=m.useState(!1),[y,b]=m.useState(u),h=()=>{const M=i.filter(k=>k.type==="node").map(k=>({"@_ref":k.id})),I=t(M);o("way",I,!1)},w=()=>{const M=i.map(k=>({"@_ref":k.id,"@_type":k.type})),I=n(M);o("relation",I,!1)},g=()=>{const M=pe(i);r(),M.forEach(I=>{if(I.type==="node"||I.type==="way"||I.type==="relation")s(I.type,I.id);else throw new Error(`Type not found ${I.type} for id ${I.id}`)})},_=()=>{const M=_n(c,d,l),I=new Blob([M],{type:"application/xml"}),k=document.createElement("a");k.href=URL.createObjectURL(I),k.download="exported_data.osm",k.click(),URL.revokeObjectURL(k.href)},j=()=>{p(y),x(!1)};return a.jsxs("div",{className:"join",children:[a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node"}),children:"Create Node"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node-on-way"}),children:"Create node on way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"split-way"}),children:"Split way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:h,children:"Create way with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:w,children:"Create relation with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:g,children:"Delete selected"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:_,children:"export josm"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>x(!0),children:"Change Settings"}),f&&a.jsx("div",{className:"modal modal-open",children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:y.osmAPI.BASEURL,onChange:M=>b({...y,osmAPI:{...y.osmAPI,BASEURL:M.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:y.osmAPI.TILE_SOURCE,onChange:M=>b({...y,osmAPI:{...y.osmAPI,TILE_SOURCE:M.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:y.view.MAX_ZOOM,onChange:M=>b({...y,view:{...y.view,MAX_ZOOM:parseFloat(M.target.value)}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn",onClick:j,children:"Save"}),a.jsx("button",{className:"btn btn-ghost",onClick:()=>x(!1),children:"Cancel"})]})]})})]})}const Qs=({id:e="drag-bar",dir:t,isDragging:n,...s})=>{const[o,r]=m.useState(!1);return a.jsx("div",{id:e,"data-testid":e,tabIndex:0,className:Q("flex-shrink-0 bg-base-300 transition-colors",t==="horizontal"?"cursor-row-resize h-1":"cursor-col-resize w-1",(n||o)&&"bg-accent"),onFocus:()=>r(!0),onBlur:()=>r(!1),...s})},Ke=({width:e,height:t,children:n,...s})=>{const{axis:o}=s,r=s.initial||(o==="x"?e/2:t/2),{position:i,separatorProps:c,setPosition:l}=Ln({...s,initial:r}),d=m.useRef(o==="x"?e:t);let p={},u={};return o==="x"?(p={width:i,height:t},u={width:e-i,height:t}):(p={width:e,height:i},u={width:e,height:t-i}),m.useEffect(()=>{o==="x"&&e!==d.current?(l(i*(e/d.current)),d.current=e):o==="y"&&t!==d.current&&(l(i*(t/d.current)),d.current=t)},[e,t,d,o,l,i]),a.jsxs("div",{style:{width:e,height:t,display:"flex",flexDirection:o==="x"?"row":"column",position:"relative"},children:[a.jsx("div",{style:p,children:n[0]({width:p.width,height:p.height})}),a.jsx(Qs,{...c,dir:o==="x"?"vertical":"horizontal",isDragging:!1}),a.jsx("div",{style:u,children:n[1]({width:u.width,height:u.height})})]})};function ea({children:e}){return a.jsx("ul",{className:"menu menu-xs",children:e})}function ue({featuretype:e,metatype:t,fullname:n,id:s,created:o,deleted:r,modified:i,children:c}){let l;switch(e){case"node":l=to;break;case"way":l=eo;break;case"relation":l=Qn;break;default:l=Jn}return a.jsxs(a.Fragment,{children:[a.jsx("span",{children:a.jsx(R,{icon:l})}),a.jsx("span",{className:"font-semibold",children:n||"[untitled]"}),t&&a.jsx("span",{className:"badge badge-xs h-fit badge-outline text-nowrap",children:t}),a.jsx("div",{className:"badge badge-xs h-fit badge-outline",children:s}),a.jsxs("div",{className:"flex space-x-1",children:[o&&a.jsx("div",{className:"badge badge-xs badge-success tooltip tooltip-bottom","data-tip":"Created",children:a.jsx(R,{icon:ye})}),i&&a.jsx("div",{className:"badge badge-xs badge-warning tooltip tooltip-bottom","data-tip":"Modified",children:a.jsx(R,{icon:Zn})}),r&&a.jsx("div",{className:"badge badge-xs badge-error tooltip tooltip-bottom","data-tip":"Deleted",children:a.jsx(R,{icon:Ut})})]}),a.jsx("span",{className:"flex items-center ml-auto",children:c})]})}function ta(e){return a.jsxs("li",{children:[" ",a.jsx("span",{className:"flex select-text justify-between items-center rounded",children:a.jsx(ue,{...e})})]})}function na({show:e,proceed:t,title:n,message:s}){const o=m.useRef(null);m.useEffect(()=>{const c=o.current;c&&(e?c.showModal():c.close())},[e]);const r=()=>{t(!1)},i=()=>{console.debug("clicking delete ok: "),t(!0)};return a.jsxs("dialog",{ref:o,className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box",children:[n&&a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsx("p",{children:s}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn btn-md",onClick:r,children:"Cancel"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:i,children:"OK"})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})}const oa=e=>a.jsx(na,{...e}),jn=me.confirmable(oa);jn.displayName="ConfirmableSimpleConfirmation";function Sn(e){return e=e||[],Y("public_transport",e)==="stop_area"&&Y("type",e)==="public_transport"}function yt(e){return e=e||[],Y("type",e)==="route"}function vn(e){return e=e||[],Y("type",e)==="route_master"}function Qe(e){if(e&&!Sn(e)){if(yt(e))return Xe.ROUTE;if(vn(e))return Xe.ROUTE_MASTER}}function rt({type:e,meta:t,showMetaType:n,children:s}){var h,w,g;const o=t["@_id"],[r,i,c,l]=S(q(_=>[_.selectFeature,_.unSelectFeature,_.deleteFeature,_.restoreDeletedFeature])),d=X(_=>_.setViewpoint),p=me.createConfirmation(jn),u=m.useMemo(()=>{var _;if(n&&((_=t.tag)!=null&&_.length)){if(e==="node")return Je(t.tag);if(e==="relation")return Qe(t.tag)}},[n,t.tag,e]),f=m.useCallback(_=>{if(_.stopPropagation(),e==="node"){const j=t;d({lat:j["@_lat"],lon:j["@_lon"]})}},[t,d,e]),x=m.useCallback(_=>{var j;_.stopPropagation(),(j=t["@_localStates"])!=null&&j.selected?i(e,o):r(e,o,!1)},[o,t,r,e,i]),y=m.useCallback(async _=>{_.stopPropagation(),console.debug("deleting: ",e,o);const j=await p({title:"Confirm delete feature",message:`Are you sure you want delete this feature?
`+(ee(t.tag||[])||o)});console.debug("confirmed deleting: ",j,e,o),j&&c(e,o)},[p,c,o,t.tag,e]),b=t["@_action"]==="delete";return a.jsxs(ta,{featuretype:e,id:o,metatype:u,fullname:ee(t.tag),created:Number(t["@_id"])<0,deleted:b,modified:t["@_action"]==="modify",children:[!b&&a.jsxs(a.Fragment,{children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:f,children:a.jsx(R,{icon:Vt.faLocationDot})}),a.jsx("button",{className:Q("btn btn-xs btn-square tooltip tooltip-bottom",((h=t["@_localStates"])==null?void 0:h.selected)&&"btn-accent"),"data-tip":(w=t["@_localStates"])!=null&&w.selected?"Unselect":"Select",onClick:x,children:a.jsx(R,{icon:(g=t["@_localStates"])!=null&&g.selected?qt.faXmarkCircle:Xt.faCheckCircle})}),a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Delete",onClick:y,children:a.jsx(R,{icon:no.faTrash})})]}),b&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Restore",onClick:()=>l(e,o),children:a.jsx(R,{icon:oo.faClockRotateLeft})}),s&&s({type:e,meta:t})]})}function te({node:e,way:t,relation:n,filter:s,...o}){return s=s||(()=>!0),a.jsxs(ea,{children:[(e||[]).filter(r=>s(r,"node")).map(r=>m.createElement(rt,{...o,key:r["@_id"],meta:r,type:"node"})),(t||[]).filter(r=>s(r,"way")).map(r=>m.createElement(rt,{...o,key:r["@_id"],meta:r,type:"way"})),(n||[]).filter(r=>s(r,"relation")).map(r=>m.createElement(rt,{...o,key:r["@_id"],meta:r,type:"relation"}))]})}function ne({name:e,defaultOpen:t,forceOpen:n,forceClose:s,children:o}){const[r,i]=m.useState(!t),c=d=>{d.stopPropagation(),s||n||i(!r)},l=n?!0:s?!1:!r;return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",onClick:c,children:[a.jsx(R,{icon:n?Kt.faMinus:s?so.faX:l?pt.faChevronDown:zt.faChevronRight}),a.jsx(R,{icon:ao.faBars,className:"ml-1"}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),l&&o]})}function sa(e){const t=S(n=>n.meta.node);return a.jsx(ne,{name:"bus stop",children:a.jsx(te,{...e,node:Object.values(t).filter(n=>Ze(n.tag))})})}function aa(e){const t=S(n=>n.meta.relation);return a.jsx(ne,{name:"stop area",children:a.jsx(te,{...e,relation:Object.values(t).filter(n=>Sn(n.tag))})})}function ra(e){const t=S(n=>n.meta.node);return a.jsx(ne,{name:"stop position",children:a.jsx(te,{...e,node:Object.values(t).filter(n=>gt(n.tag))})})}function Ne({children:e}){const[t,n]=m.useState(""),s=(o,r)=>t===""||`${r}-${JSON.stringify(o)}`.includes(t);return a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2 w-full mt-1 mx-auto",children:[a.jsx(R,{icon:ro.faSearch}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:t,onChange:o=>n(o.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 rounded overflow-scroll",children:a.jsx("ul",{className:"menu menu-xs",children:F(e).map(o=>o({filter:s}))})})]})}function ia(){return a.jsxs(Ne,{children:[({filter:e})=>a.jsx(sa,{filter:e}),({filter:e})=>a.jsx(ra,{filter:e}),({filter:e})=>a.jsx(aa,{filter:e})]})}function it(e){return Number(e["@_id"])<0}function ca(e){const{relation:t,way:n,node:s}=S(c=>c.meta),o=m.useMemo(()=>Object.values(he(t,it)),[t]),r=m.useMemo(()=>Object.values(he(n,it)),[n]),i=m.useMemo(()=>Object.values(he(s,it)),[s]);return a.jsx(ne,{name:"created",children:a.jsx(te,{...e,relation:o,way:r,node:i})})}const la=e=>e.routeEdit.selectedMaster,Nn=({left:e,right:t,bottom:n,top:s})=>o=>{const r=({"@_lon":c,"@_lat":l})=>e<=c&&c<=t&&n<=l&&l<=s,i=c=>o.meta.node[c["@_ref"]];return{node:Object.entries(o.meta.node).filter(([,c])=>r(c)).reduce((c,l)=>({...c,[l[0]]:l[1]}),{}),way:Object.entries(o.meta.way).filter(([,c])=>c.nd.map(i).some(r)).reduce((c,l)=>({...c,[l[0]]:l[1]}),{}),relation:Object.entries(o.meta.relation).filter(([,c])=>c.member.filter(l=>l["@_type"]==="node"&&i(l)).map(i).some(r)).reduce((c,l)=>({...c,[l[0]]:l[1]}),{})}};function da(e){const t=e.activeRef;return t?{type:t.type,meta:e.meta[t.type][t.id]}:null}const ct=e=>t=>{const n=t.selectedRef;return n.length?n.filter(s=>s.type===e).map(s=>t.meta[e][s.id]):[]},ua=e=>e.deletedMeta;function ma(e){const{relation:t,way:n,node:s}=S(q(ua)),o=m.useMemo(()=>Object.values(t),[t]),r=m.useMemo(()=>Object.values(n),[n]),i=m.useMemo(()=>Object.values(s),[s]);return a.jsx(ne,{name:"deleted",children:a.jsx(te,{...e,relation:o,way:r,node:i})})}function lt(e){return e["@_action"]==="modify"}function pa(e){const{relation:t,way:n,node:s}=S(c=>c.meta),o=m.useMemo(()=>Object.values(he(t,lt)),[t]),r=m.useMemo(()=>Object.values(he(n,lt)),[n]),i=m.useMemo(()=>Object.values(he(s,lt)),[s]);return a.jsx(ne,{name:"modified",children:a.jsx(te,{...e,relation:o,way:r,node:i})})}function fa(){return a.jsxs(Ne,{children:[({filter:e})=>a.jsx(ca,{filter:e}),({filter:e})=>a.jsx(pa,{filter:e}),({filter:e})=>a.jsx(ma,{filter:e})]})}function ha(e){const t=S(n=>n.meta.relation);return a.jsx(ne,{name:"route",children:a.jsx(te,{...e,relation:Object.values(t).filter(n=>yt(n.tag))})})}function xa(e){const t=S(n=>n.meta.relation);return a.jsx(ne,{name:"route master",children:a.jsx(te,{...e,relation:Object.values(t).filter(n=>vn(n.tag))})})}function ba(){return a.jsxs(Ne,{children:[({filter:e})=>a.jsx(ha,{filter:e}),({filter:e})=>a.jsx(xa,{filter:e})]})}function ga(e){const t=S(q(da));return a.jsx(ne,{name:"active",forceOpen:!0,children:a.jsx(te,{...e,node:(t==null?void 0:t.type)==="node"?[t.meta]:void 0,way:(t==null?void 0:t.type)==="way"?[t.meta]:void 0,relation:(t==null?void 0:t.type)==="relation"?[t.meta]:void 0,showMetaType:!0})})}function ya(e){const t=S(q(ct("node"))),n=S(q(ct("way"))),s=S(q(ct("relation"))),o=S(i=>i.selectFeature),r=m.useCallback(({type:i,meta:c})=>a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Active",onClick:async l=>{l.stopPropagation(),console.debug("activating: ",i,c["@_id"]),o(i,c["@_id"],!1)},children:a.jsx(R,{icon:io.faStarOfLife})}),[o]);return a.jsx(ne,{name:"selected",defaultOpen:!0,children:a.jsx(te,{...e,node:t,way:n,relation:s,showMetaType:!0,children:r})})}function wa(){return a.jsxs(Ne,{children:[({filter:e})=>a.jsx(ga,{filter:e}),({filter:e})=>a.jsx(ya,{filter:e})]})}function kn({width:e,height:t}){const n=[{title:"Bus stop",tab:()=>a.jsx(ia,{})},{title:"Route",tab:()=>a.jsx(ba,{})},{title:"Changes",tab:()=>a.jsx(fa,{})},{title:"Selected",tab:()=>a.jsx(wa,{})}],[s,o]=m.useState(0);return a.jsxs("div",{style:{width:e,height:t},className:"flex flex-col",children:[a.jsx("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs",children:n.map((r,i)=>a.jsx("a",{onClick:()=>o(i),role:"tab",className:Q("tab",i===s&&"tab-active"),children:r.title},i))}),a.jsx("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:n[s].tab()})]})}const Ot=m.memo(({initialValue:e,onCommit:t,...n})=>{const[s,o]=m.useState(e||"");return m.useEffect(()=>{o(e||"")},[e]),a.jsx("input",{...n,value:s,onChange:r=>o(r.target.value),onKeyDown:r=>{r.key==="Enter"&&r.currentTarget.blur(),r.stopPropagation()},onBlur:()=>{t(s)}})});function ke({tags:e,setTags:t,commitChange:n}){const s=pe(e),o=(l,d)=>{n(),s[l]["@_k"]=d,t([...s])},r=(l,d)=>{n(),s[l]["@_v"]=d,t([...s])},i=l=>{const d=s.filter((p,u)=>u!==l);n(),t(d)},c=()=>{n(),t([...s,{"@_k":"","@_v":""}])};return a.jsxs("table",{className:"table table-xs w-full max-w-full overflow-x-scroll",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Key"}),a.jsx("th",{children:"Value"}),a.jsx("th",{children:"Actions"})]})}),a.jsx("tbody",{children:s.map((l,d)=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsx(Ot,{type:"text",initialValue:l["@_k"],onCommit:p=>o(d,p),className:"input input-bordered input-xs rounded-md border max-w-xs"})}),a.jsx("td",{children:a.jsx(Ot,{type:"text",initialValue:l["@_v"],onCommit:p=>r(d,p),className:"input input-bordered input-xs rounded-md border max-w-xs w-fit"})}),a.jsx("td",{children:a.jsx("button",{onClick:()=>i(d),className:"btn btn-error btn-xs",children:a.jsx(R,{icon:co})})})]},d))}),a.jsx("tfoot",{children:a.jsx("tr",{children:a.jsx("td",{colSpan:3,className:"flex gap-2",children:a.jsx("button",{onClick:c,className:"btn btn-primary btn-sm",children:"Add"})})})})]})}function wt({meta:e}){const t=un(e).filter(n=>{const s=e[n];return n.startsWith("@_")&&(typeof s=="string"||typeof s=="number")});return a.jsx("ul",{className:"menu menu-xs bg-200 rounded-box",children:t.map(n=>{const s=e[n];return a.jsx("li",{children:a.jsxs("span",{className:"select-text",children:[a.jsx("span",{className:"font-semibold",children:String(n).substring(2)}),a.jsx("span",{className:"ml-auto text-base-content",children:s.toString()})]})},n)})})}function ie({type:e,id:t,showMetaType:n,children:s}){var w,g,_;const[o,r,i,c]=S(q(j=>[j.meta[e][t],j.selectFeatureWithoutActive,j.unSelectFeature,j.loadFeature])),l=Z(j=>j.osmAPI.BASEURL),d=X(j=>j.setViewpoint),p=m.useMemo(()=>{var j;if(n&&((j=o==null?void 0:o.tag)!=null&&j.length)){if(e==="node")return Je(o.tag);if(e==="relation")return Qe(o.tag)}},[n,o==null?void 0:o.tag,e]),[u,f]=m.useState(!1),x=m.useCallback(async()=>{f(!0),await c(e,t,l),f(!1)},[c,e,t,l]),y=m.useCallback(j=>{if(j.stopPropagation(),e==="node"){const M=o;d({lat:M["@_lat"],lon:M["@_lon"]})}},[o,d,e]),b=m.useCallback(j=>{var M;j.stopPropagation(),(M=o["@_localStates"])!=null&&M.selected?i(e,t):r(e,t,!1)},[t,o,r,e,i]),h=m.useCallback(j=>{j.stopPropagation(),x()},[x]);return o?a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(ue,{featuretype:e,id:t,metatype:p,fullname:ee(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:y,children:a.jsx(R,{icon:Vt.faLocationDot})}),a.jsx("button",{className:Q("btn btn-xs btn-square tooltip tooltip-bottom",((w=o["@_localStates"])==null?void 0:w.selected)&&"btn-accent"),"data-tip":(g=o["@_localStates"])!=null&&g.selected?"Unselect":"Select",onClick:b,children:a.jsx(R,{icon:(_=o["@_localStates"])!=null&&_.selected?qt.faXmarkCircle:Xt.faCheckCircle})}),s&&s({type:e,id:t})]})}):a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(ue,{featuretype:e,id:t,fullname:"[not downloaded]",children:[u?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx("button",{className:"btn btn-square btn-xs btn-success tooltip tooltip-bottom","data-tip":"Download feature",onMouseDown:h,children:a.jsx(R,{icon:lo})}),s&&s({type:e,id:t})]})})}function Mn({id:e,type:t}){const n=S(c=>c.selectFeature),{relation:s,way:o}=S(q(c=>c.meta)),r=un(s).filter(c=>Object.prototype.hasOwnProperty.call(s,c)).map(c=>s[c]),i=c=>{n("relation",c,!1)};return a.jsx("ul",{className:"menu menu-xs",children:r.filter(c=>F(c.member).some(l=>l["@_ref"]===e&&l["@_type"]===t||t==="node"&&(l["@_type"]==="way"&&o[l["@_ref"]]&&F(o[l["@_ref"]].nd).some(d=>String(d["@_ref"])===e)||l["@_type"]==="relation"&&s[l["@_ref"]]&&F(s[l["@_ref"]].member).some(d=>d["@_ref"]===e)))).map(c=>a.jsx("li",{children:a.jsx("span",{onClick:()=>i(c["@_id"]),children:a.jsx(ie,{id:c["@_id"],type:"relation",showMetaType:!0})})},c["@_id"]))})}function _t({id:e,type:t}){const n=S(q(s=>s.meta[t][e]["@_localStates"]));return a.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(n).filter(([,s])=>s).map(([s])=>a.jsx("span",{className:"badge badge-info badge-xs",children:s},s))})}function _a({id:e}){const t=S(q(o=>o.meta.node[e])),n=S(o=>o.modifyFeatureMetaNC),s=S(o=>o.commit);return t?a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Node] ",ee(t.tag)||t["@_id"]]}),a.jsx(_t,{id:e,type:"node"}),a.jsx(wt,{meta:t}),a.jsx(ke,{tags:F(t.tag),setTags:o=>{n("node",e,r=>r.tag=o)},commitChange:s}),a.jsx(Mn,{id:e,type:"node"})]}):null}function En({member:e,memberToId:t,children:n,slotSelection:s}){const[o,r]=m.useState(new Set);m.useEffect(()=>{r(l=>{const d=new Set;return e.forEach(p=>{l.has(t(p))&&d.add(t(p))}),d})},[e,t]);const i=()=>{o.size===e.length?r(new Set):r(new Set(e.map(t)))},c=m.useMemo(()=>{const l=d=>{r(p=>{const u=new Set(p);return u.has(d)?u.delete(d):u.add(d),u})};return({m:d})=>a.jsx(a.Fragment,{children:a.jsx("input",{type:"checkbox",className:"checkbox ml-2",checked:o.has(t(d)),onChange:()=>l(t(d))})})},[o,t]);return a.jsxs(a.Fragment,{children:[s({selected:o,children:a.jsx("input",{type:"checkbox",checked:o.size===e.length,onChange:i,className:"checkbox ml-2"})}),n({member:e,memberToId:t,slot:c})]})}function ja({id:e,type:t}){const n=S(o=>o.meta[t][e]),s=m.useMemo(()=>{var o;if((o=n==null?void 0:n.tag)!=null&&o.length){if(t==="node")return Je(n.tag);if(t==="relation")return Qe(n.tag)}},[n==null?void 0:n.tag,t]);return a.jsx(ue,{featuretype:t,id:e,metatype:s,fullname:ee(n.tag),created:Number(n["@_id"])<0,deleted:n["@_action"]==="delete",modified:n["@_action"]==="modify"})}function jt({handelInsertTop:e,handelIntertBottom:t,handelInsertAtActive:n}){const s=S(q(l=>l.selectedRef)),o=m.useCallback(l=>`${l.type}-${l.id}`,[]),r=m.useRef(new Set),i=()=>s.filter(l=>r.current.has(o(l))),c=m.useCallback(({member:l,memberToId:d,slot:p})=>l.map(u=>a.jsxs("div",{className:"flex flex-row gap-1 px-2 mt-1",children:[a.jsx(ja,{...u}),p({m:u})]},d(u))),[]);return a.jsxs("div",{className:"flex flex-row justify-center p-2 rounded-md",children:[a.jsxs("div",{className:"join join-vertical mr-2",children:[a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{e(i())},children:"InsTop"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{n(i())},children:"InsAct"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{t(i())},children:"InsBtm"})]}),a.jsx("div",{className:"bg-base-200 text-xs rounded max-h-full",children:a.jsx(En,{member:s,memberToId:o,slotSelection:({selected:l,children:d})=>(r.current=l,a.jsxs("div",{className:"flex flex-row px-2 py-1",children:[a.jsx("h3",{className:"text text-sm font-semibold",children:"selected Items to insert"}),a.jsx("div",{className:"ml-auto"}),d]})),children:c})})]})}function Sa({id:e,element:t="div",children:n,style:s,...o}){const{attributes:r,listeners:i,setNodeRef:c,transform:l,transition:d}=Dn({id:e}),p={transform:On.Transform.toString(l),transition:d,...s};return a.jsxs(t,{ref:c,className:"flex flex-row bg-base-200 rounded border pl-1",style:p,...o,children:[a.jsx("button",{...i,...r,className:"btn btn-ghost btn-xs my-auto inline-block",children:a.jsx(R,{icon:Gt.faGripVertical})}),n]})}function va({memberToId:e,member:t,onDragEnd:n,onDragStart:s,children:o}){const r=Fn(Nt(Xn),Nt(qn,{coordinateGetter:Vn})),[i,c]=m.useState(),l=m.useMemo(()=>t.map(f=>({id:e(f),member:f})),[t,e]);function d(f){var b;const{active:x}=f;console.debug("drag memeber start:",x);const y=(b=l.find(h=>h.id===x.id))==null?void 0:b.member;if(!y)throw new Error(`in Drag list got invalid active object ${JSON.stringify(x)}`);c(y),s(y)}function p(f){const{active:x,over:y}=f;if(console.debug("drag memeber end:",x,y),y&&x.id!==y.id){const b=l.findIndex(w=>w.id===x.id),h=l.findIndex(w=>w.id===y.id);n(Kn(l,b,h).map(w=>w.member))}c(void 0)}const u=m.useCallback(({id:f,member:x,index:y})=>a.jsx(Sa,{id:f,children:o({member:x,index:y})},f),[o]);return a.jsxs(Bn,{sensors:r,collisionDetection:Hn,onDragStart:d,onDragEnd:p,children:[a.jsx(Wn,{items:l,strategy:$n,children:l.map((f,x)=>u({id:f.id,member:f.member,index:x}))}),a.jsx(Un,{children:i?a.jsxs("div",{className:"flex bg-base-200 rounded-sm pl-1",children:[a.jsx("button",{className:"btn btn-ghost btn-xs my-auto",children:a.jsx(R,{icon:Gt.faGripVertical})}),o({member:i,isDragOverlay:!0,index:-1})]}):null})]})}function Na({member:e,isDragOverlay:t,slot:n,index:s,children:o}){return a.jsx(a.Fragment,{children:o({member:e,children:n({m:e}),overlay:t,index:s})})}function Cn({member:e,memberToId:t,children:n,slotSelection:s,...o}){const r=m.useCallback(({member:i,memberToId:c,slot:l})=>a.jsx(va,{...o,member:i,memberToId:c,children:d=>a.jsx(Na,{...d,slot:l,children:n})}),[n,o]);return a.jsx(En,{member:e,memberToId:t,slotSelection:s,children:r})}function Me({onDelete:e,member:t,memberToId:n,...s}){const o=S(x=>x.loadFeatureBatch),r=Z(x=>x.osmAPI.BASEURL),[i,c]=m.useState(!1),l=m.useRef(1),d=m.useCallback(()=>l.current++,[l]),p=m.useMemo(()=>t.map(x=>({...x,uniqueIdentifier:d()})),[d,t]),u=m.useCallback(x=>`${n(x)}_AT_LIST_${x.uniqueIdentifier}`,[n]),f=m.useCallback(({selected:x,children:y})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:b=>{b.stopPropagation();const h=p.filter(w=>!x.has(u(w)));e(p,h)},children:a.jsx(R,{icon:Yt.faDeleteLeft})}),a.jsx("button",{className:"btn btn-square btn-xs btn-accent tooltip tooltip-bottom","data-tip":"Download selected member of this list",disabled:i,onMouseDown:async b=>{b.stopPropagation(),c(!0),await o(p.filter(h=>x.has(u(h))).map(h=>h["@_type"]?{type:h["@_type"],id:h["@_ref"]}:{type:"node",id:h["@_ref"]}),r),c(!1)},children:i?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx(R,{icon:uo.faDownload})}),y]}),[r,o,p,u,e,i,c]);return a.jsx(Cn,{...s,member:p,memberToId:u,slotSelection:f})}function ka({id:e}){const t=S(q(b=>b.meta.way[e])),n=S(b=>b.modifyFeatureMetaNC),s=S(b=>b.commit),[o,r]=m.useState(void 0),i=m.useCallback(({member:b,children:h})=>a.jsx(ie,{id:b["@_ref"],type:"node",children:()=>{const w=(o==null?void 0:o.id)===b["@_ref"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Q("btn btn-square btn-xs tooltip tooltip-bottom",w&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:g=>{g.stopPropagation(),r(w?void 0:{id:b["@_ref"],type:"node"})},children:a.jsx(R,{icon:w?mo.faCircle:ft.faCircle})}),h]})}}),[o==null?void 0:o.id]),c=m.useCallback(b=>`nd-${b["@_ref"]}`,[]);if(!t)return null;function l(){s()}function d(b){n("way",e,h=>{h.nd=b})}function p(b){n("way",e,h=>{h.nd=b})}const u=b=>b.filter(h=>h.type==="node").map(h=>({"@_ref":h.id})),f=b=>{console.log("Insert at Top: ",b),s(),n("way",e,h=>{h.nd=[...u(b),...F(t.nd)]})},x=b=>{console.log("Insert at Bottom: ",b),s(),n("way",e,h=>{h.nd=[...F(t.nd),...u(b)]})},y=b=>{if(console.log("Insert at Active: ",b),!o)x(b);else{const h=[...F(t.nd)],w=h.findIndex(g=>g["@_ref"]===o.id);h.splice(w+1,0,...u(b)),s(),n("way",e,g=>{g.nd=h})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Way] ",ee(t.tag)||t["@_id"]]}),a.jsx(_t,{id:e,type:"way"}),a.jsx(wt,{meta:t}),a.jsx(ke,{tags:F(t.tag),setTags:b=>{n("way",e,h=>h.tag=b)},commitChange:s}),a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Me,{member:t.nd,memberToId:c,onDragStart:l,onDragEnd:d,onDelete:(b,h)=>p(h),children:i})}),a.jsx("div",{className:"",children:a.jsx(jt,{handelInsertTop:f,handelIntertBottom:x,handelInsertAtActive:y})})]}),a.jsx(Mn,{id:e,type:"way"})]})}const St=m.memo(({initialValue:e,onCommit:t})=>{const[n,s]=m.useState(e||"");return m.useEffect(()=>{s(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:n,onChange:o=>s(o.target.value),onKeyDown:o=>{o.key==="Enter"&&o.currentTarget.blur(),o.stopPropagation()},onBlur:()=>{t(n)}})});function Ft(e,t){return e["@_ref"]===t["@_ref"]}function Rn({member:e,index:t}){var l,d;const n=S(p=>p.meta.way),s=n[e[t]["@_ref"]],o=n[(l=e[t-1])==null?void 0:l["@_ref"]]||void 0,r=n[(d=e[t+1])==null?void 0:d["@_ref"]]||void 0,i=o&&s&&Ft(o.nd[o.nd.length-1],s.nd[0]),c=r&&s&&Ft(s.nd[s.nd.length-1],r.nd[0]);return i&&c?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to both sides",children:a.jsx(R,{icon:po.faArrowsUpDown})}):i?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to previous way",children:a.jsx(R,{icon:fo.faArrowUp})}):c?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to next way",children:a.jsx(R,{icon:ho.faArrowDown})}):a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Not connected to any way, or not downloaded",children:a.jsx(R,{icon:Kt.faMinus})})}function Ma({id:e}){const t=S(q(h=>h.meta.relation[e])),n=S(h=>h.modifyFeatureMetaNC),s=S(h=>h.commit),[o,r]=m.useState(void 0),i=m.useCallback((h,w,g)=>{console.debug("edit",h,w,g),s(),n("relation",e,_=>{_.member=F(t.member).map(j=>{if(j["@_type"]===h&&j["@_ref"]===w){const M=pe(j);return M["@_role"]=g,M}return j})})},[s,e,t.member,n]),c=m.useCallback(h=>`${h["@_type"]}-${h["@_ref"]}`,[]),l=m.useCallback(({member:h,children:w,overlay:g,index:_})=>a.jsx(ie,{id:h["@_ref"],type:h["@_type"],children:()=>{const j=(o==null?void 0:o.id)===h["@_ref"]&&o.type===h["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Q("btn btn-square btn-xs tooltip tooltip-bottom",j&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:M=>{M.stopPropagation(),r(j?void 0:{id:h["@_ref"],type:h["@_type"]})},children:a.jsx(R,{icon:j?Zt:ft.faCircle})}),a.jsx("div",{className:"w-3",children:!g&&h["@_type"]==="way"&&a.jsx(Rn,{member:t.member,index:_})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(St,{initialValue:h["@_role"],onCommit:M=>i(h["@_type"],h["@_ref"],M)})]}),w]})}}),[i,o,t.member]);if(!t)return null;function d(){s()}function p(h){n("relation",e,w=>{w.member=h})}function u(h){s(),n("relation",e,w=>{w.member=h})}const f=h=>h.map(w=>({"@_ref":w.id,"@_type":w.type})),x=h=>{console.log("Insert at Top: ",h),s(),n("relation",e,w=>{w.member=[...f(h),...F(w.member)]})},y=h=>{console.log("Insert at Bottom: ",h),s(),n("relation",e,w=>{w.member=[...F(w.member),...f(h)]})},b=h=>{if(console.log("Insert at Active: ",h),!o)y(h);else{const w=[...F(t.member)],g=w.findIndex(_=>_["@_ref"]===o.id&&_["@_type"]===o.type);w.splice(g+1,0,...f(h)),s(),n("relation",e,_=>{_.member=w})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Relation] ",ee(t.tag)||t["@_id"]]}),a.jsx(_t,{id:e,type:"relation"}),a.jsx(wt,{meta:t}),a.jsx(ke,{tags:F(t.tag),setTags:h=>{n("relation",e,w=>w.tag=h)},commitChange:s}),a.jsxs("div",{className:"flex flex-row relative",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Me,{member:t.member,memberToId:c,onDragStart:d,onDragEnd:p,onDelete:(h,w)=>u(w),children:l})}),a.jsx("div",{className:"",children:a.jsx(jt,{handelInsertTop:x,handelIntertBottom:y,handelInsertAtActive:b})})]})]})}function Tn({width:e,height:t}){const n=S(s=>s.activeRef);return a.jsx("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"property-view flex flex-col rounded bg-base-100",children:n?n.type==="node"?a.jsx(_a,{id:n.id}):n.type==="way"?a.jsx(ka,{id:n.id}):n.type==="relation"?a.jsx(Ma,{id:n.id}):a.jsxs("div",{children:["Unknown type for item ",JSON.stringify(n)]}):a.jsx("div",{children:"Please active some component to show prop edit view"})})}function Ea(){const e=G.useApp(),t=X(n=>n.setStageApp);return m.useEffect(()=>(globalThis.__PIXI_APP__=e,e.stage.hitArea=e.screen,t(e),()=>{globalThis.__PIXI_APP__=void 0,t(void 0)}),[e,t]),null}function Ee({width:e,height:t,children:n,...s}){const o=X(r=>r.setStage);return m.useEffect(()=>{o(e,t)},[e,t,o]),a.jsxs(G.Stage,{width:e,height:t,options:{background:"#1099bb"},...s,children:[n,a.jsx(Ea,{})]})}function Ce({width:e}){return a.jsx("div",{className:"slot-bottom absolute inset-x-0 bottom-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx("span",{className:"text-base-content bg-base-300 px-2 rounded",children:"data©openstreetmap contributor"})})}function Ca({width:e,height:t}){const n=m.useRef(new Xo({meta:S,view:X,settings:Z}));return m.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(Ee,{width:e,height:t,options:{background:"#1099bb"},onContextMenu:s=>s.preventDefault(),onMouseDown:s=>{n.current.transform(s)},onPointerMove:s=>{n.current.transform(s)},onMouseUp:s=>{n.current.transform(s)},onWheel:s=>{n.current.transform(s)},children:[a.jsx(Se,{width:e,height:t}),a.jsx(ve,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Ce,{width:e}),a.jsx("div",{className:"slot-top absolute inset-x-0 top-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx(Js,{stateMachine:n.current})})]})}function Ra({width:e,height:t}){return a.jsxs(Ke,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(Ca,{...n}),n=>a.jsxs(Ke,{...n,axis:"y",children:[s=>a.jsx(kn,{...s}),s=>a.jsx(Tn,{...s})]})]})}function Ta({open:e,onClose:t}){const{updateSettingsAction:n,...s}=Z(),[o,r]=m.useState(s),i=S(l=>l.reset),c=()=>{n(o),t()};return a.jsx("div",{className:Q("modal",e&&"modal-open"),children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:o.osmAPI.BASEURL,onChange:l=>r({...o,osmAPI:{...o.osmAPI,BASEURL:l.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:o.osmAPI.TILE_SOURCE,onChange:l=>r({...o,osmAPI:{...o.osmAPI,TILE_SOURCE:l.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:o.view.MAX_ZOOM,onChange:l=>r({...o,view:{...o.view,MAX_ZOOM:parseFloat(l.target.value)}}),className:"input input-bordered w-full"})]}),a.jsx("button",{className:"btn btn-error mt-4",onClick:i,children:"Reast All Data (All data will lost)"}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn btn-ghost",onClick:t,children:"Cancel"}),a.jsx("button",{className:"btn",onClick:c,children:"Save"})]})]})})}function Aa(){const[e,t]=S(q(s=>[s.autoload,s.setAutoloadNC])),n=m.useCallback(()=>t(()=>!e),[e,t]);return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Auto load OSM data on drag: "+(e?"Enabled":"Disabled"),children:a.jsx("a",{onClick:n,className:Q(e&&"active"),children:a.jsx(R,{icon:xo.faA})})})}function Pa(){const{viewpoint:e,zoom:t,height:n,width:s}=X(),o=S(q(d=>d.loadbbox)),r=Z(d=>d.osmAPI.BASEURL),[i,c]=m.useState(!1),l=m.useCallback(async()=>{i||(c(!0),await o({width:s,height:n,zoom:t,viewpoint:e},r),c(!1))},[r,n,o,e,s,t,i,c]);return a.jsx("li",{className:Q("tooltip tooltip-left",i&&"disabled"),"data-tip":"Load OSM data on current screen",children:a.jsx("a",{onClick:l,children:i?a.jsx("span",{className:"loading loading-spinner loading-xs h-[14px]"}):a.jsx(R,{icon:bo.faDownLong})})})}function Ia(){return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Export with JSOM format",children:a.jsx("a",{onClick:()=>{const{meta:e,deletedMeta:t,bbox:n}=S.getState(),s=_n(e,t,n),o=new Blob([s],{type:"application/xml"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download="exported_data.osm",r.click(),URL.revokeObjectURL(r.href)},children:a.jsx(R,{icon:go.faFileExport})})})}function La(){const[e,t]=m.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Change settings",onClick:()=>t(!0),children:a.jsx("a",{children:a.jsx(R,{icon:yo.faGear})})}),a.jsx(Ta,{open:e,onClose:()=>t(!1)})]})}function Da(){return a.jsxs("ul",{className:"menu menu-horizontal",children:[a.jsx(Aa,{}),a.jsx(Pa,{}),a.jsx(Ia,{}),a.jsx(La,{})]})}function Oa({height:e,leftSlot:t}){return a.jsxs("nav",{className:"navbar p-0 bg-base-100 overflow-hidden border-b-2 border-b-base-300",style:{height:e,maxHeight:e,minHeight:e},children:[a.jsx("div",{className:"flex-1",children:t}),a.jsx("div",{className:"flex-none",children:a.jsx(Da,{})})]})}class An extends J{constructor(n,s){super(n);C(this,"idle");C(this,"mousedown");C(this,"draging");this.idle=new H("select-idle"),this.mousedown=new H("select-mousedown"),this.draging=new H("select-dragging"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mousedown,{transform:o=>{const r=this.context,i=o;return o.type==="mousedown"&&o.shiftKey?(console.debug("BatchSelectStateMachine: transition from idle to mousedown"),r.from=le(i.clientX,i.clientY,r),!0):!1}}),this.mousedown.appendNext(this.idle,{transform:o=>{const r=this.context;return["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)?(console.debug("BatchSelectStateMachine: transition from mousedown to idle"),r.from=void 0,!0):!1}}),this.mousedown.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: start dragging");const{clientX:i,clientY:c}=o;return X.getState().setSelectionRect({from:r.from,to:le(i,c,r)}),!0}return!1}}),this.draging.appendNext(this.idle,{transform:o=>{if(["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)){if(console.debug("BatchSelectStateMachine: drag canceled, back to idle"),X.getState().setSelectionRect(),s!=null&&s.onSelectRect){const{clientX:r,clientY:i}=o;s.onSelectRect({from:this.context.from,to:le(r,i,this.context)},o)}return this.context.from=void 0,!0}return!1}}),this.draging.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: continue dragging");const{clientX:i,clientY:c}=o;return X.getState().setSelectionRect({from:r.from,to:le(i,c,r)}),!0}return!1}})}}class et extends J{constructor(n,{onRightClick:s,onLeftClick:o,onHoverExit:r,onHoverStart:i,hoverable:c,clickable:l,dragable:d,selectable:p}){super(n);C(this,"idle");C(this,"componentHover");C(this,"componentMousedown");C(this,"pointDrag");this.idle=new H("pt-bus-component-idle"),this.componentHover=new H("pt-bus-component-hover"),this.componentMousedown=new H("pt-bus-component-mousedown"),this.pointDrag=new H("pt-bus-component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:u=>{const f=this.context;if(["pointerover","pointerenter"].includes(u.type)&&"componentTarget"in u&&u.componentTarget&&c(u.componentTarget,this.context)){f.componentTarget=u.componentTarget;const{id:x,type:y}=f.componentTarget;console.log("BusComponentStateMachine: component hover triggered",y,x);const{modifyFeatureStateNC:b}=f.store.meta.getState();return b(y,x,h=>h.hovered=!0),i&&i(f.componentTarget,u),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:u=>{const f=this.context;if(u.type==="mousedown"&&f.componentTarget&&l(f.componentTarget,f)){console.log("BusComponentStateMachine: transition to "+this.componentMousedown.name);const{id:x,type:y}=f.componentTarget,{modifyFeatureStateNC:b}=f.store.meta.getState();return b(y,x,h=>h.hovered=!1),r&&r(f.componentTarget,u),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:u=>{const f=this.context;if(["pointerleave","pointerout"].includes(u.type)&&f.componentTarget){console.log("BusComponentStateMachine: transition to idle");const{id:x,type:y}=f.componentTarget,{modifyFeatureStateNC:b}=f.store.meta.getState();return b(y,x,h=>h.hovered=!1),r&&r(f.componentTarget,u),f.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:u=>{var x;const f=this.context;if(u.type==="pointermove"&&((x=f.componentTarget)==null?void 0:x.type)==="node"&&d(f.componentTarget,f)){console.log("BusComponentStateMachine: start dragging");const{clientX:y,clientY:b}=u,{commit:h}=f.store.meta.getState();return h(),Ue(y,b,f),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:u=>{const f=this.context;if((u.type==="mouseup"||u.type==="mouseupoutside")&&f.componentTarget){if(u.button===_e.RIGHT&&s?s(f.componentTarget,u):u.button===_e.LEFT&&o&&o(f.componentTarget,u),p(f.componentTarget,f)){const{selectFeature:x}=f.store.meta.getState(),{id:y,type:b}=f.componentTarget;if(typeof y=="string")x(b,y,!u.shiftKey),console.log("selected id",y,f.store.meta.getState().selectFeature);else throw new Error(`id ${y} is invalid for component`)}return f.componentTarget=void 0,!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:u=>u.type==="mouseupoutside"||u.type==="mouseup"?(console.log("BusComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:u=>{if(u.type==="pointermove"){const{clientX:f,clientY:x}=u;return Ue(f,x,this.context),!0}return!1}})}}class Fa extends J{constructor(n,s){super(n);C(this,"idle");C(this,"mapViewSubMachine");C(this,"busStopEditSubMachine");C(this,"undoRedo");C(this,"batchSelect");C(this,"menus");this.menus=s;const o=l=>l.type==="way"||l.type==="node",r=l=>l.type==="way"||l.type==="node",i=(l,d)=>{const p=d.store.meta.getState().meta[l.type][l.id].tag||[];return l.type==="node"&&(Ze(p)||gt(p))},c=l=>l.type==="node";this.idle=new H("pt-edit-idle"),this.mapViewSubMachine=new je(n,{rightClickHandeler:l=>{this.menus.busStop({...le(l.clientX,l.clientY,this.context),open:!0}),this.menus.stopPosition({x:0,y:0,open:!1})}}),this.busStopEditSubMachine=new et(n,{onRightClick:(l,d)=>{this.menus.stopPosition({...le(d.clientX,d.clientY,this.context),feature:l,open:!0})},hoverable:o,clickable:r,dragable:i,selectable:c}),this.undoRedo=new ce(n),this.batchSelect=new An(n,{onSelectRect:(l,d)=>{const{viewpoint:p,zoom:u,width:f,height:x}=this.context.store.view.getState(),y=dn(p,u,f,x,l),b=this.context.store.meta.getState(),h=Nn(y)(b);console.debug("get feature group ",h),d.ctrlKey||b.clearSelect(),Object.entries(h.node).filter(([,w])=>c({id:w["@_id"],type:"node"},this.context)).forEach(([,w])=>b.selectFeature("node",w["@_id"],!1))}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}transform(n){n.type==="mousedown"&&(this.menus.busStop({x:0,y:0,open:!1}),this.menus.stopPosition({x:0,y:0,open:!1})),super.transform(n)}}function Ba({type:e,id:t,showMetaType:n,children:s}){const o=S(q(i=>i.meta[e][t])),r=m.useMemo(()=>{var i;if(n&&((i=o==null?void 0:o.tag)!=null&&i.length)){if(e==="node")return Je(o.tag);if(e==="relation")return Qe(o.tag)}},[n,o==null?void 0:o.tag,e]);return a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsx(ue,{featuretype:e,id:t,metatype:r,fullname:ee(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:s&&s({type:e,id:t})})})}function Ha({onDelete:e,member:t,memberToId:n,...s}){const o=m.useRef(1),r=m.useCallback(()=>o.current++,[o]),i=m.useMemo(()=>t.map(d=>({...d,uniqueIdentifier:r()})),[r,t]),c=m.useCallback(d=>`${n(d)}_AT_LIST_${d.uniqueIdentifier}`,[n]),l=m.useCallback(({selected:d,children:p})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:u=>{u.stopPropagation();const f=i.filter(x=>!d.has(c(x)));e(i,f)},children:a.jsx(R,{icon:Yt.faDeleteLeft})}),p]}),[i,c,e]);return a.jsx(Cn,{...s,member:i,memberToId:c,slotSelection:l})}const Wa=m.memo(({initialValue:e,onCommit:t,onFocus:n,onBlur:s})=>{const[o,r]=m.useState(e||"");return m.useEffect(()=>{r(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:o,onChange:i=>r(i.target.value),onKeyDown:i=>{i.key==="Enter"&&i.currentTarget.blur()},onBlur:i=>{s&&s(i),t(o)},onFocus:n})});function $a({preset:e,existing:t,title:n,onSubmit:s,open:o,onClose:r,createMembers:i}){const[c,l]=m.useState({});m.useEffect(()=>{l(()=>e.tag.reduce((v,A)=>(t!=null&&t.some(O=>A["@_k"]===O["@_k"])||(v[A["@_k"]]=A["@_v"]||""),v),{}))},[t,e]);const d=m.useMemo(()=>e.tag.filter(v=>!(t!=null&&t.some(A=>v["@_k"]===A["@_k"]))),[e,t]),[p,u]=m.useState((t==null?void 0:t.map(v=>({key:v["@_k"],value:v["@_v"]})))||[]),[f,x]=m.useState("");m.useEffect(()=>{const v=document.getElementById("create-node-modal");o?v==null||v.showModal():v==null||v.close()},[o]);const y=(v,A)=>{l(O=>({...O,[v]:A}))},b=m.useCallback(()=>{f.trim()!==""&&(u(v=>[...v,{key:f.trim(),value:""}]),x(""))},[f]),h=(v,A)=>{u(O=>O.map((W,V)=>V===v?{...W,value:A}:W))},w=v=>{u(A=>A.filter((O,W)=>W!==v))},g=m.useMemo(()=>a.jsxs(a.Fragment,{children:[t&&a.jsx("div",{className:"divider",children:"Needed preset tags"}),d.map(v=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1 tooltip tooltip-top","data-tip":v.description||"",children:[a.jsxs("span",{className:"font-semibold",children:[v["@_k"]," ",v.importance==="required"&&a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:v.example||"Enter value",value:c[v["@_k"]],onChange:A=>y(v["@_k"],A.target.value),required:v.importance==="required",disabled:v.importance==="not-recommened",className:"grow"}),a.jsx("span",{className:"badge",children:v.importance})]},v["@_k"])),a.jsx("div",{className:"divider",children:t?"Exsisting or created tags":"Created tags"}),p.map((v,A)=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1",children:[a.jsxs("span",{className:"font-semibold",children:[v.key," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:"Enter value",value:v.value,onChange:O=>h(A,O.target.value),required:!0,className:"grow"}),!t&&a.jsx("span",{className:"badge",children:"created"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-error",onClick:()=>w(A),children:a.jsx(R,{icon:Ut})})]},v.key)),a.jsxs("label",{className:"input input-sm input-bordered flex items-center gap-2",children:[a.jsx("input",{type:"text",placeholder:"New tag key",value:f,onChange:v=>x(v.target.value),onKeyDown:v=>{v.key==="Enter"&&(v.preventDefault(),b())},className:"grow"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-outline",onClick:b,children:"+ add tag"})]})]}),[b,t,d,f,p,c]),[_,j]=m.useState([]),[M,I]=m.useState(void 0),k=m.useCallback((v,A,O)=>{console.log("edit",v,A,O),j(W=>W.map(V=>{if(V["@_type"]===v&&V["@_ref"]===A){const re=pe(V);return re["@_role"]=O,re}return V}))},[]),E=m.useCallback(v=>`${v["@_type"]}-${v["@_ref"]}`,[]),$=m.useCallback(({member:v,children:A})=>a.jsx(Ba,{id:v["@_ref"],type:v["@_type"],children:()=>{const O=(M==null?void 0:M.id)===v["@_ref"]&&M.type===v["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Q("btn btn-square btn-xs tooltip tooltip-bottom",O&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:W=>{W.stopPropagation(),I(O?void 0:{id:v["@_ref"],type:v["@_type"]})},children:a.jsx(R,{icon:O?Zt:ft.faCircle})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(Wa,{initialValue:v["@_role"],onCommit:W=>k(v["@_type"],v["@_ref"],W)})]}),A]})}}),[k,M]);function L(){}function N(v){j(()=>v)}function T(v){j(()=>v)}const P=v=>v.map(A=>({"@_ref":A.id,"@_type":A.type})),D=m.useCallback(v=>{console.log("Insert at Top: ",v),j(A=>[...P(v),...A])},[]),K=m.useCallback(v=>{console.log("Insert at Bottom: ",v),j(A=>[...A,...P(v)])},[]),z=m.useCallback(v=>{console.log("Insert at Active: ",v),M?j(A=>{const O=[...A],W=O.findIndex(V=>V["@_ref"]===M.id&&V["@_type"]===M.type);return O.splice(W+1,0,...P(v)),O}):K(v)},[K,M]),oe=m.useMemo(()=>i?a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Ha,{member:_,memberToId:E,onDragStart:L,onDragEnd:N,onDelete:(v,A)=>T(A),children:$})}),a.jsx("div",{className:"",children:a.jsx(jt,{handelInsertTop:D,handelIntertBottom:K,handelInsertAtActive:z})})]}):null,[i,z,K,D,_,$,E]),B=v=>{v.preventDefault();const A=Object.entries(c).filter(([,W])=>W.length).map(([W,V])=>({"@_k":W,"@_v":V})),O=p.map(W=>({"@_k":W.key,"@_v":W.value}));s({tag:[...A,...O],member:_}),u([]),x(""),r()};return a.jsx(a.Fragment,{children:a.jsxs("dialog",{id:"create-node-modal",className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box w-11/12 max-w-5xl",children:[a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsxs("form",{onSubmit:B,className:"space-y-2",children:[g,oe,a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn",onClick:()=>r(),children:"Cancel"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Submit"})]})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})})}function Ua({show:e,proceed:t,...n}){return a.jsx($a,{open:e,...n,onClose:()=>t(null),onSubmit:t})}const Va=e=>a.jsx(Ua,{...e}),Re=me.confirmable(Va);Re.displayName="CreateFeatureTagConform";const qa={tag:[{"@_k":"highway","@_v":"bus_stop",importance:"required",description:"将该处定义为公交站点。最常用的标签。",example:"bus_stop"},{"@_k":"public_transport","@_v":"platform",importance:"required",description:"用于描述该功能是一个公共交通月台，服务于公共交通路线。用于符合ptv2的标签。",example:"platform"},{"@_k":"name",importance:"required",description:"公交站点的名称。",example:"海口路海游路"},{"@_k":"name:zh",importance:"recommened",description:"公交站点的名称。(中文)",example:"海口路海游路"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点。",example:"yes"},{"@_k":"ref",importance:"optional",description:"公交站点的参考代码。（常用于内部定位和维护）",example:"ref=3154"},{"@_k":"local_ref",importance:"recommened",description:"公交站点的参考代码。如果公交站台有大量公交车停靠，每个小站点可有独立 local_ref。",example:"16"},{"@_k":"network",importance:"not-recommened",description:"公交站点的网络。可使用全称或缩写，依据附近线路标注情况确定。",example:"古田公交"},{"@_k":"operator",importance:"not-recommened",description:"在公交站点停靠的公交车的运营公司名称。若多家运营，使用分号（;）分隔。",example:"济阳舜达公共交通有限公司"},{"@_k":"shelter",importance:"recommened",description:"若公交站点提供候车亭则为“yes”，否则为“no”。",example:"no"},{"@_k":"departures_board",importance:"recommened",description:"表明公交站点使用的到站显示屏/牌类型。值可为纸质时刻表、实时显示等；departures_board=no 表示无显示屏/牌。",example:"timetable"},{"@_k":"bench",importance:"recommened",description:"若公交站点提供长凳则为“yes”，否则为“no”。",example:"yes"},{"@_k":"bin",importance:"recommened",description:"若公交站点具备垃圾箱则为“yes”，否则为“no”。",example:"no"},{"@_k":"tactile_paving",importance:"recommened",description:"若公交站点设有视障引导设施（提示视障人士月台边缘）则为“yes”，否则为“no”。",example:"no"},{"@_k":"layer",importance:"optional",description:"适用于多层公交站台。对于非地面公交站点，多层信息是必需的以避免疑问。",example:"-1"},{"@_k":"lit",importance:"recommened",description:"若公交站点夜间亮灯则为“yes”，否则为“no”。",example:"yes"},{"@_k":"surface",importance:"recommened",description:"描述公交车站所在的地面。",example:"concrete"}]},Bt={tag:[{"@_k":"public_transport","@_v":"stop_position",importance:"required",description:"用于描述该功能是一个公共交通停车点。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"公交站点的名称。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"name:zh",importance:"recommened",description:"公交站点的名称(中文)。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点",example:"yes"}]},Xa={tag:[{"@_k":"public_transport","@_v":"stop_area",importance:"required",description:"用于描述该功能是一个停车区关系。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"该站组的名称，使用主名称或推广名称，即指向同一位置的同名分站台合并于此关系中",example:"经十路舜耕路"},{"@_k":"name:zh",importance:"recommened",description:"该站组的名称(中文)，使用主名称或推广名称，即指向同一位置的同名分站台合并于此关系中",example:"经十路舜耕路"},{"@_k":"type",importance:"required",description:"","@_v":"public_transport"}]},Ka={tag:[{"@_k":"type","@_v":"route",importance:"required",description:"将该关系定义为一条线路。",example:"route"},{"@_k":"route",importance:"required",description:"将该关系线路设为一条公交/有轨电车线路。(bus/trolleybus)",example:"bus"},{"@_k":"ref","@_v":"*",importance:"required",description:"线路编号，建议使用电显、站牌或公交官网给出的名称；建议在同一城市内，区县公交在前缀中体现区县名称，如：章丘4（未注明）、番1（已注明",example:"番1"},{"@_k":"public_transport:version","@_v":"2",importance:"recommened",description:"此标签对 OSM 交通数据的用户十分有用，此标签可以让用户知道线路是根据新系统 PTv2 添加。此标签可使分析和验证更加容易。",example:"2"},{"@_k":"operator",importance:"recommened",description:"营运该线路公交公司或车队的名称。请使用规范的企业名称；若多家公司共同运营，请在两家公司之间加上“;”。",example:"上海松江公共交通有限公司"},{"@_k":"network",importance:"required",description:"该线路所属的网络，使用该网络关系相同的名称",example:"黔江公交"},{"@_k":"opening_hours",importance:"recommened",description:"公交路线的运营时间，包含首班车和末班车发车时间，登记应使用英文两字母式星期标记，并采用24小时制。",example:"Jan 1-May 31 06:00-21:45; Jun 1-Oct 7 06:00-22:15; Oct 8-Dec 31 06:00-21:45"},{"@_k":"interval",importance:"recommened",description:"公交车途径任意站点到达时的间隔时间，也称为发车间隔。格式可为 HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM 或 M。",example:"00:06:30"},{"@_k":"duration",importance:"recommened",description:"公交线路的持续时间，从发车到抵达终点。格式为 HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM 或 M。",example:"00:31"},{"@_k":"fee",importance:"recommened",description:"如果乘坐该公交需支付费用则为“yes”，选填 charge 说明乘车费用；若无需支付费用则为“no”。",example:"yes+charge=3.00 CNY"},{"@_k":"payment",importance:"recommened",description:"详细列表请见：支付方式，常用的有 payment:cash, payment:coins, payment:ic, payment:unionpay, payment:city_union, payment:china_t-union, payment:e-cny, payment:alipay, payment:wechat, payment:mipay, payment:samsung_pay, payment:huawei_pay, payment:apple_pay。",example:""},{"@_k":"bicycle",importance:"recommened",description:"如果该公交允许携带自行车乘车则为“yes”。",example:"yes"},{"@_k":"wheelchair",importance:"recommened",description:"如果允许使用轮椅的乘客或携带轮椅的乘客上车，请标记为 'yes'；否则标记为 'no'。",example:"yes"},{"@_k":"from",importance:"required",description:"公交车发车方向的位置名称，不一定是公交车站的名称。",example:"通常汽渡"},{"@_k":"via",importance:"optional",description:"在双向环线或起终点名称相同的线路中注明中间站点。",example:"涞寅路绿庭尚城"},{"@_k":"to",importance:"required",description:"公交线路目的地的名称，通常显示在公交车顶部作为终到站。",example:"北官厅"},{"@_k":"name",importance:"required",description:"建议使用格式：<前缀><编号>路: <起点站> => <终点站>，详情参考相关标准。",example:"K37路: 解放桥东 -> 铁厂北路公交车场"},{"@_k":"name:zh",importance:"recommened",description:"建议使用格式：<前缀><编号>路: <起点站> => <终点站>，详情参考相关标准。",example:"K37路: 解放桥东 -> 铁厂北路公交车场"},{"@_k":"official_name",importance:"optional",description:"用于描述官方地图上所用公交路线的名称。大多数线路仅供参考，因此请勿使用此标记。",example:"虹桥枢纽10路区间"},{"@_k":"colour",importance:"optional",description:"官方地图上公交线路的颜色，使用十六进制或 HTML 颜色代码。",example:"#58912F"},{"@_k":"roundtrip",importance:"optional",description:"指定关系是否为环路。对于大多数线路，该值为 'no'.",example:"no"},{"@_k":"description",importance:"optional",description:"其他关于该线路的未尽事宜，可以在此用中文表述，如：春节期间线路有变动、本地公交卡7折优惠",example:"济南公交刷卡标准折扣"}]},za={tag:[{"@_k":"type","@_v":"route_master",importance:"required",description:"将该关系定义为路线主关系",example:"route_master"},{"@_k":"route_master","@_v":"bus",importance:"required",description:"将该线路主关系为一条公交线路主关系",example:"bus"},{"@_k":"ref",importance:"required",description:"线路代码（若无官方代码请使用official_name标签）",example:"金青线"},{"@_k":"name",importance:"required",description:"路线名称，格式：<所在路网><编号>路（例：济南公交K10路支线）",example:"大足公交204路"},{"@_k":"network",importance:"required",description:"所属运输网络名称（需与网络关系一致）",example:"北京公交"},{"@_k":"operator",importance:"recommended",description:"运营公司名称（多家公司用分号分隔）",example:"上海众兴汽车旅游客运有限公司"},{"@_k":"wheelchair",importance:"optional",description:"是否允许轮椅上车（yes/no）",example:"yes"},{"@_k":"bicycle",importance:"optional",description:"是否允许携带自行车（yes/no）",example:"yes"},{"@_k":"official_name",importance:"optional",description:"官方地图显示名称（无正式名称时勿用）",example:"Bull City Connector"},{"@_k":"ref:OPT",importance:"conditional",description:"运营商特定参考号（根据实际情况添加）",example:"OCH"}]};function vt({x:e,y:t,open:n,children:s}){return n?a.jsx("ul",{className:"absolute rounded-lg bg-base-100 menu shadow p-0",onMouseDown:o=>o.stopPropagation(),style:{top:t,left:e},children:m.Children.map(s,(o,r)=>m.isValidElement(o)?o.type==="a"?a.jsx("li",{children:o},r):a.jsx("li",{children:a.jsx("a",{children:o})},r):null)}):null}const Ga=m.memo(function(e){const t=X(q(xt(e))),n=S(c=>c.createBusStopSel),s=S(c=>c.createStopAreaSel),o=me.createConfirmation(Re),r=async()=>{e.onClose();const c=await o({title:"Create Bus stop (Preset CN)",preset:qa});c!=null&&c.tag&&(console.debug("created bus stop",c),t&&n(t,c.tag))},i=async()=>{e.onClose();const c=await o({title:"Create Stop Area (Preset CN)",preset:Xa,createMembers:!0});c!=null&&c.tag&&s(c.tag,c.member)};return a.jsxs(vt,{...e,children:[a.jsx("a",{onClick:r,children:"New bus stop"}),a.jsx("a",{onClick:i,children:"New stop area relation"})]})}),Ya=m.memo(function(e){var c,l;const t=X(q(xt(e))),n=S(d=>d.createStopPositionSel),s=S(d=>d.modifyFeatureMetaNC),o=me.createConfirmation(Re),r=async()=>{var p;e.onClose();const d=await o({preset:Bt,title:"Create Stop position (Preset CN)"});d!=null&&d.tag&&t&&((p=e.feature)!=null&&p.id)&&n(t,d.tag,e.feature.id)},i=async()=>{var p;if(e.onClose(),!((p=e.feature)!=null&&p.id))return;const d=await o({preset:Bt,existing:S.getState().meta.node[e.feature.id].tag,title:"Add tags to existing point (Stop position preset CN)"});d!=null&&d.tag&&s("node",e.feature.id,u=>{u.tag=d.tag})};return a.jsx(vt,{...e,children:((c=e.feature)==null?void 0:c.type)==="way"?a.jsx("a",{onClick:r,children:"New stop position"}):((l=e.feature)==null?void 0:l.type)==="node"?a.jsx("a",{onClick:i,children:"Set point as stop position"}):a.jsx("a",{children:"relation is not allowed here"})})}),Za=({width:e,height:t})=>{const[n,s]=m.useState({x:0,y:0,open:!1}),[o,r]=m.useState({x:0,y:0,open:!1}),i=m.useRef(new Fa({meta:S,view:X,settings:Z},{busStop:s,stopPosition:r})).current;return m.useEffect(()=>{const c=l=>i.transform(l);return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[i]),a.jsxs("div",{className:"relative",style:{width:e,height:t},children:[a.jsxs(Ee,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:c=>i.transform(c),onPointerMove:c=>i.transform(c),onMouseUp:c=>i.transform(c),onWheel:c=>i.transform(c),children:[a.jsx(Se,{width:e,height:t}),a.jsx(ve,{width:e,height:t,stateMachine:i})]}),a.jsx(Ce,{width:e}),a.jsx(Ga,{...n,onClose:()=>s({x:0,y:0,open:!1})}),a.jsx(Ya,{...o,onClose:()=>r({x:0,y:0,open:!1})})]})};class Ja extends J{constructor(n){super(n);C(this,"idle");C(this,"mapViewSubMachine");C(this,"busStopEditSubMachine");C(this,"undoRedo");const s=c=>c.type==="node",o=c=>c.type==="node",r=()=>!1,i=()=>!1;this.idle=new H("pt-edit-idle"),this.mapViewSubMachine=new je(n),this.busStopEditSubMachine=new et(n,{onRightClick:c=>{const{routeEdit:l,setRouteStop:d}=this.context.store.meta.getState(),p=u=>u["@_ref"]===c.id&&u["@_type"]===c.type;l.stops.some(p)?d(l.stops.filter(u=>!p(u))):d([...l.stops,{"@_ref":c.id,"@_type":c.type}])},onLeftClick:(c,l)=>{const{toggleFeature:d}=this.context.store.meta.getState();d(c.type,c.id,!l.shiftKey)},hoverable:s,clickable:o,dragable:r,selectable:i}),this.undoRedo=new ce(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0})}transform(n){super.transform(n)}}class Qa extends J{constructor(n){super(n);C(this,"manualAddPathMode");C(this,"mpView");C(this,"mpComponent");C(this,"mpUndoRedo");this.manualAddPathMode=new H("path-add-manual-mode"),this.entry=this.manualAddPathMode,this.current=this.manualAddPathMode,this.accept=[this.manualAddPathMode];const s=c=>c.type==="way",o=c=>c.type==="way",r=()=>!1,i=()=>!1;this.mpView=new je(n),this.mpComponent=new et(n,{onRightClick:c=>{console.debug(`Add path: right click at ${c}`);const{routeEdit:l,setRoutePath:d}=S.getState(),p=u=>u["@_ref"]===c.id&&u["@_type"]===c.type;l.path.some(p)?d(l.path.filter(u=>!p(u))):d([...l.path,{"@_ref":c.id,"@_type":c.type}])},onLeftClick:c=>{const{toggleFeature:l}=S.getState();l(c.type,c.id,!0)},hoverable:s,clickable:o,dragable:r,selectable:i}),this.mpUndoRedo=new ce(n),this.manualAddPathMode.appendNext(this.mpComponent,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpView,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpUndoRedo,{isEpsilon:!0}),this.mpView.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpComponent.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpUndoRedo.appendNext(this.manualAddPathMode,{isEpsilon:!0})}transform(n){super.transform(n)}}class er extends J{constructor(n,s){super(n);C(this,"idle");C(this,"mapViewSubMachine");C(this,"componentSubMachine");C(this,"undoRedo");C(this,"batchSelect");this.menus=s,this.idle=new H("route-edit-idle");const o=l=>l.type==="way"||l.type==="node",r=l=>l.type==="way"||l.type==="node",i=l=>l.type==="node",c=()=>!1;this.mapViewSubMachine=new je(n),this.componentSubMachine=new et(n,{onRightClick:(l,d)=>{s.wayEditMenu({...le(d.clientX,d.clientY,this.context),open:!0,feature:l})},onLeftClick:(l,d)=>{if(l.type==="node"||l.type==="way"){const{toggleFeature:p}=this.context.store.meta.getState();p(l.type,l.id,!d.shiftKey)}},hoverable:o,clickable:r,dragable:i,selectable:c}),this.undoRedo=new ce(n),this.batchSelect=new An(n,{onSelectRect:(l,d)=>{const{viewpoint:p,zoom:u,width:f,height:x}=this.context.store.view.getState(),y=dn(p,u,f,x,l),b=this.context.store.meta.getState(),h=Nn(y)(b);d.ctrlKey||b.clearSelect(),Object.entries(h.node).forEach(([,w])=>b.selectFeature("node",w["@_id"],!1))}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}transform(n){n.type==="mousedown"&&this.menus.wayEditMenu({x:0,y:0,open:!1}),super.transform(n)}}const Le=72,tr=()=>{const e=S(l=>l.createEditRoute),t=S(l=>l.setEditRoute),n=S(l=>l.cancelEditRoute),s=S(l=>l.routeEdit.editing),o=S(l=>l.meta.relation)||{},r=me.createConfirmation(Re),i=async()=>{const l=await r({title:"Create Bus stop (Preset CN)",preset:Ka});l!=null&&l.tag&&(console.debug("created route",l),e([{"@_k":"type","@_v":"bus_route"}],[]))},c=l=>{t(l)};if(m.useEffect(()=>{const l=new ce({meta:S,view:X,settings:Z}),d=p=>l.transform(p);return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[]),s){const l=o[s],d=ee(l.tag)||"[no name]";return a.jsxs("div",{className:"bg-base-100 max-w-xl h-full mx-auto py-4",children:["Selected Route:",a.jsx("div",{className:"flex flex-row gap-2 text-base items-center",children:a.jsx(ue,{featuretype:"relation",fullname:d,id:l["@_id"],created:Number(l["@_id"])<0,modified:l["@_action"]==="modify",deleted:l["@_action"]==="delete",children:a.jsx("button",{onClick:n,className:"btn btn-error btn-square btn-sm",children:a.jsx(R,{icon:Jt})})})}),"Please jump to step 2"]})}return a.jsx("div",{className:"bg-base-100 max-w-xl h-full mx-auto",children:a.jsxs("div",{className:"card-body",children:[a.jsx("h2",{className:"card-title text-lg mb-4",children:"Create or Select Route"}),a.jsxs("button",{className:"btn btn-primary w-full mb-6",onClick:i,children:["Create New Route",a.jsx(R,{icon:ye,className:"h-5 w-5 ml-2"})]}),a.jsx("div",{className:"divider mb-4",children:"OR"}),a.jsxs("div",{className:"space-y-4",children:[a.jsx("h3",{className:"font-medium text-base",children:"Existing Routes"}),Object.keys(o).length===0?a.jsxs("div",{className:"alert alert-info",children:[a.jsx(R,{icon:wo,className:"stroke-current shrink-0 h-6 w-6"}),a.jsx("span",{children:"No routes available"})]}):a.jsx("div",{className:"h-full overflow-y-auto",children:Object.values(o).filter(l=>yt(l.tag)).map(l=>{const d=ee(l.tag)||"[no name]";return a.jsx("div",{className:"flex items-center px-4 py-2 gap-2 text-sm bg-white rounded hover:bg-base-300",children:a.jsx(ue,{featuretype:"relation",fullname:d,id:l["@_id"],created:Number(l["@_id"])<0,modified:l["@_action"]==="modify",deleted:l["@_action"]==="delete",children:a.jsx("button",{onClick:()=>c(l["@_id"]),className:"btn btn-primary btn-square btn-sm",children:a.jsx(R,{icon:ye})})})},l["@_id"])})})]})]})})},nr=()=>{const{stops:e}=S(n=>n.routeEdit),t=S(n=>n.modifyFeatureStateBatchNC);return m.useEffect(()=>{const n=S.getState().meta,s=e.filter(r=>n[r["@_type"]][r["@_ref"]]),o=s.map(r=>({type:r["@_type"],id:r["@_ref"],modify:i=>{i.highlighted=!0}}));return t(o),()=>{const r=s.map(i=>({type:i["@_type"],id:i["@_ref"],modify:c=>{c.highlighted=!1}}));t(r)}},[t,e]),null},or=()=>{const[e,t]=m.useState(!0),{stops:n}=S(i=>i.routeEdit),s=S(i=>i.setRouteStop),o=m.useCallback((i,c,l)=>{console.debug("edit",i,c,l),s(n.map(d=>{if(d["@_type"]===i&&d["@_ref"]===c){const p=pe(d);return p["@_role"]=l,p}return d}))},[s,n]),r=m.useCallback(({member:i,children:c})=>a.jsx(ie,{id:i["@_ref"],type:i["@_type"],children:()=>a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(St,{initialValue:i["@_role"],onCommit:l=>o(i["@_type"],i["@_ref"],l)})]}),c]})}),[o]);return a.jsxs("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{children:"Bus stops members (click to show/hide)"}),a.jsx("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:a.jsx(R,{icon:e?Qt.faChevronUp:pt.faChevronDown,className:"w-4 h-4"})})]}),e&&a.jsx(Me,{member:n,memberToId:i=>`${i["@_type"]}-${i["@_ref"]}`,onDelete:(i,c)=>s(c),onDragStart:()=>{},onDragEnd:i=>s(i),children:r}),a.jsx(nr,{})]})},sr=()=>{const{path:e}=S(n=>n.routeEdit),t=S(n=>n.modifyFeatureStateBatchNC);return m.useEffect(()=>{const n=S.getState().meta,s=e.filter(r=>n[r["@_type"]][r["@_ref"]]),o=s.map(r=>({type:r["@_type"],id:r["@_ref"],modify:i=>{i.highlighted=!0}}));return t(o),()=>{const r=s.map(i=>({type:i["@_type"],id:i["@_ref"],modify:c=>{c.highlighted=!1}}));t(r)}},[t,e]),null},ar=()=>{const[e,t]=m.useState(!0),{path:n}=S(i=>i.routeEdit),s=S(i=>i.setRoutePath),o=m.useCallback((i,c,l)=>{console.debug("edit",i,c,l),s(n.map(d=>{if(d["@_type"]===i&&d["@_ref"]===c){const p=pe(d);return p["@_role"]=l,p}return d}))},[s,n]),r=m.useCallback(({member:i,children:c,index:l,overlay:d})=>a.jsx(ie,{id:i["@_ref"],type:i["@_type"],children:()=>a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-3",children:!d&&a.jsx(Rn,{member:n,index:l})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(St,{initialValue:i["@_role"],onCommit:p=>o(i["@_type"],i["@_ref"],p)})]}),c]})}),[o,n]);return a.jsxs("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{children:"Path members (click to show/hide)"}),a.jsx("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:a.jsx(R,{icon:e?Qt.faChevronUp:pt.faChevronDown,className:"w-4 h-4"})})]}),e&&a.jsx(Me,{member:n,memberToId:i=>`${i["@_type"]}-${i["@_ref"]}`,onDelete:(i,c)=>s(c),onDragStart:()=>{},onDragEnd:i=>s(i),children:r}),a.jsx(sr,{})]})},rr=({width:e,height:t})=>{const n=m.useRef(new Ja({meta:S,view:X,settings:Z}));return m.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(Ee,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>n.current.transform(s),onPointerMove:s=>n.current.transform(s),onMouseUp:s=>n.current.transform(s),onWheel:s=>n.current.transform(s),children:[a.jsx(Se,{width:e,height:t}),a.jsx(ve,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Ce,{width:e}),a.jsx(or,{})]})},ir=m.memo(function(e){var i,c;const t=X(q(xt(e))),n=S(l=>l.splitWay),s=S(l=>l.createNodeOnWay),o=()=>{var l;(l=e.feature)!=null&&l.id&&n(e.feature.id),e.onClose()},r=()=>{var l;(l=e.feature)!=null&&l.id&&t&&s(t,[],e.feature.id),e.onClose()};return a.jsx(vt,{...e,children:((i=e.feature)==null?void 0:i.type)==="way"?a.jsx("a",{onClick:r,children:"New point on way"}):((c=e.feature)==null?void 0:c.type)==="node"?a.jsx("a",{onClick:o,children:"Split way by point"}):a.jsx("a",{children:"relation is not allowed here"})})}),cr=({width:e,height:t})=>{const n=m.useRef(new Qa({meta:S,view:X,settings:Z}));return m.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs("div",{className:"relative",style:{width:e,height:t},children:[a.jsxs(Ee,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>n.current.transform(s),onPointerMove:s=>n.current.transform(s),onMouseUp:s=>n.current.transform(s),onWheel:s=>n.current.transform(s),children:[a.jsx(Se,{width:e,height:t}),a.jsx(ve,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Ce,{width:e}),a.jsx(ar,{})]})},lr=({width:e,height:t})=>{const[n,s]=m.useState({x:0,y:0,open:!1}),o=m.useRef(new er({meta:S,view:X,settings:Z},{wayEditMenu:s})).current;return m.useEffect(()=>{const r=i=>o.transform(i);return document.addEventListener("keydown",r),()=>document.removeEventListener("keydown",r)},[o]),a.jsxs("div",{className:"relative",style:{width:e,height:t},children:[a.jsxs(Ee,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:r=>o.transform(r),onPointerMove:r=>o.transform(r),onMouseUp:r=>o.transform(r),onWheel:r=>o.transform(r),children:[a.jsx(Se,{width:e,height:t}),a.jsx(ve,{width:e,height:t,stateMachine:o})]}),a.jsx(Ce,{width:e}),a.jsx(ir,{...n,onClose:()=>s({x:0,y:0,open:!1})})]})},dr=({width:e,height:t})=>{const n=[{label:"Add Path"},{label:"Edit Way"}],[s,o]=m.useState(0);return a.jsxs("div",{className:"relative",style:{width:e,height:t},children:[a.jsx("div",{className:"absolute top-1 left-1 z-10",children:a.jsx("div",{className:"tabs tabs-boxed gap-1 shadow-md",children:n.map((r,i)=>a.jsx("button",{className:`tab tab-sm ${s===i?"tab-active":""}`,onClick:()=>o(i),children:r.label},i))})}),s===0?a.jsx(cr,{width:e,height:t}):a.jsx(lr,{width:e,height:t})]})},ur=()=>{const{editing:e,stops:t,path:n}=S(u=>u.routeEdit),s=S(u=>u.saveEditRoute),o=S(u=>u.modifyFeatureMetaNC),r=S(u=>u.setEditStepNC),i=S(u=>e&&u.meta.relation[e]),[c,l]=m.useState((i==null?void 0:i.tag)||[]),{undo:d}=S.temporal.getState(),p=()=>{s()};return m.useEffect(()=>{const u=new ce({meta:S,view:X,settings:Z}),f=x=>u.transform(x);return document.addEventListener("keydown",f),()=>document.removeEventListener("keydown",f)},[]),e?a.jsxs("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[a.jsx("h2",{className:"text-lg font-bold mb-4",children:"Finalize Route Edits"}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h3",{className:"font-medium mb-2",children:"Route Tags"}),a.jsx(ke,{tags:c,setTags:l,commitChange:()=>o("relation",e,u=>u.tag=c)})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h3",{className:"font-medium mb-2",children:"Route Members"}),a.jsxs("div",{className:"bg-base-200 p-2 rounded text-xs",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Stops"}),t.map((u,f)=>a.jsx(ie,{id:u["@_ref"],type:u["@_type"],showMetaType:!0},`${u["@_type"]}-${u["@_ref"]}-${f}`))]}),a.jsxs("div",{className:"",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Path"}),n.map((u,f)=>a.jsx(ie,{id:u["@_ref"],type:u["@_type"],showMetaType:!0},`${u["@_type"]}-${u["@_ref"]}-${f}`))]})]})]}),a.jsx("div",{className:"flex gap-2 justify-end",children:a.jsx("button",{onClick:p,className:"btn btn-primary",children:"Save Changes"})})]}):a.jsxs("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[a.jsx("div",{className:"alert alert-success mb-4 mx-auto",children:a.jsx("span",{children:"✓ Changes have been saved"})}),a.jsxs("div",{className:"flex gap-2 justify-end",children:[a.jsx("button",{onClick:()=>d(),className:"btn btn-primary",children:"Undo"}),a.jsx("button",{onClick:()=>r(0),className:"btn btn-primary",children:"Proceed"})]})]})},mr=({width:e,height:t})=>{const{step:n,editing:s}=S(c=>c.routeEdit),o=S(c=>c.setEditStepNC),r=c=>{o(s?c:0)},i=m.useMemo(()=>[{label:"Create or select route",component:a.jsx(tr,{})},{label:"Add bus stops",component:a.jsx(rr,{width:e,height:t-Le})},{label:"Edit route path",component:a.jsx(dr,{width:e,height:t-Le})},{label:"Save changes",component:a.jsx(ur,{})}],[e,t]);return a.jsxs("div",{style:{width:e,height:t},children:[a.jsx("div",{className:"relative",style:{width:e,height:t-Le},children:i[n].component}),a.jsx("div",{style:{width:e,height:Le},children:a.jsx("div",{className:"absolute bottom-0 left-0 right-0 flex flex-row pt-[8px] bg-base-200",children:a.jsx("ul",{className:"steps steps-horizontal mx-auto",children:i.map(({label:c},l)=>a.jsx("li",{onClick:()=>r(l),className:Q("step cursor-pointer",l<=n?"step-primary":"",!s&&"disabled"),children:c},l))})})})]})};function pr({width:e,height:t}){const n=S(la),s=S(g=>g.setSelectedMaster),o=S(g=>g.clearSelectedMaster),r=S(g=>g.meta.relation),i=S(g=>g.createLocalRelation),c=S(g=>g.modifyFeatureMetaNC),l=S(g=>g.commit),d=m.useMemo(()=>me.createConfirmation(Re),[]),p=m.useMemo(()=>Object.values(r).filter(g=>{var _;return(_=g.tag)==null?void 0:_.some(j=>j["@_k"]==="type"&&j["@_v"]==="route_master")}),[r]),u=m.useMemo(()=>Object.values(r).filter(g=>{var _;return(_=g.tag)==null?void 0:_.some(j=>j["@_k"]==="type"&&j["@_v"]==="route")}),[r]),f=m.useCallback(async()=>{const g=await d({title:"Create Route Master",preset:za});if(g!=null&&g.tag){const _=i([]);c("relation",_,j=>{j.tag=g.tag}),s(_)}},[d,i,c,s]),x=m.useCallback(g=>{n&&c("relation",n,_=>{_.member.some(j=>j["@_ref"]===g)||_.member.push({"@_type":"relation","@_ref":g,"@_role":"route"})})},[n,c]),y=m.useCallback(g=>{s(g)},[s]),b=m.useCallback(()=>{o()},[o]),h=m.useCallback(g=>{n&&c("relation",n,_=>{_.member=g})},[n,c]),w=m.useCallback((g,_)=>{n&&c("relation",n,j=>{j.member=_})},[n,c]);return m.useEffect(()=>{const g=new ce({meta:S,view:X,settings:Z}),_=j=>g.transform(j);return document.addEventListener("keydown",_),()=>document.removeEventListener("keydown",_)},[]),a.jsxs("div",{className:"p-4 bg-base-100 flex flex-col gap-4",style:{width:e,height:t},children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h2",{className:"text-xl font-bold",children:"Route Masters"}),a.jsxs("button",{onClick:f,className:"btn btn-primary btn-sm",children:[a.jsx(R,{icon:ye,className:"mr-2"}),"New Route Master"]})]}),a.jsxs("div",{className:"flex gap-4 flex-1 overflow-hidden",children:[a.jsx("div",{className:"w-1/2 bg-base-200 p-4 rounded-box h-full max-h-full flex flex-col",children:a.jsxs(Ne,{children:[({filter:g})=>a.jsx(ne,{forceOpen:!0,name:"route masters",defaultOpen:!0,children:a.jsx(te,{relation:Object.values(p),showMetaType:!0,filter:g,children:({meta:_})=>a.jsx("button",{className:"btn btn-ghost btn-xs ml-2 tooltip tooltip-bottom","data-tip":"Select as edting route master",onClick:()=>y(_["@_id"]),children:a.jsx(R,{icon:ye})})})}),({filter:g})=>a.jsx(ne,{name:"available-routes",defaultOpen:!0,children:a.jsx(te,{relation:Object.values(u),showMetaType:!0,filter:g,children:({meta:_})=>a.jsx("button",{onClick:()=>x(_["@_id"]),className:"btn btn-ghost btn-xs ml-2 btn-smtooltip tooltip-bottom","data-tip":"Append to editing",children:a.jsx(R,{icon:zt.faChevronRight})})})})]})}),a.jsx("div",{className:"overflow-scroll bg-base-200 p-4 rounded-box h-full max-h-full",children:n?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"font-bold",children:ee(r[n].tag)||"Unnamed Master"}),a.jsx("button",{onClick:b,className:"btn btn-ghost btn-sm",children:a.jsx(R,{icon:Jt})})]}),a.jsx(ke,{tags:r[n].tag||[],setTags:g=>c("relation",n,_=>{_.tag=g}),commitChange:l}),a.jsxs("div",{className:"mb-4",children:[a.jsx("h4",{className:"font-medium mb-2",children:"Member Routes"}),a.jsx(Me,{member:r[n].member,memberToId:g=>`${g["@_type"]}-${g["@_ref"]}`,onDelete:w,onDragStart:()=>{},onDragEnd:h,children:({member:g,children:_})=>a.jsx(ie,{id:g["@_ref"],type:g["@_type"],showMetaType:!0,children:()=>_})})]})]}):a.jsx("div",{className:"text-center text-gray-500",children:"Select or create a route master to begin"})})]})]})}function fr({width:e,height:t,children:n}){return a.jsx("div",{className:"bg-base-100 border-r-2 border-r-base-300 flex flex-col",style:{width:e,height:t,maxWidth:e,maxHeight:t},children:n})}function hr({width:e,height:t}){const s=m.useMemo(()=>[{tooltip:"Bus stop edit tab",icon:a.jsx(R,{icon:_o.faBusSimple}),stage:()=>a.jsx(Za,{width:e-42,height:t})},{tooltip:"Route edit tab",icon:a.jsx(R,{icon:jo.faRoute}),stage:()=>a.jsx(mr,{width:e-42,height:t})},{tooltip:"Edit bus relation",icon:a.jsx(R,{icon:So.faCodeCommit}),stage:()=>a.jsx(pr,{width:e-42,height:t})}],[e,t]),[o,r]=m.useState(0);return a.jsxs("div",{className:"flex flex-row",style:{height:t,width:e,maxHeight:t,maxWidth:e},onContextMenu:i=>i.preventDefault(),children:[a.jsx(fr,{width:42,height:t,children:s.map((i,c)=>a.jsx("div",{className:"tooltip tooltip-right mx-auto mt-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(c),className:Q("btn btn-ghost btn-square btn-sm",c===o&&"btn-active"),children:i.icon})}))}),a.jsx("div",{className:"relative",style:{height:t,width:e-42},children:s[o].stage()})]})}function xr({width:e,height:t}){return a.jsxs(Ke,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(hr,{...n}),n=>a.jsxs(Ke,{...n,axis:"y",children:[s=>a.jsx(kn,{...s}),s=>a.jsx(Tn,{...s})]})]})}function br({width:e,height:t}){const s=m.useMemo(()=>[{title:a.jsx(R,{icon:vo.faBus}),tooltip:"Public transport edit mode",component:()=>a.jsx(xr,{width:e,height:t-42})},{title:a.jsx(R,{icon:No.faMap}),tooltip:"Map edit mode",component:()=>a.jsx(Ra,{width:e,height:t-42})}],[e,t]),[o,r]=m.useState(0);return a.jsxs("div",{style:{width:e,height:t,position:"relative"},children:[a.jsx(Oa,{height:42,leftSlot:a.jsx(a.Fragment,{children:s.map((i,c)=>a.jsx("div",{className:"tooltip tooltip-right ml-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(c),className:Q("btn btn-ghost btn-square btn-sm",o===c&&"btn-active"),children:i.title})},c))})}),a.jsx("div",{className:"relative",children:s[o].component()})]})}function gr(){const[{width:e,height:t},n]=m.useState({width:window.innerWidth,height:window.innerHeight});return m.useEffect(()=>{const s=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}}),a.jsx("div",{className:"wrapper h-screen w-screen overflow-hidden",style:{width:e},children:a.jsx(br,{width:e,height:t})})}function yr(){return a.jsx(gr,{})}function wr(){return a.jsx(a.Fragment,{children:a.jsx(yr,{})})}const Ht=document.getElementById("root");Ht?zn.createRoot(Ht).render(a.jsx(m.StrictMode,{children:a.jsx(wr,{})})):console.error("Root element not found. Ensure there is an element with the ID 'root' in your HTML.");
