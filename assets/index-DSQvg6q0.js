var hn=Object.defineProperty;var xn=(e,t,n)=>t in e?hn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var A=(e,t,n)=>xn(e,typeof t!="symbol"?t+"":t,n);import{c as Ye,j as a,m as K,r as h,u as B,d as gn,F as T,a as bn,C as wn,b as yn,e as ct,D as _n,f as jn,S as Sn,v as Nn,g as vn,s as kn,K as Cn,P as En,h as Mn,l as ue,i as Tn}from"./react-nkIrz5Fj.js";import{d as ze,e as An,f as yt,h as _t,j as In,k as Ze,l as Rn,m as Pe,n as Le,o as jt,q as Pn,r as St,t as Ln,u as Dn,v as Fn,w as On,x as Nt,y as Bn,z as $n,A as Hn,B as vt,C as kt,D as Wn,E as Vn,F as Ct,G as Et,H as Mt,I as Tt,J as Je,K as Un,L as qn,M as Xn,N as Kn,O as Gn,P as Yn,Q as zn,R as Zn,S as Jn,T as Qn,U as eo,V as to,W as no,X as oo,Y as so,Z as ao}from"./fazustand-DRFLGKhA.js";import{a as At,f as He,d as ro,c as It,b as We,s as dt,g as io,h as lo,j as co,k as Rt,t as uo}from"./vendor-BZfy3mO-.js";import{i as Pt,j as po,L as _e,k as je,c as De,l as le,m as Ee,G as Lt,n as ut,R as mo}from"./pixi-CptTcpyr.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const fo={lon:-122.431297,lat:37.773972},ho=17,xo={viewpoint:fo,zoom:ho},go=e=>({setViewpoint:t=>e(()=>({viewpoint:t})),setZoom:t=>e(()=>({zoom:t})),setStage:(t,n)=>e({width:t,height:n}),setStageApp:t=>e({stage:t}),setSelectionRect:t=>e({selectionRect:t})}),pt=()=>new URLSearchParams(window.location.search),bo=e=>{const t=e.toString(),n=t?"?":"";window.history.replaceState(null,"",`${location.pathname}${n}${t}`)},wo=e=>(t,n,s)=>{const o=e(t,n,s),r={},i=pt(),l=i.get("lat"),d=i.get("lon"),c=i.get("zoom");l&&d&&(r.viewpoint={lat:parseFloat(l),lon:parseFloat(d)}),c&&(r.zoom=parseFloat(c));const p={...o,...r};return t(p,!0,"mapViewURLPersist/hydrate"),s.subscribe((f,x)=>{var m,g,w,v,k,C,I,j,N;const y=pt();let b=!1;((m=f.viewpoint)==null?void 0:m.lat)!==((g=x.viewpoint)==null?void 0:g.lat)&&(y.set("lat",((v=(w=f.viewpoint)==null?void 0:w.lat)==null?void 0:v.toString())||""),b=!0),((k=f.viewpoint)==null?void 0:k.lon)!==((C=x.viewpoint)==null?void 0:C.lon)&&(y.set("lon",((j=(I=f.viewpoint)==null?void 0:I.lon)==null?void 0:j.toString())||""),b=!0),f.zoom!==x.zoom&&(y.set("zoom",((N=f.zoom)==null?void 0:N.toString())||""),b=!0),b&&bo(y)}),p},Y=Ye()(ze(wo((...e)=>({...xo,...go(...e)})),{name:"MapView"})),yo={lon:-122.431297,lat:37.773972};Fe(yo);const ce=256,Se={XMIN:-2003750834e-2,YMIN:-200489661e-1,XMAX:2003750834e-2,YMAX:200489661e-1,EQUATOR:4007501668e-2};function _o(e){const[t,n]=At("EPSG:3857","EPSG:4326",[e.x,e.y]);return{lon:t,lat:n}}function Fe(e){const[t,n]=At("EPSG:4326","EPSG:3857",[e.lon,e.lat]);return{x:t,y:n}}function Dt(e,t){const n=Math.pow(2,t)*ce,s=Se.EQUATOR/n,o=(e.x-Se.XMIN)/s,r=(Se.XMAX-e.y)/s;return{x:o,y:r}}function Ft(e,t){return Dt(Fe(e),t)}function Ot(e,t,n,s,o){const r=Dt(Fe(t),n),i=s?s/2:0,l=o?o/2:0;return{x:Math.floor(e.x+i-r.x),y:Math.floor(e.y+l-r.y)}}function Qe(e,t,n,s,o){return Ot(Ft(e,n),t,n,s,o)}function ee(e,t,n,s,o){const r=Math.pow(2,n)*ce,i=Se.EQUATOR/r,l=Fe(t),d=Math.floor(s/2),c=Math.floor(o/2),p=(e.x-d)*i,u=(e.y-c)*i,f={x:l.x+p,y:l.y-u};return _o(f)}function Bt(e,t,n,s){const{lon:o,lat:r}=ee({x:0,y:0},e,t,n,s),{lon:i,lat:l}=ee({x:n,y:s},e,t,n,s);return{left:o,bottom:l,right:i,top:r}}function jo(e,t,n,s,{from:o,to:r}){const i={x:Math.min(o.x,r.x),y:Math.min(o.y,r.y)},l={x:Math.max(o.x,r.x),y:Math.max(o.y,r.y)};console.debug("getBoundsByRect, p1 p2",i,l,"vp zoom w h",e,t,n,s,{from:o,to:r});const{lon:d,lat:c}=ee(i,e,t,n,s),{lon:p,lat:u}=ee(l,e,t,n,s);return{left:d,bottom:u,right:p,top:c}}const $t=e=>t=>e.x!==0&&e.y!==0?ee(e,t.viewpoint,t.zoom,t.width,t.height):void 0;function pe(e){return JSON.parse(JSON.stringify(e))}const ne=e=>Object.keys(e);class So{constructor(){A(this,"timers",new Map)}debounce(t,n,s,o=!1){return(...r)=>{const i=o&&!this.timers.has(s);this.timers.has(s)&&clearTimeout(this.timers.get(s));const l=setTimeout(()=>{this.timers.delete(s),o||t(...r)},n);this.timers.set(s,l),i&&t(...r)}}cancel(t){this.timers.has(t)&&(clearTimeout(this.timers.get(t)),this.timers.delete(t))}cancelAll(){for(const t of this.timers.values())clearTimeout(t);this.timers.clear()}}function L(e){return e?Array.isArray(e)?e:[e]:[]}const Z=(...e)=>e.filter(Boolean).join(" ");class W{constructor(t){A(this,"name");A(this,"next",[]);this.name=t}appendNext(t,n){const s=t instanceof W?t:t.entry;if(n.isEpsilon)this.next.push({isEpsilon:!0,state:s});else{if(!n.transform)throw new Error("Non-ε transition requires a transform function.");this.next.push({isEpsilon:!1,transform:n.transform,state:s})}}}const Re=class Re{constructor(t){A(this,"name");A(this,"entry");A(this,"current");A(this,"accept");A(this,"debouncer");A(this,"context");this.name="base",this.context={store:t},this.debouncer=new So}appendNext(t,n){this.accept.forEach(s=>s.appendNext(t,n))}computeEpsilonClosure(t){const n=new Set,s=[t];for(;s.length;){const o=s.pop();if(!n.has(o)){n.add(o);for(const{state:r,isEpsilon:i}of o.next)i&&s.push(r)}}return Array.from(n)}transform(t){const n=this.computeEpsilonClosure(this.current);for(const s of n)for(const o of s.next)if(!o.isEpsilon&&o.transform(t)){this.current=o.state;return}}debouncedTransform(t){this.debouncer.debounce(this.transform.bind(this),Re.DEBOUNCE_DELAY,t.type,!0)(t)}};A(Re,"DEBOUNCE_DELAY",20);let Q=Re;function ie(e,t,n){const{stage:s}=n.store.view.getState(),o=s.view.getBoundingClientRect(),r=e-o.x,i=t-o.y;return console.debug("getLocalPosistion, x y",e,t," convert to ",r,i),{x:r,y:i}}const Me=(e,t,n)=>{var y;const{height:s,width:o,viewpoint:r,zoom:i,stage:l}=n.store.view.getState();if(!s||!o||!l)return;const d=l.view.getBoundingClientRect(),c=e-d.x,p=t-d.y,{modifyFeatureMetaNC:u}=n.store.meta.getState(),f=ee({x:c,y:p},r,i,o,s),x=Qe(f,r,i,o,s);if(console.log("on component drag",{x:e,y:t},{x:c,y:p},x),(y=n.componentTarget)!=null&&y.id&&n.componentTarget.type==="node"){const{type:b,id:m}=n.componentTarget;u(b,m,g=>{g["@_lon"]=f.lon,g["@_lat"]=f.lat})}else throw new Error(`context.componentTarget should not be ${JSON.stringify(n.componentTarget)} at point move`)};class No extends Q{constructor(n){super(n);A(this,"idle");A(this,"componentHover");A(this,"componentMousedown");A(this,"pointDrag");this.idle=new W("component-idle"),this.componentHover=new W("component-hover"),this.componentMousedown=new W("component-mousedown"),this.pointDrag=new W("component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:s=>{const o=this.context;if(["pointerover","pointerenter"].includes(s.type)&&"componentTarget"in s&&s.componentTarget){o.componentTarget=s.componentTarget;const{id:r,type:i}=o.componentTarget;console.log("ComponentStateMachine: component hover triggered",i,r);const{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,d=>d.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:s=>{const o=this.context;if(s.type==="mousedown"&&o.componentTarget){console.log("ComponentStateMachine: transition to mousedown");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,d=>d.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:s=>{const o=this.context;if(["pointerleave","pointerout"].includes(s.type)&&o.componentTarget){console.log("ComponentStateMachine: transition to idle");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,d=>d.hovered=!1),o.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:s=>{var r;const o=this.context;if(s.type==="pointermove"&&((r=o.componentTarget)==null?void 0:r.type)==="node"){console.log("ComponentStateMachine: start dragging");const{clientX:i,clientY:l}=s,{commit:d}=o.store.meta.getState();return d(),Me(i,l,o),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:s=>{const o=this.context;if((s.type==="mouseup"||s.type==="mouseupoutside")&&o.componentTarget){const{selectFeature:r,unSelectFeature:i}=o.store.meta.getState(),{id:l,type:d}=o.componentTarget;if(typeof l=="string")s.ctrlKey?i(d,l):(r(d,l,!s.shiftKey),console.log("selected id",l,o.store.meta.getState().selectFeature)),o.componentTarget=void 0;else throw new Error(`id ${l} is invalid for component`);return!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:s=>s.type==="mouseup"||s.type==="mouseuppoutside"?(console.log("ComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:s=>{if(s.type==="pointermove"){const{clientX:o,clientY:r}=s;return Me(o,r,this.context),!0}return!1}})}}var Te=(e=>(e[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(Te||{});class Ht extends Q{constructor(n,s){super(n);A(this,"idle");A(this,"rightMousedown");A(this,"mapDrag");this.idle=new W("mapview-idle"),this.mapDrag=new W("mapview-mapDrag"),this.rightMousedown=new W("mapview-right-mousedown"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="wheel"){const l=r.deltaY<0,{zoom:d,setZoom:c}=i.store.view.getState(),p=d+(l?1:-1),u=i.store.settings.getState();return p>=0&&p<=u.view.MAX_ZOOM&&c(p),!0}return!1}}),this.idle.appendNext(this.mapDrag,{transform:r=>{const i=this.context;if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===Te.LEFT){const{clientX:l,clientY:d}=r;return i.startPoint={x:l,y:d},i.viewpointBeforeDrag=i.store.view.getState().viewpoint,console.log("MapViewStateMachine: 开始地图拖拽",i.startPoint),!0}return!1}}),this.idle.appendNext(this.rightMousedown,{transform:r=>{if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===Te.RIGHT){const{clientX:i,clientY:l}=r;return this.context.startPoint={x:i,y:l},this.context.viewpointBeforeDrag=this.context.store.view.getState().viewpoint,!0}return!1}}),this.rightMousedown.appendNext(this.idle,{transform:r=>r.type==="mouseup"?(s&&s.rightClickHandeler(r),this.context.startPoint=void 0,this.context.viewpointBeforeDrag=void 0,!0):!1});const o=r=>{var l,d;const i=this.context;if(r.type==="pointermove"){const{clientX:c,clientY:p}=r,[u,f]=[c,p];if(typeof((l=i.startPoint)==null?void 0:l.x)!="number"||typeof((d=i.startPoint)==null?void 0:d.y)!="number")throw new Error("context.startPoint.x must be number when map drag");const[x,y]=[i.startPoint.x-u,i.startPoint.y-f];console.log("moving to",x,y);const{zoom:b,setViewpoint:m,width:g,height:w}=i.store.view.getState(),v=g,k=w,C=i.viewpointBeforeDrag,I=ee({x:x+v/2,y:y+k/2},C,b,v,k);return m(I),!0}return!1};this.rightMousedown.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="mouseup"||r.type==="mouseupoutside"){if(i.startPoint=void 0,i.viewpointBeforeDrag=void 0,i.store.meta.getState().autoload){const{viewpoint:l,zoom:d,width:c,height:p}=i.store.view.getState(),u=c,f=p,{loadbbox:x}=i.store.meta.getState(),y=i.store.settings.getState();x({width:u,height:f,zoom:d,viewpoint:l},y.osmAPI.BASEURL)}return!0}return!1}})}}function vo(e,t,n){const s=We();dt(s,n,t);const o=io(s);if(o===0)return It(t);const r=We();dt(r,e,t);const i=lo(r,s)/o,l=Math.max(0,Math.min(1,i)),d=We();return co(d,t,s,l),d}function Wt(e,t){let n=null,s=null,o=1/0;const r=He(e.lon,e.lat);for(let i=0;i<t.length-1;i++){const l=He(t[i]["@_lon"],t[i]["@_lat"]),d=He(t[i+1]["@_lon"],t[i+1]["@_lat"]),c=vo(r,l,d),p=ro(r,c);p<o&&(o=p,n=It(c),s=t[i])}if(s===null)throw new Error("point is not insertable for polyline");return{nearestPoint:n?{lon:n[0],lat:n[1]}:e,insertAfter:s}}class Vt extends Q{constructor(n){super(n);A(this,"idle");this.idle=new W("undo-redo-idle"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}})}}class ko extends Q{constructor(n){super(n);A(this,"idle");A(this,"undoRedo");A(this,"addNode");A(this,"addNodeOnWay");A(this,"splitWay");this.idle=new W("node-idle"),this.addNode=new W("add-node"),this.addNodeOnWay=new W("add-node-on-way"),this.splitWay=new W("split-way"),this.undoRedo=new Vt(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}}),this.idle.appendNext(this.addNode,{transform:s=>s.type==="add-node"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.addNodeOnWay,{transform:s=>s.type==="add-node-on-way"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.splitWay,{transform:s=>s.type==="split-way"?(console.log("to split way state"),!0):!1}),this.addNode.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0){const{viewpoint:r,zoom:i,width:l,height:d}=this.context.store.view.getState(),c=l,p=d,{clientX:u,clientY:f}=o,x=ee({x:u,y:f},r,i,c,p);this.context.store.meta.getState().createLocalNode(x),console.log("added node")}return!0}return!1}}),this.addNodeOnWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="way"){const{viewpoint:r,zoom:i,width:l,height:d}=this.context.store.view.getState(),c=l,p=d,{meta:u,createLocalNode:f,modifyFeatureMetaNC:x,commit:y}=this.context.store.meta.getState(),{clientX:b,clientY:m}=o,g=ee({x:b,y:m},r,i,c,p),w=u.way[o.componentTarget.id],v=w.nd.map(N=>u.node[N["@_ref"]]),{nearestPoint:k,insertAfter:C}=Wt(g,v),I=f(k),j=Array.from(w.nd);j.splice(w.nd.findIndex(N=>N["@_ref"]===C["@_id"])+1,0,{"@_ref":I}),y(),x(o.componentTarget.type,o.componentTarget.id,N=>N.nd=j),console.log("nodeid",I,j),console.log("added node")}return!0}return!1}}),this.splitWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="node"){const{meta:r,splitWay:i}=this.context.store.meta.getState(),l=r.node[o.componentTarget.id];i(l["@_id"]),console.log("splited way")}return!0}return!1}})}}class Co extends Q{constructor(n){super(n);A(this,"idle");A(this,"componentSubMachine");A(this,"mapViewSubMachine");A(this,"uiStateSubMachine");this.idle=new W("common-edit-idle"),this.componentSubMachine=new No(n),this.mapViewSubMachine=new Ht(n),this.uiStateSubMachine=new ko(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.uiStateSubMachine,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.uiStateSubMachine.appendNext(this.idle,{isEpsilon:!0})}}const Eo={},Mo={commitCounter:1},To={selectedRef:[],activeRef:void 0},Ao={meta:{node:{},way:{},relation:{}},deletedMeta:{node:{},way:{},relation:{}},_create_feature_counter:-1},Io={bbox:[],autoload:!0},Ut={...Mo,...To,...Ao,...Io,...Eo};function G(e){e.commitCounter++}const Ro=e=>({commit:()=>e(t=>G(t))});function z(e,t){if(!t)return null;const n=L(t);for(let s=0;s<n.length;s++){const o=n[s];if(o["@_k"]===e)return o["@_v"]}return null}const et=(e,t,n,s,o,r)=>{const i=(l,d)=>{if(d==="relation"){const c=r[l];if(!c)return;n[l]||(n[l]=!0),L(c.member).forEach(p=>{const u=p["@_ref"],f=p["@_type"];f==="node"?!e[u]&&s[u]&&(e[u]=!0):f==="way"?!t[u]&&o[u]&&i(u,"way"):f==="relation"&&!n[u]&&r[u]&&i(u,"relation")})}else if(d==="way"){const c=o[l];if(!c)return;t[l]||(t[l]=!0),L(c.nd).forEach(p=>{const u=p["@_ref"];!e[u]&&s[u]&&(e[u]=!0)})}else if(d==="node"){if(!s[l])return;e[l]||(e[l]=!0)}};return i};function Po(e,t,n){const s={},o={},r={},i=et(s,o,r,e,t,n);return Object.values(n).forEach(l=>{(z("type",l.tag)==="route_master"&&z("route_master",l.tag)==="bus"||z("type",l.tag)==="route"&&z("public_transport:version",l.tag)==="2")&&i(l["@_id"],"relation")}),Object.values(n).forEach(l=>{z("type",l.tag)==="route"&&z("public_transport:version",l.tag)==="2"&&z("roundtrip",l.tag)==="yes"&&i(l["@_id"],"relation")}),{node:s,way:o,relation:r}}function Lo(e,t,n){const s={},o={},r={},i=et(s,o,r,e,t,n);return Object.values(n).forEach(l=>{z("highway",l.tag)&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{z("highway",l.tag)&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{z("highway",l.tag)&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}function Do(e,t,n){const s={},o={},r={},i=et(s,o,r,e,t,n);return Object.values(n).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}const Fo=e=>{const{node:t,way:n,relation:s}=e,o={elems:{node:{},way:{},relation:{}},roots:{node:{},way:{},relation:{}}},r=(i,l)=>{Object.keys(l).forEach(d=>{const c=d;o.elems[i][c]={id:c,type:i,fathers:{node:[],way:[],relation:[]},childs:{node:[],way:[],relation:[]}},o.roots[i][c]=!0})};return r("node",t),r("way",n),r("relation",s),Object.values(n).forEach(i=>{const l=o.elems.way[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.nd.forEach(d=>{const c=o.elems.node[d["@_ref"]];c&&(c.fathers.way.push(l.id),l.childs.node.push(c.id),delete o.roots.node[c.id])})}),Object.values(s).forEach(i=>{const l=o.elems.relation[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.member.forEach(d=>{const c=o.elems[d["@_type"]][d["@_ref"]];c&&(c.fathers.relation.push(l.id),l.childs[d["@_type"]].push(c.id),delete o.roots[d["@_type"]][c.id])})}),o},qt=e=>{const t=(...d)=>d.reduce((c,p)=>(Object.assign(c.node,p.node),Object.assign(c.way,p.way),Object.assign(c.relation,p.relation),c),{node:{},way:{},relation:{}}),{node:n,way:s,relation:o}=e,r=Po(n,s,o),i=Lo(n,s,o),l=Do(n,s,o);return{ptv2:r,highway:i,created:l,global:t(r,i)}},Oo=An.createComputed(e=>({collections:qt(e.meta),tree:Fo(e.meta)}));function Bo(e,t,n,s){const o=e.meta[t][n]["@_localStates"];o&&s(o)}function me(e,t,n){e.meta[t][n]["@_localStates"]={visible:!0,highlighted:!1,hovered:!1,selected:!1,active:!1}}function Xt(e,t,n){if(e.activeRef){const{type:s,id:o}=e.activeRef;e.meta[s][o]["@_localStates"]&&(e.meta[s][o]["@_localStates"].active=!1)}e.activeRef={type:t,id:n},e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!0)}function Kt(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)||(e.selectedRef.push({type:t,id:n}),e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].selected=!0))}function Ve(e){if(e.activeRef){const{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1),e.activeRef=void 0}e.selectedRef.forEach(({id:t,type:n})=>e.meta[n][t]["@_localStates"]&&(e.meta[n][t]["@_localStates"].selected=!1)),e.selectedRef=[]}function Ne(e,t,n){Kt(e,t,n),Xt(e,t,n)}function $o(e,t,n){Kt(e,t,n)}function Ho(e,t,n){const s=e.meta[t][n]["@_localStates"];if(s!=null&&s.active&&(s.active=!1,e.activeRef=void 0),s!=null&&s.selected&&(s.selected=!1,e.selectedRef=e.selectedRef.filter(o=>!(o.id===n&&o.type===t))),!e.activeRef&&e.selectedRef.length>0){const{type:o,id:r}=e.selectedRef[0];Xt(e,o,r)}}const Wo=(e,t)=>({"@_id":`${e._create_feature_counter--}`,"@_lat":t.lat,"@_lon":t.lon,"@_visible":"true"}),Gt=(e,t)=>({"@_id":`${e._create_feature_counter--}`,nd:[...t],"@_visible":"true"}),Vo=(e,t)=>({"@_id":`${e._create_feature_counter--}`,member:[...t],"@_visible":"true"});function ve(e,t,n){const s=n["@_id"];e.meta[t][s]&&console.debug(`Can't add feature ${t} ${s}: already exsits! Ignoring this attempt`),e.meta[t][s]=n,me(e,t,s)}function Uo(e,t,n){return L(n).forEach(s=>ve(e,t,s))}function Yt(e,t){const n=Wo(e,t);return e.meta.node[n["@_id"]]=n,me(e,"node",n["@_id"]),n["@_id"]}function qo(e,t){const n=Gt(e,t);return e.meta.way[n["@_id"]]=n,me(e,"way",n["@_id"]),n["@_id"]}function zt(e,t){const n=Vo(e,t);return e.meta.relation[n["@_id"]]=n,me(e,"relation",n["@_id"]),n["@_id"]}const oe=(e,t,n,s)=>{const o=e.meta[t][n];o&&(s(o),o["@_action"]="modify")};function Xo(e,t,n){const s=t.elems.node[n].fathers.way.map(o=>e.meta.way[o]);s==null||s.forEach(o=>{const r=o.nd,i=r.findIndex(l=>l["@_ref"]===n);if(i!==0&&i!==r.length-1){if(i===-1)throw new Error(`way ${o} must contain node ${n}, the feature tree is broken.`);const l=r.slice(i);o.nd=r.slice(0,i+1),o["@_action"]="modify";const d=Gt(e,l);d.tag=o.tag&&[...o.tag],e.meta.way[d["@_id"]]=d,me(e,"way",d["@_id"]);const c=t.elems.way[o["@_id"]].fathers.relation.map(p=>e.meta.relation[p]);c==null||c.forEach(p=>{const u=p.member,f=u.findIndex(x=>x["@_ref"]===o["@_id"]);if(f===-1)throw new Error(`relation ${p} must contain way ${o}, the feature tree is broken.`);u.splice(f+1,0,{"@_ref":d["@_id"],"@_type":"way","@_role":u[f]["@_role"]}),p.member=u,p["@_action"]="modify"})}})}function Ae(e,t,n){if(!e.meta[t][n])throw new Error(`Can't delete feature ${t} ${n}: not exsit!`);e.deletedMeta[t][n]=e.meta[t][n],e.deletedMeta[t][n]["@_action"]="delete",delete e.meta[t][n]}function Ko(e,t,n){const{way:s,relation:o}=t.elems.node[n].fathers;s.forEach(r=>{oe(e,"way",r,i=>{i.nd=i.nd.filter(l=>l["@_ref"]!==n)}),e.meta.way[r].nd.length<=1&&Zt(e,t,r)}),o.forEach(r=>{oe(e,"relation",r,i=>{i.member=i.member.filter(l=>l["@_type"]==="node"&&l["@_ref"]===n)})}),Ae(e,"node",n)}function Zt(e,t,n){e.meta.way[n].nd.forEach(o=>{const r=o["@_ref"],{way:i,relation:l}=t.elems.node[r].fathers;i.length>1||l.length>0||Ae(e,"node",r)});const{relation:s}=t.elems.way[n].fathers;s.forEach(o=>{oe(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="way"&&i["@_ref"]===n)})}),Ae(e,"way",n)}function Go(e,t,n){const{relation:s}=t.elems.relation[n].fathers;s.forEach(o=>{oe(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="relation"&&i["@_ref"]===n)})}),Ae(e,"relation",n)}function Yo(e,t,n,s){if(n==="node")Ko(e,t,s);else if(n==="way")Zt(e,t,s);else if(n==="relation")Go(e,t,s);else throw new Error(`Type ${n} not allowed.`)}const zo=["tag","nd","member","node","way","relation"];async function re(e,t){const n=`${e}${t}`,s=await fetch(n);if(!s.ok)throw new Error(`Error on fetching ${n}: ${s.statusText}`);const o=await s.text(),i=new Rt.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",isArray:(l,d,c,p)=>!p&&zo.includes(l)}).parse(o);return console.log(`Get ${n}`,JSON.stringify(i),i),i}async function Zo(e,t,n,s,o){const r=await re(e,`/api/0.6/map?bbox=${t},${n},${s},${o}`);return r.osm.bounds["@_maxlat"]=Number(r.osm.bounds["@_maxlat"]),r.osm.bounds["@_minlat"]=Number(r.osm.bounds["@_minlat"]),r.osm.bounds["@_maxlon"]=Number(r.osm.bounds["@_maxlon"]),r.osm.bounds["@_minlon"]=Number(r.osm.bounds["@_minlon"]),r.osm.node=L(r.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i.tag&&(i.tag=L(i.tag)),i)),r}async function Jo(e,t){const s=(await re(e,`/api/0.6/node/${t}`)).osm.node;return s["@_lon"]=Number(s["@_lon"]),s["@_lat"]=Number(s["@_lat"]),s}async function Qo(e,t){return(await re(e,`/api/0.6/way/${t}`)).osm.way}async function es(e,t){return(await re(e,`/api/0.6/relation/${t}`)).osm.relation}async function Ue(e,t){if(t.length===0)return[];const s=`/api/0.6/nodes?nodes=${t.join(",")}`,o=await re(e,s);return L(o.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i))}async function ts(e,t){if(t.length===0)return[];const s=`/api/0.6/ways?ways=${t.join(",")}`,o=await re(e,s);return L(o.osm.way)}async function ns(e,t){if(t.length===0)return[];const s=`/api/0.6/relations?relations=${t.join(",")}`,o=await re(e,s);return L(o.osm.relation)}async function os(e,{viewpoint:t,zoom:n,width:s,height:o},r){const{left:l,bottom:d,right:c,top:p}=Bt(t,n,s,o),u=f=>f.osm.bounds["@_minlon"]<=l+1e-7&&f.osm.bounds["@_minlat"]<=d+1e-7&&f.osm.bounds["@_maxlon"]>=c-1e-7&&f.osm.bounds["@_maxlat"]>=p-1e-7;return e.some(u)?(console.log("requested bbox is already cached"),null):(console.log(`osm load data, faild to get cache: ${l} ${d} ${c} ${p}`,t,n),console.log("state bboxs",e),await Zo(r,l,d,c,p))}function Jt(e,t,n){const s=Yt(e,t);return oe(e,"node",s,n),s}function ss(e,t,n,s){let o="0";return oe(e,"way",s,r=>{const i=r.nd.map(c=>e.meta.node[c["@_ref"]]),{nearestPoint:l,insertAfter:d}=Wt(t,i);o=Jt(e,l,n),r.nd.splice(r.nd.findIndex(c=>c["@_ref"]===d["@_id"])+1,0,{"@_ref":o})}),o}const as=e=>({modifyFeatureStateNC:(t,n,s)=>e(o=>{Bo(o,t,n,s)}),selectFeature:(t,n,s)=>e(o=>{G(o),s&&Ve(o),Ne(o,t,n)}),selectFeatureWithoutActive:(t,n,s)=>e(o=>{G(o),s&&Ve(o),$o(o,t,n)}),unSelectFeature:(t,n)=>e(s=>{G(s),Ho(s,t,n)}),clearSelect:()=>e(t=>{G(t),Ve(t)})}),rs=(e,t)=>({addFeatureMetaBatch:(n,s)=>e(o=>Uo(o,n,s)),createLocalNode:n=>{let s="0";return e(o=>{G(o),s=Yt(o,n)}),s},createLocalWay:n=>{let s="0";return e(o=>{G(o),s=qo(o,n)}),s},createLocalRelation:n=>{let s="0";return e(o=>{G(o),s=zt(o,n)}),s},modifyFeatureMetaNC:(n,s,o)=>e(r=>{oe(r,n,s,o)}),deleteFeature:(n,s)=>e(o=>{G(o),Yo(o,t().tree,n,s)}),splitWay:n=>e(s=>{G(s),Xo(s,t().tree,n)})}),is=(e,t)=>({loadbbox:async(n,s)=>{const{bbox:o,meta:r}=t();if(!(n.zoom<=16))try{const i=await os(o||[],n,s);if(i===null)return;const{node:l,way:d,relation:c}=pe(r),p=[],u=[],f=[];i.osm.node.forEach(w=>{const v=w["@_id"];l[v]||(l[v]=w,p.push(w))}),i.osm.way.forEach(w=>{const v=w["@_id"];d[v]||(d[v]=w,u.push(w))}),i.osm.relation.forEach(w=>{const v=w["@_id"];c[v]||(c[v]=w,f.push(w))});const x=qt({node:l,way:d,relation:c}),y={nodesId:new Set(Object.keys(x.global.node)),waysId:new Set(Object.keys(x.global.way)),relationsId:new Set(Object.keys(x.global.relation))},b=p.filter(w=>y.nodesId.has(w["@_id"])),m=u.filter(w=>y.waysId.has(w["@_id"])),g=f.filter(w=>y.relationsId.has(w["@_id"]));e(w=>{G(w),b.forEach(v=>{w.meta.node[v["@_id"]]||ve(w,"node",v)}),m.forEach(v=>{w.meta.way[v["@_id"]]||ve(w,"way",v)}),g.forEach(v=>{w.meta.relation[v["@_id"]]||ve(w,"relation",v)}),w.bbox.push({...i,osm:{...i.osm,node:[],way:[],relation:[]}})})}catch(i){console.log(i)}},loadFeature:async(n,s,o)=>{const{meta:r,addFeatureMetaBatch:i}=t();if(n==="node")r.node[s]||i("node",await Jo(o,s));else if(n==="way"){const l=await Qo(o,s),d=await Ue(o,l.nd.map(c=>c["@_ref"]));i("node",d.filter(c=>!r.node[c["@_id"]])),r.way[s]||i("way",l)}else n==="relation"&&(r.relation[s]||i("relation",await es(o,s)))},loadFeatureBatch:async(n,s)=>{const{meta:o,addFeatureMetaBatch:r}=t(),i=n.filter(c=>c.type==="node"&&!o.node[c.id]).map(c=>c.id),l=n.filter(c=>c.type==="way"&&!o.way[c.id]).map(c=>c.id),d=n.filter(c=>c.type==="relation"&&!o.relation[c.id]).map(c=>c.id);if(l.length>0){const c=await ts(s,l),p=c.map(f=>f.nd.map(x=>x["@_ref"]).filter(x=>!o.node[x])).flat(),u=await Ue(s,p);r("node",u),r("way",c)}if(i.length>0){const c=await Ue(s,i);r("node",c)}if(d.length>0){const c=await ns(s,d);r("relation",c)}},setAutoloadNC:n=>e(s=>{s.autoload=typeof n=="function"?n():n})}),ls=e=>({createBusStopSel:(t,n)=>e(s=>{G(s);const o=Jt(s,t,r=>{r.tag=n});Ne(s,"node",o)}),createStopPositionSel:(t,n,s)=>e(o=>{G(o);const r=ss(o,t,i=>{i.tag=n},s);Ne(o,"node",r)}),createStopAreaSel:(t,n)=>{e(s=>{G(s);const o=zt(s,n||[]);oe(s,"relation",o,r=>{r.tag=t}),Ne(s,"relation",o)})}}),cs=e=>({reset:()=>{e({...Ut})}}),E=Ye()(ze(yt(Oo(uo(In((...e)=>({...Ut,...Ro(...e),...as(...e),...rs(...e),...is(...e),...ls(...e),...cs(...e)})),{partialize:e=>{const{tree:t,collections:n,...s}=e;return s},equality:(e,t)=>e.commitCounter===t.commitCounter})),{name:"OSMMapStateStore",storage:_t(()=>localStorage),partialize:e=>{const{tree:t,collections:n,...s}=e;return s}}),{name:"OSMMapState"})),ds=e=>({updateSettingsAction:t=>e(()=>t)}),us={osmAPI:{BASEURL:"https://api.openstreetmap.org",TILE_SOURCE:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"},view:{MAX_ZOOM:19},pixiRender:{zIndex:{LINE:10,POINT:20,MASK:30}}},ps={name:"settingStore",storage:_t(()=>localStorage)},ae=Ye()(ze(yt((...e)=>({...us,...ds(...e)}),ps),{name:"Settings"}));function ms(e,t,n,s){return e.replace("{z}",String(s)).replace("{x}",String(t)).replace("{y}",String(n))}function fs({source:e,x:t,y:n,mapViewStatus:{zoom:s,width:o,height:r,viewpoint:i}}){const l=ms(e,t,n,s),d={x:t*ce,y:n*ce},c=Ot(d,i,s,o,r);return a.jsx(K.Sprite,{image:l,position:c})}function Qt(e){const{width:t,height:n}=e,s=ae(d=>d.osmAPI.TILE_SOURCE),o=Y(),{viewpoint:r,zoom:i}=o,l=()=>{const{x:d,y:c}=Ft(r,i),[p,u,f,x]=[d-(t>>1),c-(n>>1),d+(t>>1),c+(n>>1)].map(b=>Math.floor(b/ce)),y=[];for(let b=p;b<=f;b++)for(let m=u;m<=x;m++)y.push(a.jsx(fs,{source:s,x:b,y:m,mapViewStatus:{...e,...o}},`${b}-${m}`));return y};return a.jsx(K.Container,{children:l()})}function hs(e,t){return[e[0]+t[0],e[1]+t[1]]}function xs(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function ge(e,t,n=0){return Math.abs(e[0]-t[0])<=n&&Math.abs(e[1]-t[1])<=n}function ke(e,t){const n=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(n*n+s*s)}function gs(e,t={}){const s=[e[0],e[1]],o=[e[e.length-2],e[e.length-1]],r=ge(s,o,1e-4),i=new Pt(e);t.native=!1,i.closeStroke=!1;const l={shape:i,lineStyle:t},d={closePointEps:1e-4,indices:[],points:[],uvs:[]};po.buildLine(l,d);const c=d.points,p=d.indices,u=new Map,f=[],x=[];let y=[NaN,NaN],b=[NaN,NaN],m=0,g=0,w=[NaN,NaN],v=[NaN,NaN],k=[NaN,NaN],C=NaN,I=NaN,j=NaN;for(let M=0;M<p.length;M+=3){const P=p[M],D=p[M+1],q=p[M+2],X=[c[P*2],c[P*2+1]],J=[c[D*2],c[D*2+1]],O=[c[q*2],c[q*2+1]];if(M===0)u.set(P,!0),u.set(D,!1),u.set(q,!0),f.push(X),x.push(J),f.push(O),b=J,y=O,m=ke(X,O);else{let _=u.get(P),R=u.get(D),F=u.get(q);_===void 0&&ge(X,w,1e-4)&&(_=u.get(C),u.set(P,_)),R===void 0&&ge(J,v,1e-4)&&(R=u.get(I),u.set(D,R)),F===void 0&&ge(O,k,1e-4)&&(F=u.get(j),u.set(q,F));let H,U,te;_===void 0&&(H=P,U=X,te=!F),R===void 0&&(H=D,U=J,te=!_),F===void 0&&(H=q,U=O,te=!R),H!==void 0&&(u.set(H,te),te===!0?(f.push(U),m+=ke(y,U),y=U):(x.push(U),g+=ke(b,U),b=U))}w=X,v=J,k=O,C=P,I=D,j=q}const N={},V=f.length+x.length+1,$=new Array(V*2);let S=0;for(let M=0;M<f.length;++S,++M)$[S*2]=f[M][0],$[S*2+1]=f[M][1];for(let M=x.length-1;M>=0;++S,--M)$[S*2]=x[M][0],$[S*2+1]=x[M][1];if($[S*2]=f[0][0],$[S*2+1]=f[0][1],N.perimeter=$,r){const M=g>m?x:f,P=new Array((M.length+1)*2);for(let D=0;D<M.length;++D)P[D*2]=M[D][0],P[D*2+1]=M[D][1];P[M.length*2]=M[0][0],P[M.length*2+1]=M[0][1],N.outer=P}return N}function mt(e,t,n=!1,s=!1){let r=t,i;const l=[];for(let d=0;d<e.length;d++){const c=e[d];if(i){let p=ke(i,c)-r;if(p>=0){const u=xs(i,c),f=t*Math.cos(u),x=t*Math.sin(u);let y=0,b=0;n&&(y=7*Math.cos(u+Math.PI/2),b=7*Math.sin(u+Math.PI/2));let m=[i[0]+r*Math.cos(u)+y,i[1]+r*Math.sin(u)+b];const g=[i,m];for(s&&p>=t*100&&(t=Math.floor(p/100)),p-=t;p>=0;p-=t)m=hs(m,[f,x]),g.push(m);g.push(c),l.push({coords:g.slice(1,-1),angle:u+(n?Math.PI/2:0)})}r=-p}i=c}return l}function be(e){return e==="butt"?_e.BUTT:e==="square"?_e.SQUARE:_e.ROUND}function we(e){return e==="bevel"?je.BEVEL:e==="miter"?je.MITER:je.ROUND}De.from("src/location-pin.svg");const bs=De.from("src/circle.svg"),ws=De.from("src/bus.svg"),ft=De.from("src/arrow-right-long.svg"),ys={proposed:!0,planned:!0,construction:!0,disused:!0,abandoned:!0,was:!0,dismantled:!0,razed:!0,demolished:!0,destroyed:!0,removed:!0,obliterated:!0,intermittent:!0};function _s(e){const t=e.split(":");return t.length===1?e:t[0]in ys?e.slice(t[0].length+1):e}const ht={aerialway:{chair_lift:!0,drag_lift:!0,"j-bar":!0,magic_carpet:!0,mixed_lift:!0,platter:!0,rope_tow:!0,"t-bar":!0,zip_line:!0},highway:{motorway:!0},junction:{circular:!0,roundabout:!0},man_made:{goods_conveyor:!0,"piste:halfpipe":!0},"piste:type":{downhill:!0,sled:!0,yes:!0},roller_coaster:{track:!0},"seamark:type":{"two-way_route":!0,recommended_traffic_lane:!0,separation_lane:!0,separation_roundabout:!0},waterway:{canal:!0,ditch:!0,drain:!0,fish_pass:!0,flowline:!0,pressurised:!0,river:!0,spillway:!0,stream:!0,tidal_channel:!0}},ye={natural:{cliff:!0,coastline:!0},barrier:{retaining_wall:!0,kerb:!0,guard_rail:!0,city_wall:!0},man_made:{embankment:!0},waterway:{weir:!0}};function js(e){const t={yes:!0,1:!0,"-1":!0,reversible:!0,alternating:!0,no:!1,0:!1};let n=null;return e.forEach(s=>{s["@_k"]==="oneway"&&t[s["@_v"]]&&(n=t[s["@_v"]])}),n!==null?n:(e.forEach(s=>{s["@_k"]in ht&&s["@_v"]in ht[s["@_k"]]&&(n=!0)}),!!n)}function Ss(e){const t=()=>{for(let n=0;n<e.length;n++){const s=e[n]["@_k"],o=e[n]["@_v"],r=_s(s);if(r in ye&&o in ye[r])return ye[r][o]?r:ye[r][o]}return null};return e.some(n=>n["@_k"]==="two_sided"&&n["@_v"]==="yes")?!1:t()!==null}const Ns={surface:{paved:!0,asphalt:!0,concrete:!0,chipseal:!0,"concrete:lanes":!0,"concrete:plates":!0},tracktype:{grade1:!0}},vs=new Set(["motorway","trunk","primary","secondary","tertiary","residential","motorway_link","trunk_link","primary_link","secondary_link","tertiary_link","unclassified","road","service","track","living_street","bus_guideway","busway"]),Ce=new Set(["abandoned","construction","demolished","destroyed","dismantled","disused","intermittent","obliterated","planned","proposed","razed","removed","was"]),ks=new RegExp("^("+Array.from(Ce).join("|")+"):"),qe={DEFAULTS:{fill:{width:2,color:11184810,alpha:.3},casing:{width:5,color:4473924,alpha:1,cap:"round",join:"round"},stroke:{width:3,color:13421772,alpha:1,cap:"round",join:"round"}},LIFECYCLE:{casing:{alpha:0},stroke:{dash:[7,3],cap:"butt"}},red:{fill:{color:14708319,alpha:.3}},green:{fill:{color:9228383,alpha:.3}},blue:{fill:{color:7853278,alpha:.3}},yellow:{fill:{color:16777108,alpha:.25}},gold:{fill:{color:12893721,alpha:.3}},orange:{fill:{color:14059546,alpha:.3}},pink:{fill:{color:14918901,alpha:.3}},teal:{fill:{color:10084778,alpha:.3}},lightgreen:{fill:{color:12511295,alpha:.3}},tan:{fill:{color:16112826,alpha:.3}},darkgray:{fill:{color:9211020,alpha:.5}},lightgray:{fill:{color:11184810,alpha:.3}},motorway:{casing:{width:10,color:7354159},stroke:{width:8,color:13574273}},trunk:{casing:{width:10,color:7354159},stroke:{width:8,color:14495522}},primary:{casing:{width:10,color:7354159},stroke:{width:8,color:16357382}},secondary:{casing:{width:10,color:7354159},stroke:{width:8,color:15987474}},tertiary:{casing:{width:10,color:7354159},stroke:{width:8,color:16775603}},unclassified:{casing:{width:10,color:4473924},stroke:{width:8,color:14535850}},residential:{casing:{width:10,color:4473924},stroke:{width:8,color:16777215}},living_street:{casing:{width:7,color:16777215},stroke:{width:5,color:13421772}},service:{casing:{width:7,color:4473924},stroke:{width:5,color:16777215}},special_service:{casing:{width:7,color:4473924},stroke:{width:5,color:14535850}},track:{casing:{width:7,color:7630703},stroke:{width:5,color:12957087}},pedestrian:{casing:{width:7,color:16777215},stroke:{width:5,color:10061960,dash:[8,8],cap:"butt"}},path:{casing:{width:5,color:14535850},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},footway:{casing:{width:5,color:16777215},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},crossing_marked:{casing:{width:5,color:14535850},stroke:{width:3,color:4998212,dash:[6,3],cap:"butt"}},crossing_unmarked:{casing:{width:5,color:14535850},stroke:{width:3,color:7826026,dash:[6,4],cap:"butt"}},cycleway:{casing:{width:5,color:16777215},stroke:{width:3,color:5810669,dash:[6,6],cap:"butt"}},bridleway:{casing:{width:5,color:16777215},stroke:{width:3,color:14708063,dash:[6,6],cap:"butt"}},corridor:{casing:{width:5,color:16777215},stroke:{width:3,color:9228383,dash:[2,8],cap:"round"}},steps:{casing:{width:5,color:16777215},stroke:{width:3,color:8507996,dash:[3,3],cap:"butt"}},river:{fill:{color:7853278,alpha:.3},casing:{width:10,color:4473924},stroke:{width:8,color:7855581}},stream:{fill:{color:7853278,alpha:.3},casing:{width:7,color:4473924},stroke:{width:5,color:7855581}},ridge:{stroke:{width:2,color:9228383}},runway:{casing:{width:10,color:0,cap:"butt"},stroke:{width:8,color:16777215,dash:[24,48],cap:"butt"}},taxiway:{casing:{width:7,color:4473924},stroke:{width:5,color:16776960}},railway:{casing:{width:7,color:5592405,cap:"butt"},stroke:{width:2,color:15658734,dash:[12,12],cap:"butt"}},ferry:{casing:{alpha:0},stroke:{width:3,color:5810669,dash:[12,8],cap:"butt"}},boundary:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:16777215,dash:[20,5,5,5],cap:"butt"}},boundary_park:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:11592344,dash:[20,5,5,5],cap:"butt"}},barrier:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_wall:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_hedge:{fill:{color:9228383,alpha:.3},casing:{alpha:0},stroke:{width:3,color:9228383,dash:[10,5,2,5],cap:"round"}},tree_row:{casing:{width:7,color:4473924},stroke:{width:5,color:9228383}},construction:{casing:{width:10,color:16777215},stroke:{width:8,color:16542740,dash:[10,10],cap:"butt"}},pipeline:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[80,2],cap:"butt"}},roller_coaster:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[10,1],cap:"butt"}}},Cs={aeroway:{runway:"runway",taxiway:"taxiway"},amenity:{childcare:"yellow",college:"yellow",fountain:"blue",kindergarten:"yellow",parking:"darkgray",research_institute:"yellow",school:"yellow",university:"yellow"},building:{"*":"red"},barrier:{city_wall:"barrier_wall",hedge:"barrier_hedge",retaining_wall:"barrier_wall",wall:"barrier_wall","*":"barrier"},boundary:{protected_area:"boundary_park",national_park:"boundary_park","*":"boundary"},crossing:{marked:"crossing_marked",traffic_signals:"crossing_marked",uncontrolled:"crossing_marked",zebra:"crossing_marked","*":"crossing_unmarked"},golf:{green:"lightgreen"},highway:{bridleway:"bridleway",bus_guideway:"railway",busway:"special_service",corridor:"corridor",construction:"construction",cycleway:"cycleway",footway:"footway",living_street:"living_street",living_street_link:"living_street",motorway:"motorway",motorway_link:"motorway",path:"path",pedestrian:"pedestrian",primary:"primary",primary_link:"primary",residential:"residential",residential_link:"residential",secondary:"secondary",secondary_link:"secondary",service:"service",service_link:"service",steps:"steps",tertiary:"tertiary",tertiary_link:"tertiary",track:"track",trunk:"trunk",trunk_link:"trunk",unclassified:"unclassified",unclassified_link:"unclassified"},landuse:{cemetery:"lightgreen",commercial:"orange",construction:"gold",farmland:"lightgreen",farmyard:"tan",flowerbed:"green",forest:"green",grass:"green",industrial:"pink",landfill:"orange",meadow:"lightgreen",military:"orange",orchard:"lightgreen",quarry:"darkgray",railway:"darkgray",recreation_ground:"green",residential:"gold",retail:"orange",village_green:"green",vineyard:"lightgreen"},leisure:{garden:"green",golf_course:"green",nature_reserve:"green",park:"green",pitch:"green",swimming_pool:"blue",track:"yellow"},man_made:{adit:"darkgray",breakwater:"barrier_wall",groyne:"barrier_wall",pipeline:"pipeline"},military:{"*":"orange"},natural:{bare_rock:"darkgray",bay:"blue",beach:"yellow",cave_entrance:"darkgray",cliff:"darkgray",glacier:"lightgray",ridge:"ridge",rock:"darkgray",sand:"yellow",scree:"darkgray",scrub:"yellow",shingle:"darkgray",stone:"darkgray",strait:"blue",tree_row:"tree_row",water:"blue",wetland:"teal","*":"green"},power:{plant:"pink"},railway:{platform:"footway","*":"railway"},roller_coaster:{track:"roller_coaster"},route:{ferry:"ferry"},sport:{baseball:"yellow",basketball:"darkgray",beachvolleyball:"yellow",skateboard:"darkgray",softball:"yellow"},type:{waterway:"river"},waterway:{river:"river",dam:"DEFAULTS",weir:"DEFAULTS","*":"stream"},service:{alley:"special_service",driveway:"special_service","drive-through":"special_service",parking_aisle:"special_service","*":"special_service"}};function Es(e){var b,m,g,w,v,k,C,I,j,N,V,$;const t=qe.DEFAULTS,n={};for(const S of e)n[S["@_k"]]=S["@_v"];let s=t,o=999,r;for(const[S,M]of Object.entries(n)){const P=Cs[S];if(!P||!M||S==="service"&&n.highway===void 0)continue;const D=P[M]??P["*"];let q=Object.keys(P).length;if(Ce.has(M)&&(q=999),D&&q<=o){const X=qe[D];if(!X){console.error(`invalid styleID: ${D}`);continue}if(s=X,o=q,r=S,o===1)break}}let i=!1;for(const[S,M]of Object.entries(n))if(Ce.has(S)&&M!=="no"){i=!0;break}else if((!r||S===r)&&Ce.has(M)){i=!0;break}else if(!r&&ks.test(S)&&M!=="no"){i=!0;break}const l={};for(const S of["fill","casing","stroke"]){l[S]={};const M=(b=s[S])==null?void 0:b.width;if(M!==void 0&&typeof M=="number")l[S].width=M;else{const O=(m=t[S])==null?void 0:m.width;O!==void 0&&(l[S].width=O)}const P=(g=s[S])==null?void 0:g.color;if(P!==void 0&&typeof P=="number")l[S].color=P;else{const O=(w=t[S])==null?void 0:w.color;O!==void 0&&(l[S].color=O)}const D=(v=s[S])==null?void 0:v.alpha;if(D!==void 0&&typeof D=="number")l[S].alpha=D;else{const O=(k=t[S])==null?void 0:k.alpha;O!==void 0&&(l[S].alpha=O)}const q=(C=s[S])==null?void 0:C.cap;if(q!==void 0&&typeof q=="string")l[S].cap=q;else{const O=(I=t[S])==null?void 0:I.cap;O!==void 0&&(l[S].cap=O)}const X=(j=s[S])==null?void 0:j.join;if(X!==void 0&&typeof X=="string")l[S].join=X;else{const O=(N=t[S])==null?void 0:N.join;O!==void 0&&(l[S].join=O)}const J=(V=s[S])==null?void 0:V.dash;if(J!==void 0&&Array.isArray(J))l[S].dash=J;else{const O=($=t[S])==null?void 0:$.dash;O!==void 0&&(l[S].dash=O)}}const d=n.bridge,c=n.cutting,p=n.embankment,u=n.highway,f=n.tracktype,x=n.tunnel;let y=n.surface;if(u==="track"&&f!=="grade1"&&(y=y||"dirt"),(d||p||c)&&(l.casing.width=(l.casing.width||0)+7,l.casing.color=0,l.casing.cap="butt",(p||c)&&(l.casing.dash=[2,4])),x&&(l.stroke.alpha=.5),y&&u&&vs.has(u)&&!Ns.surface[y]&&(d||(l.casing.color=13421772),l.casing.cap="butt",l.casing.dash=[4,4]),i){const S=qe.LIFECYCLE;for(const M of["fill","casing","stroke"])if(S[M])for(const[P,D]of Object.entries(S[M]))l[M][P]=D}return l}const xt=35;function Ms({line:e,nodePath:t,mapViewStatus:{viewpoint:n,zoom:s,width:o,height:r},status:{visible:i,hovered:l,selected:d,highlighted:c},layerRef:p,...u}){const f=s>=16&&i,x=t.map(j=>Qe({lon:j["@_lon"],lat:j["@_lat"]},n,s,o,r)),y=h.useRef(null),b=h.useRef(null),m=Es(L(e.tag)),g=h.useMemo(()=>{var $;const j=Math.max(3,(($=m==null?void 0:m.casing)==null?void 0:$.width)||0),N=x.flatMap(S=>[S.x,S.y]),V={alignment:.5,color:0,width:j+10,alpha:1,join:je.BEVEL,cap:_e.BUTT};return gs(N,V)},[x,m]),w=h.useCallback(j=>{j.clear();const N=m.casing||{};N.dash?j=new le(j,{dash:N.dash,color:N.color,width:N.width,alpha:N.alpha||1,join:we(N.join),cap:be(N.cap)}):j.lineStyle({color:N.color,width:N.width,alpha:N.alpha||1,join:we(N.join),cap:be(N.cap)});const[V,...$]=x;j.moveTo(V.x,V.y),$.forEach(S=>{j.lineTo(S.x,S.y)})},[x,m.casing]),v=h.useCallback(j=>{j.clear();const N=m.stroke||{};N.dash?j=new le(j,{dash:N.dash,color:N.color,width:N.width,alpha:N.alpha||1,join:we(N.join),cap:be(N.cap)}):j.lineStyle({color:N.color,width:N.width,alpha:N.alpha||1,join:we(N.join),cap:be(N.cap)});const[V,...$]=x;j.moveTo(V.x,V.y),$.forEach(S=>{j.lineTo(S.x,S.y)})},[x,m]),k=h.useCallback(()=>{y.current&&g.perimeter&&(y.current.hitArea=new Pt(g.perimeter))},[y,g]);h.useEffect(()=>{const j=y.current;if(j!==null){const N=()=>{k()},V=()=>{const $=f&&l,S=f&&d,M=f&&c;if($){if(!j.filters){const P=new Ee({distance:15,outerStrength:3,color:16776960});P.resolution=2,j.filters=[P]}}else if(M){if(!j.filters){const P=new Ee({distance:15,outerStrength:3,color:7377663});P.resolution=2,j.filters=[P]}}else j.filters&&(j.filters=null);if(S&&p.current){b.current||(b.current=new Lt,p.current.addChild(b.current));const P={alpha:.9,dash:[6,3],width:2,color:16711680};b.current.clear();const D=new le(b.current,P);g&&(g.outer&&g.inner?(D.drawPolygon(g.outer),D.drawPolygon(g.inner)):D.drawPolygon(g.perimeter))}else b.current&&(b.current.destroy({children:!0}),b.current=null)};N(),V()}},[c,l,d,f,k,g,p]),h.useEffect(()=>()=>{b.current&&(b.current.destroy({children:!0}),b.current=null)},[]);const C=js(L(e.tag)),I=Ss(L(e.tag));return a.jsxs(K.Container,{visible:f,position:{x:0,y:0},ref:y,...u,children:[a.jsx(K.Graphics,{draw:w}),a.jsx(K.Graphics,{draw:v}),C&&mt(x.map(j=>[j.x,j.y]),xt,!1,!0).map((j,N)=>j.coords.map(([V,$],S)=>a.jsx(K.Sprite,{eventMode:"none",width:8,height:8,texture:ft,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:V,y:$},rotation:j.angle,tint:0},`${N}-${S}`))).flat(),I&&mt(x.map(j=>[j.x,j.y]),xt,!0,!0).map((j,N)=>j.coords.map(([V,$],S)=>a.jsx(K.Sprite,{eventMode:"none",width:8,height:8,texture:ft,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:V,y:$},rotation:j.angle,tint:0},`${N}-${S}`))).flat()]})}function fe(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="platform")&&e.some(t=>t["@_k"]==="highway"&&t["@_v"]==="bus_stop")}function tt(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="stop_position")&&e.some(t=>t["@_k"]==="name")&&e.some(t=>t["@_k"]==="bus")}function se(e){var t;return e=e||[],(t=e.find(n=>n["@_k"]==="name"))==null?void 0:t["@_v"]}function Oe(e){if(e){if(fe(e))return"Bus Stop";if(tt(e))return"Stop Position"}}function Ts({node:e,mapViewStatus:{width:t,height:n,viewpoint:s,zoom:o},status:{visible:r,hovered:i,selected:l,highlighted:d},layerRef:c,...p}){const u=o>=16&&r,f=h.useRef(null),x=h.useRef(null),y=fe(L(e.tag)),b="dot",m=Qe({lon:e["@_lon"],lat:e["@_lat"]},s,o,t,n);return h.useEffect(()=>{const g=f.current;if(g){const w=()=>{if(!u)return;const k=20,C=g.getLocalBounds().clone();{let I=C.width/2;I<k/2&&(I=k/2),I=I+2;const j=new ut(0,0,I);g.hitArea=j}},v=()=>{const k=u&&i,C=u&&d,I=u&&l;if(k){if(!g.filters){const j=new Ee({distance:15,outerStrength:3,color:16776960});j.resolution=2,g.filters=[j]}}else if(C){if(!g.filters){const j=new Ee({distance:15,outerStrength:3,color:7377663});j.resolution=2,g.filters=[j]}}else g.filters&&(g.filters=null);if(I&&c.current){console.log("show select"),x.current||(x.current=new Lt,c.current.addChild(x.current));const j={alpha:.9,dash:[6,3],width:3,color:16711680};x.current.clear();const N=g.hitArea;N instanceof ut?(new le(x.current,j).drawCircle(N.x+m.x,N.y+m.y,N.radius,20),console.log(x.current)):N instanceof mo&&new le(x.current,j).drawRect(N.x+m.x,N.y+m.y,N.width,N.height)}else x.current&&(x.current.destroy({children:!0}),x.current=null)};w(),v()}},[o,d,i,u,b,l,c,m]),h.useEffect(()=>()=>{x.current&&(x.current.destroy({children:!0}),x.current=null)},[]),h.useEffect(()=>{const g=f.current;g&&(o<16||(o<17?g.scale.set(.8,.8):g.scale.set(1,1)))},[o]),o<16?null:a.jsxs(K.Container,{...p,position:m,visible:u,ref:f,children:[a.jsx(K.Sprite,{eventMode:"none",sortableChildren:!1,visible:!0,texture:bs,anchor:{x:.5,y:.5},width:y?16:8,height:y?16:8}),y&&a.jsx(K.Sprite,{eventMode:"none",texture:ws,anchor:{x:.5,y:.5},width:11,height:11})]})}const As=h.forwardRef(function({view:{width:t,height:n,viewpoint:s,zoom:o},meta:{node:r,way:i},pointRenderer:l,wayRenderer:d,...c},p){const{left:u,bottom:f,right:x,top:y}=h.useMemo(()=>Bt(s,o,t,n),[s,o,t,n]),b=h.useCallback(({"@_lon":m,"@_lat":g})=>u<=m&&m<=x&&f<=g&&g<=y,[u,f,x,y]);return o<16?null:a.jsxs(K.Container,{ref:p,...c,children:[Object.values(i).filter(m=>m.nd.map(g=>r[g["@_ref"]]).some(b)).map(d),Object.values(r).filter(b).map(l)]})});function Is({selectionRect:e}){if(!e)return null;const{from:t,to:n}=e,s=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);return a.jsx(K.Graphics,{draw:l=>{l.clear(),l.beginFill(16753920,.5),l.drawRect(s,o,r,i),l.endFill()}})}function Rs({node:e,stateMachine:t,...n}){const s=e["@_localStates"],o=e["@_id"];return a.jsx(Ts,{...n,node:e,status:s,eventMode:"static",mousedown:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),mouseup:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerover:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerout:r=>t.transform({...r,componentTarget:{id:o,type:"node"}})})}function Ps({way:e,node:t,stateMachine:n,...s}){const o=e["@_localStates"],r=e["@_id"],i=h.useMemo(()=>e.nd.map(l=>t[l["@_ref"]]),[t,e.nd]);return a.jsx(Ms,{...s,line:e,nodePath:i,status:o,eventMode:"static",pointerover:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),pointerout:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mousedown:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mouseup:l=>n.transform({...l,componentTarget:{id:r,type:"way"}})})}function en({width:e,height:t,stateMachine:n}){const[s,o,r]=Y(B(c=>[c.viewpoint,c.zoom,c.selectionRect])),{node:i,way:l}=E(c=>c.meta),d=h.useRef(null);return a.jsxs(a.Fragment,{children:[a.jsx(As,{view:{viewpoint:s,zoom:o,width:e,height:t},meta:{node:i,way:l},ref:d,wayRenderer:c=>a.jsx(Ps,{way:c,node:i,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:d},c["@_id"]),pointRenderer:c=>a.jsx(Rs,{node:c,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:d},c["@_id"])}),a.jsx(Is,{selectionRect:r})]})}function tn(e,t,n){const s={"?xml":{"@_version":"1.0","@_encoding":"UTF-8"},osm:{bounds:{"@_minlat":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlat"]),1/0),"@_minlon":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlon"]),1/0),"@_maxlat":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlat"]),-1/0),"@_maxlon":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlon"]),-1/0),"@_origin":"v0.0.2-BusFensi"},node:Object.values({...e.node,...t.node}),way:Object.values({...e.way,...t.way}),relation:Object.values({...e.relation,...t.relation}),"@_version":.6,"@_generator":"BusFensi"}};console.log(s,e);const r=new Rt.XMLBuilder({ignoreAttributes:["localStates"],attributeNamePrefix:"@_",suppressBooleanAttributes:!1}).build(s);return console.log(r),r}function Ls({stateMachine:e}){const{createLocalWay:t,createLocalRelation:n,deleteFeature:s,selectFeature:o,clearSelect:r,selectedRef:i,meta:l,bbox:d,deletedMeta:c}=E(B(C=>C)),{updateSettingsAction:p,...u}=ae(),[f,x]=h.useState(!1),[y,b]=h.useState(u),m=()=>{const C=i.filter(j=>j.type==="node").map(j=>({"@_ref":j.id})),I=t(C);o("way",I,!1)},g=()=>{const C=i.map(j=>({"@_ref":j.id,"@_type":j.type})),I=n(C);o("relation",I,!1)},w=()=>{const C=pe(i);r(),C.forEach(I=>{if(I.type==="node"||I.type==="way"||I.type==="relation")s(I.type,I.id);else throw new Error(`Type not found ${I.type} for id ${I.id}`)})},v=()=>{const C=tn(l,c,d),I=new Blob([C],{type:"application/xml"}),j=document.createElement("a");j.href=URL.createObjectURL(I),j.download="exported_data.osm",j.click(),URL.revokeObjectURL(j.href)},k=()=>{p(y),x(!1)};return a.jsxs("div",{className:"join",children:[a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node"}),children:"Create Node"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node-on-way"}),children:"Create node on way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"split-way"}),children:"Split way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:m,children:"Create way with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:g,children:"Create relation with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:w,children:"Delete selected"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:v,children:"export josm"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>x(!0),children:"Change Settings"}),f&&a.jsx("div",{className:"modal modal-open",children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:y.osmAPI.BASEURL,onChange:C=>b({...y,osmAPI:{...y.osmAPI,BASEURL:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:y.osmAPI.TILE_SOURCE,onChange:C=>b({...y,osmAPI:{...y.osmAPI,TILE_SOURCE:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:y.view.MAX_ZOOM,onChange:C=>b({...y,view:{...y.view,MAX_ZOOM:parseFloat(C.target.value)}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn",onClick:k,children:"Save"}),a.jsx("button",{className:"btn btn-ghost",onClick:()=>x(!1),children:"Cancel"})]})]})})]})}const Ds=({id:e="drag-bar",dir:t,isDragging:n,...s})=>{const[o,r]=h.useState(!1);return a.jsx("div",{id:e,"data-testid":e,tabIndex:0,className:Z("flex-shrink-0 bg-base-300 transition-colors",t==="horizontal"?"cursor-row-resize h-1":"cursor-col-resize w-1",(n||o)&&"bg-accent"),onFocus:()=>r(!0),onBlur:()=>r(!1),...s})},Ie=({width:e,height:t,children:n,...s})=>{const{axis:o}=s,r=s.initial||(o==="x"?e/2:t/2),{position:i,separatorProps:l,setPosition:d}=gn({...s,initial:r}),c=h.useRef(o==="x"?e:t);let p={},u={};return o==="x"?(p={width:i,height:t},u={width:e-i,height:t}):(p={width:e,height:i},u={width:e,height:t-i}),h.useEffect(()=>{o==="x"&&e!==c.current?(d(i*(e/c.current)),c.current=e):o==="y"&&t!==c.current&&(d(i*(t/c.current)),c.current=t)},[e,t,c,o,d,i]),a.jsxs("div",{style:{width:e,height:t,display:"flex",flexDirection:o==="x"?"row":"column",position:"relative"},children:[a.jsx("div",{style:p,children:n[0]({width:p.width,height:p.height})}),a.jsx(Ds,{...l,dir:o==="x"?"vertical":"horizontal",isDragging:!1}),a.jsx("div",{style:u,children:n[1]({width:u.width,height:u.height})})]})};function Be({id:e,filter:t}){const n=E(B(f=>f.meta.node[e])),s=E(B(f=>{var x;return(x=f.meta.node[e])==null?void 0:x["@_localStates"]})),o=E(f=>f.selectFeature);if(!n||!t(n,"node")||!s)return null;const{visible:r,selected:i}=s;let l=`node-${e}`,d=Ze;const c=L(n.tag);c.forEach(f=>{f["@_k"]==="name"&&(l=f["@_v"])}),fe(c)&&(d=Rn);const p=`outline-list-item
    ${r?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,u=f=>{o("node",e,!f.shiftKey)};return a.jsx("li",{className:p,children:a.jsxs("span",{className:i?"active":"",onClick:u,children:[a.jsx(T,{icon:d}),l]})})}function nt({id:e,filter:t}){const n=E(B(m=>Object.keys(m.meta.node))),s=E(B(m=>m.meta.way[e])),o=E(m=>m.selectFeature),r=E(B(m=>{var g;return(g=m.meta.way[e])==null?void 0:g["@_localStates"]})),[i,l]=h.useState(!0);if(!t(s,"way")||!s||!r)return null;const{visible:d,selected:c}=r,p=L(s.tag);let u=`way-${e}`;p.forEach(m=>{m["@_k"]==="name"&&(u=m["@_v"])});const f=L(s.nd).filter(m=>n.includes(m["@_ref"])),x=`outline-list-item
    ${c?"active":d?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,y=m=>{o("way",e,!m.shiftKey)},b=m=>{m.stopPropagation(),l(!i)};return a.jsxs("li",{className:x,children:[a.jsxs("span",{className:`flex flex-row ${c?"bg-neutral text-neutral-content ":""}`,onClick:y,children:[a.jsx(T,{icon:i?Pe:Le,onClick:b}),a.jsx(T,{icon:jt,className:"ml-2 "}),a.jsx("span",{className:"ml-0 mr-auto",children:u})]}),!i&&a.jsx("ul",{className:"menu menu-xs pl-4",children:f.map(m=>a.jsx(Be,{id:m["@_ref"],filter:t},m["@_ref"]))})]})}function ot({id:e,filter:t}){const n=E(B(w=>w.meta.relation[e])),s=E(w=>w.selectFeature),o=E(B(w=>{var v;return(v=w.meta.relation[e])==null?void 0:v["@_localStates"]})),[r,i]=h.useState(!0);if(!t(n,"relation")||!n||!o)return null;const{visible:l,selected:d}=o;let c=`relation-${e}`;L(n.tag).forEach(w=>{w["@_k"]==="name"&&(c=w["@_v"])});const u=`outline-list-item
    ${d?"active":l?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,f=L(n.member),x=f.filter(w=>w["@_type"]==="node"),y=f.filter(w=>w["@_type"]==="way"),b=f.filter(w=>w["@_type"]==="relation"),m=w=>{s("relation",e,!w.shiftKey)},g=w=>{w.stopPropagation(),i(!r)};return a.jsxs("li",{className:u,children:[a.jsxs("span",{className:`flex flex-row ${d?"bg-neutral text-neutral-content ":""}`,onClick:m,children:[a.jsx(T,{icon:r?Pe:Le,onClick:g}),a.jsx(T,{className:"ml-2",icon:Pn}),c]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[x.map(w=>a.jsx(Be,{id:w["@_ref"],filter:t},w["@_ref"])),y.map(w=>a.jsx(nt,{id:w["@_ref"],filter:t},w["@_ref"])),b.map(w=>a.jsx(ot,{id:w["@_ref"],filter:t},w["@_ref"]))]})]})}function Xe({collecion:e,name:t,filterFun:n}){const{node:s,way:o,relation:r}=e,{roots:i}=E(u=>u.tree),[l,d]=h.useState(!0),c=u=>{u.stopPropagation(),d(!l)},p=(u,f)=>u&&(f==="node"&&s[u["@_id"]]||f==="way"&&o[u["@_id"]]||f==="relation"&&r[u["@_id"]])&&n(u,f);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(T,{icon:l?Pe:Le,onClick:c}),a.jsx(T,{icon:St,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:t})]}),!l&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...ne(i.node)].map(u=>a.jsx(Be,{id:u,filter:p},u)),[...ne(i.way)].map(u=>a.jsx(nt,{id:u,filter:p},u)),[...ne(i.relation)].map(u=>a.jsx(ot,{id:u,filter:p},u))]})]})}function Fs({name:e,filterFun:t}){const{node:n,way:s,relation:o}=E(c=>c.collections.global),[r,i]=h.useState(!0),l=c=>{c.stopPropagation(),i(!r)},d=(c,p)=>c&&t(c,p)&&(p==="node"&&n[c["@_id"]]||p==="way"&&s[c["@_id"]]||p==="relation"&&o[c["@_id"]]);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(T,{icon:r?Pe:Le,onClick:l}),a.jsx(T,{icon:St,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...ne(n)].map(c=>a.jsx(Be,{id:c,filter:d},c)),[...ne(s)].map(c=>a.jsx(nt,{id:c,filter:d},c)),[...ne(o)].map(c=>a.jsx(ot,{id:c,filter:d},c))]})]})}function Os({width:e,height:t}){const{ptv2:n,highway:s,created:o}=E(d=>d.collections),[r,i]=h.useState(""),l=(d,c)=>r===""||`${c}-${JSON.stringify(d)}`.includes(r);return a.jsxs("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"outline-view flex flex-col p-1 rounded bg-base-100 overflow-x-scroll",children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2",children:[a.jsx(T,{icon:Ln}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:r,onChange:d=>i(d.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 overflow-scroll mt-1 rounded",children:a.jsxs("ul",{className:"menu menu-xs bg-base-200",children:[a.jsx(Xe,{name:"Public Transport",collecion:n,filterFun:l}),a.jsx(Xe,{name:"Highway",collecion:s,filterFun:l}),a.jsx(Xe,{name:"Created",collecion:o,filterFun:l}),a.jsx(Fs,{name:"Global",filterFun:l})]})})]})}const gt=h.memo(({initialValue:e,onCommit:t,...n})=>{const[s,o]=h.useState(e||"");return h.useEffect(()=>{o(e||"")},[e]),a.jsx("input",{...n,value:s,onChange:r=>o(r.target.value),onKeyDown:r=>{r.key==="Enter"&&r.currentTarget.blur(),r.stopPropagation()},onBlur:()=>{t(s)}})});function st({tags:e,setTags:t,commitChange:n}){const s=pe(e),o=(d,c)=>{n(),s[d]["@_k"]=c,t([...s])},r=(d,c)=>{n(),s[d]["@_v"]=c,t([...s])},i=d=>{const c=s.filter((p,u)=>u!==d);n(),t(c)},l=()=>{n(),t([...s,{"@_k":"","@_v":""}])};return a.jsxs("table",{className:"table table-xs w-full max-w-full overflow-x-scroll",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Key"}),a.jsx("th",{children:"Value"}),a.jsx("th",{children:"Actions"})]})}),a.jsx("tbody",{children:s.map((d,c)=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsx(gt,{type:"text",initialValue:d["@_k"],onCommit:p=>o(c,p),className:"input input-bordered input-xs rounded-md border max-w-xs"})}),a.jsx("td",{children:a.jsx(gt,{type:"text",initialValue:d["@_v"],onCommit:p=>r(c,p),className:"input input-bordered input-xs rounded-md border max-w-xs w-fit"})}),a.jsx("td",{children:a.jsx("button",{onClick:()=>i(c),className:"btn btn-error btn-xs",children:a.jsx(T,{icon:Dn})})})]},c))}),a.jsx("tfoot",{children:a.jsx("tr",{children:a.jsx("td",{colSpan:3,className:"flex gap-2",children:a.jsx("button",{onClick:l,className:"btn btn-primary btn-sm",children:"Add"})})})})]})}function at({meta:e}){const t=ne(e).filter(n=>{const s=e[n];return n.startsWith("@_")&&(typeof s=="string"||typeof s=="number")});return a.jsx("ul",{className:"menu menu-xs bg-200 rounded-box",children:t.map(n=>{const s=e[n];return a.jsx("li",{children:a.jsxs("span",{className:"select-text",children:[a.jsx("span",{className:"font-semibold",children:String(n).substring(2)}),a.jsx("span",{className:"ml-auto text-base-content",children:s.toString()})]})},n)})})}function nn({id:e,type:t}){const n=E(l=>l.selectFeature),{relation:s,way:o}=E(B(l=>l.meta)),r=ne(s).filter(l=>Object.prototype.hasOwnProperty.call(s,l)).map(l=>s[l]),i=(l,d)=>{n("relation",d,!l.shiftKey)};return a.jsx("ul",{className:"menu menu-xs",children:r.filter(l=>L(l.member).some(d=>d["@_ref"]===e&&d["@_type"]===t||t==="node"&&(d["@_type"]==="way"&&o[d["@_ref"]]&&L(o[d["@_ref"]].nd).some(c=>String(c["@_ref"])===e)||d["@_type"]==="relation"&&s[d["@_ref"]]&&L(s[d["@_ref"]].member).some(c=>c["@_ref"]===e)))).map(l=>a.jsx("li",{onClick:d=>i(d,l["@_id"]),children:z("name",l.tag)||l["@_id"]},l["@_id"]))})}function rt({id:e,type:t}){const n=E(B(s=>s.meta[t][e]["@_localStates"]));return a.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(n).filter(([,s])=>s).map(([s])=>a.jsx("span",{className:"badge badge-info badge-xs",children:s},s))})}function Bs({id:e}){const t=E(B(o=>o.meta.node[e])),n=E(o=>o.modifyFeatureMetaNC),s=E(o=>o.commit);return t?a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Node] ",se(t.tag)||t["@_id"]]}),a.jsx(rt,{id:e,type:"node"}),a.jsx(at,{meta:t}),a.jsx(st,{tags:L(t.tag),setTags:o=>{n("node",e,r=>r.tag=o)},commitChange:s}),a.jsx(nn,{id:e,type:"node"})]}):null}function de({featuretype:e,metatype:t,fullname:n,id:s,created:o,deleted:r,modified:i,children:l}){let d;switch(e){case"node":d=Hn;break;case"way":d=jt;break;case"relation":d=$n;break;default:d=Bn}return a.jsxs(a.Fragment,{children:[a.jsx("span",{children:a.jsx(T,{icon:d})}),a.jsx("span",{className:"font-semibold",children:n||"[untitled]"}),t&&a.jsx("span",{className:"badge badge-xs h-fit badge-outline text-nowrap",children:t}),a.jsx("div",{className:"badge badge-xs h-fit badge-outline",children:s}),a.jsxs("div",{className:"flex space-x-1",children:[o&&a.jsx("div",{className:"badge badge-xs badge-success tooltip tooltip-bottom","data-tip":"Created",children:a.jsx(T,{icon:Fn})}),i&&a.jsx("div",{className:"badge badge-xs badge-warning tooltip tooltip-bottom","data-tip":"Modified",children:a.jsx(T,{icon:On})}),r&&a.jsx("div",{className:"badge badge-xs badge-error tooltip tooltip-bottom","data-tip":"Deleted",children:a.jsx(T,{icon:Nt})})]}),a.jsx("span",{className:"flex items-center ml-auto",children:l})]})}function $s(e){return a.jsxs("li",{children:[" ",a.jsx("span",{className:"flex select-text justify-between items-center rounded",children:a.jsx(de,{...e})})]})}function on(e){return e=e||[],z("public_transport",e)==="stop_area"&&z("type",e)==="public_transport"}function $e(e){if(e&&on(e))return"Stop Area"}function sn({member:e,memberToId:t,children:n,slotSelection:s}){const[o,r]=h.useState(new Set);h.useEffect(()=>{r(d=>{const c=new Set;return e.forEach(p=>{d.has(t(p))&&c.add(t(p))}),c})},[e,t]);const i=()=>{o.size===e.length?r(new Set):r(new Set(e.map(t)))},l=h.useMemo(()=>{const d=c=>{r(p=>{const u=new Set(p);return u.has(c)?u.delete(c):u.add(c),u})};return({m:c})=>a.jsx(a.Fragment,{children:a.jsx("input",{type:"checkbox",className:"checkbox ml-2",checked:o.has(t(c)),onChange:()=>d(t(c))})})},[o,t]);return a.jsxs(a.Fragment,{children:[s({selected:o,children:a.jsx("input",{type:"checkbox",checked:o.size===e.length,onChange:i,className:"checkbox ml-2"})}),n({member:e,memberToId:t,slot:l})]})}function Hs({id:e,type:t}){const n=E(o=>o.meta[t][e]),s=h.useMemo(()=>{var o;if((o=n==null?void 0:n.tag)!=null&&o.length){if(t==="node")return Oe(n.tag);if(t==="relation")return $e(n.tag)}},[n==null?void 0:n.tag,t]);return a.jsx(de,{featuretype:t,id:e,metatype:s,fullname:se(n.tag),created:Number(n["@_id"])<0,deleted:n["@_action"]==="delete",modified:n["@_action"]==="modify"})}function it({handelInsertTop:e,handelIntertBottom:t,handelInsertAtActive:n}){const s=E(B(d=>d.selectedRef)),o=h.useCallback(d=>`${d.type}-${d.id}`,[]),r=h.useRef(new Set),i=()=>s.filter(d=>r.current.has(o(d))),l=h.useCallback(({member:d,memberToId:c,slot:p})=>d.map(u=>a.jsxs("div",{className:"flex flex-row gap-1 px-2 mt-1",children:[a.jsx(Hs,{...u}),p({m:u})]},c(u))),[]);return a.jsxs("div",{className:"flex flex-row justify-center p-2 rounded-md",children:[a.jsxs("div",{className:"join join-vertical mr-2",children:[a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{e(i())},children:"InsTop"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{n(i())},children:"InsAct"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{t(i())},children:"InsBtm"})]}),a.jsx("div",{className:"bg-base-200 text-xs rounded max-h-full",children:a.jsx(sn,{member:s,memberToId:o,slotSelection:({selected:d,children:c})=>(r.current=d,a.jsxs("div",{className:"flex flex-row px-2 py-1",children:[a.jsx("h3",{className:"text text-sm font-semibold",children:"selected Items to insert"}),a.jsx("div",{className:"ml-auto"}),c]})),children:l})})]})}function Ws({id:e,element:t="div",children:n,style:s,...o}){const{attributes:r,listeners:i,setNodeRef:l,transform:d,transition:c}=bn({id:e}),p={transform:wn.Transform.toString(d),transition:c,...s};return a.jsxs(t,{ref:l,className:"flex flex-row bg-base-200 rounded border pl-1",style:p,...o,children:[a.jsx("button",{...i,...r,className:"btn btn-ghost btn-xs my-auto inline-block",children:a.jsx(T,{icon:vt.faGripVertical})}),n]})}function Vs({memberToId:e,member:t,onDragEnd:n,onDragStart:s,children:o}){const r=yn(ct(En),ct(Cn,{coordinateGetter:kn})),[i,l]=h.useState(),d=h.useMemo(()=>t.map(f=>({id:e(f),member:f})),[t,e]);function c(f){var b;const{active:x}=f;console.debug("drag memeber start:",x);const y=(b=d.find(m=>m.id===x.id))==null?void 0:b.member;if(!y)throw new Error(`in Drag list got invalid active object ${JSON.stringify(x)}`);l(y),s(y)}function p(f){const{active:x,over:y}=f;if(console.debug("drag memeber end:",x,y),y&&x.id!==y.id){const b=d.findIndex(g=>g.id===x.id),m=d.findIndex(g=>g.id===y.id);n(Mn(d,b,m).map(g=>g.member))}l(void 0)}const u=h.useCallback(({id:f,member:x})=>a.jsx(Ws,{id:f,children:o({member:x})},f),[o]);return a.jsxs(_n,{sensors:r,collisionDetection:jn,onDragStart:c,onDragEnd:p,children:[a.jsx(Sn,{items:d,strategy:Nn,children:d.map(u)}),a.jsx(vn,{children:i?a.jsxs("div",{className:"flex bg-base-200 rounded-sm pl-1",children:[a.jsx("button",{className:"btn btn-ghost btn-xs my-auto",children:a.jsx(T,{icon:vt.faGripVertical})}),o({member:i,isDragOverlay:!0})]}):null})]})}function Us({member:e,isDragOverlay:t,slot:n,children:s}){return a.jsx(a.Fragment,{children:s({member:e,children:n({m:e}),overlay:t})})}function an({member:e,memberToId:t,children:n,slotSelection:s,...o}){const r=h.useCallback(({member:i,memberToId:l,slot:d})=>a.jsx(Vs,{...o,member:i,memberToId:l,children:c=>a.jsx(Us,{...c,slot:d,children:n})}),[n,o]);return a.jsx(sn,{member:e,memberToId:t,slotSelection:s,children:r})}function rn({onDelete:e,member:t,memberToId:n,...s}){const o=E(x=>x.loadFeatureBatch),r=ae(x=>x.osmAPI.BASEURL),[i,l]=h.useState(!1),d=h.useRef(1),c=h.useCallback(()=>d.current++,[d]),p=h.useMemo(()=>t.map(x=>({...x,uniqueIdentifier:c()})),[c,t]),u=h.useCallback(x=>`${n(x)}_AT_LIST_${x.uniqueIdentifier}`,[n]),f=h.useCallback(({selected:x,children:y})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:b=>{b.stopPropagation();const m=p.filter(g=>!x.has(u(g)));e(p,m)},children:a.jsx(T,{icon:kt.faDeleteLeft})}),a.jsx("button",{className:"btn btn-square btn-xs btn-accent tooltip tooltip-bottom","data-tip":"Download selected member of this list",disabled:i,onMouseDown:async b=>{b.stopPropagation(),l(!0),await o(p.filter(m=>x.has(u(m))).map(m=>m["@_type"]?{type:m["@_type"],id:m["@_ref"]}:{type:"node",id:m["@_ref"]}),r),l(!1)},children:i?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx(T,{icon:Wn.faDownload})}),y]}),[r,o,p,u,e,i,l]);return a.jsx(an,{...s,member:p,memberToId:u,slotSelection:f})}function ln({type:e,id:t,showMetaType:n,children:s}){var g,w,v;const[o,r,i,l]=E(B(k=>[k.meta[e][t],k.selectFeatureWithoutActive,k.unSelectFeature,k.loadFeature])),d=ae(k=>k.osmAPI.BASEURL),c=Y(k=>k.setViewpoint),p=h.useMemo(()=>{var k;if(n&&((k=o==null?void 0:o.tag)!=null&&k.length)){if(e==="node")return Oe(o.tag);if(e==="relation")return $e(o.tag)}},[n,o==null?void 0:o.tag,e]),[u,f]=h.useState(!1),x=h.useCallback(async()=>{f(!0),await l(e,t,d),f(!1)},[l,e,t,d]),y=h.useCallback(k=>{if(k.stopPropagation(),e==="node"){const C=o;c({lat:C["@_lat"],lon:C["@_lon"]})}},[o,c,e]),b=h.useCallback(k=>{var C;k.stopPropagation(),(C=o["@_localStates"])!=null&&C.selected?i(e,t):r(e,t,!1)},[t,o,r,e,i]),m=h.useCallback(k=>{k.stopPropagation(),x()},[x]);return o?a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(de,{featuretype:e,id:t,metatype:p,fullname:se(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:y,children:a.jsx(T,{icon:Ct.faLocationDot})}),a.jsx("button",{className:Z("btn btn-xs btn-square tooltip tooltip-bottom",((g=o["@_localStates"])==null?void 0:g.selected)&&"btn-accent"),"data-tip":(w=o["@_localStates"])!=null&&w.selected?"Unselect":"Select",onClick:b,children:a.jsx(T,{icon:(v=o["@_localStates"])!=null&&v.selected?Et.faXmarkCircle:Mt.faCheckCircle})}),s&&s({type:e,id:t})]})}):a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(de,{featuretype:e,id:t,fullname:"[not downloaded]",children:[u?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx("button",{className:"btn btn-square btn-xs btn-success tooltip tooltip-bottom","data-tip":"Download feature",onMouseDown:m,children:a.jsx(T,{icon:Vn})}),s&&s({type:e,id:t})]})})}function qs({id:e}){const t=E(B(b=>b.meta.way[e])),n=E(b=>b.modifyFeatureMetaNC),s=E(b=>b.commit),[o,r]=h.useState(void 0),i=h.useCallback(({member:b,children:m})=>a.jsx(ln,{id:b["@_ref"],type:"node",children:()=>{const g=(o==null?void 0:o.id)===b["@_ref"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Z("btn btn-square btn-xs tooltip tooltip-bottom",g&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:w=>{w.stopPropagation(),r(g?void 0:{id:b["@_ref"],type:"node"})},children:a.jsx(T,{icon:g?Tt.faCircle:Je.faCircle})}),m]})}}),[o==null?void 0:o.id]),l=h.useCallback(b=>`nd-${b["@_ref"]}`,[]);if(!t)return null;function d(){s()}function c(b){n("way",e,m=>{m.nd=b})}function p(b){n("way",e,m=>{m.nd=b})}const u=b=>b.filter(m=>m.type==="node").map(m=>({"@_ref":m.id})),f=b=>{console.log("Insert at Top: ",b),s(),n("way",e,m=>{m.nd=[...u(b),...L(t.nd)]})},x=b=>{console.log("Insert at Bottom: ",b),s(),n("way",e,m=>{m.nd=[...L(t.nd),...u(b)]})},y=b=>{if(console.log("Insert at Active: ",b),!o)x(b);else{const m=[...L(t.nd)],g=m.findIndex(w=>w["@_ref"]===o.id);m.splice(g+1,0,...u(b)),s(),n("way",e,w=>{w.nd=m})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Way] ",se(t.tag)||t["@_id"]]}),a.jsx(rt,{id:e,type:"way"}),a.jsx(at,{meta:t}),a.jsx(st,{tags:L(t.tag),setTags:b=>{n("way",e,m=>m.tag=b)},commitChange:s}),a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(rn,{member:t.nd,memberToId:l,onDragStart:d,onDragEnd:c,onDelete:(b,m)=>p(m),children:i})}),a.jsx("div",{className:"",children:a.jsx(it,{handelInsertTop:f,handelIntertBottom:x,handelInsertAtActive:y})})]}),a.jsx(nn,{id:e,type:"way"})]})}const Xs=h.memo(({initialValue:e,onCommit:t})=>{const[n,s]=h.useState(e||"");return h.useEffect(()=>{s(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:n,onChange:o=>s(o.target.value),onKeyDown:o=>{o.key==="Enter"&&o.currentTarget.blur(),o.stopPropagation()},onBlur:()=>{t(n)}})});function Ks({id:e}){const t=E(B(m=>m.meta.relation[e])),n=E(m=>m.modifyFeatureMetaNC),s=E(m=>m.commit),[o,r]=h.useState(void 0),i=h.useCallback((m,g,w)=>{console.debug("edit",m,g,w),s(),n("relation",e,v=>{v.member=L(t.member).map(k=>{if(k["@_type"]===m&&k["@_ref"]===g){const C=pe(k);return C["@_role"]=w,C}return k})})},[s,e,t.member,n]),l=h.useCallback(m=>`${m["@_type"]}-${m["@_ref"]}`,[]),d=h.useCallback(({member:m,children:g})=>a.jsx(ln,{id:m["@_ref"],type:m["@_type"],children:()=>{const w=(o==null?void 0:o.id)===m["@_ref"]&&o.type===m["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Z("btn btn-square btn-xs tooltip tooltip-bottom",w&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:v=>{v.stopPropagation(),r(w?void 0:{id:m["@_ref"],type:m["@_type"]})},children:a.jsx(T,{icon:w?Ze:Je.faCircle})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(Xs,{initialValue:m["@_role"],onCommit:v=>i(m["@_type"],m["@_ref"],v)})]}),g]})}}),[i,o]);if(!t)return null;function c(){s()}function p(m){n("relation",e,g=>{g.member=m})}function u(m){s(),n("relation",e,g=>{g.member=m})}const f=m=>m.map(g=>({"@_ref":g.id,"@_type":g.type})),x=m=>{console.log("Insert at Top: ",m),s(),n("relation",e,g=>{g.member=[...f(m),...L(g.member)]})},y=m=>{console.log("Insert at Bottom: ",m),s(),n("relation",e,g=>{g.member=[...L(g.member),...f(m)]})},b=m=>{if(console.log("Insert at Active: ",m),!o)y(m);else{const g=[...L(t.member)],w=g.findIndex(v=>v["@_ref"]===o.id&&v["@_type"]===o.type);g.splice(w+1,0,...f(m)),s(),n("relation",e,v=>{v.member=g})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Relation] ",se(t.tag)||t["@_id"]]}),a.jsx(rt,{id:e,type:"relation"}),a.jsx(at,{meta:t}),a.jsx(st,{tags:L(t.tag),setTags:m=>{n("relation",e,g=>g.tag=m)},commitChange:s}),a.jsxs("div",{className:"flex flex-row relative",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(rn,{member:t.member,memberToId:l,onDragStart:c,onDragEnd:p,onDelete:(m,g)=>u(g),children:d})}),a.jsx("div",{className:"",children:a.jsx(it,{handelInsertTop:x,handelIntertBottom:y,handelInsertAtActive:b})})]})]})}function cn({width:e,height:t}){const n=E(s=>s.activeRef);return a.jsx("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"property-view flex flex-col rounded bg-base-100",children:n?n.type==="node"?a.jsx(Bs,{id:n.id}):n.type==="way"?a.jsx(qs,{id:n.id}):n.type==="relation"?a.jsx(Ks,{id:n.id}):a.jsxs("div",{children:["Unknown type for item ",JSON.stringify(n)]}):a.jsx("div",{children:"Please active some component to show prop edit view"})})}function Gs(){const e=K.useApp(),t=Y(n=>n.setStageApp);return h.useEffect(()=>(globalThis.__PIXI_APP__=e,e.stage.hitArea=e.screen,t(e),()=>{globalThis.__PIXI_APP__=void 0,t(void 0)}),[e,t]),null}function dn({width:e,height:t,children:n,...s}){const o=Y(r=>r.setStage);return h.useEffect(()=>{o(e,t)},[e,t,o]),a.jsxs(K.Stage,{width:e,height:t,options:{background:"#1099bb"},...s,children:[n,a.jsx(Gs,{})]})}function un({width:e}){return a.jsx("div",{className:"slot-bottom absolute inset-x-0 bottom-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx("span",{className:"text-base-content bg-base-300 px-2 rounded",children:"data©openstreetmap contributor"})})}function Ys({width:e,height:t}){const n=h.useRef(new Co({meta:E,view:Y,settings:ae}));return h.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(dn,{width:e,height:t,options:{background:"#1099bb"},onContextMenu:s=>s.preventDefault(),onMouseDown:s=>{n.current.transform(s)},onPointerMove:s=>{n.current.transform(s)},onMouseUp:s=>{n.current.transform(s)},onWheel:s=>{n.current.transform(s)},children:[a.jsx(Qt,{width:e,height:t}),a.jsx(en,{width:e,height:t,stateMachine:n.current})]}),a.jsx(un,{width:e}),a.jsx("div",{className:"slot-top absolute inset-x-0 top-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx(Ls,{stateMachine:n.current})})]})}function zs({width:e,height:t}){return a.jsxs(Ie,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(Ys,{...n}),n=>a.jsxs(Ie,{...n,axis:"y",children:[s=>a.jsx(Os,{...s}),s=>a.jsx(cn,{...s})]})]})}function Zs({open:e,onClose:t}){const{updateSettingsAction:n,...s}=ae(),[o,r]=h.useState(s),i=E(d=>d.reset),l=()=>{n(o),t()};return a.jsx("div",{className:Z("modal",e&&"modal-open"),children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:o.osmAPI.BASEURL,onChange:d=>r({...o,osmAPI:{...o.osmAPI,BASEURL:d.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:o.osmAPI.TILE_SOURCE,onChange:d=>r({...o,osmAPI:{...o.osmAPI,TILE_SOURCE:d.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:o.view.MAX_ZOOM,onChange:d=>r({...o,view:{...o.view,MAX_ZOOM:parseFloat(d.target.value)}}),className:"input input-bordered w-full"})]}),a.jsx("button",{className:"btn btn-error mt-4",onClick:i,children:"Reast All Data (All data will lost)"}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn btn-ghost",onClick:t,children:"Cancel"}),a.jsx("button",{className:"btn",onClick:l,children:"Save"})]})]})})}function Js(){const[e,t]=E(B(s=>[s.autoload,s.setAutoloadNC])),n=h.useCallback(()=>t(()=>!e),[e,t]);return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Auto load OSM data on drag: "+(e?"Enabled":"Disabled"),children:a.jsx("a",{onClick:n,className:Z(e&&"active"),children:a.jsx(T,{icon:Un.faA})})})}function Qs(){const{viewpoint:e,zoom:t,height:n,width:s}=Y(),o=E(B(c=>c.loadbbox)),r=ae(c=>c.osmAPI.BASEURL),[i,l]=h.useState(!1),d=h.useCallback(async()=>{i||(l(!0),await o({width:s,height:n,zoom:t,viewpoint:e},r),l(!1))},[r,n,o,e,s,t,i,l]);return a.jsx("li",{className:Z("tooltip tooltip-left",i&&"disabled"),"data-tip":"Load OSM data on current screen",children:a.jsx("a",{onClick:d,children:i?a.jsx("span",{className:"loading loading-spinner loading-xs h-[14px]"}):a.jsx(T,{icon:qn.faDownLong})})})}function ea(){return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Export with JSOM format",children:a.jsx("a",{onClick:()=>{const{meta:e,deletedMeta:t,bbox:n}=E.getState(),s=tn(e,t,n),o=new Blob([s],{type:"application/xml"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download="exported_data.osm",r.click(),URL.revokeObjectURL(r.href)},children:a.jsx(T,{icon:Xn.faFileExport})})})}function ta(){const[e,t]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Change settings",onClick:()=>t(!0),children:a.jsx("a",{children:a.jsx(T,{icon:Kn.faGear})})}),a.jsx(Zs,{open:e,onClose:()=>t(!1)})]})}function na(){return a.jsxs("ul",{className:"menu menu-horizontal",children:[a.jsx(Js,{}),a.jsx(Qs,{}),a.jsx(ea,{}),a.jsx(ta,{})]})}function oa({height:e,leftSlot:t}){return a.jsxs("nav",{className:"navbar p-0 bg-base-100 overflow-hidden border-b-2 border-b-base-300",style:{height:e,maxHeight:e,minHeight:e},children:[a.jsx("div",{className:"flex-1",children:t}),a.jsx("div",{className:"flex-none",children:a.jsx(na,{})})]})}function pn({x:e,y:t,open:n,children:s}){return n?a.jsx("ul",{className:"absolute rounded-lg bg-base-100 menu shadow p-0",onMouseDown:o=>o.stopPropagation(),style:{top:t,left:e},children:h.Children.map(s,(o,r)=>h.isValidElement(o)?o.type==="a"?a.jsx("li",{children:o},r):a.jsx("li",{children:a.jsx("a",{children:o})},r):null)}):null}const sa=({left:e,right:t,bottom:n,top:s})=>o=>{const r=({"@_lon":l,"@_lat":d})=>e<=l&&l<=t&&n<=d&&d<=s,i=l=>o.meta.node[l["@_ref"]];return{node:Object.entries(o.meta.node).filter(([,l])=>r(l)).reduce((l,d)=>({...l,[d[0]]:d[1]}),{}),way:Object.entries(o.meta.way).filter(([,l])=>l.nd.map(i).some(r)).reduce((l,d)=>({...l,[d[0]]:d[1]}),{}),relation:Object.entries(o.meta.relation).filter(([,l])=>l.member.filter(d=>d["@_type"]==="node"&&i(d)).map(i).some(r)).reduce((l,d)=>({...l,[d[0]]:d[1]}),{})}};function aa(e){const t=e.activeRef;return t?{type:t.type,meta:e.meta[t.type][t.id]}:null}const Ke=e=>t=>{const n=t.selectedRef;return n.length?n.filter(s=>s.type===e).map(s=>t.meta[e][s.id]):[]};class ra extends Q{constructor(n,s){super(n);A(this,"idle");A(this,"mousedown");A(this,"draging");this.idle=new W("select-idle"),this.mousedown=new W("select-mousedown"),this.draging=new W("select-dragging"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mousedown,{transform:o=>{const r=this.context,i=o;return o.type==="mousedown"&&o.shiftKey?(console.debug("BatchSelectStateMachine: transition from idle to mousedown"),r.from=ie(i.clientX,i.clientY,r),!0):!1}}),this.mousedown.appendNext(this.idle,{transform:o=>{const r=this.context;return["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)?(console.debug("BatchSelectStateMachine: transition from mousedown to idle"),r.from=void 0,!0):!1}}),this.mousedown.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: start dragging");const{clientX:i,clientY:l}=o;return Y.getState().setSelectionRect({from:r.from,to:ie(i,l,r)}),!0}return!1}}),this.draging.appendNext(this.idle,{transform:o=>{if(["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)){if(console.debug("BatchSelectStateMachine: drag canceled, back to idle"),Y.getState().setSelectionRect(),s!=null&&s.onSelectRect){const{clientX:r,clientY:i}=o;s.onSelectRect({from:this.context.from,to:ie(r,i,this.context)})}return this.context.from=void 0,!0}return!1}}),this.draging.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: continue dragging");const{clientX:i,clientY:l}=o;return Y.getState().setSelectionRect({from:r.from,to:ie(i,l,r)}),!0}return!1}})}}class ia extends Q{constructor(n,{menus:s,hoverable:o,clickable:r,dragable:i,selectable:l}){super(n);A(this,"idle");A(this,"componentHover");A(this,"componentMousedown");A(this,"pointDrag");this.context.rightClickMenus=s,this.idle=new W("pt-bus-component-idle"),this.componentHover=new W("pt-bus-component-hover"),this.componentMousedown=new W("pt-bus-component-mousedown"),this.pointDrag=new W("pt-bus-component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:d=>{const c=this.context;if(["pointerover","pointerenter"].includes(d.type)&&"componentTarget"in d&&d.componentTarget&&o(d.componentTarget,this.context)){c.componentTarget=d.componentTarget;const{id:p,type:u}=c.componentTarget;console.log("BusComponentStateMachine: component hover triggered",u,p);const{modifyFeatureStateNC:f}=c.store.meta.getState();return f(u,p,x=>x.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:d=>{const c=this.context;if(d.type==="mousedown"&&c.componentTarget&&r(c.componentTarget,c)){console.log("BusComponentStateMachine: transition to "+this.componentMousedown.name);const{id:p,type:u}=c.componentTarget,{modifyFeatureStateNC:f}=c.store.meta.getState();return f(u,p,x=>x.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:d=>{const c=this.context;if(["pointerleave","pointerout"].includes(d.type)&&c.componentTarget){console.log("BusComponentStateMachine: transition to idle");const{id:p,type:u}=c.componentTarget,{modifyFeatureStateNC:f}=c.store.meta.getState();return f(u,p,x=>x.hovered=!1),c.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:d=>{var p;const c=this.context;if(d.type==="pointermove"&&((p=c.componentTarget)==null?void 0:p.type)==="node"&&i(c.componentTarget,c)){console.log("BusComponentStateMachine: start dragging");const{clientX:u,clientY:f}=d,{commit:x}=c.store.meta.getState();return x(),Me(u,f,c),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:d=>{const c=this.context;if((d.type==="mouseup"||d.type==="mouseupoutside")&&c.componentTarget){if(d.button===Te.RIGHT){const p=d;this.context.rightClickMenus.stopPosition({...ie(p.clientX,p.clientY,this.context),feature:c.componentTarget,open:!0})}if(l(c.componentTarget,c)){const{selectFeature:p}=c.store.meta.getState(),{id:u,type:f}=c.componentTarget;if(typeof u=="string")p(f,u,!d.shiftKey),console.log("selected id",u,c.store.meta.getState().selectFeature);else throw new Error(`id ${u} is invalid for component`)}return c.componentTarget=void 0,!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:d=>d.type==="mouseupoutside"||d.type==="mouseup"?(console.log("BusComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:d=>{if(d.type==="pointermove"){const{clientX:c,clientY:p}=d;return Me(c,p,this.context),!0}return!1}})}}class la extends Q{constructor(n,s){super(n);A(this,"idle");A(this,"mapViewSubMachine");A(this,"busStopEditSubMachine");A(this,"undoRedo");A(this,"batchSelect");A(this,"menus");this.menus=s;const o=d=>d.type==="way"||d.type==="node",r=d=>d.type==="way"||d.type==="node",i=(d,c)=>{const p=c.store.meta.getState().meta[d.type][d.id].tag||[];return d.type==="node"&&(fe(p)||tt(p))},l=d=>d.type==="node";this.idle=new W("pt-edit-idle"),this.mapViewSubMachine=new Ht(n,{rightClickHandeler:d=>{s.busStop({...ie(d.clientX,d.clientY,this.context),open:!0}),s.stopPosition({x:0,y:0,open:!1})}}),this.busStopEditSubMachine=new ia(n,{menus:s,hoverable:o,clickable:r,dragable:i,selectable:l}),this.undoRedo=new Vt(n),this.batchSelect=new ra(n,{onSelectRect:d=>{const{viewpoint:c,zoom:p,width:u,height:f}=this.context.store.view.getState(),x=jo(c,p,u,f,d),y=this.context.store.meta.getState(),b=sa(x)(y);console.debug("get feature group ",b),Object.entries(b.node).filter(([,m])=>l({id:m["@_id"],type:"node"},this.context)).forEach(([,m])=>y.selectFeature("node",m["@_id"],!1))}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}transform(n){n.type==="mousedown"&&(this.menus.busStop({x:0,y:0,open:!1}),this.menus.stopPosition({x:0,y:0,open:!1})),super.transform(n)}}const ca={tag:[{"@_k":"highway","@_v":"bus_stop",importance:"required",description:"将该处定义为公交站点。最常用的标签。",example:"bus_stop"},{"@_k":"public_transport","@_v":"platform",importance:"required",description:"用于描述该功能是一个公共交通月台，服务于公共交通路线。用于符合ptv2的标签。",example:"platform"},{"@_k":"name",importance:"required",description:"公交站点的名称。",example:"海口路海游路"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点。",example:"yes"},{"@_k":"ref",importance:"optional",description:"公交站点的参考代码。（常用于内部定位和维护）",example:"ref=3154"},{"@_k":"local_ref",importance:"recommened",description:"公交站点的参考代码。如果公交站台有大量公交车停靠，每个小站点可有独立 local_ref。",example:"16"},{"@_k":"network",importance:"not-recommened",description:"公交站点的网络。可使用全称或缩写，依据附近线路标注情况确定。",example:"古田公交"},{"@_k":"operator",importance:"not-recommened",description:"在公交站点停靠的公交车的运营公司名称。若多家运营，使用分号（;）分隔。",example:"济阳舜达公共交通有限公司"},{"@_k":"shelter",importance:"recommened",description:"若公交站点提供候车亭则为“yes”，否则为“no”。",example:"no"},{"@_k":"departures_board",importance:"recommened",description:"表明公交站点使用的到站显示屏/牌类型。值可为纸质时刻表、实时显示等；departures_board=no 表示无显示屏/牌。",example:"timetable"},{"@_k":"bench",importance:"recommened",description:"若公交站点提供长凳则为“yes”，否则为“no”。",example:"yes"},{"@_k":"bin",importance:"recommened",description:"若公交站点具备垃圾箱则为“yes”，否则为“no”。",example:"no"},{"@_k":"tactile_paving",importance:"recommened",description:"若公交站点设有视障引导设施（提示视障人士月台边缘）则为“yes”，否则为“no”。",example:"no"},{"@_k":"layer",importance:"optional",description:"适用于多层公交站台。对于非地面公交站点，多层信息是必需的以避免疑问。",example:"-1"},{"@_k":"lit",importance:"recommened",description:"若公交站点夜间亮灯则为“yes”，否则为“no”。",example:"yes"},{"@_k":"surface",importance:"recommened",description:"描述公交车站所在的地面。",example:"concrete"}]},bt={tag:[{"@_k":"public_transport","@_v":"stop_position",importance:"required",description:"用于描述该功能是一个公共交通停车点。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"公交站点的名称。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点",example:"yes"}]},da={tag:[{"@_k":"public_transport","@_v":"stop_area",importance:"required",description:"用于描述该功能是一个停车区关系。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"该站组的名称，使用主名称或推广名称，即指向同一位置的同名分站台合并于此关系中",example:"经十路舜耕路"},{"@_k":"type",importance:"required",description:"","@_v":"public_transport"}]};function ua({children:e}){return a.jsx("ul",{className:"menu menu-xs",children:e})}function pa({show:e,proceed:t,title:n,message:s}){const o=h.useRef(null);h.useEffect(()=>{const l=o.current;l&&(e?l.showModal():l.close())},[e]);const r=()=>{t(!1)},i=()=>{console.debug("clicking delete ok: "),t(!0)};return a.jsxs("dialog",{ref:o,className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box",children:[n&&a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsx("p",{children:s}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn btn-md",onClick:r,children:"Cancel"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:i,children:"OK"})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})}const ma=e=>a.jsx(pa,{...e}),mn=ue.confirmable(ma);mn.displayName="ConfirmableSimpleConfirmation";function Ge({type:e,meta:t,showMetaType:n,children:s}){var y,b,m;const o=t["@_id"],[r,i,l]=E(B(g=>[g.selectFeature,g.unSelectFeature,g.deleteFeature])),d=Y(g=>g.setViewpoint),c=ue.createConfirmation(mn),p=h.useMemo(()=>{var g;if(n&&((g=t.tag)!=null&&g.length)){if(e==="node")return Oe(t.tag);if(e==="relation")return $e(t.tag)}},[n,t.tag,e]),u=h.useCallback(g=>{if(g.stopPropagation(),e==="node"){const w=t;d({lat:w["@_lat"],lon:w["@_lon"]})}},[t,d,e]),f=h.useCallback(g=>{var w;g.stopPropagation(),(w=t["@_localStates"])!=null&&w.selected?i(e,o):r(e,o,!1)},[o,t,r,e,i]),x=h.useCallback(async g=>{g.stopPropagation(),console.debug("deleting: ",e,o);const w=await c({title:"Confirm delete feature",message:`Are you sure you want delete this feature?
`+(se(t.tag||[])||o)});console.debug("confirmed deleting: ",w,e,o),w&&l(e,o)},[c,l,o,t.tag,e]);return a.jsxs($s,{featuretype:e,id:o,metatype:p,fullname:se(t.tag),created:Number(t["@_id"])<0,deleted:t["@_action"]==="delete",modified:t["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:u,children:a.jsx(T,{icon:Ct.faLocationDot})}),a.jsx("button",{className:Z("btn btn-xs btn-square tooltip tooltip-bottom",((y=t["@_localStates"])==null?void 0:y.selected)&&"btn-accent"),"data-tip":(b=t["@_localStates"])!=null&&b.selected?"Unselect":"Select",onClick:f,children:a.jsx(T,{icon:(m=t["@_localStates"])!=null&&m.selected?Et.faXmarkCircle:Mt.faCheckCircle})}),a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Delete",onClick:x,children:a.jsx(T,{icon:Gn.faTrash})}),s&&s({type:e,meta:t})]})}function he({node:e,way:t,relation:n,filter:s,...o}){return s=s||(()=>!0),a.jsxs(ua,{children:[(e||[]).filter(r=>s(r,"node")).map(r=>h.createElement(Ge,{...o,key:r["@_id"],meta:r,type:"node"})),(t||[]).filter(r=>s(r,"way")).map(r=>h.createElement(Ge,{...o,key:r["@_id"],meta:r,type:"way"})),(n||[]).filter(r=>s(r,"relation")).map(r=>h.createElement(Ge,{...o,key:r["@_id"],meta:r,type:"relation"}))]})}function xe({name:e,defaultOpen:t,forceOpen:n,forceClose:s,children:o}){const[r,i]=h.useState(!t),l=c=>{c.stopPropagation(),s||n||i(!r)},d=n?!0:s?!1:!r;return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",onClick:l,children:[a.jsx(T,{icon:n?Tt.faCircle:s?Yn.faX:d?Zn.faChevronDown:zn.faChevronRight}),a.jsx(T,{icon:Jn.faBars,className:"ml-1"}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),d&&o]})}function fa(e){const t=E(n=>n.meta.node);return a.jsx(xe,{name:"bus stop",children:a.jsx(he,{...e,node:Object.values(t).filter(n=>fe(n.tag))})})}function ha(e){const t=E(n=>n.meta.relation);return a.jsx(xe,{name:"stop area",children:a.jsx(he,{...e,relation:Object.values(t).filter(n=>on(n.tag))})})}function xa(e){const t=E(n=>n.meta.node);return a.jsx(xe,{name:"stop position",children:a.jsx(he,{...e,node:Object.values(t).filter(n=>tt(n.tag))})})}function fn({children:e}){const[t,n]=h.useState(""),s=(o,r)=>t===""||`${r}-${JSON.stringify(o)}`.includes(t);return a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2 w-full mt-1 mx-auto",children:[a.jsx(T,{icon:Qn.faSearch}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:t,onChange:o=>n(o.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 rounded overflow-scroll",children:a.jsx("ul",{className:"menu menu-xs",children:L(e).map(o=>o({filter:s}))})})]})}function ga(){return a.jsxs(fn,{children:[({filter:e})=>a.jsx(fa,{filter:e}),({filter:e})=>a.jsx(xa,{filter:e}),({filter:e})=>a.jsx(ha,{filter:e})]})}function ba({type:e,id:t,showMetaType:n,children:s}){const o=E(B(i=>i.meta[e][t])),r=h.useMemo(()=>{var i;if(n&&((i=o==null?void 0:o.tag)!=null&&i.length)){if(e==="node")return Oe(o.tag);if(e==="relation")return $e(o.tag)}},[n,o==null?void 0:o.tag,e]);return a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsx(de,{featuretype:e,id:t,metatype:r,fullname:se(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:s&&s({type:e,id:t})})})}function wa({onDelete:e,member:t,memberToId:n,...s}){const o=h.useRef(1),r=h.useCallback(()=>o.current++,[o]),i=h.useMemo(()=>t.map(c=>({...c,uniqueIdentifier:r()})),[r,t]),l=h.useCallback(c=>`${n(c)}_AT_LIST_${c.uniqueIdentifier}`,[n]),d=h.useCallback(({selected:c,children:p})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:u=>{u.stopPropagation();const f=i.filter(x=>!c.has(l(x)));e(i,f)},children:a.jsx(T,{icon:kt.faDeleteLeft})}),p]}),[i,l,e]);return a.jsx(an,{...s,member:i,memberToId:l,slotSelection:d})}const ya=h.memo(({initialValue:e,onCommit:t,onFocus:n,onBlur:s})=>{const[o,r]=h.useState(e||"");return h.useEffect(()=>{r(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:o,onChange:i=>r(i.target.value),onKeyDown:i=>{i.key==="Enter"&&i.currentTarget.blur()},onBlur:i=>{s&&s(i),t(o)},onFocus:n})});function _a({preset:e,existing:t,title:n,onSubmit:s,open:o,onClose:r,createMembers:i}){const[l,d]=h.useState({});h.useEffect(()=>{d(()=>e.tag.reduce((_,R)=>(t!=null&&t.some(F=>R["@_k"]===F["@_k"])||(_[R["@_k"]]=R["@_v"]||""),_),{}))},[t,e]);const c=h.useMemo(()=>e.tag.filter(_=>!(t!=null&&t.some(R=>_["@_k"]===R["@_k"]))),[e,t]),[p,u]=h.useState((t==null?void 0:t.map(_=>({key:_["@_k"],value:_["@_v"]})))||[]),[f,x]=h.useState("");h.useEffect(()=>{const _=document.getElementById("create-node-modal");o?_==null||_.showModal():_==null||_.close()},[o]);const y=(_,R)=>{d(F=>({...F,[_]:R}))},b=h.useCallback(()=>{f.trim()!==""&&(u(_=>[..._,{key:f.trim(),value:""}]),x(""))},[f]),m=(_,R)=>{u(F=>F.map((H,U)=>U===_?{...H,value:R}:H))},g=_=>{u(R=>R.filter((F,H)=>H!==_))},w=h.useMemo(()=>a.jsxs(a.Fragment,{children:[t&&a.jsx("div",{className:"divider",children:"Needed preset tags"}),c.map(_=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1 tooltip tooltip-top","data-tip":_.description||"",children:[a.jsxs("span",{className:"font-semibold",children:[_["@_k"]," ",_.importance==="required"&&a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:_.example||"Enter value",value:l[_["@_k"]],onChange:R=>y(_["@_k"],R.target.value),required:_.importance==="required",disabled:_.importance==="not-recommened",className:"grow"}),a.jsx("span",{className:"badge",children:_.importance})]},_["@_k"])),a.jsx("div",{className:"divider",children:t?"Exsisting or created tags":"Created tags"}),p.map((_,R)=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1",children:[a.jsxs("span",{className:"font-semibold",children:[_.key," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:"Enter value",value:_.value,onChange:F=>m(R,F.target.value),required:!0,className:"grow"}),!t&&a.jsx("span",{className:"badge",children:"created"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-error",onClick:()=>g(R),children:a.jsx(T,{icon:Nt})})]},_.key)),a.jsxs("label",{className:"input input-sm input-bordered flex items-center gap-2",children:[a.jsx("input",{type:"text",placeholder:"New tag key",value:f,onChange:_=>x(_.target.value),onKeyDown:_=>{_.key==="Enter"&&(_.preventDefault(),b())},className:"grow"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-outline",onClick:b,children:"+ add tag"})]})]}),[b,t,c,f,p,l]),[v,k]=h.useState([]),[C,I]=h.useState(void 0),j=h.useCallback((_,R,F)=>{console.log("edit",_,R,F),k(H=>H.map(U=>{if(U["@_type"]===_&&U["@_ref"]===R){const te=pe(U);return te["@_role"]=F,te}return U}))},[]),N=h.useCallback(_=>`${_["@_type"]}-${_["@_ref"]}`,[]),V=h.useCallback(({member:_,children:R})=>a.jsx(ba,{id:_["@_ref"],type:_["@_type"],children:()=>{const F=(C==null?void 0:C.id)===_["@_ref"]&&C.type===_["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:Z("btn btn-square btn-xs tooltip tooltip-bottom",F&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:H=>{H.stopPropagation(),I(F?void 0:{id:_["@_ref"],type:_["@_type"]})},children:a.jsx(T,{icon:F?Ze:Je.faCircle})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(ya,{initialValue:_["@_role"],onCommit:H=>j(_["@_type"],_["@_ref"],H)})]}),R]})}}),[j,C]);function $(){}function S(_){k(()=>_)}function M(_){k(()=>_)}const P=_=>_.map(R=>({"@_ref":R.id,"@_type":R.type})),D=h.useCallback(_=>{console.log("Insert at Top: ",_),k(R=>[...P(_),...R])},[]),q=h.useCallback(_=>{console.log("Insert at Bottom: ",_),k(R=>[...R,...P(_)])},[]),X=h.useCallback(_=>{console.log("Insert at Active: ",_),C?k(R=>{const F=[...R],H=F.findIndex(U=>U["@_ref"]===C.id&&U["@_type"]===C.type);return F.splice(H+1,0,...P(_)),F}):q(_)},[q,C]),J=h.useMemo(()=>i?a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(wa,{member:v,memberToId:N,onDragStart:$,onDragEnd:S,onDelete:(_,R)=>M(R),children:V})}),a.jsx("div",{className:"",children:a.jsx(it,{handelInsertTop:D,handelIntertBottom:q,handelInsertAtActive:X})})]}):null,[i,X,q,D,v,V,N]),O=_=>{_.preventDefault();const R=Object.entries(l).filter(([,H])=>H.length).map(([H,U])=>({"@_k":H,"@_v":U})),F=p.map(H=>({"@_k":H.key,"@_v":H.value}));s({tag:[...R,...F],member:v}),u([]),x(""),r()};return a.jsx(a.Fragment,{children:a.jsxs("dialog",{id:"create-node-modal",className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box w-11/12 max-w-5xl",children:[a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsxs("form",{onSubmit:O,className:"space-y-2",children:[w,J,a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn",onClick:()=>r(),children:"Cancel"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Submit"})]})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})})}function ja({show:e,proceed:t,...n}){return a.jsx(_a,{open:e,...n,onClose:()=>t(null),onSubmit:t})}const Sa=e=>a.jsx(ja,{...e}),lt=ue.confirmable(Sa);lt.displayName="CreateFeatureTagConform";function Na(e){const t=E(B(aa));return a.jsx(xe,{name:"active",forceOpen:!0,children:a.jsx(he,{...e,node:(t==null?void 0:t.type)==="node"?[t.meta]:void 0,way:(t==null?void 0:t.type)==="way"?[t.meta]:void 0,relation:(t==null?void 0:t.type)==="relation"?[t.meta]:void 0,showMetaType:!0})})}function va(e){const t=E(B(Ke("node"))),n=E(B(Ke("way"))),s=E(B(Ke("relation"))),o=E(i=>i.selectFeature),r=h.useCallback(({type:i,meta:l})=>a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Active",onClick:async d=>{d.stopPropagation(),console.debug("activating: ",i,l["@_id"]),o(i,l["@_id"],!1)},children:a.jsx(T,{icon:eo.faStarOfLife})}),[o]);return a.jsx(xe,{name:"selected",defaultOpen:!0,children:a.jsx(he,{...e,node:t,way:n,relation:s,showMetaType:!0,children:r})})}function ka(){return a.jsxs(fn,{children:[({filter:e})=>a.jsx(Na,{filter:e}),({filter:e})=>a.jsx(va,{filter:e})]})}const Ca=h.memo(function(e){const t=Y(B($t(e))),n=E(l=>l.createBusStopSel),s=E(l=>l.createStopAreaSel),o=ue.createConfirmation(lt),r=h.useCallback(async()=>{e.onClose();const l=await o({title:"Create Bus stop (Preset CN)",preset:ca});l!=null&&l.tag&&(console.debug("created bus stop",l),t&&n(t,l.tag))},[e,o,t,n]),i=h.useCallback(async()=>{e.onClose();const l=await o({title:"Create Stop Area (Preset CN)",preset:da,createMembers:!0});l!=null&&l.tag&&s(l.tag,l.member)},[o,s,e]);return a.jsx(a.Fragment,{children:a.jsxs(pn,{...e,children:[a.jsx("a",{onClick:r,children:"New bus stop"}),a.jsx("a",{onClick:i,children:"New stop area relation"})]})})}),Ea=h.memo(function(e){var l,d;const t=Y(B($t(e))),n=E(c=>c.createStopPositionSel),s=E(c=>c.modifyFeatureMetaNC),o=ue.createConfirmation(lt),r=h.useCallback(async()=>{var p,u;e.onClose(),console.debug("clicked new stop position");const c=await o({preset:bt,title:"Create Stop position (Preset CN)"});c!=null&&c.tag&&(console.debug("created stop position",c),t&&((p=e.feature)!=null&&p.id)&&n(t,c.tag,(u=e.feature)==null?void 0:u.id))},[e,o,t,n]),i=h.useCallback(async()=>{var p;if(e.onClose(),console.debug("clicked new stop position"),!((p=e.feature)!=null&&p.id))return;const c=await o({preset:bt,existing:E.getState().meta.node[e.feature.id].tag,title:"Add tags to existing point (Stop position preset CN)"});c!=null&&c.tag&&(console.debug("created stop position",c),s("node",e.feature.id,u=>{u.tag=c.tag}))},[e,o,s]);return a.jsx(a.Fragment,{children:a.jsx(pn,{...e,children:((l=e.feature)==null?void 0:l.type)==="way"?a.jsx("a",{onClick:r,children:"New stop position"}):((d=e.feature)==null?void 0:d.type)==="node"?a.jsx("a",{onClick:i,children:"Set point as stop position"}):a.jsx("a",{children:"relation is not allowed here"})})})});function Ma({width:e,height:t,stateMachine:n}){return h.useEffect(()=>{const s=o=>n.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[n]),a.jsxs(a.Fragment,{children:[a.jsxs(dn,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>{n.transform(s)},onPointerMove:s=>{n.transform(s)},onMouseUp:s=>{n.transform(s)},onWheel:s=>{n.transform(s)},children:[a.jsx(Qt,{width:e,height:t}),a.jsx(en,{width:e,height:t,stateMachine:n})]}),a.jsx(un,{width:e})]})}function Ta({width:e,height:t,children:n}){return a.jsx("div",{className:"bg-base-100 border-r-2 border-r-base-300 flex flex-col",style:{width:e,height:t,maxWidth:e,maxHeight:t},children:n})}function Aa({width:e,height:t}){const[s,o]=h.useState({x:0,y:0,open:!1}),[r,i]=h.useState({x:0,y:0,open:!1}),l=h.useRef(new la({meta:E,view:Y,settings:ae},{busStop:o,stopPosition:i})).current,d=h.useMemo(()=>[{tooltip:"Bus stop edit tab",icon:a.jsx(T,{icon:to.faBusSimple}),stage:()=>a.jsx(Ma,{width:e-42,height:t,stateMachine:l})},{tooltip:"Route edit tab",icon:a.jsx(T,{icon:no.faRoute}),stage:()=>a.jsx("div",{className:"p-2",children:"Route Edit Placeholder"})},{tooltip:"Edit bus relation",icon:a.jsx(T,{icon:oo.faCodeCommit}),stage:()=>a.jsx("div",{className:"p-2",children:"Bus Relation Edit Placeholder"})}],[e,t,l]),[c,p]=h.useState(0);return a.jsxs("div",{className:"flex flex-row",style:{height:t,width:e,maxHeight:t,maxWidth:e},onContextMenu:u=>u.preventDefault(),children:[a.jsx(Ta,{width:42,height:t,children:d.map((u,f)=>a.jsx("div",{className:"tooltip tooltip-right mx-auto mt-1","data-tip":u.tooltip,children:a.jsx("button",{onClick:()=>p(f),className:Z("btn btn-ghost btn-square btn-sm",f===c&&"btn-active"),children:u.icon})}))}),a.jsxs("div",{className:"relative",style:{height:t,width:e-42},children:[d[c].stage(),a.jsx(Ca,{...s,onClose:()=>o({x:0,y:0,open:!1})}),a.jsx(Ea,{...r,onClose:()=>i({x:0,y:0,open:!1})})]})]})}function Ia({width:e,height:t}){const n=[{title:"Bus stop",tab:()=>a.jsx(ga,{})},{title:"Selected",tab:()=>a.jsx(ka,{})}],[s,o]=h.useState(0);return a.jsxs("div",{style:{width:e,height:t},className:"flex flex-col",children:[a.jsx("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs",children:n.map((r,i)=>a.jsx("a",{onClick:()=>o(i),role:"tab",className:Z("tab",i===s&&"tab-active"),children:r.title},i))}),a.jsx("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:n[s].tab()})]})}function Ra({width:e,height:t}){return a.jsxs(Ie,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(Aa,{...n}),n=>a.jsxs(Ie,{...n,axis:"y",children:[s=>a.jsx(Ia,{...s}),s=>a.jsx(cn,{...s})]})]})}function Pa({width:e,height:t}){const s=h.useMemo(()=>[{title:a.jsx(T,{icon:so.faBus}),tooltip:"Public transport edit mode",component:()=>a.jsx(Ra,{width:e,height:t-42})},{title:a.jsx(T,{icon:ao.faMap}),tooltip:"Map edit mode",component:()=>a.jsx(zs,{width:e,height:t-42})}],[e,t]),[o,r]=h.useState(0);return a.jsxs("div",{style:{width:e,height:t,position:"relative"},children:[a.jsx(oa,{height:42,leftSlot:a.jsx(a.Fragment,{children:s.map((i,l)=>a.jsx("div",{className:"tooltip tooltip-right ml-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(l),className:Z("btn btn-ghost btn-square btn-sm",o===l&&"btn-active"),children:i.title})},l))})}),a.jsx("div",{className:"relative",children:s[o].component()})]})}function La(){const[{width:e,height:t},n]=h.useState({width:window.innerWidth,height:window.innerHeight});return h.useEffect(()=>{const s=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}}),a.jsx("div",{className:"wrapper h-screen w-screen overflow-hidden",style:{width:e},children:a.jsx(Pa,{width:e,height:t})})}function Da(){return a.jsx(La,{})}function Fa(){return a.jsx(a.Fragment,{children:a.jsx(Da,{})})}const wt=document.getElementById("root");wt?Tn.createRoot(wt).render(a.jsx(h.StrictMode,{children:a.jsx(Fa,{})})):console.error("Root element not found. Ensure there is an element with the ID 'root' in your HTML.");
