var ln=Object.defineProperty;var cn=(e,t,n)=>t in e?ln(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var T=(e,t,n)=>cn(e,typeof t!="symbol"?t+"":t,n);import{c as Ke,j as a,m as $,r as w,u as L,d as dn,F as R,a as un,C as pn,b as mn,e as st,D as fn,f as hn,S as xn,v as gn,g as bn,s as wn,K as yn,P as jn,h as _n,l as pe,i as Sn}from"./react-CKBB1JJQ.js";import{d as Ge,e as Nn,f as mt,h as ft,j as vn,k as ht,l as kn,m as Ie,n as Pe,o as xt,q as Cn,r as gt,t as En,u as Mn,v as Tn,w as Rn,x as bt,y as An,z as In,A as Pn,B as wt,C as Ln,D as Dn,E as Fn,F as yt,G as jt,H as _t,I as St,J as Nt,K as On,L as Bn,M as Hn,N as $n,O as Wn,P as Vn,Q as Un,R as Xn,S as qn,T as Kn,U as Gn,V as Yn,W as zn,X as Zn,Y as Jn,Z as Qn}from"./fazustand-D88I-2ly.js";import{a as vt,f as Be,d as eo,c as kt,b as He,s as at,g as to,h as no,j as oo,k as Ct,t as so}from"./vendor-pGlK2z3f.js";import{i as Et,j as ao,L as ye,k as je,c as Le,l as de,m as ke,G as Mt,n as rt,R as ro}from"./pixi-DNw4YZxi.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const io={lon:-122.431297,lat:37.773972},lo=17,co={viewpoint:io,zoom:lo},uo=e=>({setViewpoint:t=>e(()=>({viewpoint:t})),setZoom:t=>e(()=>({zoom:t})),setStage:(t,n)=>e({width:t,height:n}),setStageApp:t=>e({stage:t}),setSelectionRect:t=>e({selectionRect:t})}),it=()=>new URLSearchParams(window.location.search),po=e=>{const t=e.toString(),n=t?"?":"";window.history.replaceState(null,"",`${location.pathname}${n}${t}`)},mo=e=>(t,n,s)=>{const o=e(t,n,s),r={},i=it(),l=i.get("lat"),c=i.get("lon"),d=i.get("zoom");l&&c&&(r.viewpoint={lat:parseFloat(l),lon:parseFloat(c)}),d&&(r.zoom=parseFloat(d));const u={...o,...r};return t(u,!0,"mapViewURLPersist/hydrate"),s.subscribe((f,h)=>{var m,g,b,y,S,C,k,_,v;const j=it();let x=!1;((m=f.viewpoint)==null?void 0:m.lat)!==((g=h.viewpoint)==null?void 0:g.lat)&&(j.set("lat",((y=(b=f.viewpoint)==null?void 0:b.lat)==null?void 0:y.toString())||""),x=!0),((S=f.viewpoint)==null?void 0:S.lon)!==((C=h.viewpoint)==null?void 0:C.lon)&&(j.set("lon",((_=(k=f.viewpoint)==null?void 0:k.lon)==null?void 0:_.toString())||""),x=!0),f.zoom!==h.zoom&&(j.set("zoom",((v=f.zoom)==null?void 0:v.toString())||""),x=!0),x&&po(j)}),u},W=Ke()(Ge(mo((...e)=>({...co,...uo(...e)})),{name:"MapView"})),fo={lon:-122.431297,lat:37.773972};De(fo);const ue=256,_e={XMIN:-2003750834e-2,YMIN:-200489661e-1,XMAX:2003750834e-2,YMAX:200489661e-1,EQUATOR:4007501668e-2};function ho(e){const[t,n]=vt("EPSG:3857","EPSG:4326",[e.x,e.y]);return{lon:t,lat:n}}function De(e){const[t,n]=vt("EPSG:4326","EPSG:3857",[e.lon,e.lat]);return{x:t,y:n}}function Tt(e,t){const n=Math.pow(2,t)*ue,s=_e.EQUATOR/n,o=(e.x-_e.XMIN)/s,r=(_e.XMAX-e.y)/s;return{x:o,y:r}}function Rt(e,t){return Tt(De(e),t)}function At(e,t,n,s,o){const r=Tt(De(t),n),i=s?s/2:0,l=o?o/2:0;return{x:Math.floor(e.x+i-r.x),y:Math.floor(e.y+l-r.y)}}function Ye(e,t,n,s,o){return At(Rt(e,n),t,n,s,o)}function Z(e,t,n,s,o){const r=Math.pow(2,n)*ue,i=_e.EQUATOR/r,l=De(t),c=Math.floor(s/2),d=Math.floor(o/2),u=(e.x-c)*i,p=(e.y-d)*i,f={x:l.x+u,y:l.y-p};return ho(f)}function It(e,t,n,s){const{lon:o,lat:r}=Z({x:0,y:0},e,t,n,s),{lon:i,lat:l}=Z({x:n,y:s},e,t,n,s);return{left:o,bottom:l,right:i,top:r}}function xo(e,t,n,s,{from:o,to:r}){const i={x:Math.min(o.x,r.x),y:Math.min(o.y,r.y)},l={x:Math.max(o.x,r.x),y:Math.max(o.y,r.y)};console.debug("getBoundsByRect, p1 p2",i,l,"vp zoom w h",e,t,n,s,{from:o,to:r});const{lon:c,lat:d}=Z(i,e,t,n,s),{lon:u,lat:p}=Z(l,e,t,n,s);return{left:c,bottom:p,right:u,top:d}}const Pt=e=>t=>e.x!==0&&e.y!==0?Z(e,t.viewpoint,t.zoom,t.width,t.height):void 0;function Fe(e){return JSON.parse(JSON.stringify(e))}const J=e=>Object.keys(e);class go{constructor(){T(this,"timers",new Map)}debounce(t,n,s,o=!1){return(...r)=>{const i=o&&!this.timers.has(s);this.timers.has(s)&&clearTimeout(this.timers.get(s));const l=setTimeout(()=>{this.timers.delete(s),o||t(...r)},n);this.timers.set(s,l),i&&t(...r)}}cancel(t){this.timers.has(t)&&(clearTimeout(this.timers.get(t)),this.timers.delete(t))}cancelAll(){for(const t of this.timers.values())clearTimeout(t);this.timers.clear()}}function I(e){return e?Array.isArray(e)?e:[e]:[]}const q=(...e)=>e.filter(Boolean).join(" ");class O{constructor(t){T(this,"name");T(this,"next",[]);this.name=t}appendNext(t,n){const s=t instanceof O?t:t.entry;if(n.isEpsilon)this.next.push({isEpsilon:!0,state:s});else{if(!n.transform)throw new Error("Non-ε transition requires a transform function.");this.next.push({isEpsilon:!1,transform:n.transform,state:s})}}}const Ae=class Ae{constructor(t){T(this,"name");T(this,"entry");T(this,"current");T(this,"accept");T(this,"debouncer");T(this,"context");this.name="base",this.context={store:t},this.debouncer=new go}appendNext(t,n){this.accept.forEach(s=>s.appendNext(t,n))}computeEpsilonClosure(t){const n=new Set,s=[t];for(;s.length;){const o=s.pop();if(!n.has(o)){n.add(o);for(const{state:r,isEpsilon:i}of o.next)i&&s.push(r)}}return Array.from(n)}transform(t){const n=this.computeEpsilonClosure(this.current);for(const s of n)for(const o of s.next)if(!o.isEpsilon&&o.transform(t)){this.current=o.state;return}}debouncedTransform(t){this.debouncer.debounce(this.transform.bind(this),Ae.DEBOUNCE_DELAY,t.type,!0)(t)}};T(Ae,"DEBOUNCE_DELAY",20);let G=Ae;function se(e,t,n){const{stage:s}=n.store.view.getState(),o=s.view.getBoundingClientRect(),r=e-o.x,i=t-o.y;return console.debug("getLocalPosistion, x y",e,t," convert to ",r,i),{x:r,y:i}}const Ce=(e,t,n)=>{var j;const{height:s,width:o,viewpoint:r,zoom:i,stage:l}=n.store.view.getState();if(!s||!o||!l)return;const c=l.view.getBoundingClientRect(),d=e-c.x,u=t-c.y,{modifyFeatureMetaNC:p}=n.store.meta.getState(),f=Z({x:d,y:u},r,i,o,s),h=Ye(f,r,i,o,s);if(console.log("on component drag",{x:e,y:t},{x:d,y:u},h),(j=n.componentTarget)!=null&&j.id&&n.componentTarget.type==="node"){const{type:x,id:m}=n.componentTarget;p(x,m,g=>{g["@_lon"]=f.lon,g["@_lat"]=f.lat})}else throw new Error(`context.componentTarget should not be ${JSON.stringify(n.componentTarget)} at point move`)};class bo extends G{constructor(n){super(n);T(this,"idle");T(this,"componentHover");T(this,"componentMousedown");T(this,"pointDrag");this.idle=new O("component-idle"),this.componentHover=new O("component-hover"),this.componentMousedown=new O("component-mousedown"),this.pointDrag=new O("component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:s=>{const o=this.context;if(["pointerover","pointerenter"].includes(s.type)&&"componentTarget"in s&&s.componentTarget){o.componentTarget=s.componentTarget;const{id:r,type:i}=o.componentTarget;console.log("ComponentStateMachine: component hover triggered",i,r);const{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:s=>{const o=this.context;if(s.type==="mousedown"&&o.componentTarget){console.log("ComponentStateMachine: transition to mousedown");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:s=>{const o=this.context;if(["pointerleave","pointerout"].includes(s.type)&&o.componentTarget){console.log("ComponentStateMachine: transition to idle");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!1),o.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:s=>{var r;const o=this.context;if(s.type==="pointermove"&&((r=o.componentTarget)==null?void 0:r.type)==="node"){console.log("ComponentStateMachine: start dragging");const{clientX:i,clientY:l}=s,{commit:c}=o.store.meta.getState();return c(),Ce(i,l,o),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:s=>{const o=this.context;if((s.type==="mouseup"||s.type==="mouseupoutside")&&o.componentTarget){const{selectFeature:r,unSelectFeature:i}=o.store.meta.getState(),{id:l,type:c}=o.componentTarget;if(typeof l=="string")s.ctrlKey?i(c,l):(r(c,l,!s.shiftKey),console.log("selected id",l,o.store.meta.getState().selectFeature)),o.componentTarget=void 0;else throw new Error(`id ${l} is invalid for component`);return!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:s=>s.type==="mouseup"||s.type==="mouseuppoutside"?(console.log("ComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:s=>{if(s.type==="pointermove"){const{clientX:o,clientY:r}=s;return Ce(o,r,this.context),!0}return!1}})}}var Ee=(e=>(e[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(Ee||{});class Lt extends G{constructor(n,s){super(n);T(this,"idle");T(this,"rightMousedown");T(this,"mapDrag");this.idle=new O("mapview-idle"),this.mapDrag=new O("mapview-mapDrag"),this.rightMousedown=new O("mapview-right-mousedown"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="wheel"){const l=r.deltaY<0,{zoom:c,setZoom:d}=i.store.view.getState(),u=c+(l?1:-1),p=i.store.settings.getState();return u>=0&&u<=p.view.MAX_ZOOM&&d(u),!0}return!1}}),this.idle.appendNext(this.mapDrag,{transform:r=>{const i=this.context;if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===Ee.LEFT){const{clientX:l,clientY:c}=r;return i.startPoint={x:l,y:c},i.viewpointBeforeDrag=i.store.view.getState().viewpoint,console.log("MapViewStateMachine: 开始地图拖拽",i.startPoint),!0}return!1}}),this.idle.appendNext(this.rightMousedown,{transform:r=>{if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===Ee.RIGHT){const{clientX:i,clientY:l}=r;return this.context.startPoint={x:i,y:l},this.context.viewpointBeforeDrag=this.context.store.view.getState().viewpoint,!0}return!1}}),this.rightMousedown.appendNext(this.idle,{transform:r=>r.type==="mouseup"?(s&&s.rightClickHandeler(r),this.context.startPoint=void 0,this.context.viewpointBeforeDrag=void 0,!0):!1});const o=r=>{var l,c;const i=this.context;if(r.type==="pointermove"){const{clientX:d,clientY:u}=r,[p,f]=[d,u];if(typeof((l=i.startPoint)==null?void 0:l.x)!="number"||typeof((c=i.startPoint)==null?void 0:c.y)!="number")throw new Error("context.startPoint.x must be number when map drag");const[h,j]=[i.startPoint.x-p,i.startPoint.y-f];console.log("moving to",h,j);const{zoom:x,setViewpoint:m,width:g,height:b}=i.store.view.getState(),y=g,S=b,C=i.viewpointBeforeDrag,k=Z({x:h+y/2,y:j+S/2},C,x,y,S);return m(k),!0}return!1};this.rightMousedown.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="mouseup"||r.type==="mouseupoutside"){if(i.startPoint=void 0,i.viewpointBeforeDrag=void 0,i.store.meta.getState().autoload){const{viewpoint:l,zoom:c,width:d,height:u}=i.store.view.getState(),p=d,f=u,{loadbbox:h}=i.store.meta.getState(),j=i.store.settings.getState();h({width:p,height:f,zoom:c,viewpoint:l},j.osmAPI.BASEURL)}return!0}return!1}})}}function wo(e,t,n){const s=He();at(s,n,t);const o=to(s);if(o===0)return kt(t);const r=He();at(r,e,t);const i=no(r,s)/o,l=Math.max(0,Math.min(1,i)),c=He();return oo(c,t,s,l),c}function Dt(e,t){let n=null,s=null,o=1/0;const r=Be(e.lon,e.lat);for(let i=0;i<t.length-1;i++){const l=Be(t[i]["@_lon"],t[i]["@_lat"]),c=Be(t[i+1]["@_lon"],t[i+1]["@_lat"]),d=wo(r,l,c),u=eo(r,d);u<o&&(o=u,n=kt(d),s=t[i])}if(s===null)throw new Error("point is not insertable for polyline");return{nearestPoint:n?{lon:n[0],lat:n[1]}:e,insertAfter:s}}class Ft extends G{constructor(n){super(n);T(this,"idle");this.idle=new O("undo-redo-idle"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}})}}class yo extends G{constructor(n){super(n);T(this,"idle");T(this,"undoRedo");T(this,"addNode");T(this,"addNodeOnWay");T(this,"splitWay");this.idle=new O("node-idle"),this.addNode=new O("add-node"),this.addNodeOnWay=new O("add-node-on-way"),this.splitWay=new O("split-way"),this.undoRedo=new Ft(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}}),this.idle.appendNext(this.addNode,{transform:s=>s.type==="add-node"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.addNodeOnWay,{transform:s=>s.type==="add-node-on-way"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.splitWay,{transform:s=>s.type==="split-way"?(console.log("to split way state"),!0):!1}),this.addNode.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0){const{viewpoint:r,zoom:i,width:l,height:c}=this.context.store.view.getState(),d=l,u=c,{clientX:p,clientY:f}=o,h=Z({x:p,y:f},r,i,d,u);this.context.store.meta.getState().createLocalNode(h),console.log("added node")}return!0}return!1}}),this.addNodeOnWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="way"){const{viewpoint:r,zoom:i,width:l,height:c}=this.context.store.view.getState(),d=l,u=c,{meta:p,createLocalNode:f,modifyFeatureMetaNC:h,commit:j}=this.context.store.meta.getState(),{clientX:x,clientY:m}=o,g=Z({x,y:m},r,i,d,u),b=p.way[o.componentTarget.id],y=b.nd.map(v=>p.node[v["@_ref"]]),{nearestPoint:S,insertAfter:C}=Dt(g,y),k=f(S),_=Array.from(b.nd);_.splice(b.nd.findIndex(v=>v["@_ref"]===C["@_id"])+1,0,{"@_ref":k}),j(),h(o.componentTarget.type,o.componentTarget.id,v=>v.nd=_),console.log("nodeid",k,_),console.log("added node")}return!0}return!1}}),this.splitWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="node"){const{meta:r,splitWay:i}=this.context.store.meta.getState(),l=r.node[o.componentTarget.id];i(l["@_id"]),console.log("splited way")}return!0}return!1}})}}class jo extends G{constructor(n){super(n);T(this,"idle");T(this,"componentSubMachine");T(this,"mapViewSubMachine");T(this,"uiStateSubMachine");this.idle=new O("common-edit-idle"),this.componentSubMachine=new bo(n),this.mapViewSubMachine=new Lt(n),this.uiStateSubMachine=new yo(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.uiStateSubMachine,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.uiStateSubMachine.appendNext(this.idle,{isEpsilon:!0})}}const _o={},So={commitCounter:1},No={selectedRef:[],activeRef:void 0},vo={meta:{node:{},way:{},relation:{}},deletedMeta:{node:{},way:{},relation:{}}},ko={bbox:[],autoload:!0},Ot={...So,...No,...vo,...ko,..._o};function U(e){e.commitCounter++}const Co=e=>({commit:()=>e(t=>U(t))});function V(e,t){if(!t)return null;const n=I(t);for(let s=0;s<n.length;s++){const o=n[s];if(o["@_k"]===e)return o["@_v"]}return null}const ze=(e,t,n,s,o,r)=>{const i=(l,c)=>{if(c==="relation"){const d=r[l];if(!d)return;n[l]||(n[l]=!0),I(d.member).forEach(u=>{const p=u["@_ref"],f=u["@_type"];f==="node"?!e[p]&&s[p]&&(e[p]=!0):f==="way"?!t[p]&&o[p]&&i(p,"way"):f==="relation"&&!n[p]&&r[p]&&i(p,"relation")})}else if(c==="way"){const d=o[l];if(!d)return;t[l]||(t[l]=!0),I(d.nd).forEach(u=>{const p=u["@_ref"];!e[p]&&s[p]&&(e[p]=!0)})}else if(c==="node"){if(!s[l])return;e[l]||(e[l]=!0)}};return i};function Eo(e,t,n){const s={},o={},r={},i=ze(s,o,r,e,t,n);return Object.values(n).forEach(l=>{(V("type",l.tag)==="route_master"&&V("route_master",l.tag)==="bus"||V("type",l.tag)==="route"&&V("public_transport:version",l.tag)==="2")&&i(l["@_id"],"relation")}),Object.values(n).forEach(l=>{V("type",l.tag)==="route"&&V("public_transport:version",l.tag)==="2"&&V("roundtrip",l.tag)==="yes"&&i(l["@_id"],"relation")}),{node:s,way:o,relation:r}}function Mo(e,t,n){const s={},o={},r={},i=ze(s,o,r,e,t,n);return Object.values(n).forEach(l=>{V("highway",l.tag)&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{V("highway",l.tag)&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{V("highway",l.tag)&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}function To(e,t,n){const s={},o={},r={},i=ze(s,o,r,e,t,n);return Object.values(n).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}const Ro=e=>{const{node:t,way:n,relation:s}=e,o={elems:{node:{},way:{},relation:{}},roots:{node:{},way:{},relation:{}}},r=(i,l)=>{Object.keys(l).forEach(c=>{const d=c;o.elems[i][d]={id:d,type:i,fathers:{node:[],way:[],relation:[]},childs:{node:[],way:[],relation:[]}},o.roots[i][d]=!0})};return r("node",t),r("way",n),r("relation",s),Object.values(n).forEach(i=>{const l=o.elems.way[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.nd.forEach(c=>{const d=o.elems.node[c["@_ref"]];d&&(d.fathers.way.push(l.id),l.childs.node.push(d.id),delete o.roots.node[d.id])})}),Object.values(s).forEach(i=>{const l=o.elems.relation[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.member.forEach(c=>{const d=o.elems[c["@_type"]][c["@_ref"]];d&&(d.fathers.relation.push(l.id),l.childs[c["@_type"]].push(d.id),delete o.roots[c["@_type"]][d.id])})}),o},Bt=e=>{const t=(...c)=>c.reduce((d,u)=>(Object.assign(d.node,u.node),Object.assign(d.way,u.way),Object.assign(d.relation,u.relation),d),{node:{},way:{},relation:{}}),{node:n,way:s,relation:o}=e,r=Eo(n,s,o),i=Mo(n,s,o),l=To(n,s,o);return{ptv2:r,highway:i,created:l,global:t(r,i)}},Ao=Nn.createComputed(e=>({collections:Bt(e.meta),tree:Ro(e.meta)}));function Io(e,t,n,s){const o=e.meta[t][n]["@_localStates"];o&&s(o)}function me(e,t,n){e.meta[t][n]["@_localStates"]={visible:!0,highlighted:!1,hovered:!1,selected:!1,active:!1}}function Ht(e,t,n){if(e.activeRef){const{type:s,id:o}=e.activeRef;e.meta[s][o]["@_localStates"]&&(e.meta[s][o]["@_localStates"].active=!1)}e.activeRef={type:t,id:n},e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!0)}function $t(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)||(e.selectedRef.push({type:t,id:n}),e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].selected=!0))}function $e(e){if(e.activeRef){const{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1),e.activeRef=void 0}e.selectedRef.forEach(({id:t,type:n})=>e.meta[n][t]["@_localStates"]&&(e.meta[n][t]["@_localStates"].selected=!1)),e.selectedRef=[]}function Po(e,t,n){$t(e,t,n),Ht(e,t,n)}function Lo(e,t,n){$t(e,t,n)}function Do(e,t,n){const s=e.meta[t][n]["@_localStates"];if(s!=null&&s.active&&(s.active=!1,e.activeRef=void 0),s!=null&&s.selected&&(s.selected=!1,e.selectedRef=e.selectedRef.filter(o=>!(o.id===n&&o.type===t))),!e.activeRef&&e.selectedRef.length>0){const{type:o,id:r}=e.selectedRef[0];Ht(e,o,r)}}let Fo=-1;const Oo=e=>({"@_id":`${Fo--}`,"@_lat":e.lat,"@_lon":e.lon,"@_visible":"true"});let Bo=-1;const Wt=e=>({"@_id":`${Bo--}`,nd:[...e],"@_visible":"true"});let Ho=-1;const $o=e=>({"@_id":`${Ho--}`,member:[...e],"@_visible":"true"});function Se(e,t,n){const s=n["@_id"];e.meta[t][s]&&console.debug(`Can't add feature ${t} ${s}: already exsits! Ignoring this attempt`),e.meta[t][s]=n,me(e,t,s)}function Wo(e,t,n){return I(n).forEach(s=>Se(e,t,s))}function Vt(e,t){const n=Oo(t);return e.meta.node[n["@_id"]]=n,me(e,"node",n["@_id"]),n["@_id"]}function Vo(e,t){const n=Wt(t);return e.meta.way[n["@_id"]]=n,me(e,"way",n["@_id"]),n["@_id"]}function Uo(e,t){const n=$o(t);return e.meta.relation[n["@_id"]]=n,me(e,"relation",n["@_id"]),n["@_id"]}const te=(e,t,n,s)=>{const o=e.meta[t][n];o&&(s(o),o["@_action"]="modify")};function Xo(e,t,n){const s=t.elems.node[n].fathers.way.map(o=>e.meta.way[o]);s==null||s.forEach(o=>{const r=o.nd,i=r.findIndex(l=>l["@_ref"]===n);if(i!==0&&i!==r.length-1){if(i===-1)throw new Error(`way ${o} must contain node ${n}, the feature tree is broken.`);const l=r.slice(i);o.nd=r.slice(0,i+1),o["@_action"]="modify";const c=Wt(l);c.tag=o.tag&&[...o.tag],e.meta.way[c["@_id"]]=c,me(e,"way",c["@_id"]);const d=t.elems.way[o["@_id"]].fathers.relation.map(u=>e.meta.relation[u]);d==null||d.forEach(u=>{const p=u.member,f=p.findIndex(h=>h["@_ref"]===o["@_id"]);if(f===-1)throw new Error(`relation ${u} must contain way ${o}, the feature tree is broken.`);p.splice(f+1,0,{"@_ref":c["@_id"],"@_type":"way","@_role":p[f]["@_role"]}),u.member=p,u["@_action"]="modify"})}})}function Me(e,t,n){if(!e.meta[t][n])throw new Error(`Can't delete feature ${t} ${n}: not exsit!`);e.deletedMeta[t][n]=e.meta[t][n],e.deletedMeta[t][n]["@_action"]="delete",delete e.meta[t][n]}function qo(e,t,n){const{way:s,relation:o}=t.elems.node[n].fathers;s.forEach(r=>{te(e,"way",r,i=>{i.nd=i.nd.filter(l=>l["@_ref"]!==n)}),e.meta.way[r].nd.length<=1&&Ut(e,t,r)}),o.forEach(r=>{te(e,"relation",r,i=>{i.member=i.member.filter(l=>l["@_type"]==="node"&&l["@_ref"]===n)})}),Me(e,"node",n)}function Ut(e,t,n){e.meta.way[n].nd.forEach(o=>{const r=o["@_ref"],{way:i,relation:l}=t.elems.node[r].fathers;i.length>1||l.length>0||Me(e,"node",r)});const{relation:s}=t.elems.way[n].fathers;s.forEach(o=>{te(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="way"&&i["@_ref"]===n)})}),Me(e,"way",n)}function Ko(e,t,n){const{relation:s}=t.elems.relation[n].fathers;s.forEach(o=>{te(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="relation"&&i["@_ref"]===n)})}),Me(e,"relation",n)}function Go(e,t,n,s){if(n==="node")qo(e,t,s);else if(n==="way")Ut(e,t,s);else if(n==="relation")Ko(e,t,s);else throw new Error(`Type ${n} not allowed.`)}const Yo=["tag","nd","member","node","way","relation"];async function oe(e,t){const n=`${e}${t}`,s=await fetch(n);if(!s.ok)throw new Error(`Error on fetching ${n}: ${s.statusText}`);const o=await s.text(),i=new Ct.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",isArray:(l,c,d,u)=>!u&&Yo.includes(l)}).parse(o);return console.log(`Get ${n}`,JSON.stringify(i),i),i}async function zo(e,t,n,s,o){const r=await oe(e,`/api/0.6/map?bbox=${t},${n},${s},${o}`);return r.osm.bounds["@_maxlat"]=Number(r.osm.bounds["@_maxlat"]),r.osm.bounds["@_minlat"]=Number(r.osm.bounds["@_minlat"]),r.osm.bounds["@_maxlon"]=Number(r.osm.bounds["@_maxlon"]),r.osm.bounds["@_minlon"]=Number(r.osm.bounds["@_minlon"]),r.osm.node=I(r.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i.tag&&(i.tag=I(i.tag)),i)),r}async function Zo(e,t){const s=(await oe(e,`/api/0.6/node/${t}`)).osm.node;return s["@_lon"]=Number(s["@_lon"]),s["@_lat"]=Number(s["@_lat"]),s}async function Jo(e,t){return(await oe(e,`/api/0.6/way/${t}`)).osm.way}async function Qo(e,t){return(await oe(e,`/api/0.6/relation/${t}`)).osm.relation}async function We(e,t){if(t.length===0)return[];const s=`/api/0.6/nodes?nodes=${t.join(",")}`,o=await oe(e,s);return I(o.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i))}async function es(e,t){if(t.length===0)return[];const s=`/api/0.6/ways?ways=${t.join(",")}`,o=await oe(e,s);return I(o.osm.way)}async function ts(e,t){if(t.length===0)return[];const s=`/api/0.6/relations?relations=${t.join(",")}`,o=await oe(e,s);return I(o.osm.relation)}async function ns(e,{viewpoint:t,zoom:n,width:s,height:o},r){const{left:l,bottom:c,right:d,top:u}=It(t,n,s,o),p=f=>f.osm.bounds["@_minlon"]<=l+1e-7&&f.osm.bounds["@_minlat"]<=c+1e-7&&f.osm.bounds["@_maxlon"]>=d-1e-7&&f.osm.bounds["@_maxlat"]>=u-1e-7;return e.some(p)?(console.log("requested bbox is already cached"),null):(console.log(`osm load data, faild to get cache: ${l} ${c} ${d} ${u}`,t,n),console.log("state bboxs",e),await zo(r,l,c,d,u))}function Xt(e,t,n){const s=Vt(e,t);return te(e,"node",s,n),s}function os(e,t,n,s){let o="0";return te(e,"way",s,r=>{const i=r.nd.map(d=>e.meta.node[d["@_ref"]]),{nearestPoint:l,insertAfter:c}=Dt(t,i);o=Xt(e,l,n),r.nd.splice(r.nd.findIndex(d=>d["@_ref"]===c["@_id"])+1,0,{"@_ref":o})}),o}const ss=e=>({modifyFeatureStateNC:(t,n,s)=>e(o=>{Io(o,t,n,s)}),selectFeature:(t,n,s)=>e(o=>{U(o),s&&$e(o),Po(o,t,n)}),selectFeatureWithoutActive:(t,n,s)=>e(o=>{U(o),s&&$e(o),Lo(o,t,n)}),unSelectFeature:(t,n)=>e(s=>{U(s),Do(s,t,n)}),clearSelect:()=>e(t=>{U(t),$e(t)})}),as=(e,t)=>({addFeatureMetaBatch:(n,s)=>e(o=>Wo(o,n,s)),createLocalNode:n=>{let s="0";return e(o=>{U(o),s=Vt(o,n)}),s},createLocalWay:n=>{let s="0";return e(o=>{U(o),s=Vo(o,n)}),s},createLocalRelation:n=>{let s="0";return e(o=>{U(o),s=Uo(o,n)}),s},modifyFeatureMetaNC:(n,s,o)=>e(r=>{te(r,n,s,o)}),deleteFeature:(n,s)=>e(o=>{U(o),Go(o,t().tree,n,s)}),splitWay:n=>e(s=>{U(s),Xo(s,t().tree,n)})}),rs=(e,t)=>({loadbbox:async(n,s)=>{const{bbox:o,meta:r}=t();if(!(n.zoom<=16))try{const i=await ns(o||[],n,s);if(i===null)return;const{node:l,way:c,relation:d}=Fe(r),u=[],p=[],f=[];i.osm.node.forEach(b=>{const y=b["@_id"];l[y]||(l[y]=b,u.push(b))}),i.osm.way.forEach(b=>{const y=b["@_id"];c[y]||(c[y]=b,p.push(b))}),i.osm.relation.forEach(b=>{const y=b["@_id"];d[y]||(d[y]=b,f.push(b))});const h=Bt({node:l,way:c,relation:d}),j={nodesId:new Set(Object.keys(h.global.node)),waysId:new Set(Object.keys(h.global.way)),relationsId:new Set(Object.keys(h.global.relation))},x=u.filter(b=>j.nodesId.has(b["@_id"])),m=p.filter(b=>j.waysId.has(b["@_id"])),g=f.filter(b=>j.relationsId.has(b["@_id"]));e(b=>{U(b),x.forEach(y=>{b.meta.node[y["@_id"]]||Se(b,"node",y)}),m.forEach(y=>{b.meta.way[y["@_id"]]||Se(b,"way",y)}),g.forEach(y=>{b.meta.relation[y["@_id"]]||Se(b,"relation",y)}),b.bbox.push({...i,osm:{...i.osm,node:[],way:[],relation:[]}})})}catch(i){console.log(i)}},loadFeature:async(n,s,o)=>{const{meta:r,addFeatureMetaBatch:i}=t();if(n==="node")r.node[s]||i("node",await Zo(o,s));else if(n==="way"){const l=await Jo(o,s),c=await We(o,l.nd.map(d=>d["@_ref"]));i("node",c.filter(d=>!r.node[d["@_id"]])),r.way[s]||i("way",l)}else n==="relation"&&(r.relation[s]||i("relation",await Qo(o,s)))},loadFeatureBatch:async(n,s)=>{const{meta:o,addFeatureMetaBatch:r}=t(),i=n.filter(d=>d.type==="node"&&!o.node[d.id]).map(d=>d.id),l=n.filter(d=>d.type==="way"&&!o.way[d.id]).map(d=>d.id),c=n.filter(d=>d.type==="relation"&&!o.relation[d.id]).map(d=>d.id);if(l.length>0){const d=await es(s,l),u=d.map(f=>f.nd.map(h=>h["@_ref"]).filter(h=>!o.node[h])).flat(),p=await We(s,u);r("node",p),r("way",d)}if(i.length>0){const d=await We(s,i);r("node",d)}if(c.length>0){const d=await ts(s,c);r("relation",d)}},setAutoloadNC:n=>e(s=>{s.autoload=typeof n=="function"?n():n})}),is=e=>({createBusStop:(t,n)=>e(s=>{U(s),Xt(s,t,o=>{o.tag=n})}),createStopPosition:(t,n,s)=>e(o=>{U(o),os(o,t,r=>{r.tag=n},s)})}),ls=e=>({reset:()=>{e({...Ot})}}),E=Ke()(Ge(mt(Ao(so(vn((...e)=>({...Ot,...Co(...e),...ss(...e),...as(...e),...rs(...e),...is(...e),...ls(...e)})),{partialize:e=>{const{tree:t,collections:n,...s}=e;return s},equality:(e,t)=>e.commitCounter===t.commitCounter})),{name:"OSMMapStateStore",storage:ft(()=>localStorage),partialize:e=>{const{tree:t,collections:n,...s}=e;return s}}),{name:"OSMMapState"})),cs=e=>({updateSettingsAction:t=>e(()=>t)}),ds={osmAPI:{BASEURL:"https://api.openstreetmap.org",TILE_SOURCE:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"},view:{MAX_ZOOM:19},pixiRender:{zIndex:{LINE:10,POINT:20,MASK:30}}},us={name:"settingStore",storage:ft(()=>localStorage)},ee=Ke()(Ge(mt((...e)=>({...ds,...cs(...e)}),us),{name:"Settings"}));function ps(e,t,n,s){return e.replace("{z}",String(s)).replace("{x}",String(t)).replace("{y}",String(n))}function ms({source:e,x:t,y:n,mapViewStatus:{zoom:s,width:o,height:r,viewpoint:i}}){const l=ps(e,t,n,s),c={x:t*ue,y:n*ue},d=At(c,i,s,o,r);return a.jsx($.Sprite,{image:l,position:d})}function qt(e){const{width:t,height:n}=e,s=ee(c=>c.osmAPI.TILE_SOURCE),o=W(),{viewpoint:r,zoom:i}=o,l=()=>{const{x:c,y:d}=Rt(r,i),[u,p,f,h]=[c-(t>>1),d-(n>>1),c+(t>>1),d+(n>>1)].map(x=>Math.floor(x/ue)),j=[];for(let x=u;x<=f;x++)for(let m=p;m<=h;m++)j.push(a.jsx(ms,{source:s,x,y:m,mapViewStatus:{...e,...o}},`${x}-${m}`));return j};return a.jsx($.Container,{children:l()})}function fs(e,t){return[e[0]+t[0],e[1]+t[1]]}function hs(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function xe(e,t,n=0){return Math.abs(e[0]-t[0])<=n&&Math.abs(e[1]-t[1])<=n}function Ne(e,t){const n=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(n*n+s*s)}function xs(e,t={}){const s=[e[0],e[1]],o=[e[e.length-2],e[e.length-1]],r=xe(s,o,1e-4),i=new Et(e);t.native=!1,i.closeStroke=!1;const l={shape:i,lineStyle:t},c={closePointEps:1e-4,indices:[],points:[],uvs:[]};ao.buildLine(l,c);const d=c.points,u=c.indices,p=new Map,f=[],h=[];let j=[NaN,NaN],x=[NaN,NaN],m=0,g=0,b=[NaN,NaN],y=[NaN,NaN],S=[NaN,NaN],C=NaN,k=NaN,_=NaN;for(let M=0;M<u.length;M+=3){const A=u[M],P=u[M+1],H=u[M+2],X=[d[A*2],d[A*2+1]],Y=[d[P*2],d[P*2+1]],D=[d[H*2],d[H*2+1]];if(M===0)p.set(A,!0),p.set(P,!1),p.set(H,!0),f.push(X),h.push(Y),f.push(D),x=Y,j=D,m=Ne(X,D);else{let ae=p.get(A),re=p.get(P),ie=p.get(H);ae===void 0&&xe(X,b,1e-4)&&(ae=p.get(C),p.set(A,ae)),re===void 0&&xe(Y,y,1e-4)&&(re=p.get(k),p.set(P,re)),ie===void 0&&xe(D,S,1e-4)&&(ie=p.get(_),p.set(H,ie));let le,z,ce;ae===void 0&&(le=A,z=X,ce=!ie),re===void 0&&(le=P,z=Y,ce=!ae),ie===void 0&&(le=H,z=D,ce=!re),le!==void 0&&(p.set(le,ce),ce===!0?(f.push(z),m+=Ne(j,z),j=z):(h.push(z),g+=Ne(x,z),x=z))}b=X,y=Y,S=D,C=A,k=P,_=H}const v={},B=f.length+h.length+1,F=new Array(B*2);let N=0;for(let M=0;M<f.length;++N,++M)F[N*2]=f[M][0],F[N*2+1]=f[M][1];for(let M=h.length-1;M>=0;++N,--M)F[N*2]=h[M][0],F[N*2+1]=h[M][1];if(F[N*2]=f[0][0],F[N*2+1]=f[0][1],v.perimeter=F,r){const M=g>m?h:f,A=new Array((M.length+1)*2);for(let P=0;P<M.length;++P)A[P*2]=M[P][0],A[P*2+1]=M[P][1];A[M.length*2]=M[0][0],A[M.length*2+1]=M[0][1],v.outer=A}return v}function lt(e,t,n=!1,s=!1){let r=t,i;const l=[];for(let c=0;c<e.length;c++){const d=e[c];if(i){let u=Ne(i,d)-r;if(u>=0){const p=hs(i,d),f=t*Math.cos(p),h=t*Math.sin(p);let j=0,x=0;n&&(j=7*Math.cos(p+Math.PI/2),x=7*Math.sin(p+Math.PI/2));let m=[i[0]+r*Math.cos(p)+j,i[1]+r*Math.sin(p)+x];const g=[i,m];for(s&&u>=t*100&&(t=Math.floor(u/100)),u-=t;u>=0;u-=t)m=fs(m,[f,h]),g.push(m);g.push(d),l.push({coords:g.slice(1,-1),angle:p+(n?Math.PI/2:0)})}r=-u}i=d}return l}function ge(e){return e==="butt"?ye.BUTT:e==="square"?ye.SQUARE:ye.ROUND}function be(e){return e==="bevel"?je.BEVEL:e==="miter"?je.MITER:je.ROUND}Le.from("src/location-pin.svg");const gs=Le.from("src/circle.svg"),bs=Le.from("src/bus.svg"),ct=Le.from("src/arrow-right-long.svg"),ws={proposed:!0,planned:!0,construction:!0,disused:!0,abandoned:!0,was:!0,dismantled:!0,razed:!0,demolished:!0,destroyed:!0,removed:!0,obliterated:!0,intermittent:!0};function ys(e){const t=e.split(":");return t.length===1?e:t[0]in ws?e.slice(t[0].length+1):e}const dt={aerialway:{chair_lift:!0,drag_lift:!0,"j-bar":!0,magic_carpet:!0,mixed_lift:!0,platter:!0,rope_tow:!0,"t-bar":!0,zip_line:!0},highway:{motorway:!0},junction:{circular:!0,roundabout:!0},man_made:{goods_conveyor:!0,"piste:halfpipe":!0},"piste:type":{downhill:!0,sled:!0,yes:!0},roller_coaster:{track:!0},"seamark:type":{"two-way_route":!0,recommended_traffic_lane:!0,separation_lane:!0,separation_roundabout:!0},waterway:{canal:!0,ditch:!0,drain:!0,fish_pass:!0,flowline:!0,pressurised:!0,river:!0,spillway:!0,stream:!0,tidal_channel:!0}},we={natural:{cliff:!0,coastline:!0},barrier:{retaining_wall:!0,kerb:!0,guard_rail:!0,city_wall:!0},man_made:{embankment:!0},waterway:{weir:!0}};function js(e){const t={yes:!0,1:!0,"-1":!0,reversible:!0,alternating:!0,no:!1,0:!1};let n=null;return e.forEach(s=>{s["@_k"]==="oneway"&&t[s["@_v"]]&&(n=t[s["@_v"]])}),n!==null?n:(e.forEach(s=>{s["@_k"]in dt&&s["@_v"]in dt[s["@_k"]]&&(n=!0)}),!!n)}function _s(e){const t=()=>{for(let n=0;n<e.length;n++){const s=e[n]["@_k"],o=e[n]["@_v"],r=ys(s);if(r in we&&o in we[r])return we[r][o]?r:we[r][o]}return null};return e.some(n=>n["@_k"]==="two_sided"&&n["@_v"]==="yes")?!1:t()!==null}const Ss={surface:{paved:!0,asphalt:!0,concrete:!0,chipseal:!0,"concrete:lanes":!0,"concrete:plates":!0},tracktype:{grade1:!0}},Ns=new Set(["motorway","trunk","primary","secondary","tertiary","residential","motorway_link","trunk_link","primary_link","secondary_link","tertiary_link","unclassified","road","service","track","living_street","bus_guideway","busway"]),ve=new Set(["abandoned","construction","demolished","destroyed","dismantled","disused","intermittent","obliterated","planned","proposed","razed","removed","was"]),vs=new RegExp("^("+Array.from(ve).join("|")+"):"),Ve={DEFAULTS:{fill:{width:2,color:11184810,alpha:.3},casing:{width:5,color:4473924,alpha:1,cap:"round",join:"round"},stroke:{width:3,color:13421772,alpha:1,cap:"round",join:"round"}},LIFECYCLE:{casing:{alpha:0},stroke:{dash:[7,3],cap:"butt"}},red:{fill:{color:14708319,alpha:.3}},green:{fill:{color:9228383,alpha:.3}},blue:{fill:{color:7853278,alpha:.3}},yellow:{fill:{color:16777108,alpha:.25}},gold:{fill:{color:12893721,alpha:.3}},orange:{fill:{color:14059546,alpha:.3}},pink:{fill:{color:14918901,alpha:.3}},teal:{fill:{color:10084778,alpha:.3}},lightgreen:{fill:{color:12511295,alpha:.3}},tan:{fill:{color:16112826,alpha:.3}},darkgray:{fill:{color:9211020,alpha:.5}},lightgray:{fill:{color:11184810,alpha:.3}},motorway:{casing:{width:10,color:7354159},stroke:{width:8,color:13574273}},trunk:{casing:{width:10,color:7354159},stroke:{width:8,color:14495522}},primary:{casing:{width:10,color:7354159},stroke:{width:8,color:16357382}},secondary:{casing:{width:10,color:7354159},stroke:{width:8,color:15987474}},tertiary:{casing:{width:10,color:7354159},stroke:{width:8,color:16775603}},unclassified:{casing:{width:10,color:4473924},stroke:{width:8,color:14535850}},residential:{casing:{width:10,color:4473924},stroke:{width:8,color:16777215}},living_street:{casing:{width:7,color:16777215},stroke:{width:5,color:13421772}},service:{casing:{width:7,color:4473924},stroke:{width:5,color:16777215}},special_service:{casing:{width:7,color:4473924},stroke:{width:5,color:14535850}},track:{casing:{width:7,color:7630703},stroke:{width:5,color:12957087}},pedestrian:{casing:{width:7,color:16777215},stroke:{width:5,color:10061960,dash:[8,8],cap:"butt"}},path:{casing:{width:5,color:14535850},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},footway:{casing:{width:5,color:16777215},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},crossing_marked:{casing:{width:5,color:14535850},stroke:{width:3,color:4998212,dash:[6,3],cap:"butt"}},crossing_unmarked:{casing:{width:5,color:14535850},stroke:{width:3,color:7826026,dash:[6,4],cap:"butt"}},cycleway:{casing:{width:5,color:16777215},stroke:{width:3,color:5810669,dash:[6,6],cap:"butt"}},bridleway:{casing:{width:5,color:16777215},stroke:{width:3,color:14708063,dash:[6,6],cap:"butt"}},corridor:{casing:{width:5,color:16777215},stroke:{width:3,color:9228383,dash:[2,8],cap:"round"}},steps:{casing:{width:5,color:16777215},stroke:{width:3,color:8507996,dash:[3,3],cap:"butt"}},river:{fill:{color:7853278,alpha:.3},casing:{width:10,color:4473924},stroke:{width:8,color:7855581}},stream:{fill:{color:7853278,alpha:.3},casing:{width:7,color:4473924},stroke:{width:5,color:7855581}},ridge:{stroke:{width:2,color:9228383}},runway:{casing:{width:10,color:0,cap:"butt"},stroke:{width:8,color:16777215,dash:[24,48],cap:"butt"}},taxiway:{casing:{width:7,color:4473924},stroke:{width:5,color:16776960}},railway:{casing:{width:7,color:5592405,cap:"butt"},stroke:{width:2,color:15658734,dash:[12,12],cap:"butt"}},ferry:{casing:{alpha:0},stroke:{width:3,color:5810669,dash:[12,8],cap:"butt"}},boundary:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:16777215,dash:[20,5,5,5],cap:"butt"}},boundary_park:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:11592344,dash:[20,5,5,5],cap:"butt"}},barrier:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_wall:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_hedge:{fill:{color:9228383,alpha:.3},casing:{alpha:0},stroke:{width:3,color:9228383,dash:[10,5,2,5],cap:"round"}},tree_row:{casing:{width:7,color:4473924},stroke:{width:5,color:9228383}},construction:{casing:{width:10,color:16777215},stroke:{width:8,color:16542740,dash:[10,10],cap:"butt"}},pipeline:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[80,2],cap:"butt"}},roller_coaster:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[10,1],cap:"butt"}}},ks={aeroway:{runway:"runway",taxiway:"taxiway"},amenity:{childcare:"yellow",college:"yellow",fountain:"blue",kindergarten:"yellow",parking:"darkgray",research_institute:"yellow",school:"yellow",university:"yellow"},building:{"*":"red"},barrier:{city_wall:"barrier_wall",hedge:"barrier_hedge",retaining_wall:"barrier_wall",wall:"barrier_wall","*":"barrier"},boundary:{protected_area:"boundary_park",national_park:"boundary_park","*":"boundary"},crossing:{marked:"crossing_marked",traffic_signals:"crossing_marked",uncontrolled:"crossing_marked",zebra:"crossing_marked","*":"crossing_unmarked"},golf:{green:"lightgreen"},highway:{bridleway:"bridleway",bus_guideway:"railway",busway:"special_service",corridor:"corridor",construction:"construction",cycleway:"cycleway",footway:"footway",living_street:"living_street",living_street_link:"living_street",motorway:"motorway",motorway_link:"motorway",path:"path",pedestrian:"pedestrian",primary:"primary",primary_link:"primary",residential:"residential",residential_link:"residential",secondary:"secondary",secondary_link:"secondary",service:"service",service_link:"service",steps:"steps",tertiary:"tertiary",tertiary_link:"tertiary",track:"track",trunk:"trunk",trunk_link:"trunk",unclassified:"unclassified",unclassified_link:"unclassified"},landuse:{cemetery:"lightgreen",commercial:"orange",construction:"gold",farmland:"lightgreen",farmyard:"tan",flowerbed:"green",forest:"green",grass:"green",industrial:"pink",landfill:"orange",meadow:"lightgreen",military:"orange",orchard:"lightgreen",quarry:"darkgray",railway:"darkgray",recreation_ground:"green",residential:"gold",retail:"orange",village_green:"green",vineyard:"lightgreen"},leisure:{garden:"green",golf_course:"green",nature_reserve:"green",park:"green",pitch:"green",swimming_pool:"blue",track:"yellow"},man_made:{adit:"darkgray",breakwater:"barrier_wall",groyne:"barrier_wall",pipeline:"pipeline"},military:{"*":"orange"},natural:{bare_rock:"darkgray",bay:"blue",beach:"yellow",cave_entrance:"darkgray",cliff:"darkgray",glacier:"lightgray",ridge:"ridge",rock:"darkgray",sand:"yellow",scree:"darkgray",scrub:"yellow",shingle:"darkgray",stone:"darkgray",strait:"blue",tree_row:"tree_row",water:"blue",wetland:"teal","*":"green"},power:{plant:"pink"},railway:{platform:"footway","*":"railway"},roller_coaster:{track:"roller_coaster"},route:{ferry:"ferry"},sport:{baseball:"yellow",basketball:"darkgray",beachvolleyball:"yellow",skateboard:"darkgray",softball:"yellow"},type:{waterway:"river"},waterway:{river:"river",dam:"DEFAULTS",weir:"DEFAULTS","*":"stream"},service:{alley:"special_service",driveway:"special_service","drive-through":"special_service",parking_aisle:"special_service","*":"special_service"}};function Cs(e){var x,m,g,b,y,S,C,k,_,v,B,F;const t=Ve.DEFAULTS,n={};for(const N of e)n[N["@_k"]]=N["@_v"];let s=t,o=999,r;for(const[N,M]of Object.entries(n)){const A=ks[N];if(!A||!M||N==="service"&&n.highway===void 0)continue;const P=A[M]??A["*"];let H=Object.keys(A).length;if(ve.has(M)&&(H=999),P&&H<=o){const X=Ve[P];if(!X){console.error(`invalid styleID: ${P}`);continue}if(s=X,o=H,r=N,o===1)break}}let i=!1;for(const[N,M]of Object.entries(n))if(ve.has(N)&&M!=="no"){i=!0;break}else if((!r||N===r)&&ve.has(M)){i=!0;break}else if(!r&&vs.test(N)&&M!=="no"){i=!0;break}const l={};for(const N of["fill","casing","stroke"]){l[N]={};const M=(x=s[N])==null?void 0:x.width;if(M!==void 0&&typeof M=="number")l[N].width=M;else{const D=(m=t[N])==null?void 0:m.width;D!==void 0&&(l[N].width=D)}const A=(g=s[N])==null?void 0:g.color;if(A!==void 0&&typeof A=="number")l[N].color=A;else{const D=(b=t[N])==null?void 0:b.color;D!==void 0&&(l[N].color=D)}const P=(y=s[N])==null?void 0:y.alpha;if(P!==void 0&&typeof P=="number")l[N].alpha=P;else{const D=(S=t[N])==null?void 0:S.alpha;D!==void 0&&(l[N].alpha=D)}const H=(C=s[N])==null?void 0:C.cap;if(H!==void 0&&typeof H=="string")l[N].cap=H;else{const D=(k=t[N])==null?void 0:k.cap;D!==void 0&&(l[N].cap=D)}const X=(_=s[N])==null?void 0:_.join;if(X!==void 0&&typeof X=="string")l[N].join=X;else{const D=(v=t[N])==null?void 0:v.join;D!==void 0&&(l[N].join=D)}const Y=(B=s[N])==null?void 0:B.dash;if(Y!==void 0&&Array.isArray(Y))l[N].dash=Y;else{const D=(F=t[N])==null?void 0:F.dash;D!==void 0&&(l[N].dash=D)}}const c=n.bridge,d=n.cutting,u=n.embankment,p=n.highway,f=n.tracktype,h=n.tunnel;let j=n.surface;if(p==="track"&&f!=="grade1"&&(j=j||"dirt"),(c||u||d)&&(l.casing.width=(l.casing.width||0)+7,l.casing.color=0,l.casing.cap="butt",(u||d)&&(l.casing.dash=[2,4])),h&&(l.stroke.alpha=.5),j&&p&&Ns.has(p)&&!Ss.surface[j]&&(c||(l.casing.color=13421772),l.casing.cap="butt",l.casing.dash=[4,4]),i){const N=Ve.LIFECYCLE;for(const M of["fill","casing","stroke"])if(N[M])for(const[A,P]of Object.entries(N[M]))l[M][A]=P}return l}const ut=35;function Es({line:e,nodePath:t,mapViewStatus:{viewpoint:n,zoom:s,width:o,height:r},status:{visible:i,hovered:l,selected:c,highlighted:d},layerRef:u,...p}){const f=s>=16&&i,h=t.map(_=>Ye({lon:_["@_lon"],lat:_["@_lat"]},n,s,o,r)),j=w.useRef(null),x=w.useRef(null),m=Cs(I(e.tag)),g=w.useMemo(()=>{var F;const _=Math.max(3,((F=m==null?void 0:m.casing)==null?void 0:F.width)||0),v=h.flatMap(N=>[N.x,N.y]),B={alignment:.5,color:0,width:_+10,alpha:1,join:je.BEVEL,cap:ye.BUTT};return xs(v,B)},[h,m]),b=w.useCallback(_=>{_.clear();const v=m.casing||{};v.dash?_=new de(_,{dash:v.dash,color:v.color,width:v.width,alpha:v.alpha||1,join:be(v.join),cap:ge(v.cap)}):_.lineStyle({color:v.color,width:v.width,alpha:v.alpha||1,join:be(v.join),cap:ge(v.cap)});const[B,...F]=h;_.moveTo(B.x,B.y),F.forEach(N=>{_.lineTo(N.x,N.y)})},[h,m.casing]),y=w.useCallback(_=>{_.clear();const v=m.stroke||{};v.dash?_=new de(_,{dash:v.dash,color:v.color,width:v.width,alpha:v.alpha||1,join:be(v.join),cap:ge(v.cap)}):_.lineStyle({color:v.color,width:v.width,alpha:v.alpha||1,join:be(v.join),cap:ge(v.cap)});const[B,...F]=h;_.moveTo(B.x,B.y),F.forEach(N=>{_.lineTo(N.x,N.y)})},[h,m]),S=w.useCallback(()=>{j.current&&g.perimeter&&(j.current.hitArea=new Et(g.perimeter))},[j,g]);w.useEffect(()=>{const _=j.current;if(_!==null){const v=()=>{S()},B=()=>{const F=f&&l,N=f&&c,M=f&&d;if(F){if(!_.filters){const A=new ke({distance:15,outerStrength:3,color:16776960});A.resolution=2,_.filters=[A]}}else if(M){if(!_.filters){const A=new ke({distance:15,outerStrength:3,color:7377663});A.resolution=2,_.filters=[A]}}else _.filters&&(_.filters=null);if(N&&u.current){x.current||(x.current=new Mt,u.current.addChild(x.current));const A={alpha:.9,dash:[6,3],width:2,color:16711680};x.current.clear();const P=new de(x.current,A);g&&(g.outer&&g.inner?(P.drawPolygon(g.outer),P.drawPolygon(g.inner)):P.drawPolygon(g.perimeter))}else x.current&&(x.current.destroy({children:!0}),x.current=null)};v(),B()}},[d,l,c,f,S,g,u]),w.useEffect(()=>()=>{x.current&&(x.current.destroy({children:!0}),x.current=null)},[]);const C=js(I(e.tag)),k=_s(I(e.tag));return a.jsxs($.Container,{visible:f,position:{x:0,y:0},ref:j,...p,children:[a.jsx($.Graphics,{draw:b}),a.jsx($.Graphics,{draw:y}),C&&lt(h.map(_=>[_.x,_.y]),ut,!1,!0).map((_,v)=>_.coords.map(([B,F],N)=>a.jsx($.Sprite,{eventMode:"none",width:8,height:8,texture:ct,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:B,y:F},rotation:_.angle,tint:0},`${v}-${N}`))).flat(),k&&lt(h.map(_=>[_.x,_.y]),ut,!0,!0).map((_,v)=>_.coords.map(([B,F],N)=>a.jsx($.Sprite,{eventMode:"none",width:8,height:8,texture:ct,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:B,y:F},rotation:_.angle,tint:0},`${v}-${N}`))).flat()]})}function K(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="platform")&&e.some(t=>t["@_k"]==="highway"&&t["@_v"]==="bus_stop")}function Q(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="stop_position")&&e.some(t=>t["@_k"]==="name")&&e.some(t=>t["@_k"]==="bus")}function ne(e){var t;return e=e||[],(t=e.find(n=>n["@_k"]==="name"))==null?void 0:t["@_v"]}function Ze(e){if(e){if(K(e))return"Bus Stop";if(Q(e))return"Stop Position"}}function Ms({node:e,mapViewStatus:{width:t,height:n,viewpoint:s,zoom:o},status:{visible:r,hovered:i,selected:l,highlighted:c},layerRef:d,...u}){const p=o>=16&&r,f=w.useRef(null),h=w.useRef(null),j=K(I(e.tag)),x="dot",m=Ye({lon:e["@_lon"],lat:e["@_lat"]},s,o,t,n);return w.useEffect(()=>{const g=f.current;if(g){const b=()=>{if(!p)return;const S=20,C=g.getLocalBounds().clone();{let k=C.width/2;k<S/2&&(k=S/2),k=k+2;const _=new rt(0,0,k);g.hitArea=_}},y=()=>{const S=p&&i,C=p&&c,k=p&&l;if(S){if(!g.filters){const _=new ke({distance:15,outerStrength:3,color:16776960});_.resolution=2,g.filters=[_]}}else if(C){if(!g.filters){const _=new ke({distance:15,outerStrength:3,color:7377663});_.resolution=2,g.filters=[_]}}else g.filters&&(g.filters=null);if(k&&d.current){console.log("show select"),h.current||(h.current=new Mt,d.current.addChild(h.current));const _={alpha:.9,dash:[6,3],width:3,color:16711680};h.current.clear();const v=g.hitArea;v instanceof rt?(new de(h.current,_).drawCircle(v.x+m.x,v.y+m.y,v.radius,20),console.log(h.current)):v instanceof ro&&new de(h.current,_).drawRect(v.x+m.x,v.y+m.y,v.width,v.height)}else h.current&&(h.current.destroy({children:!0}),h.current=null)};b(),y()}},[o,c,i,p,x,l,d,m]),w.useEffect(()=>()=>{h.current&&(h.current.destroy({children:!0}),h.current=null)},[]),w.useEffect(()=>{const g=f.current;g&&(o<16||(o<17?g.scale.set(.8,.8):g.scale.set(1,1)))},[o]),o<16?null:a.jsxs($.Container,{...u,position:m,visible:p,ref:f,children:[a.jsx($.Sprite,{eventMode:"none",sortableChildren:!1,visible:!0,texture:gs,anchor:{x:.5,y:.5},width:j?16:8,height:j?16:8}),j&&a.jsx($.Sprite,{eventMode:"none",texture:bs,anchor:{x:.5,y:.5},width:11,height:11})]})}const Ts=w.forwardRef(function({view:{width:t,height:n,viewpoint:s,zoom:o},meta:{node:r,way:i},pointRenderer:l,wayRenderer:c,...d},u){const{left:p,bottom:f,right:h,top:j}=w.useMemo(()=>It(s,o,t,n),[s,o,t,n]),x=w.useCallback(({"@_lon":m,"@_lat":g})=>p<=m&&m<=h&&f<=g&&g<=j,[p,f,h,j]);return o<16?null:a.jsxs($.Container,{ref:u,...d,children:[Object.values(i).filter(m=>m.nd.map(g=>r[g["@_ref"]]).some(x)).map(c),Object.values(r).filter(x).map(l)]})});function Rs({selectionRect:e}){if(!e)return null;const{from:t,to:n}=e,s=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);return a.jsx($.Graphics,{draw:l=>{l.clear(),l.beginFill(16753920,.5),l.drawRect(s,o,r,i),l.endFill()}})}function As({node:e,stateMachine:t,...n}){const s=e["@_localStates"],o=e["@_id"];return a.jsx(Ms,{...n,node:e,status:s,eventMode:"static",mousedown:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),mouseup:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerover:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerout:r=>t.transform({...r,componentTarget:{id:o,type:"node"}})})}function Is({way:e,node:t,stateMachine:n,...s}){const o=e["@_localStates"],r=e["@_id"],i=w.useMemo(()=>e.nd.map(l=>t[l["@_ref"]]),[t,e.nd]);return a.jsx(Es,{...s,line:e,nodePath:i,status:o,eventMode:"static",pointerover:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),pointerout:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mousedown:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mouseup:l=>n.transform({...l,componentTarget:{id:r,type:"way"}})})}function Kt({width:e,height:t,stateMachine:n}){const[s,o,r]=W(L(d=>[d.viewpoint,d.zoom,d.selectionRect])),{node:i,way:l}=E(d=>d.meta),c=w.useRef(null);return a.jsxs(a.Fragment,{children:[a.jsx(Ts,{view:{viewpoint:s,zoom:o,width:e,height:t},meta:{node:i,way:l},ref:c,wayRenderer:d=>a.jsx(Is,{way:d,node:i,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:c},d["@_id"]),pointRenderer:d=>a.jsx(As,{node:d,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:c},d["@_id"])}),a.jsx(Rs,{selectionRect:r})]})}function Gt(e,t,n){const s={"?xml":{"@_version":"1.0","@_encoding":"UTF-8"},osm:{bounds:{"@_minlat":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlat"]),1/0),"@_minlon":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlon"]),1/0),"@_maxlat":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlat"]),-1/0),"@_maxlon":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlon"]),-1/0),"@_origin":"v0.0.2-BusFensi"},node:Object.values({...e.node,...t.node}),way:Object.values({...e.way,...t.way}),relation:Object.values({...e.relation,...t.relation}),"@_version":.6,"@_generator":"BusFensi"}};console.log(s,e);const r=new Ct.XMLBuilder({ignoreAttributes:["localStates"],attributeNamePrefix:"@_",suppressBooleanAttributes:!1}).build(s);return console.log(r),r}function Ps({stateMachine:e}){const{createLocalWay:t,createLocalRelation:n,deleteFeature:s,selectFeature:o,clearSelect:r,selectedRef:i,meta:l,bbox:c,deletedMeta:d}=E(L(C=>C)),{updateSettingsAction:u,...p}=ee(),[f,h]=w.useState(!1),[j,x]=w.useState(p),m=()=>{const C=i.filter(_=>_.type==="node").map(_=>({"@_ref":_.id})),k=t(C);o("way",k,!1)},g=()=>{const C=i.map(_=>({"@_ref":_.id,"@_type":_.type})),k=n(C);o("relation",k,!1)},b=()=>{const C=Fe(i);r(),C.forEach(k=>{if(k.type==="node"||k.type==="way"||k.type==="relation")s(k.type,k.id);else throw new Error(`Type not found ${k.type} for id ${k.id}`)})},y=()=>{const C=Gt(l,d,c),k=new Blob([C],{type:"application/xml"}),_=document.createElement("a");_.href=URL.createObjectURL(k),_.download="exported_data.osm",_.click(),URL.revokeObjectURL(_.href)},S=()=>{u(j),h(!1)};return a.jsxs("div",{className:"join",children:[a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node"}),children:"Create Node"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node-on-way"}),children:"Create node on way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"split-way"}),children:"Split way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:m,children:"Create way with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:g,children:"Create relation with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:b,children:"Delete selected"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:y,children:"export josm"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>h(!0),children:"Change Settings"}),f&&a.jsx("div",{className:"modal modal-open",children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:j.osmAPI.BASEURL,onChange:C=>x({...j,osmAPI:{...j.osmAPI,BASEURL:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:j.osmAPI.TILE_SOURCE,onChange:C=>x({...j,osmAPI:{...j.osmAPI,TILE_SOURCE:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:j.view.MAX_ZOOM,onChange:C=>x({...j,view:{...j.view,MAX_ZOOM:parseFloat(C.target.value)}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn",onClick:S,children:"Save"}),a.jsx("button",{className:"btn btn-ghost",onClick:()=>h(!1),children:"Cancel"})]})]})})]})}const Ls=({id:e="drag-bar",dir:t,isDragging:n,...s})=>{const[o,r]=w.useState(!1);return a.jsx("div",{id:e,"data-testid":e,tabIndex:0,className:q("flex-shrink-0 bg-base-300 transition-colors",t==="horizontal"?"cursor-row-resize h-1":"cursor-col-resize w-1",(n||o)&&"bg-accent"),onFocus:()=>r(!0),onBlur:()=>r(!1),...s})},Te=({width:e,height:t,children:n,...s})=>{const{axis:o}=s,r=s.initial||(o==="x"?e/2:t/2),{position:i,separatorProps:l,setPosition:c}=dn({...s,initial:r}),d=w.useRef(o==="x"?e:t);let u={},p={};return o==="x"?(u={width:i,height:t},p={width:e-i,height:t}):(u={width:e,height:i},p={width:e,height:t-i}),w.useEffect(()=>{o==="x"&&e!==d.current?(c(i*(e/d.current)),d.current=e):o==="y"&&t!==d.current&&(c(i*(t/d.current)),d.current=t)},[e,t,d,o,c,i]),a.jsxs("div",{style:{width:e,height:t,display:"flex",flexDirection:o==="x"?"row":"column",position:"relative"},children:[a.jsx("div",{style:u,children:n[0]({width:u.width,height:u.height})}),a.jsx(Ls,{...l,dir:o==="x"?"vertical":"horizontal",isDragging:!1}),a.jsx("div",{style:p,children:n[1]({width:p.width,height:p.height})})]})};function Oe({id:e,filter:t}){const n=E(L(f=>f.meta.node[e])),s=E(L(f=>{var h;return(h=f.meta.node[e])==null?void 0:h["@_localStates"]})),o=E(f=>f.selectFeature);if(!n||!t(n,"node")||!s)return null;const{visible:r,selected:i}=s;let l=`node-${e}`,c=ht;const d=I(n.tag);d.forEach(f=>{f["@_k"]==="name"&&(l=f["@_v"])}),K(d)&&(c=kn);const u=`outline-list-item
    ${r?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,p=f=>{o("node",e,!f.shiftKey)};return a.jsx("li",{className:u,children:a.jsxs("span",{className:i?"active":"",onClick:p,children:[a.jsx(R,{icon:c}),l]})})}function Je({id:e,filter:t}){const n=E(L(m=>Object.keys(m.meta.node))),s=E(L(m=>m.meta.way[e])),o=E(m=>m.selectFeature),r=E(L(m=>{var g;return(g=m.meta.way[e])==null?void 0:g["@_localStates"]})),[i,l]=w.useState(!0);if(!t(s,"way")||!s||!r)return null;const{visible:c,selected:d}=r,u=I(s.tag);let p=`way-${e}`;u.forEach(m=>{m["@_k"]==="name"&&(p=m["@_v"])});const f=I(s.nd).filter(m=>n.includes(m["@_ref"])),h=`outline-list-item
    ${d?"active":c?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,j=m=>{o("way",e,!m.shiftKey)},x=m=>{m.stopPropagation(),l(!i)};return a.jsxs("li",{className:h,children:[a.jsxs("span",{className:`flex flex-row ${d?"bg-neutral text-neutral-content ":""}`,onClick:j,children:[a.jsx(R,{icon:i?Ie:Pe,onClick:x}),a.jsx(R,{icon:xt,className:"ml-2 "}),a.jsx("span",{className:"ml-0 mr-auto",children:p})]}),!i&&a.jsx("ul",{className:"menu menu-xs pl-4",children:f.map(m=>a.jsx(Oe,{id:m["@_ref"],filter:t},m["@_ref"]))})]})}function Qe({id:e,filter:t}){const n=E(L(b=>b.meta.relation[e])),s=E(b=>b.selectFeature),o=E(L(b=>{var y;return(y=b.meta.relation[e])==null?void 0:y["@_localStates"]})),[r,i]=w.useState(!0);if(!t(n,"relation")||!n||!o)return null;const{visible:l,selected:c}=o;let d=`relation-${e}`;I(n.tag).forEach(b=>{b["@_k"]==="name"&&(d=b["@_v"])});const p=`outline-list-item
    ${c?"active":l?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,f=I(n.member),h=f.filter(b=>b["@_type"]==="node"),j=f.filter(b=>b["@_type"]==="way"),x=f.filter(b=>b["@_type"]==="relation"),m=b=>{s("relation",e,!b.shiftKey)},g=b=>{b.stopPropagation(),i(!r)};return a.jsxs("li",{className:p,children:[a.jsxs("span",{className:`flex flex-row ${c?"bg-neutral text-neutral-content ":""}`,onClick:m,children:[a.jsx(R,{icon:r?Ie:Pe,onClick:g}),a.jsx(R,{className:"ml-2",icon:Cn}),d]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[h.map(b=>a.jsx(Oe,{id:b["@_ref"],filter:t},b["@_ref"])),j.map(b=>a.jsx(Je,{id:b["@_ref"],filter:t},b["@_ref"])),x.map(b=>a.jsx(Qe,{id:b["@_ref"],filter:t},b["@_ref"]))]})]})}function Ue({collecion:e,name:t,filterFun:n}){const{node:s,way:o,relation:r}=e,{roots:i}=E(p=>p.tree),[l,c]=w.useState(!0),d=p=>{p.stopPropagation(),c(!l)},u=(p,f)=>p&&(f==="node"&&s[p["@_id"]]||f==="way"&&o[p["@_id"]]||f==="relation"&&r[p["@_id"]])&&n(p,f);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(R,{icon:l?Ie:Pe,onClick:d}),a.jsx(R,{icon:gt,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:t})]}),!l&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...J(i.node)].map(p=>a.jsx(Oe,{id:p,filter:u},p)),[...J(i.way)].map(p=>a.jsx(Je,{id:p,filter:u},p)),[...J(i.relation)].map(p=>a.jsx(Qe,{id:p,filter:u},p))]})]})}function Ds({name:e,filterFun:t}){const{node:n,way:s,relation:o}=E(d=>d.collections.global),[r,i]=w.useState(!0),l=d=>{d.stopPropagation(),i(!r)},c=(d,u)=>d&&t(d,u)&&(u==="node"&&n[d["@_id"]]||u==="way"&&s[d["@_id"]]||u==="relation"&&o[d["@_id"]]);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(R,{icon:r?Ie:Pe,onClick:l}),a.jsx(R,{icon:gt,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...J(n)].map(d=>a.jsx(Oe,{id:d,filter:c},d)),[...J(s)].map(d=>a.jsx(Je,{id:d,filter:c},d)),[...J(o)].map(d=>a.jsx(Qe,{id:d,filter:c},d))]})]})}function Fs({width:e,height:t}){const{ptv2:n,highway:s,created:o}=E(c=>c.collections),[r,i]=w.useState(""),l=(c,d)=>r===""||`${d}-${JSON.stringify(c)}`.includes(r);return a.jsxs("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"outline-view flex flex-col p-1 rounded bg-base-100 overflow-x-scroll",children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2",children:[a.jsx(R,{icon:En}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:r,onChange:c=>i(c.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 overflow-scroll mt-1 rounded",children:a.jsxs("ul",{className:"menu menu-xs bg-base-200",children:[a.jsx(Ue,{name:"Public Transport",collecion:n,filterFun:l}),a.jsx(Ue,{name:"Highway",collecion:s,filterFun:l}),a.jsx(Ue,{name:"Created",collecion:o,filterFun:l}),a.jsx(Ds,{name:"Global",filterFun:l})]})})]})}function et({tags:e,setTags:t,commitChange:n}){const s=w.useRef(!1),o=Fe(e),r=(f,h)=>{s.current||(n(),s.current=!1),o[f]["@_k"]=h,t([...o])},i=(f,h)=>{s.current||(n(),s.current=!1),o[f]["@_v"]=h,t([...o])},l=()=>{s.current=!0},c=()=>{s.current=!1},d=f=>{const h=o.filter((j,x)=>x!==f);n(),t(h)},u=()=>{n(),t([...o,{"@_k":"","@_v":""}])},p=()=>{n(),t(o)};return a.jsxs("table",{className:"table table-xs w-full max-w-full overflow-x-scroll",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Key"}),a.jsx("th",{children:"Value"}),a.jsx("th",{children:"Actions"})]})}),a.jsx("tbody",{children:o.map((f,h)=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsx("input",{type:"text",value:f["@_k"],onFocus:l,onChange:j=>r(h,j.target.value),onBlur:c,className:"input input-bordered input-xs rounded-md border max-w-xs"})}),a.jsx("td",{children:a.jsx("input",{type:"text",value:f["@_v"],onFocus:l,onChange:j=>i(h,j.target.value),onBlur:c,className:"input input-bordered input-xs rounded-md border max-w-xs w-fit"})}),a.jsx("td",{children:a.jsx("button",{onClick:()=>d(h),className:"btn btn-error btn-xs",children:a.jsx(R,{icon:Mn})})})]},h))}),a.jsx("tfoot",{children:a.jsx("tr",{children:a.jsxs("td",{colSpan:3,className:"flex gap-2",children:[a.jsx("button",{onClick:p,className:"btn btn-success btn-sm",children:"Save"}),a.jsx("button",{onClick:u,className:"btn btn-primary btn-sm",children:"Add"})]})})})]})}function tt({meta:e}){const t=J(e).filter(n=>{const s=e[n];return n.startsWith("@_")&&(typeof s=="string"||typeof s=="number")});return a.jsx("ul",{className:"menu menu-xs bg-200 rounded-box",children:t.map(n=>{const s=e[n];return a.jsx("li",{children:a.jsxs("span",{className:"select-text",children:[a.jsx("span",{className:"font-semibold",children:String(n).substring(2)}),a.jsx("span",{className:"ml-auto text-base-content",children:s.toString()})]})},n)})})}function Yt({id:e,type:t}){const n=E(l=>l.selectFeature),{relation:s,way:o}=E(L(l=>l.meta)),r=J(s).filter(l=>Object.prototype.hasOwnProperty.call(s,l)).map(l=>s[l]),i=(l,c)=>{n("relation",c,!l.shiftKey)};return a.jsx("ul",{className:"menu menu-xs",children:r.filter(l=>I(l.member).some(c=>c["@_ref"]===e&&c["@_type"]===t||t==="node"&&(c["@_type"]==="way"&&o[c["@_ref"]]&&I(o[c["@_ref"]].nd).some(d=>String(d["@_ref"])===e)||c["@_type"]==="relation"&&s[c["@_ref"]]&&I(s[c["@_ref"]].member).some(d=>d["@_ref"]===e)))).map(l=>a.jsx("li",{onClick:c=>i(c,l["@_id"]),children:V("name",l.tag)||l["@_id"]},l["@_id"]))})}function nt({id:e,type:t}){const n=E(L(s=>s.meta[t][e]["@_localStates"]));return a.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(n).filter(([,s])=>s).map(([s])=>a.jsx("span",{className:"badge badge-info badge-xs",children:s},s))})}function Os({id:e}){const t=E(L(o=>o.meta.node[e])),n=E(o=>o.modifyFeatureMetaNC),s=E(o=>o.commit);return t?a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Node] ",ne(t.tag)||t["@_id"]]}),a.jsx(nt,{id:e,type:"node"}),a.jsx(tt,{meta:t}),a.jsx(et,{tags:I(t.tag),setTags:o=>{n("node",e,r=>r.tag=o)},commitChange:s}),a.jsx(Yt,{id:e,type:"node"})]}):null}function Re({featuretype:e,metatype:t,fullname:n,id:s,created:o,deleted:r,modified:i,children:l}){let c;switch(e){case"node":c=Pn;break;case"way":c=xt;break;case"relation":c=In;break;default:c=An}return a.jsxs(a.Fragment,{children:[a.jsx("span",{children:a.jsx(R,{icon:c})}),a.jsx("span",{className:"font-semibold",children:n||"[untitled]"}),t&&a.jsx("span",{className:"badge badge-xs h-fit badge-outline text-nowrap",children:t}),a.jsx("div",{className:"badge badge-xs h-fit badge-outline",children:s}),a.jsxs("div",{className:"flex space-x-1",children:[o&&a.jsx("div",{className:"badge badge-xs badge-success tooltip tooltip-bottom","data-tip":"Created",children:a.jsx(R,{icon:Tn})}),i&&a.jsx("div",{className:"badge badge-xs badge-warning tooltip tooltip-bottom","data-tip":"Modified",children:a.jsx(R,{icon:Rn})}),r&&a.jsx("div",{className:"badge badge-xs badge-error tooltip tooltip-bottom","data-tip":"Deleted",children:a.jsx(R,{icon:bt})})]}),a.jsx("span",{className:"flex items-center ml-auto",children:l})]})}function Bs(e){return a.jsxs("li",{children:[" ",a.jsx("span",{className:"flex select-text justify-between items-center rounded",children:a.jsx(Re,{...e})})]})}function zt(e){return e=e||[],V("public_transport",e)==="stop_area"&&V("type",e)==="public_transport"}function ot(e){if(e&&zt(e))return"Stop Area"}function Zt({member:e,memberToId:t,children:n,slotSelection:s}){const[o,r]=w.useState(new Set);w.useEffect(()=>{r(c=>{const d=new Set;return e.forEach(u=>{c.has(t(u))&&d.add(t(u))}),d})},[e,t]);const i=()=>{o.size===e.length?r(new Set):r(new Set(e.map(t)))},l=w.useMemo(()=>{const c=d=>{r(u=>{const p=new Set(u);return p.has(d)?p.delete(d):p.add(d),p})};return({m:d})=>a.jsx(a.Fragment,{children:a.jsx("input",{type:"checkbox",className:"checkbox ml-2",checked:o.has(t(d)),onChange:()=>c(t(d))})})},[o,t]);return a.jsxs(a.Fragment,{children:[s({selected:o,children:a.jsx("input",{type:"checkbox",checked:o.size===e.length,onChange:i,className:"checkbox ml-2"})}),n({member:e,memberToId:t,slot:l})]})}function Hs({id:e,type:t}){const n=E(o=>o.meta[t][e]),s=w.useMemo(()=>{var o;if((o=n==null?void 0:n.tag)!=null&&o.length){if(t==="node")return Ze(n.tag);if(t==="relation")return ot(n.tag)}},[n==null?void 0:n.tag,t]);return a.jsx(Re,{featuretype:t,id:e,metatype:s,fullname:ne(n.tag),created:Number(n["@_id"])<0,deleted:n["@_action"]==="delete",modified:n["@_action"]==="modify"})}function Jt({handelInsertTop:e,handelIntertBottom:t,handelInsertAtActive:n}){const s=E(L(c=>c.selectedRef)),o=w.useCallback(c=>`${c.type}-${c.id}`,[]),r=w.useRef(new Set),i=()=>s.filter(c=>r.current.has(o(c))),l=w.useCallback(({member:c,memberToId:d,slot:u})=>c.map(p=>a.jsxs("div",{className:"flex flex-row gap-1 px-2 mt-1",children:[a.jsx(Hs,{...p}),u({m:p})]},d(p))),[]);return a.jsxs("div",{className:"flex flex-row justify-center p-2 rounded-md",children:[a.jsxs("div",{className:"join join-vertical mr-2",children:[a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{e(i())},children:"InsTop"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{n(i())},children:"InsAct"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{t(i())},children:"InsBtm"})]}),a.jsx("div",{className:"bg-base-200 text-xs rounded max-h-full",children:a.jsx(Zt,{member:s,memberToId:o,slotSelection:({selected:c,children:d})=>(r.current=c,a.jsxs("div",{className:"flex flex-row px-2 py-1",children:[a.jsx("h3",{className:"text text-sm font-semibold",children:"selected Items to insert"}),a.jsx("div",{className:"ml-auto"}),d]})),children:l})})]})}function $s({id:e,element:t="div",children:n,style:s,...o}){const{attributes:r,listeners:i,setNodeRef:l,transform:c,transition:d}=un({id:e}),u={transform:pn.Transform.toString(c),transition:d,...s};return a.jsxs(t,{ref:l,className:"flex flex-row bg-base-200 rounded border pl-1",style:u,...o,children:[a.jsx("button",{...i,...r,className:"btn btn-ghost btn-xs my-auto inline-block",children:a.jsx(R,{icon:wt.faGripVertical})}),n]})}function Ws({memberToId:e,member:t,onDragEnd:n,onDragStart:s,children:o}){const r=mn(st(jn),st(yn,{coordinateGetter:wn})),[i,l]=w.useState(),c=w.useMemo(()=>t.map(f=>({id:e(f),member:f})),[t,e]);function d(f){var x;const{active:h}=f;console.debug("drag memeber start:",h);const j=(x=c.find(m=>m.id===h.id))==null?void 0:x.member;if(!j)throw new Error(`in Drag list got invalid active object ${JSON.stringify(h)}`);l(j),s(j)}function u(f){const{active:h,over:j}=f;if(console.debug("drag memeber end:",h,j),j&&h.id!==j.id){const x=c.findIndex(g=>g.id===h.id),m=c.findIndex(g=>g.id===j.id);n(_n(c,x,m).map(g=>g.member))}l(void 0)}const p=w.useCallback(({id:f,member:h})=>a.jsx($s,{id:f,children:o({member:h})},f),[o]);return a.jsxs(fn,{sensors:r,collisionDetection:hn,onDragStart:d,onDragEnd:u,children:[a.jsx(xn,{items:c,strategy:gn,children:c.map(p)}),a.jsx(bn,{children:i?a.jsxs("div",{className:"flex bg-base-200 rounded-sm pl-1",children:[a.jsx("button",{className:"btn btn-ghost btn-xs my-auto",children:a.jsx(R,{icon:wt.faGripVertical})}),o({member:i,isDragOverlay:!0})]}):null})]})}function Vs({member:e,isDragOverlay:t,slot:n,children:s}){return a.jsx(a.Fragment,{children:s({member:e,children:n({m:e}),overlay:t})})}function Us({member:e,memberToId:t,children:n,slotSelection:s,...o}){const r=w.useCallback(({member:i,memberToId:l,slot:c})=>a.jsx(Ws,{...o,member:i,memberToId:l,children:d=>a.jsx(Vs,{...d,slot:c,children:n})}),[n,o]);return a.jsx(Zt,{member:e,memberToId:t,slotSelection:s,children:r})}function Qt({onDelete:e,member:t,memberToId:n,...s}){const o=E(h=>h.loadFeatureBatch),r=ee(h=>h.osmAPI.BASEURL),[i,l]=w.useState(!1),c=w.useRef(1),d=w.useCallback(()=>c.current++,[c]),u=w.useMemo(()=>t.map(h=>({...h,uniqueIdentifier:d()})),[d,t]),p=w.useCallback(h=>`${n(h)}_AT_LIST_${h.uniqueIdentifier}`,[n]),f=w.useCallback(({selected:h,children:j})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:x=>{x.stopPropagation();const m=u.filter(g=>!h.has(p(g)));e(u,m)},children:a.jsx(R,{icon:Ln.faDeleteLeft})}),a.jsx("button",{className:"btn btn-square btn-xs btn-accent tooltip tooltip-bottom","data-tip":"Download selected member of this list",disabled:i,onMouseDown:async x=>{x.stopPropagation(),l(!0),await o(u.filter(m=>h.has(p(m))).map(m=>m["@_type"]?{type:m["@_type"],id:m["@_ref"]}:{type:"node",id:m["@_ref"]}),r),l(!1)},children:i?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx(R,{icon:Dn.faDownload})}),j]}),[r,o,u,p,e,i,l]);return a.jsx(Us,{...s,member:u,memberToId:p,slotSelection:f})}function en({type:e,id:t,showMetaType:n,children:s}){var g,b,y;const[o,r,i,l]=E(L(S=>[S.meta[e][t],S.selectFeatureWithoutActive,S.unSelectFeature,S.loadFeature])),c=ee(S=>S.osmAPI.BASEURL),d=W(S=>S.setViewpoint),u=w.useMemo(()=>{var S;if(n&&((S=o==null?void 0:o.tag)!=null&&S.length)){if(e==="node")return Ze(o.tag);if(e==="relation")return ot(o.tag)}},[n,o==null?void 0:o.tag,e]),[p,f]=w.useState(!1),h=w.useCallback(async()=>{f(!0),await l(e,t,c),f(!1)},[l,e,t,c]),j=w.useCallback(S=>{if(S.stopPropagation(),e==="node"){const C=o;d({lat:C["@_lat"],lon:C["@_lon"]})}},[o,d,e]),x=w.useCallback(S=>{var C;S.stopPropagation(),(C=o["@_localStates"])!=null&&C.selected?i(e,t):r(e,t,!1)},[t,o,r,e,i]),m=w.useCallback(S=>{S.stopPropagation(),h()},[h]);return o?a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(Re,{featuretype:e,id:t,metatype:u,fullname:ne(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:j,children:a.jsx(R,{icon:yt.faLocationDot})}),a.jsx("button",{className:q("btn btn-xs btn-square tooltip tooltip-bottom",((g=o["@_localStates"])==null?void 0:g.selected)&&"btn-accent"),"data-tip":(b=o["@_localStates"])!=null&&b.selected?"Unselect":"Select",onClick:x,children:a.jsx(R,{icon:(y=o["@_localStates"])!=null&&y.selected?jt.faXmarkCircle:_t.faCheckCircle})}),s&&s({type:e,id:t})]})}):a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(Re,{featuretype:e,id:t,fullname:"[not downloaded]",children:[p?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx("button",{className:"btn btn-square btn-xs btn-success tooltip tooltip-bottom","data-tip":"Download feature",onMouseDown:m,children:a.jsx(R,{icon:Fn})}),s&&s({type:e,id:t})]})})}function Xs({id:e}){const t=E(L(x=>x.meta.way[e])),n=E(x=>x.modifyFeatureMetaNC),s=E(x=>x.commit),[o,r]=w.useState(void 0),i=w.useCallback(({member:x,children:m})=>a.jsx(en,{id:x["@_ref"],type:"node",children:()=>{const g=(o==null?void 0:o.id)===x["@_ref"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:q("btn btn-square btn-xs tooltip tooltip-bottom",g&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:b=>{b.stopPropagation(),r(g?void 0:{id:x["@_ref"],type:"node"})},children:a.jsx(R,{icon:g?St.faCircle:Nt.faCircle})}),m]})}}),[o==null?void 0:o.id]),l=w.useCallback(x=>`nd-${x["@_ref"]}`,[]);if(!t)return null;function c(){s()}function d(x){n("way",e,m=>{m.nd=x})}function u(x){n("way",e,m=>{m.nd=x})}const p=x=>x.filter(m=>m.type==="node").map(m=>({"@_ref":m.id})),f=x=>{console.log("Insert at Top: ",x),s(),n("way",e,m=>{m.nd=[...p(x),...I(t.nd)]})},h=x=>{console.log("Insert at Bottom: ",x),s(),n("way",e,m=>{m.nd=[...I(t.nd),...p(x)]})},j=x=>{if(console.log("Insert at Active: ",x),!o)h(x);else{const m=[...I(t.nd)],g=m.findIndex(b=>b["@_ref"]===o.id);m.splice(g+1,0,...p(x)),s(),n("way",e,b=>{b.nd=m})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Way] ",ne(t.tag)||t["@_id"]]}),a.jsx(nt,{id:e,type:"way"}),a.jsx(tt,{meta:t}),a.jsx(et,{tags:I(t.tag),setTags:x=>{n("way",e,m=>m.tag=x)},commitChange:s}),a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Qt,{member:t.nd,memberToId:l,onDragStart:c,onDragEnd:d,onDelete:(x,m)=>u(m),children:i})}),a.jsx("div",{className:"",children:a.jsx(Jt,{handelInsertTop:f,handelIntertBottom:h,handelInsertAtActive:j})})]}),a.jsx(Yt,{id:e,type:"way"})]})}function qs({id:e}){const t=E(L(y=>y.meta.relation[e])),n=E(y=>y.modifyFeatureMetaNC),s=E(y=>y.commit),[o,r]=w.useState(void 0),i=w.useRef(!1),l=w.useCallback((y,S,C)=>{console.log("edit",y,S,C),i.current&&(i.current=!1,s()),n("relation",e,k=>{k.member=I(t.member).map(_=>{if(_["@_type"]===y&&_["@_ref"]===S){const v=Fe(_);return v["@_role"]=C,v}return _})})},[s,e,t.member,n]),c=()=>{i.current=!0},d=()=>{i.current=!1},u=w.useCallback(y=>`${y["@_type"]}-${y["@_ref"]}`,[]),p=w.useCallback(({member:y,children:S})=>a.jsx(en,{id:y["@_ref"],type:y["@_type"],children:()=>{const C=(o==null?void 0:o.id)===y["@_ref"]&&o.type===y["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:q("btn btn-square btn-xs tooltip tooltip-bottom",C&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:k=>{k.stopPropagation(),r(C?void 0:{id:y["@_ref"],type:y["@_type"]})},children:a.jsx(R,{icon:C?ht:Nt.faCircle})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:y["@_role"],onMouseDown:k=>k.stopPropagation(),onKeyDown:k=>k.stopPropagation(),onChange:k=>l(y["@_type"],y["@_ref"],k.target.value),onBlur:d,onFocus:c})]}),S]})}}),[l,o]);if(!t)return null;function f(){s()}function h(y){n("relation",e,S=>{S.member=y})}function j(y){s(),n("relation",e,S=>{S.member=y})}const x=y=>y.map(S=>({"@_ref":S.id,"@_type":S.type})),m=y=>{console.log("Insert at Top: ",y),s(),n("relation",e,S=>{S.member=[...x(y),...I(S.member)]})},g=y=>{console.log("Insert at Bottom: ",y),s(),n("relation",e,S=>{S.member=[...I(S.member),...x(y)]})},b=y=>{if(console.log("Insert at Active: ",y),!o)g(y);else{const S=[...I(t.member)],C=S.findIndex(k=>k["@_ref"]===o.id&&k["@_type"]===o.type);S.splice(C+1,0,...x(y)),s(),n("relation",e,k=>{k.member=S})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Relation] ",ne(t.tag)||t["@_id"]]}),a.jsx(nt,{id:e,type:"relation"}),a.jsx(tt,{meta:t}),a.jsx(et,{tags:I(t.tag),setTags:y=>{n("relation",e,S=>S.tag=y)},commitChange:s}),a.jsxs("div",{className:"flex flex-row relative",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Qt,{member:t.member,memberToId:u,onDragStart:f,onDragEnd:h,onDelete:(y,S)=>j(S),children:p})}),a.jsx("div",{className:"",children:a.jsx(Jt,{handelInsertTop:m,handelIntertBottom:g,handelInsertAtActive:b})})]})]})}function tn({width:e,height:t}){const n=E(s=>s.activeRef);return a.jsx("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"property-view flex flex-col rounded bg-base-100",children:n?n.type==="node"?a.jsx(Os,{id:n.id}):n.type==="way"?a.jsx(Xs,{id:n.id}):n.type==="relation"?a.jsx(qs,{id:n.id}):a.jsxs("div",{children:["Unknown type for item ",JSON.stringify(n)]}):a.jsx("div",{children:"Please active some component to show prop edit view"})})}function Ks(){const e=$.useApp(),t=W(n=>n.setStageApp);return w.useEffect(()=>(globalThis.__PIXI_APP__=e,e.stage.hitArea=e.screen,t(e),()=>{globalThis.__PIXI_APP__=void 0,t(void 0)}),[e,t]),null}function nn({width:e,height:t,children:n,...s}){const o=W(r=>r.setStage);return w.useEffect(()=>{o(e,t)},[e,t,o]),a.jsxs($.Stage,{width:e,height:t,options:{background:"#1099bb"},...s,children:[n,a.jsx(Ks,{})]})}function on({width:e}){return a.jsx("div",{className:"slot-bottom absolute inset-x-0 bottom-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx("span",{className:"text-base-content bg-base-300 px-2 rounded",children:"data©openstreetmap contributor"})})}function Gs({width:e,height:t}){const n=w.useRef(new jo({meta:E,view:W,settings:ee}));return w.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(nn,{width:e,height:t,options:{background:"#1099bb"},onContextMenu:s=>s.preventDefault(),onMouseDown:s=>{n.current.transform(s)},onPointerMove:s=>{n.current.transform(s)},onMouseUp:s=>{n.current.transform(s)},onWheel:s=>{n.current.transform(s)},children:[a.jsx(qt,{width:e,height:t}),a.jsx(Kt,{width:e,height:t,stateMachine:n.current})]}),a.jsx(on,{width:e}),a.jsx("div",{className:"slot-top absolute inset-x-0 top-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx(Ps,{stateMachine:n.current})})]})}function Ys({width:e,height:t}){return a.jsxs(Te,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(Gs,{...n}),n=>a.jsxs(Te,{...n,axis:"y",children:[s=>a.jsx(Fs,{...s}),s=>a.jsx(tn,{...s})]})]})}function zs({open:e,onClose:t}){const{updateSettingsAction:n,...s}=ee(),[o,r]=w.useState(s),i=E(c=>c.reset),l=()=>{n(o),t()};return a.jsx("div",{className:q("modal",e&&"modal-open"),children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:o.osmAPI.BASEURL,onChange:c=>r({...o,osmAPI:{...o.osmAPI,BASEURL:c.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:o.osmAPI.TILE_SOURCE,onChange:c=>r({...o,osmAPI:{...o.osmAPI,TILE_SOURCE:c.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:o.view.MAX_ZOOM,onChange:c=>r({...o,view:{...o.view,MAX_ZOOM:parseFloat(c.target.value)}}),className:"input input-bordered w-full"})]}),a.jsx("button",{className:"btn btn-error mt-4",onClick:i,children:"Reast All Data (All data will lost)"}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn btn-ghost",onClick:t,children:"Cancel"}),a.jsx("button",{className:"btn",onClick:l,children:"Save"})]})]})})}function Zs(){const[e,t]=E(L(s=>[s.autoload,s.setAutoloadNC])),n=w.useCallback(()=>t(()=>!e),[e,t]);return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Auto load OSM data on drag: "+(e?"Enabled":"Disabled"),children:a.jsx("a",{onClick:n,className:q(e&&"active"),children:a.jsx(R,{icon:On.faA})})})}function Js(){const{viewpoint:e,zoom:t,height:n,width:s}=W(),o=E(L(d=>d.loadbbox)),r=ee(d=>d.osmAPI.BASEURL),[i,l]=w.useState(!1),c=w.useCallback(async()=>{i||(l(!0),await o({width:s,height:n,zoom:t,viewpoint:e},r),l(!1))},[r,n,o,e,s,t,i,l]);return a.jsx("li",{className:q("tooltip tooltip-left",i&&"disabled"),"data-tip":"Load OSM data on current screen",children:a.jsx("a",{onClick:c,children:i?a.jsx("span",{className:"loading loading-spinner loading-xs h-[14px]"}):a.jsx(R,{icon:Bn.faDownLong})})})}function Qs(){return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Export with JSOM format",children:a.jsx("a",{onClick:()=>{const{meta:e,deletedMeta:t,bbox:n}=E.getState(),s=Gt(e,t,n),o=new Blob([s],{type:"application/xml"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download="exported_data.osm",r.click(),URL.revokeObjectURL(r.href)},children:a.jsx(R,{icon:Hn.faFileExport})})})}function ea(){const[e,t]=w.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Change settings",onClick:()=>t(!0),children:a.jsx("a",{children:a.jsx(R,{icon:$n.faGear})})}),a.jsx(zs,{open:e,onClose:()=>t(!1)})]})}function ta(){return a.jsxs("ul",{className:"menu menu-horizontal",children:[a.jsx(Zs,{}),a.jsx(Js,{}),a.jsx(Qs,{}),a.jsx(ea,{})]})}function na({height:e,leftSlot:t}){return a.jsxs("nav",{className:"navbar p-0 bg-base-100 overflow-hidden border-b-2 border-b-base-300",style:{height:e,maxHeight:e,minHeight:e},children:[a.jsx("div",{className:"flex-1",children:t}),a.jsx("div",{className:"flex-none",children:a.jsx(ta,{})})]})}function sn({x:e,y:t,open:n,children:s}){return n?a.jsx("ul",{className:"absolute rounded-lg bg-base-100 menu shadow p-0",style:{top:t,left:e},children:w.Children.map(s,(o,r)=>w.isValidElement(o)?o.type==="a"?a.jsx("li",{children:o},r):a.jsx("li",{children:a.jsx("a",{children:o})},r):null)}):null}const oa=({left:e,right:t,bottom:n,top:s})=>o=>{const r=({"@_lon":l,"@_lat":c})=>e<=l&&l<=t&&n<=c&&c<=s,i=l=>o.meta.node[l["@_ref"]];return{node:Object.entries(o.meta.node).filter(([,l])=>r(l)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{}),way:Object.entries(o.meta.way).filter(([,l])=>l.nd.map(i).some(r)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{}),relation:Object.entries(o.meta.relation).filter(([,l])=>l.member.filter(c=>c["@_type"]==="node"&&i(c)).map(i).some(r)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{})}};function sa(e){const t=e.activeRef;return t?{type:t.type,meta:e.meta[t.type][t.id]}:null}const Xe=e=>t=>{const n=t.selectedRef;return n.length?n.filter(s=>s.type===e).map(s=>t.meta[e][s.id]):[]};class aa extends G{constructor(n,s){super(n);T(this,"idle");T(this,"mousedown");T(this,"draging");this.idle=new O("select-idle"),this.mousedown=new O("select-mousedown"),this.draging=new O("select-dragging"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mousedown,{transform:o=>{const r=this.context,i=o;return o.type==="mousedown"&&o.shiftKey?(console.debug("BatchSelectStateMachine: transition from idle to mousedown"),r.from=se(i.clientX,i.clientY,r),!0):!1}}),this.mousedown.appendNext(this.idle,{transform:o=>{const r=this.context;return["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)?(console.debug("BatchSelectStateMachine: transition from mousedown to idle"),r.from=void 0,!0):!1}}),this.mousedown.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: start dragging");const{clientX:i,clientY:l}=o;return W.getState().setSelectionRect({from:r.from,to:se(i,l,r)}),!0}return!1}}),this.draging.appendNext(this.idle,{transform:o=>{if(["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)){if(console.debug("BatchSelectStateMachine: drag canceled, back to idle"),W.getState().setSelectionRect(),s!=null&&s.onSelectRect){const{clientX:r,clientY:i}=o;s.onSelectRect({from:this.context.from,to:se(r,i,this.context)})}return this.context.from=void 0,!0}return!1}}),this.draging.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: continue dragging");const{clientX:i,clientY:l}=o;return W.getState().setSelectionRect({from:r.from,to:se(i,l,r)}),!0}return!1}})}}class ra extends G{constructor(n,{menus:s}){super(n);T(this,"idle");T(this,"componentHover");T(this,"componentMousedown");T(this,"pointDrag");this.context.rightClickMenus=s,this.idle=new O("pt-bus-component-idle"),this.componentHover=new O("pt-bus-component-hover"),this.componentMousedown=new O("pt-bus-component-mousedown"),this.pointDrag=new O("pt-bus-component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle];const o=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="way"||c.type==="node"&&(K(u)||Q(u))},r=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="way"||c.type==="node"&&(K(u)||Q(u))},i=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="node"&&(K(u)||Q(u))},l=i;this.idle.appendNext(this.componentHover,{transform:c=>{const d=this.context;if(["pointerover","pointerenter"].includes(c.type)&&"componentTarget"in c&&c.componentTarget&&o(c.componentTarget,this.context)){d.componentTarget=c.componentTarget;const{id:u,type:p}=d.componentTarget;console.log("BusComponentStateMachine: component hover triggered",p,u);const{modifyFeatureStateNC:f}=d.store.meta.getState();return f(p,u,h=>h.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:c=>{const d=this.context;if(c.type==="mousedown"&&d.componentTarget&&r(d.componentTarget,d)){console.log("BusComponentStateMachine: transition to "+this.componentMousedown.name);const{id:u,type:p}=d.componentTarget,{modifyFeatureStateNC:f}=d.store.meta.getState();return f(p,u,h=>h.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:c=>{const d=this.context;if(["pointerleave","pointerout"].includes(c.type)&&d.componentTarget){console.log("BusComponentStateMachine: transition to idle");const{id:u,type:p}=d.componentTarget,{modifyFeatureStateNC:f}=d.store.meta.getState();return f(p,u,h=>h.hovered=!1),d.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:c=>{var u;const d=this.context;if(c.type==="pointermove"&&((u=d.componentTarget)==null?void 0:u.type)==="node"&&i(d.componentTarget,d)){console.log("BusComponentStateMachine: start dragging");const{clientX:p,clientY:f}=c,{commit:h}=d.store.meta.getState();return h(),Ce(p,f,d),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:c=>{const d=this.context;if((c.type==="mouseup"||c.type==="mouseupoutside")&&d.componentTarget){if(c.button===Ee.RIGHT){const u=c;this.context.rightClickMenus.stopPosition({...se(u.clientX,u.clientY,this.context),feature:d.componentTarget,open:!0})}if(l(d.componentTarget,d)){const{selectFeature:u}=d.store.meta.getState(),{id:p,type:f}=d.componentTarget;if(typeof p=="string")u(f,p,!c.shiftKey),console.log("selected id",p,d.store.meta.getState().selectFeature);else throw new Error(`id ${p} is invalid for component`)}return d.componentTarget=void 0,!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:c=>c.type==="mouseupoutside"||c.type==="mouseup"?(console.log("BusComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:c=>{if(c.type==="pointermove"){const{clientX:d,clientY:u}=c;return Ce(d,u,this.context),!0}return!1}})}}class ia extends G{constructor(n,s){super(n);T(this,"idle");T(this,"mapViewSubMachine");T(this,"busStopEditSubMachine");T(this,"undoRedo");T(this,"batchSelect");T(this,"menus");this.menus=s;const o=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="way"||c.type==="node"&&(K(u)||Q(u))},r=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="way"||c.type==="node"&&(K(u)||Q(u))},i=(c,d)=>{const u=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="node"&&(K(u)||Q(u))},l=i;this.idle=new O("pt-edit-idle"),this.mapViewSubMachine=new Lt(n,{rightClickHandeler:c=>{s.busStop({...se(c.clientX,c.clientY,this.context),open:!0}),s.stopPosition({x:0,y:0,open:!1})}}),this.busStopEditSubMachine=new ra(n,{menus:s,hoverable:o,clickable:r,dragable:i,selectable:l}),this.undoRedo=new Ft(n),this.batchSelect=new aa(n,{onSelectRect:c=>{const{viewpoint:d,zoom:u,width:p,height:f}=this.context.store.view.getState(),h=xo(d,u,p,f,c),j=this.context.store.meta.getState(),x=oa(h)(j);console.debug("get feature group ",x),Object.entries(x.node).filter(([,m])=>l({id:m["@_id"],type:"node"},this.context)).forEach(([,m])=>j.selectFeature("node",m["@_id"],!1))}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}transform(n){n.type==="mousedown"&&(this.menus.busStop({x:0,y:0,open:!1}),this.menus.stopPosition({x:0,y:0,open:!1})),super.transform(n)}}const la={tag:[{"@_k":"highway","@_v":"bus_stop",importance:"required",description:"将该处定义为公交站点。最常用的标签。",example:"bus_stop"},{"@_k":"public_transport","@_v":"platform",importance:"required",description:"用于描述该功能是一个公共交通月台，服务于公共交通路线。用于符合ptv2的标签。",example:"platform"},{"@_k":"name",importance:"required",description:"公交站点的名称。",example:"海口路海游路"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点。",example:"yes"},{"@_k":"ref",importance:"optional",description:"公交站点的参考代码。（常用于内部定位和维护）",example:"ref=3154"},{"@_k":"local_ref",importance:"recommened",description:"公交站点的参考代码。如果公交站台有大量公交车停靠，每个小站点可有独立 local_ref。",example:"16"},{"@_k":"network",importance:"not-recommened",description:"公交站点的网络。可使用全称或缩写，依据附近线路标注情况确定。",example:"古田公交"},{"@_k":"operator",importance:"not-recommened",description:"在公交站点停靠的公交车的运营公司名称。若多家运营，使用分号（;）分隔。",example:"济阳舜达公共交通有限公司"},{"@_k":"shelter",importance:"recommened",description:"若公交站点提供候车亭则为“yes”，否则为“no”。",example:"no"},{"@_k":"departures_board",importance:"recommened",description:"表明公交站点使用的到站显示屏/牌类型。值可为纸质时刻表、实时显示等；departures_board=no 表示无显示屏/牌。",example:"timetable"},{"@_k":"bench",importance:"recommened",description:"若公交站点提供长凳则为“yes”，否则为“no”。",example:"yes"},{"@_k":"bin",importance:"recommened",description:"若公交站点具备垃圾箱则为“yes”，否则为“no”。",example:"no"},{"@_k":"tactile_paving",importance:"recommened",description:"若公交站点设有视障引导设施（提示视障人士月台边缘）则为“yes”，否则为“no”。",example:"no"},{"@_k":"layer",importance:"optional",description:"适用于多层公交站台。对于非地面公交站点，多层信息是必需的以避免疑问。",example:"-1"},{"@_k":"lit",importance:"recommened",description:"若公交站点夜间亮灯则为“yes”，否则为“no”。",example:"yes"},{"@_k":"surface",importance:"recommened",description:"描述公交车站所在的地面。",example:"concrete"}]},ca={tag:[{"@_k":"public_transport","@_v":"stop_position",importance:"required",description:"用于描述该功能是一个公共交通停车点。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"公交站点的名称。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点",example:"yes"}]};function da({children:e}){return a.jsx("ul",{className:"menu menu-xs",children:e})}function ua({show:e,proceed:t,title:n,message:s}){const o=w.useRef(null);w.useEffect(()=>{const l=o.current;l&&(e?l.showModal():l.close())},[e]);const r=()=>{t(!1)},i=()=>{console.debug("clicking delete ok: "),t(!0)};return a.jsxs("dialog",{ref:o,className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box",children:[n&&a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsx("p",{children:s}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn btn-md",onClick:r,children:"Cancel"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:i,children:"OK"})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})}const pa=e=>a.jsx(ua,{...e}),ma=pe.confirmable(pa);function qe({type:e,meta:t,showMetaType:n,children:s}){var j,x,m;const o=t["@_id"],[r,i,l]=E(L(g=>[g.selectFeature,g.unSelectFeature,g.deleteFeature])),c=W(g=>g.setViewpoint),d=pe.createConfirmation(ma),u=w.useMemo(()=>{var g;if(n&&((g=t.tag)!=null&&g.length)){if(e==="node")return Ze(t.tag);if(e==="relation")return ot(t.tag)}},[n,t.tag,e]),p=w.useCallback(g=>{if(g.stopPropagation(),e==="node"){const b=t;c({lat:b["@_lat"],lon:b["@_lon"]})}},[t,c,e]),f=w.useCallback(g=>{var b;g.stopPropagation(),(b=t["@_localStates"])!=null&&b.selected?i(e,o):r(e,o,!1)},[o,t,r,e,i]),h=w.useCallback(async g=>{g.stopPropagation(),console.debug("deleting: ",e,o);const b=await d({title:"Confirm delete feature",message:`Are you sure you want delete this feature?
`+(ne(t.tag||[])||o)});console.debug("confirmed deleting: ",b,e,o),b&&l(e,o)},[d,l,o,t.tag,e]);return a.jsxs(Bs,{featuretype:e,id:o,metatype:u,fullname:ne(t.tag),created:Number(t["@_id"])<0,deleted:t["@_action"]==="delete",modified:t["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:p,children:a.jsx(R,{icon:yt.faLocationDot})}),a.jsx("button",{className:q("btn btn-xs btn-square tooltip tooltip-bottom",((j=t["@_localStates"])==null?void 0:j.selected)&&"btn-accent"),"data-tip":(x=t["@_localStates"])!=null&&x.selected?"Unselect":"Select",onClick:f,children:a.jsx(R,{icon:(m=t["@_localStates"])!=null&&m.selected?jt.faXmarkCircle:_t.faCheckCircle})}),a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Delete",onClick:h,children:a.jsx(R,{icon:Wn.faTrash})}),s&&s({type:e,meta:t})]})}function fe({node:e,way:t,relation:n,filter:s,...o}){return s=s||(()=>!0),a.jsxs(da,{children:[(e||[]).filter(r=>s(r,"node")).map(r=>w.createElement(qe,{...o,key:r["@_id"],meta:r,type:"node"})),(t||[]).filter(r=>s(r,"way")).map(r=>w.createElement(qe,{...o,key:r["@_id"],meta:r,type:"way"})),(n||[]).filter(r=>s(r,"relation")).map(r=>w.createElement(qe,{...o,key:r["@_id"],meta:r,type:"relation"}))]})}function he({name:e,defaultOpen:t,forceOpen:n,forceClose:s,children:o}){const[r,i]=w.useState(!t),l=d=>{d.stopPropagation(),s||n||i(!r)},c=n?!0:s?!1:!r;return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",onClick:l,children:[a.jsx(R,{icon:n?St.faCircle:s?Vn.faX:c?Xn.faChevronDown:Un.faChevronRight}),a.jsx(R,{icon:qn.faBars,className:"ml-1"}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),c&&o]})}function fa(e){const t=E(n=>n.meta.node);return a.jsx(he,{name:"bus stop",children:a.jsx(fe,{...e,node:Object.values(t).filter(n=>K(n.tag))})})}function ha(e){const t=E(n=>n.meta.relation);return a.jsx(he,{name:"stop area",children:a.jsx(fe,{...e,relation:Object.values(t).filter(n=>zt(n.tag))})})}function xa(e){const t=E(n=>n.meta.node);return a.jsx(he,{name:"stop position",children:a.jsx(fe,{...e,node:Object.values(t).filter(n=>Q(n.tag))})})}function an({children:e}){const[t,n]=w.useState(""),s=(o,r)=>t===""||`${r}-${JSON.stringify(o)}`.includes(t);return a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2 w-full mt-1 mx-auto",children:[a.jsx(R,{icon:Kn.faSearch}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:t,onChange:o=>n(o.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 rounded overflow-scroll",children:a.jsx("ul",{className:"menu menu-xs",children:I(e).map(o=>o({filter:s}))})})]})}function ga(){return a.jsxs(an,{children:[({filter:e})=>a.jsx(fa,{filter:e}),({filter:e})=>a.jsx(xa,{filter:e}),({filter:e})=>a.jsx(ha,{filter:e})]})}function ba({preset:e,title:t,onSubmit:n,open:s,onClose:o}){const[r,i]=w.useState({});w.useEffect(()=>{i(()=>e.tag.reduce((m,g)=>(m[g["@_k"]]=g["@_v"]||"",m),{}))},[e]);const[l,c]=w.useState([]),[d,u]=w.useState("");w.useEffect(()=>{const m=document.getElementById("create-node-modal");s?m==null||m.showModal():m==null||m.close()},[s]);const p=(m,g)=>{i(b=>({...b,[m]:g}))},f=()=>{d.trim()!==""&&(c(m=>[...m,{key:d.trim(),value:""}]),u(""))},h=(m,g)=>{c(b=>b.map((y,S)=>S===m?{...y,value:g}:y))},j=m=>{c(g=>g.filter((b,y)=>y!==m))},x=m=>{m.preventDefault();const g=Object.entries(r).filter(([,y])=>y.length).map(([y,S])=>({"@_k":y,"@_v":S})),b=l.map(y=>({"@_k":y.key,"@_v":y.value}));n([...g,...b]),c([]),u(""),o()};return a.jsx(a.Fragment,{children:a.jsxs("dialog",{id:"create-node-modal",className:"modal",onClose:o,children:[a.jsxs("div",{className:"modal-box w-11/12 max-w-5xl",children:[a.jsx("h3",{className:"font-bold text-lg mb-2",children:t}),a.jsxs("form",{onSubmit:x,className:"space-y-2",children:[e.tag.map(m=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1 tooltip tooltip-top","data-tip":m.description||"",children:[a.jsxs("span",{className:"font-semibold",children:[m["@_k"]," ",m.importance==="required"&&a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:m.example||"Enter value",value:r[m["@_k"]],onChange:g=>p(m["@_k"],g.target.value),required:m.importance==="required",disabled:m.importance==="not-recommened",className:"grow"}),a.jsx("span",{className:"badge",children:m.importance})]},m["@_k"])),l.map((m,g)=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1",children:[a.jsxs("span",{className:"font-semibold",children:[m.key," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:"Enter value",value:m.value,onChange:b=>h(g,b.target.value),required:!0,className:"grow"}),a.jsx("span",{className:"badge",children:"created"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-error",onClick:()=>j(g),children:a.jsx(R,{icon:bt})})]},m.key)),a.jsxs("label",{className:"input input-sm input-bordered flex items-center gap-2",children:[a.jsx("input",{type:"text",placeholder:"New tag key",value:d,onChange:m=>u(m.target.value),onKeyDown:m=>{m.key==="Enter"&&(m.preventDefault(),f())},className:"grow"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-outline",onClick:f,children:"+ add tag"})]}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn",onClick:()=>o(),children:"Cancel"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Submit"})]})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})})}function wa({show:e,proceed:t,preset:n,title:s}){return a.jsx(ba,{preset:n,title:s,open:e,onClose:()=>t(null),onSubmit:t})}const ya=e=>a.jsx(wa,{...e}),rn=pe.confirmable(ya);function ja(e){const t=E(L(sa));return a.jsx(he,{name:"active",forceOpen:!0,children:a.jsx(fe,{...e,node:(t==null?void 0:t.type)==="node"?[t.meta]:void 0,way:(t==null?void 0:t.type)==="way"?[t.meta]:void 0,relation:(t==null?void 0:t.type)==="relation"?[t.meta]:void 0,showMetaType:!0})})}function _a(e){const t=E(L(Xe("node"))),n=E(L(Xe("way"))),s=E(L(Xe("relation"))),o=E(i=>i.selectFeature),r=w.useCallback(({type:i,meta:l})=>a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Active",onClick:async c=>{c.stopPropagation(),console.debug("activating: ",i,l["@_id"]),o(i,l["@_id"],!1)},children:a.jsx(R,{icon:Gn.faStarOfLife})}),[o]);return a.jsx(he,{name:"selected",defaultOpen:!0,children:a.jsx(fe,{...e,node:t,way:n,relation:s,showMetaType:!0,children:r})})}function Sa(){return a.jsxs(an,{children:[({filter:e})=>a.jsx(ja,{filter:e}),({filter:e})=>a.jsx(_a,{filter:e})]})}const Na=w.memo(function(t){const n=W(L(Pt(t))),s=E(i=>i.createBusStop),o=pe.createConfirmation(rn),r=w.useCallback(async()=>{t.onClose();const i=await o({title:"Create Bus stop (Preset CN)",preset:la});i&&(console.debug("created bus stop",i),n&&s(n,i))},[t,o,n,s]);return a.jsx(a.Fragment,{children:a.jsx(sn,{...t,children:a.jsx("a",{onClick:r,children:"New bus stop"})})})}),va=w.memo(function(t){const n=W(L(Pt(t))),s=E(i=>i.createStopPosition),o=pe.createConfirmation(rn),r=w.useCallback(async()=>{var l,c;t.onClose(),console.debug("clicked new stop position");const i=await o({preset:ca,title:"Create Stop position (Preset CN)"});i&&(console.debug("created stop position",i),n&&((l=t.feature)!=null&&l.id)&&s(n,i,(c=t.feature)==null?void 0:c.id))},[t,o,n,s]);return a.jsx(a.Fragment,{children:a.jsx(sn,{...t,children:a.jsx("a",{onClick:r,children:"New stop position"})})})});function ka({width:e,height:t,stateMachine:n}){return w.useEffect(()=>{const s=o=>n.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[n]),a.jsxs(a.Fragment,{children:[a.jsxs(nn,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>{n.transform(s)},onPointerMove:s=>{n.transform(s)},onMouseUp:s=>{n.transform(s)},onWheel:s=>{n.transform(s)},children:[a.jsx(qt,{width:e,height:t}),a.jsx(Kt,{width:e,height:t,stateMachine:n})]}),a.jsx(on,{width:e})]})}function Ca({width:e,height:t,children:n}){return a.jsx("div",{className:"bg-base-100 border-r-2 border-r-base-300 flex flex-col",style:{width:e,height:t,maxWidth:e,maxHeight:t},children:n})}function Ea({width:e,height:t}){const[s,o]=w.useState({x:0,y:0,open:!1}),[r,i]=w.useState({x:0,y:0,open:!1}),l=w.useRef(new ia({meta:E,view:W,settings:ee},{busStop:o,stopPosition:i})).current,c=w.useMemo(()=>[{tooltip:"Bus stop edit tab",icon:a.jsx(R,{icon:Yn.faBusSimple}),stage:()=>a.jsx(ka,{width:e-42,height:t,stateMachine:l})},{tooltip:"Route edit tab",icon:a.jsx(R,{icon:zn.faRoute}),stage:()=>a.jsx("div",{className:"p-2",children:"Route Edit Placeholder"})},{tooltip:"Edit bus relation",icon:a.jsx(R,{icon:Zn.faCodeCommit}),stage:()=>a.jsx("div",{className:"p-2",children:"Bus Relation Edit Placeholder"})}],[e,t,l]),[d,u]=w.useState(0);return a.jsxs("div",{className:"flex flex-row",style:{height:t,width:e,maxHeight:t,maxWidth:e},onContextMenu:p=>p.preventDefault(),children:[a.jsx(Ca,{width:42,height:t,children:c.map((p,f)=>a.jsx("div",{className:"tooltip tooltip-right mx-auto mt-1","data-tip":p.tooltip,children:a.jsx("button",{onClick:()=>u(f),className:q("btn btn-ghost btn-square btn-sm",f===d&&"btn-active"),children:p.icon})}))}),a.jsxs("div",{className:"relative",style:{height:t,width:e-42},children:[c[d].stage(),a.jsx(Na,{...s,onClose:()=>o({x:0,y:0,open:!1})}),a.jsx(va,{...r,onClose:()=>i({x:0,y:0,open:!1})})]})]})}function Ma({width:e,height:t}){const n=[{title:"Bus stop",tab:()=>a.jsx(ga,{})},{title:"Selected",tab:()=>a.jsx(Sa,{})}],[s,o]=w.useState(0);return a.jsxs("div",{style:{width:e,height:t},className:"flex flex-col",children:[a.jsx("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs",children:n.map((r,i)=>a.jsx("a",{onClick:()=>o(i),role:"tab",className:q("tab",i===s&&"tab-active"),children:r.title},i))}),a.jsx("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:n[s].tab()})]})}function Ta({width:e,height:t}){return a.jsxs(Te,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(Ea,{...n}),n=>a.jsxs(Te,{...n,axis:"y",children:[s=>a.jsx(Ma,{...s}),s=>a.jsx(tn,{...s})]})]})}function Ra({width:e,height:t}){const s=w.useMemo(()=>[{title:a.jsx(R,{icon:Jn.faBus}),tooltip:"Public transport edit mode",component:()=>a.jsx(Ta,{width:e,height:t-42})},{title:a.jsx(R,{icon:Qn.faMap}),tooltip:"Map edit mode",component:()=>a.jsx(Ys,{width:e,height:t-42})}],[e,t]),[o,r]=w.useState(0);return a.jsxs("div",{style:{width:e,height:t,position:"relative"},children:[a.jsx(na,{height:42,leftSlot:a.jsx(a.Fragment,{children:s.map((i,l)=>a.jsx("div",{className:"tooltip tooltip-right ml-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(l),className:q("btn btn-ghost btn-square btn-sm",o===l&&"btn-active"),children:i.title})},l))})}),a.jsx("div",{className:"relative",children:s[o].component()})]})}function Aa(){const[{width:e,height:t},n]=w.useState({width:window.innerWidth,height:window.innerHeight});return w.useEffect(()=>{const s=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}}),a.jsx("div",{className:"wrapper h-screen w-screen overflow-hidden",style:{width:e},children:a.jsx(Ra,{width:e,height:t})})}function Ia(){return a.jsx(Aa,{})}function Pa(){return a.jsx(a.Fragment,{children:a.jsx(Ia,{})})}const pt=document.getElementById("root");pt?Sn.createRoot(pt).render(a.jsx(w.StrictMode,{children:a.jsx(Pa,{})})):console.error("Root element not found. Ensure there is an element with the ID 'root' in your HTML.");
