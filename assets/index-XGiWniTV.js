var An=Object.defineProperty;var Pn=(e,t,n)=>t in e?An(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var R=(e,t,n)=>Pn(e,typeof t!="symbol"?t+"":t,n);import{c as ut,j as a,m as G,r as h,u as H,d as In,F as M,a as Dn,C as Ln,b as Fn,e as Et,D as On,f as Bn,S as Hn,v as $n,g as Wn,s as Un,K as Vn,P as qn,h as Xn,l as fe,i as Kn}from"./react-D6IF3wfB.js";import{d as pt,e as zn,f as Ut,h as Vt,j as Gn,k as mt,l as Yn,m as Be,n as He,o as qt,q as Jn,r as Xt,t as Zn,u as Qn,v as ct,w as eo,x as Kt,y as to,z as no,A as oo,B as so,C as zt,D as Gt,E as Yt,F as Jt,G as Zt,H as ao,I as Qt,J as ft,K as ro,L as io,M as lo,N as co,O as uo,P as po,Q as mo,R as fo,S as ho,T as xo,U as go,V as ht,W as bo,X as yo,Y as wo,Z as _o,_ as jo,$ as en,a0 as So,a1 as No,a2 as vo,a3 as ko,a4 as Co}from"./fazustand-DrlNrdqd.js";import{a as tn,f as tt,d as Eo,c as nn,b as nt,s as Mt,g as Mo,h as Ro,j as To,k as on,t as Ao}from"./vendor-DwBm2GRd.js";import{i as sn,j as Po,L as ke,k as Ce,c as $e,l as xe,m as Ae,G as an,n as Io,o as Rt,R as Do}from"./pixi-zB6yLL9X.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const Lo={lon:-122.431297,lat:37.773972},Fo=17,Oo={viewpoint:Lo,zoom:Fo},Bo=e=>({setViewpoint:t=>e(()=>({viewpoint:t})),setZoom:t=>e(()=>({zoom:t})),setStage:(t,n)=>e({width:t,height:n}),setStageApp:t=>e({stage:t}),setSelectionRect:t=>e({selectionRect:t})}),Tt=()=>new URLSearchParams(window.location.search),Ho=e=>{const t=e.toString(),n=t?"?":"";window.history.replaceState(null,"",`${location.pathname}${n}${t}`)},$o=e=>(t,n,s)=>{const o=e(t,n,s),r={},i=Tt(),l=i.get("lat"),c=i.get("lon"),d=i.get("zoom");l&&c&&(r.viewpoint={lat:parseFloat(l),lon:parseFloat(c)}),d&&(r.zoom=parseFloat(d));const f={...o,...r};return t(f,!0,"mapViewURLPersist/hydrate"),s.subscribe((p,x)=>{var m,b,y,k,v,C,I,N,E;const w=Tt();let g=!1;((m=p.viewpoint)==null?void 0:m.lat)!==((b=x.viewpoint)==null?void 0:b.lat)&&(w.set("lat",((k=(y=p.viewpoint)==null?void 0:y.lat)==null?void 0:k.toString())||""),g=!0),((v=p.viewpoint)==null?void 0:v.lon)!==((C=x.viewpoint)==null?void 0:C.lon)&&(w.set("lon",((N=(I=p.viewpoint)==null?void 0:I.lon)==null?void 0:N.toString())||""),g=!0),p.zoom!==x.zoom&&(w.set("zoom",((E=p.zoom)==null?void 0:E.toString())||""),g=!0),g&&Ho(w)}),f},K=ut()(pt($o((...e)=>({...Oo,...Bo(...e)})),{name:"MapView"})),Wo={lon:-122.431297,lat:37.773972};We(Wo);const ge=256,Ee={XMIN:-2003750834e-2,YMIN:-200489661e-1,XMAX:2003750834e-2,YMAX:200489661e-1,EQUATOR:4007501668e-2};function Uo(e){const[t,n]=tn("EPSG:3857","EPSG:4326",[e.x,e.y]);return{lon:t,lat:n}}function We(e){const[t,n]=tn("EPSG:4326","EPSG:3857",[e.lon,e.lat]);return{x:t,y:n}}function rn(e,t){const n=Math.pow(2,t)*ge,s=Ee.EQUATOR/n,o=(e.x-Ee.XMIN)/s,r=(Ee.XMAX-e.y)/s;return{x:o,y:r}}function ln(e,t){return rn(We(e),t)}function cn(e,t,n,s,o){const r=rn(We(t),n),i=s?s/2:0,l=o?o/2:0;return{x:Math.floor(e.x+i-r.x),y:Math.floor(e.y+l-r.y)}}function xt(e,t,n,s,o){return cn(ln(e,n),t,n,s,o)}function oe(e,t,n,s,o){const r=Math.pow(2,n)*ge,i=Ee.EQUATOR/r,l=We(t),c=Math.floor(s/2),d=Math.floor(o/2),f=(e.x-c)*i,u=(e.y-d)*i,p={x:l.x+f,y:l.y-u};return Uo(p)}function dn(e,t,n,s){const{lon:o,lat:r}=oe({x:0,y:0},e,t,n,s),{lon:i,lat:l}=oe({x:n,y:s},e,t,n,s);return{left:o,bottom:l,right:i,top:r}}function Vo(e,t,n,s,{from:o,to:r}){const i={x:Math.min(o.x,r.x),y:Math.min(o.y,r.y)},l={x:Math.max(o.x,r.x),y:Math.max(o.y,r.y)};console.debug("getBoundsByRect, p1 p2",i,l,"vp zoom w h",e,t,n,s,{from:o,to:r});const{lon:c,lat:d}=oe(i,e,t,n,s),{lon:f,lat:u}=oe(l,e,t,n,s);return{left:c,bottom:u,right:f,top:d}}const un=e=>t=>e.x!==0&&e.y!==0?oe(e,t.viewpoint,t.zoom,t.width,t.height):void 0;function le(e){return JSON.parse(JSON.stringify(e))}const ae=e=>Object.keys(e);class qo{constructor(){R(this,"timers",new Map)}debounce(t,n,s,o=!1){return(...r)=>{const i=o&&!this.timers.has(s);this.timers.has(s)&&clearTimeout(this.timers.get(s));const l=setTimeout(()=>{this.timers.delete(s),o||t(...r)},n);this.timers.set(s,l),i&&t(...r)}}cancel(t){this.timers.has(t)&&(clearTimeout(this.timers.get(t)),this.timers.delete(t))}cancelAll(){for(const t of this.timers.values())clearTimeout(t);this.timers.clear()}}function L(e){return e?Array.isArray(e)?e:[e]:[]}const J=(...e)=>e.filter(Boolean).join(" ");class W{constructor(t){R(this,"name");R(this,"next",[]);this.name=t}appendNext(t,n){const s=t instanceof W?t:t.entry;if(n.isEpsilon)this.next.push({isEpsilon:!0,state:s});else{if(!n.transform)throw new Error("Non-Îµ transition requires a transform function.");this.next.push({isEpsilon:!1,transform:n.transform,state:s})}}}const Oe=class Oe{constructor(t){R(this,"name");R(this,"entry");R(this,"current");R(this,"accept");R(this,"debouncer");R(this,"context");this.name="base",this.context={store:t},this.debouncer=new qo}appendNext(t,n){this.accept.forEach(s=>s.appendNext(t,n))}computeEpsilonClosure(t){const n=new Set,s=[t];for(;s.length;){const o=s.pop();if(!n.has(o)){n.add(o);for(const{state:r,isEpsilon:i}of o.next)i&&s.push(r)}}return Array.from(n)}transform(t){const n=this.computeEpsilonClosure(this.current);for(const s of n)for(const o of s.next)if(!o.isEpsilon&&o.transform(t)){this.current=o.state;return}}debouncedTransform(t){this.debouncer.debounce(this.transform.bind(this),Oe.DEBOUNCE_DELAY,t.type,!0)(t)}};R(Oe,"DEBOUNCE_DELAY",20);let Z=Oe;function pe(e,t,n){const{stage:s}=n.store.view.getState(),o=s.view.getBoundingClientRect(),r=e-o.x,i=t-o.y;return console.debug("getLocalPosistion, x y",e,t," convert to ",r,i),{x:r,y:i}}const Pe=(e,t,n)=>{var w;const{height:s,width:o,viewpoint:r,zoom:i,stage:l}=n.store.view.getState();if(!s||!o||!l)return;const c=l.view.getBoundingClientRect(),d=e-c.x,f=t-c.y,{modifyFeatureMetaNC:u}=n.store.meta.getState(),p=oe({x:d,y:f},r,i,o,s),x=xt(p,r,i,o,s);if(console.log("on component drag",{x:e,y:t},{x:d,y:f},x),(w=n.componentTarget)!=null&&w.id&&n.componentTarget.type==="node"){const{type:g,id:m}=n.componentTarget;u(g,m,b=>{b["@_lon"]=p.lon,b["@_lat"]=p.lat})}else throw new Error(`context.componentTarget should not be ${JSON.stringify(n.componentTarget)} at point move`)};class Xo extends Z{constructor(n){super(n);R(this,"idle");R(this,"componentHover");R(this,"componentMousedown");R(this,"pointDrag");this.idle=new W("component-idle"),this.componentHover=new W("component-hover"),this.componentMousedown=new W("component-mousedown"),this.pointDrag=new W("component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:s=>{const o=this.context;if(["pointerover","pointerenter"].includes(s.type)&&"componentTarget"in s&&s.componentTarget){o.componentTarget=s.componentTarget;const{id:r,type:i}=o.componentTarget;console.log("ComponentStateMachine: component hover triggered",i,r);const{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:s=>{const o=this.context;if(s.type==="mousedown"&&o.componentTarget){console.log("ComponentStateMachine: transition to mousedown");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:s=>{const o=this.context;if(["pointerleave","pointerout"].includes(s.type)&&o.componentTarget){console.log("ComponentStateMachine: transition to idle");const{id:r,type:i}=o.componentTarget,{modifyFeatureStateNC:l}=o.store.meta.getState();return l(i,r,c=>c.hovered=!1),o.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:s=>{var r;const o=this.context;if(s.type==="pointermove"&&((r=o.componentTarget)==null?void 0:r.type)==="node"){console.log("ComponentStateMachine: start dragging");const{clientX:i,clientY:l}=s,{commit:c}=o.store.meta.getState();return c(),Pe(i,l,o),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:s=>{const o=this.context;if((s.type==="mouseup"||s.type==="mouseupoutside")&&o.componentTarget){const{selectFeature:r,unSelectFeature:i}=o.store.meta.getState(),{id:l,type:c}=o.componentTarget;if(typeof l=="string")s.ctrlKey?i(c,l):(r(c,l,!s.shiftKey),console.log("selected id",l,o.store.meta.getState().selectFeature)),o.componentTarget=void 0;else throw new Error(`id ${l} is invalid for component`);return!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:s=>s.type==="mouseup"||s.type==="mouseuppoutside"?(console.log("ComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:s=>{if(s.type==="pointermove"){const{clientX:o,clientY:r}=s;return Pe(o,r,this.context),!0}return!1}})}}var be=(e=>(e[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(be||{});class Ue extends Z{constructor(n,s){super(n);R(this,"idle");R(this,"rightMousedown");R(this,"mapDrag");this.idle=new W("mapview-idle"),this.mapDrag=new W("mapview-mapDrag"),this.rightMousedown=new W("mapview-right-mousedown"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="wheel"){const l=r.deltaY<0,{zoom:c,setZoom:d}=i.store.view.getState(),f=c+(l?1:-1),u=i.store.settings.getState();return f>=0&&f<=u.view.MAX_ZOOM&&d(f),!0}return!1}}),this.idle.appendNext(this.mapDrag,{transform:r=>{const i=this.context;if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===be.LEFT){const{clientX:l,clientY:c}=r;return i.startPoint={x:l,y:c},i.viewpointBeforeDrag=i.store.view.getState().viewpoint,console.log("MapViewStateMachine: å¼å§å°å¾ææ½",i.startPoint),!0}return!1}}),this.idle.appendNext(this.rightMousedown,{transform:r=>{if(r.componentTarget)return!1;if(r.type==="mousedown"&&!r.shiftKey&&r.button===be.RIGHT){const{clientX:i,clientY:l}=r;return this.context.startPoint={x:i,y:l},this.context.viewpointBeforeDrag=this.context.store.view.getState().viewpoint,!0}return!1}}),this.rightMousedown.appendNext(this.idle,{transform:r=>r.type==="mouseup"?(s&&s.rightClickHandeler(r),this.context.startPoint=void 0,this.context.viewpointBeforeDrag=void 0,!0):!1});const o=r=>{var l,c;const i=this.context;if(r.type==="pointermove"){const{clientX:d,clientY:f}=r,[u,p]=[d,f];if(typeof((l=i.startPoint)==null?void 0:l.x)!="number"||typeof((c=i.startPoint)==null?void 0:c.y)!="number")throw new Error("context.startPoint.x must be number when map drag");const[x,w]=[i.startPoint.x-u,i.startPoint.y-p];console.log("moving to",x,w);const{zoom:g,setViewpoint:m,width:b,height:y}=i.store.view.getState(),k=b,v=y,C=i.viewpointBeforeDrag,I=oe({x:x+k/2,y:w+v/2},C,g,k,v);return m(I),!0}return!1};this.rightMousedown.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.mapDrag,{transform:o}),this.mapDrag.appendNext(this.idle,{transform:r=>{const i=this.context;if(r.type==="mouseup"||r.type==="mouseupoutside"){if(i.startPoint=void 0,i.viewpointBeforeDrag=void 0,i.store.meta.getState().autoload){const{viewpoint:l,zoom:c,width:d,height:f}=i.store.view.getState(),u=d,p=f,{loadbbox:x}=i.store.meta.getState(),w=i.store.settings.getState();x({width:u,height:p,zoom:c,viewpoint:l},w.osmAPI.BASEURL)}return!0}return!1}})}}function Ko(e,t,n){const s=nt();Mt(s,n,t);const o=Mo(s);if(o===0)return nn(t);const r=nt();Mt(r,e,t);const i=Ro(r,s)/o,l=Math.max(0,Math.min(1,i)),c=nt();return To(c,t,s,l),c}function pn(e,t){let n=null,s=null,o=1/0;const r=tt(e.lon,e.lat);for(let i=0;i<t.length-1;i++){const l=tt(t[i]["@_lon"],t[i]["@_lat"]),c=tt(t[i+1]["@_lon"],t[i+1]["@_lat"]),d=Ko(r,l,c),f=Eo(r,d);f<o&&(o=f,n=nn(d),s=t[i])}if(s===null)throw new Error("point is not insertable for polyline");return{nearestPoint:n?{lon:n[0],lat:n[1]}:e,insertAfter:s}}class Ve extends Z{constructor(n){super(n);R(this,"idle");this.idle=new W("undo-redo-idle"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}})}}class zo extends Z{constructor(n){super(n);R(this,"idle");R(this,"undoRedo");R(this,"addNode");R(this,"addNodeOnWay");R(this,"splitWay");this.idle=new W("node-idle"),this.addNode=new W("add-node"),this.addNodeOnWay=new W("add-node-on-way"),this.splitWay=new W("split-way"),this.undoRedo=new Ve(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.idle.appendNext(this.idle,{transform:s=>{if(s.type==="keydown"){const o=s,{undo:r,redo:i}=this.context.store.meta.temporal.getState();if(o.code==="KeyZ"){if(o.shiftKey&&o.ctrlKey)return console.log("redo"),i(),!0;if(o.ctrlKey)return console.log("undo"),r(),!0}}if(s.type==="utils-undo"){const{undo:o}=this.context.store.meta.temporal.getState();return console.log("undo"),o(),!0}if(s.type==="utils-redo"){const{redo:o}=this.context.store.meta.temporal.getState();return console.log("redo"),o(),!0}return!1}}),this.idle.appendNext(this.addNode,{transform:s=>s.type==="add-node"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.addNodeOnWay,{transform:s=>s.type==="add-node-on-way"?(console.log("to addnode way state"),!0):!1}),this.idle.appendNext(this.splitWay,{transform:s=>s.type==="split-way"?(console.log("to split way state"),!0):!1}),this.addNode.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0){const{viewpoint:r,zoom:i,width:l,height:c}=this.context.store.view.getState(),d=l,f=c,{clientX:u,clientY:p}=o,x=oe({x:u,y:p},r,i,d,f);this.context.store.meta.getState().createLocalNode(x),console.log("added node")}return!0}return!1}}),this.addNodeOnWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="way"){const{viewpoint:r,zoom:i,width:l,height:c}=this.context.store.view.getState(),d=l,f=c,{meta:u,createLocalNode:p,modifyFeatureMetaNC:x,commit:w}=this.context.store.meta.getState(),{clientX:g,clientY:m}=o,b=oe({x:g,y:m},r,i,d,f),y=u.way[o.componentTarget.id],k=y.nd.map(E=>u.node[E["@_ref"]]),{nearestPoint:v,insertAfter:C}=pn(b,k),I=p(v),N=Array.from(y.nd);N.splice(y.nd.findIndex(E=>E["@_ref"]===C["@_id"])+1,0,{"@_ref":I}),w(),x(o.componentTarget.type,o.componentTarget.id,E=>E.nd=N),console.log("nodeid",I,N),console.log("added node")}return!0}return!1}}),this.splitWay.appendNext(this.idle,{transform:s=>{if(s.type==="mousedown"){const o=s;if(o.button===0&&o.componentTarget&&o.componentTarget.type==="node"){const{meta:r,splitWay:i}=this.context.store.meta.getState(),l=r.node[o.componentTarget.id];i(l["@_id"]),console.log("splited way")}return!0}return!1}})}}class Go extends Z{constructor(n){super(n);R(this,"idle");R(this,"componentSubMachine");R(this,"mapViewSubMachine");R(this,"uiStateSubMachine");this.idle=new W("common-edit-idle"),this.componentSubMachine=new Xo(n),this.mapViewSubMachine=new Ue(n),this.uiStateSubMachine=new zo(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.uiStateSubMachine,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.uiStateSubMachine.appendNext(this.idle,{isEpsilon:!0})}}const Yo={routeEdit:{step:0,stops:[],path:[]}},Jo={commitCounter:1},Zo={selectedRef:[],activeRef:void 0},Qo={meta:{node:{},way:{},relation:{}},deletedMeta:{node:{},way:{},relation:{}},_create_feature_counter:-1},es={bbox:[],autoload:!0},mn={...Jo,...Zo,...Qo,...es,...Yo};function V(e){e.commitCounter++}const ts=e=>({commit:()=>e(t=>V(t))});function Y(e,t){if(!t)return null;const n=L(t);for(let s=0;s<n.length;s++){const o=n[s];if(o["@_k"]===e)return o["@_v"]}return null}const gt=(e,t,n,s,o,r)=>{const i=(l,c)=>{if(c==="relation"){const d=r[l];if(!d)return;n[l]||(n[l]=!0),L(d.member).forEach(f=>{const u=f["@_ref"],p=f["@_type"];p==="node"?!e[u]&&s[u]&&(e[u]=!0):p==="way"?!t[u]&&o[u]&&i(u,"way"):p==="relation"&&!n[u]&&r[u]&&i(u,"relation")})}else if(c==="way"){const d=o[l];if(!d)return;t[l]||(t[l]=!0),L(d.nd).forEach(f=>{const u=f["@_ref"];!e[u]&&s[u]&&(e[u]=!0)})}else if(c==="node"){if(!s[l])return;e[l]||(e[l]=!0)}};return i};function ns(e,t,n){const s={},o={},r={},i=gt(s,o,r,e,t,n);return Object.values(n).forEach(l=>{(Y("type",l.tag)==="route_master"&&Y("route_master",l.tag)==="bus"||Y("type",l.tag)==="route"&&Y("public_transport:version",l.tag)==="2")&&i(l["@_id"],"relation")}),Object.values(n).forEach(l=>{Y("type",l.tag)==="route"&&Y("public_transport:version",l.tag)==="2"&&Y("roundtrip",l.tag)==="yes"&&i(l["@_id"],"relation")}),{node:s,way:o,relation:r}}function os(e,t,n){const s={},o={},r={},i=gt(s,o,r,e,t,n);return Object.values(n).forEach(l=>{Y("highway",l.tag)&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{Y("highway",l.tag)&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{Y("highway",l.tag)&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}function ss(e,t,n){const s={},o={},r={},i=gt(s,o,r,e,t,n);return Object.values(n).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"relation")}),Object.values(t).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"way")}),Object.values(e).forEach(l=>{Number(l["@_id"])<0&&i(l["@_id"],"node")}),{node:s,way:o,relation:r}}const as=e=>{const{node:t,way:n,relation:s}=e,o={elems:{node:{},way:{},relation:{}},roots:{node:{},way:{},relation:{}}},r=(i,l)=>{Object.keys(l).forEach(c=>{const d=c;o.elems[i][d]={id:d,type:i,fathers:{node:[],way:[],relation:[]},childs:{node:[],way:[],relation:[]}},o.roots[i][d]=!0})};return r("node",t),r("way",n),r("relation",s),Object.values(n).forEach(i=>{const l=o.elems.way[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.nd.forEach(c=>{const d=o.elems.node[c["@_ref"]];d&&(d.fathers.way.push(l.id),l.childs.node.push(d.id),delete o.roots.node[d.id])})}),Object.values(s).forEach(i=>{const l=o.elems.relation[i["@_id"]];if(!l)throw new Error(`${i["@_id"]} !`);i.member.forEach(c=>{const d=o.elems[c["@_type"]][c["@_ref"]];d&&(d.fathers.relation.push(l.id),l.childs[c["@_type"]].push(d.id),delete o.roots[c["@_type"]][d.id])})}),o},fn=e=>{const t=(...c)=>c.reduce((d,f)=>(Object.assign(d.node,f.node),Object.assign(d.way,f.way),Object.assign(d.relation,f.relation),d),{node:{},way:{},relation:{}}),{node:n,way:s,relation:o}=e,r=ns(n,s,o),i=os(n,s,o),l=ss(n,s,o);return{ptv2:r,highway:i,created:l,global:t(r,i)}},rs=zn.createComputed(e=>({collections:fn(e.meta),tree:as(e.meta)}));function At(e,t,n,s){const o=e.meta[t][n]["@_localStates"];o&&s(o)}function ye(e,t,n){e.meta[t][n]["@_localStates"]={visible:!0,highlighted:!1,hovered:!1,selected:!1,active:!1}}function is(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)&&(e.selectedRef=e.selectedRef.filter(o=>!s(o))),e.activeRef&&s(e.activeRef)&&(e.activeRef=void 0),delete e.meta[t][n]["@_localStates"]}function hn(e,t,n){if(e.activeRef){const{type:s,id:o}=e.activeRef;e.meta[s][o]["@_localStates"]&&(e.meta[s][o]["@_localStates"].active=!1)}e.activeRef={type:t,id:n},e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!0)}function xn(e,t,n){const s=o=>o.type===t&&o.id===n;e.selectedRef.some(s)||(e.selectedRef.push({type:t,id:n}),e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].selected=!0))}function he(e){if(e.activeRef){const{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1),e.activeRef=void 0}e.selectedRef.forEach(({id:t,type:n})=>e.meta[n][t]["@_localStates"]&&(e.meta[n][t]["@_localStates"].selected=!1)),e.selectedRef=[]}function me(e,t,n){xn(e,t,n),hn(e,t,n)}function Pt(e,t,n){xn(e,t,n)}function ot(e,t,n){const s=e.meta[t][n]["@_localStates"];if(s!=null&&s.active&&(s.active=!1,e.activeRef=void 0),s!=null&&s.selected&&(s.selected=!1,e.selectedRef=e.selectedRef.filter(o=>!(o.id===n&&o.type===t))),!e.activeRef&&e.selectedRef.length>0){const{type:o,id:r}=e.selectedRef[0];hn(e,o,r)}}const ls=(e,t)=>({"@_id":`${e._create_feature_counter--}`,"@_lat":t.lat,"@_lon":t.lon,"@_visible":"true"}),gn=(e,t)=>({"@_id":`${e._create_feature_counter--}`,nd:[...t],"@_visible":"true"}),cs=(e,t)=>({"@_id":`${e._create_feature_counter--}`,member:[...t],"@_visible":"true"});function Me(e,t,n){const s=n["@_id"];if(e.meta[t][s]&&console.debug(`Can't add feature ${t} ${s}: already exsits! Ignoring this attempt`),t==="node"){const o=n;o["@_lon"]=Number(o["@_lon"]),o["@_lat"]=Number(o["@_lat"]),e.meta[t][s]=o}else e.meta[t][s]=n;ye(e,t,s)}function ds(e,t,n){return L(n).forEach(s=>Me(e,t,s))}function bn(e,t){const n=ls(e,t);return e.meta.node[n["@_id"]]=n,ye(e,"node",n["@_id"]),n["@_id"]}function us(e,t){const n=gn(e,t);return e.meta.way[n["@_id"]]=n,ye(e,"way",n["@_id"]),n["@_id"]}function dt(e,t){const n=cs(e,t);return e.meta.relation[n["@_id"]]=n,ye(e,"relation",n["@_id"]),n["@_id"]}const te=(e,t,n,s)=>{const o=e.meta[t][n];o&&(s(o),o["@_action"]="modify")};function ps(e,t,n){const s=t.elems.node[n].fathers.way.map(o=>e.meta.way[o]);s==null||s.forEach(o=>{const r=o.nd,i=r.findIndex(l=>l["@_ref"]===n);if(i!==0&&i!==r.length-1){if(i===-1)throw new Error(`way ${o} must contain node ${n}, the feature tree is broken.`);const l=r.slice(i);o.nd=r.slice(0,i+1),o["@_action"]="modify";const c=gn(e,l);c.tag=o.tag&&[...o.tag],e.meta.way[c["@_id"]]=c,ye(e,"way",c["@_id"]);const d=t.elems.way[o["@_id"]].fathers.relation.map(f=>e.meta.relation[f]);d==null||d.forEach(f=>{const u=f.member,p=u.findIndex(x=>x["@_ref"]===o["@_id"]);if(p===-1)throw new Error(`relation ${f} must contain way ${o}, the feature tree is broken.`);u.splice(p+1,0,{"@_ref":c["@_id"],"@_type":"way","@_role":u[p]["@_role"]}),f.member=u,f["@_action"]="modify"})}})}function Ie(e,t,n){if(!e.meta[t][n])throw new Error(`Can't delete feature ${t} ${n}: not exsit!`);e.deletedMeta[t][n]=e.meta[t][n],e.deletedMeta[t][n]["@_action"]="delete",is(e,t,n),delete e.meta[t][n]}function ms(e,t,n){const{way:s,relation:o}=t.elems.node[n].fathers;s.forEach(r=>{te(e,"way",r,i=>{i.nd=i.nd.filter(l=>l["@_ref"]!==n)}),e.meta.way[r].nd.length<=1&&yn(e,t,r)}),o.forEach(r=>{te(e,"relation",r,i=>{i.member=i.member.filter(l=>l["@_type"]==="node"&&l["@_ref"]===n)})}),Ie(e,"node",n)}function yn(e,t,n){e.meta.way[n].nd.forEach(o=>{const r=o["@_ref"],{way:i,relation:l}=t.elems.node[r].fathers;i.length>1||l.length>0||Ie(e,"node",r)});const{relation:s}=t.elems.way[n].fathers;s.forEach(o=>{te(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="way"&&i["@_ref"]===n)})}),Ie(e,"way",n)}function fs(e,t,n){const{relation:s}=t.elems.relation[n].fathers;s.forEach(o=>{te(e,"relation",o,r=>{r.member=r.member.filter(i=>i["@_type"]==="relation"&&i["@_ref"]===n)})}),Ie(e,"relation",n)}function hs(e,t,n,s){if(n==="node")ms(e,t,s);else if(n==="way")yn(e,t,s);else if(n==="relation")fs(e,t,s);else throw new Error(`Type ${n} not allowed.`)}const xs=["tag","nd","member","node","way","relation"];async function ce(e,t){const n=`${e}${t}`,s=await fetch(n);if(!s.ok)throw new Error(`Error on fetching ${n}: ${s.statusText}`);const o=await s.text(),i=new on.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",isArray:(l,c,d,f)=>!f&&xs.includes(l)}).parse(o);return console.log(`Get ${n}`,JSON.stringify(i),i),i}async function gs(e,t,n,s,o){const r=await ce(e,`/api/0.6/map?bbox=${t},${n},${s},${o}`);return r.osm.bounds["@_maxlat"]=Number(r.osm.bounds["@_maxlat"]),r.osm.bounds["@_minlat"]=Number(r.osm.bounds["@_minlat"]),r.osm.bounds["@_maxlon"]=Number(r.osm.bounds["@_maxlon"]),r.osm.bounds["@_minlon"]=Number(r.osm.bounds["@_minlon"]),r.osm.node=L(r.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i.tag&&(i.tag=L(i.tag)),i)),r}async function bs(e,t){const s=(await ce(e,`/api/0.6/node/${t}`)).osm.node;return s["@_lon"]=Number(s["@_lon"]),s["@_lat"]=Number(s["@_lat"]),s}async function ys(e,t){return(await ce(e,`/api/0.6/way/${t}`)).osm.way}async function ws(e,t){return(await ce(e,`/api/0.6/relation/${t}`)).osm.relation}async function st(e,t){if(t.length===0)return[];const s=`/api/0.6/nodes?nodes=${t.join(",")}`,o=await ce(e,s);return L(o.osm.node).map(i=>(i["@_lat"]=Number(i["@_lat"]),i["@_lon"]=Number(i["@_lon"]),i))}async function _s(e,t){if(t.length===0)return[];const s=`/api/0.6/ways?ways=${t.join(",")}`,o=await ce(e,s);return L(o.osm.way)}async function js(e,t){if(t.length===0)return[];const s=`/api/0.6/relations?relations=${t.join(",")}`,o=await ce(e,s);return L(o.osm.relation)}async function Ss(e,{viewpoint:t,zoom:n,width:s,height:o},r){const{left:l,bottom:c,right:d,top:f}=dn(t,n,s,o),u=p=>p.osm.bounds["@_minlon"]<=l+1e-7&&p.osm.bounds["@_minlat"]<=c+1e-7&&p.osm.bounds["@_maxlon"]>=d-1e-7&&p.osm.bounds["@_maxlat"]>=f-1e-7;return e.some(u)?(console.log("requested bbox is already cached"),null):(console.log(`osm load data, faild to get cache: ${l} ${c} ${d} ${f}`,t,n),console.log("state bboxs",e),await gs(r,l,c,d,f))}function wn(e,t,n){const s=bn(e,t);return te(e,"node",s,n),s}function Ns(e,t,n,s){let o="0";return te(e,"way",s,r=>{const i=r.nd.map(d=>e.meta.node[d["@_ref"]]),{nearestPoint:l,insertAfter:c}=pn(t,i);o=wn(e,l,n),r.nd.splice(r.nd.findIndex(d=>d["@_ref"]===c["@_id"])+1,0,{"@_ref":o})}),o}const vs=e=>({modifyFeatureStateNC:(t,n,s)=>e(o=>{At(o,t,n,s)}),modifyFeatureStateBatchNC:t=>e(n=>{t.forEach(({type:s,id:o,modify:r})=>{At(n,s,o,r)})}),selectFeature:(t,n,s)=>e(o=>{V(o),s&&he(o),me(o,t,n)}),selectFeatureWithoutActive:(t,n,s)=>e(o=>{V(o),s&&he(o),Pt(o,t,n)}),unSelectFeature:(t,n)=>e(s=>{V(s),ot(s,t,n)}),toggleFeature:(t,n,s)=>e(o=>{var r;V(o),(r=o.meta[t][n]["@_localStates"])!=null&&r.selected?ot(o,t,n):(s&&he(o),me(o,t,n))}),toggleFeatureWithoutActive:(t,n,s)=>e(o=>{var r;V(o),(r=o.meta[t][n]["@_localStates"])!=null&&r.selected?ot(o,t,n):(s&&he(o),Pt(o,t,n))}),clearSelect:()=>e(t=>{V(t),he(t)})}),ks=(e,t)=>({addFeatureMetaBatch:(n,s)=>e(o=>ds(o,n,s)),createLocalNode:n=>{let s="0";return e(o=>{V(o),s=bn(o,n)}),s},createLocalWay:n=>{let s="0";return e(o=>{V(o),s=us(o,n)}),s},createLocalRelation:n=>{let s="0";return e(o=>{V(o),s=dt(o,n)}),s},modifyFeatureMetaNC:(n,s,o)=>e(r=>{te(r,n,s,o)}),deleteFeature:(n,s)=>e(o=>{V(o),hs(o,t().tree,n,s)}),splitWay:n=>e(s=>{V(s),ps(s,t().tree,n)})}),Cs=(e,t)=>({loadbbox:async(n,s)=>{const{bbox:o,meta:r}=t();if(!(n.zoom<=16))try{const i=await Ss(o||[],n,s);if(i===null)return;const{node:l,way:c,relation:d}=le(r),f=[],u=[],p=[];i.osm.node.forEach(y=>{const k=y["@_id"];l[k]||(l[k]=y,f.push(y))}),i.osm.way.forEach(y=>{const k=y["@_id"];c[k]||(c[k]=y,u.push(y))}),i.osm.relation.forEach(y=>{const k=y["@_id"];d[k]||(d[k]=y,p.push(y))});const x=fn({node:l,way:c,relation:d}),w={nodesId:new Set(Object.keys(x.global.node)),waysId:new Set(Object.keys(x.global.way)),relationsId:new Set(Object.keys(x.global.relation))},g=f.filter(y=>w.nodesId.has(y["@_id"])),m=u.filter(y=>w.waysId.has(y["@_id"])),b=p.filter(y=>w.relationsId.has(y["@_id"]));e(y=>{V(y),g.forEach(k=>{y.meta.node[k["@_id"]]||Me(y,"node",k)}),m.forEach(k=>{y.meta.way[k["@_id"]]||Me(y,"way",k)}),b.forEach(k=>{y.meta.relation[k["@_id"]]||Me(y,"relation",k)}),y.bbox.push({...i,osm:{...i.osm,node:[],way:[],relation:[]}})})}catch(i){console.log(i)}},loadFeature:async(n,s,o)=>{const{meta:r,addFeatureMetaBatch:i}=t();if(n==="node")r.node[s]||i("node",await bs(o,s));else if(n==="way"){const l=await ys(o,s),c=await st(o,l.nd.map(d=>d["@_ref"]));i("node",c.filter(d=>!r.node[d["@_id"]])),r.way[s]||i("way",l)}else n==="relation"&&(r.relation[s]||i("relation",await ws(o,s)))},loadFeatureBatch:async(n,s)=>{const{meta:o,addFeatureMetaBatch:r}=t(),i=n.filter(d=>d.type==="node"&&!o.node[d.id]).map(d=>d.id),l=n.filter(d=>d.type==="way"&&!o.way[d.id]).map(d=>d.id),c=n.filter(d=>d.type==="relation"&&!o.relation[d.id]).map(d=>d.id);if(l.length>0){const d=await _s(s,l),f=d.map(p=>p.nd.map(x=>x["@_ref"]).filter(x=>!o.node[x])).flat(),u=await st(s,f);r("node",u),r("way",d)}if(i.length>0){const d=await st(s,i);r("node",d)}if(c.length>0){const d=await js(s,c);r("relation",d)}},setAutoloadNC:n=>e(s=>{s.autoload=typeof n=="function"?n():n})}),It=e=>{var t,n;return e["@_type"]==="node"||((t=e["@_role"])==null?void 0:t.startsWith("stop"))||((n=e["@_role"])==null?void 0:n.startsWith("platform"))},Es=e=>({createBusStopSel:(t,n)=>e(s=>{V(s);const o=wn(s,t,r=>{r.tag=n});me(s,"node",o)}),createStopPositionSel:(t,n,s)=>e(o=>{V(o);const r=Ns(o,t,i=>{i.tag=n},s);me(o,"node",r)}),createStopAreaSel:(t,n)=>e(s=>{V(s);const o=dt(s,n||[]);te(s,"relation",o,r=>{r.tag=t}),me(s,"relation",o)}),createEditRoute:(t,n)=>e(s=>{V(s);const o=dt(s,n||[]);te(s,"relation",o,c=>{c.tag=t}),me(s,"relation",o);const r=n||[],i=r.map((c,d)=>It(c)?d:-1),l=i.lastIndexOf(Math.max(...i));s.routeEdit={editing:o,step:0,stops:r.slice(0,l+1),path:r.slice(l+1,r.length)}}),setEditRoute:t=>e(n=>{var i;V(n);const s=((i=n.meta.relation)==null?void 0:i[t].member)||[],o=s.map((l,c)=>It(l)?c:-1),r=o.lastIndexOf(Math.max(...o));n.routeEdit={editing:t,step:0,stops:s.slice(0,r+1),path:s.slice(r+1,s.length)}}),cancelEditRoute:()=>e(t=>{V(t),t.routeEdit={editing:void 0,step:0,stops:[],path:[]}}),setRouteStop:t=>e(n=>{V(n),n.routeEdit.stops=t}),setRoutePath:t=>e(n=>{V(n),n.routeEdit.path=t}),setEditStepNC:t=>e(n=>{n.routeEdit.step=t}),saveEditRoute:()=>e(t=>{const{editing:n,stops:s,path:o}=t.routeEdit;n&&(V(t),te(t,"relation",n,r=>{r.tag=[...r.tag||[]],r.member=[...s,...o]}),t.routeEdit.editing=void 0,t.routeEdit.stops=[],t.routeEdit.path=[])})}),Ms=e=>({reset:()=>{e({...mn})}}),_=ut()(pt(Ut(rs(Ao(Gn((...e)=>({...mn,...ts(...e),...vs(...e),...ks(...e),...Cs(...e),...Es(...e),...Ms(...e)})),{partialize:e=>{const{tree:t,collections:n,...s}=e;return s},equality:(e,t)=>e.commitCounter===t.commitCounter})),{name:"OSMMapStateStore",storage:Vt(()=>localStorage),partialize:e=>{const{tree:t,collections:n,...s}=e;return s}}),{name:"OSMMapState"})),Rs=e=>({updateSettingsAction:t=>e(()=>t)}),Ts={osmAPI:{BASEURL:"https://api.openstreetmap.org",TILE_SOURCE:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"},view:{MAX_ZOOM:19},pixiRender:{zIndex:{LINE:10,POINT:20,MASK:30}}},As={name:"settingStore",storage:Vt(()=>localStorage)},ne=ut()(pt(Ut((...e)=>({...Ts,...Rs(...e)}),As),{name:"Settings"}));function Ps(e,t,n,s){return e.replace("{z}",String(s)).replace("{x}",String(t)).replace("{y}",String(n))}function Is({source:e,x:t,y:n,mapViewStatus:{zoom:s,width:o,height:r,viewpoint:i}}){const l=Ps(e,t,n,s),c={x:t*ge,y:n*ge},d=cn(c,i,s,o,r);return a.jsx(G.Sprite,{image:l,position:d})}function qe(e){const{width:t,height:n}=e,s=ne(c=>c.osmAPI.TILE_SOURCE),o=K(),{viewpoint:r,zoom:i}=o,l=()=>{const{x:c,y:d}=ln(r,i),[f,u,p,x]=[c-(t>>1),d-(n>>1),c+(t>>1),d+(n>>1)].map(g=>Math.floor(g/ge)),w=[];for(let g=f;g<=p;g++)for(let m=u;m<=x;m++)w.push(a.jsx(Is,{source:s,x:g,y:m,mapViewStatus:{...e,...o}},`${g}-${m}`));return w};return a.jsx(G.Container,{children:l()})}function Ds(e,t){return[e[0]+t[0],e[1]+t[1]]}function Ls(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function _e(e,t,n=0){return Math.abs(e[0]-t[0])<=n&&Math.abs(e[1]-t[1])<=n}function Re(e,t){const n=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(n*n+s*s)}function Fs(e,t={}){const s=[e[0],e[1]],o=[e[e.length-2],e[e.length-1]],r=_e(s,o,1e-4),i=new sn(e);t.native=!1,i.closeStroke=!1;const l={shape:i,lineStyle:t},c={closePointEps:1e-4,indices:[],points:[],uvs:[]};Po.buildLine(l,c);const d=c.points,f=c.indices,u=new Map,p=[],x=[];let w=[NaN,NaN],g=[NaN,NaN],m=0,b=0,y=[NaN,NaN],k=[NaN,NaN],v=[NaN,NaN],C=NaN,I=NaN,N=NaN;for(let T=0;T<f.length;T+=3){const P=f[T],F=f[T+1],X=f[T+2],z=[d[P*2],d[P*2+1]],Q=[d[F*2],d[F*2+1]],B=[d[X*2],d[X*2+1]];if(T===0)u.set(P,!0),u.set(F,!1),u.set(X,!0),p.push(z),x.push(Q),p.push(B),g=Q,w=B,m=Re(z,B);else{let j=u.get(P),A=u.get(F),O=u.get(X);j===void 0&&_e(z,y,1e-4)&&(j=u.get(C),u.set(P,j)),A===void 0&&_e(Q,k,1e-4)&&(A=u.get(I),u.set(F,A)),O===void 0&&_e(B,v,1e-4)&&(O=u.get(N),u.set(X,O));let $,q,se;j===void 0&&($=P,q=z,se=!O),A===void 0&&($=F,q=Q,se=!j),O===void 0&&($=X,q=B,se=!A),$!==void 0&&(u.set($,se),se===!0?(p.push(q),m+=Re(w,q),w=q):(x.push(q),b+=Re(g,q),g=q))}y=z,k=Q,v=B,C=P,I=F,N=X}const E={},U=p.length+x.length+1,D=new Array(U*2);let S=0;for(let T=0;T<p.length;++S,++T)D[S*2]=p[T][0],D[S*2+1]=p[T][1];for(let T=x.length-1;T>=0;++S,--T)D[S*2]=x[T][0],D[S*2+1]=x[T][1];if(D[S*2]=p[0][0],D[S*2+1]=p[0][1],E.perimeter=D,r){const T=b>m?x:p,P=new Array((T.length+1)*2);for(let F=0;F<T.length;++F)P[F*2]=T[F][0],P[F*2+1]=T[F][1];P[T.length*2]=T[0][0],P[T.length*2+1]=T[0][1],E.outer=P}return E}function Dt(e,t,n=!1,s=!1){let r=t,i;const l=[];for(let c=0;c<e.length;c++){const d=e[c];if(i){let f=Re(i,d)-r;if(f>=0){const u=Ls(i,d),p=t*Math.cos(u),x=t*Math.sin(u);let w=0,g=0;n&&(w=7*Math.cos(u+Math.PI/2),g=7*Math.sin(u+Math.PI/2));let m=[i[0]+r*Math.cos(u)+w,i[1]+r*Math.sin(u)+g];const b=[i,m];for(s&&f>=t*100&&(t=Math.floor(f/100)),f-=t;f>=0;f-=t)m=Ds(m,[p,x]),b.push(m);b.push(d),l.push({coords:b.slice(1,-1),angle:u+(n?Math.PI/2:0)})}r=-f}i=d}return l}function je(e){return e==="butt"?ke.BUTT:e==="square"?ke.SQUARE:ke.ROUND}function Se(e){return e==="bevel"?Ce.BEVEL:e==="miter"?Ce.MITER:Ce.ROUND}$e.from("src/location-pin.svg");const Os=$e.from("src/circle.svg"),Bs=$e.from("src/bus.svg"),Lt=$e.from("src/arrow-right-long.svg"),Hs={proposed:!0,planned:!0,construction:!0,disused:!0,abandoned:!0,was:!0,dismantled:!0,razed:!0,demolished:!0,destroyed:!0,removed:!0,obliterated:!0,intermittent:!0};function $s(e){const t=e.split(":");return t.length===1?e:t[0]in Hs?e.slice(t[0].length+1):e}const Ft={aerialway:{chair_lift:!0,drag_lift:!0,"j-bar":!0,magic_carpet:!0,mixed_lift:!0,platter:!0,rope_tow:!0,"t-bar":!0,zip_line:!0},highway:{motorway:!0},junction:{circular:!0,roundabout:!0},man_made:{goods_conveyor:!0,"piste:halfpipe":!0},"piste:type":{downhill:!0,sled:!0,yes:!0},roller_coaster:{track:!0},"seamark:type":{"two-way_route":!0,recommended_traffic_lane:!0,separation_lane:!0,separation_roundabout:!0},waterway:{canal:!0,ditch:!0,drain:!0,fish_pass:!0,flowline:!0,pressurised:!0,river:!0,spillway:!0,stream:!0,tidal_channel:!0}},Ne={natural:{cliff:!0,coastline:!0},barrier:{retaining_wall:!0,kerb:!0,guard_rail:!0,city_wall:!0},man_made:{embankment:!0},waterway:{weir:!0}};function Ws(e){const t={yes:!0,1:!0,"-1":!0,reversible:!0,alternating:!0,no:!1,0:!1};let n=null;return e.forEach(s=>{s["@_k"]==="oneway"&&t[s["@_v"]]&&(n=t[s["@_v"]])}),n!==null?n:(e.forEach(s=>{s["@_k"]in Ft&&s["@_v"]in Ft[s["@_k"]]&&(n=!0)}),!!n)}function Us(e){const t=()=>{for(let n=0;n<e.length;n++){const s=e[n]["@_k"],o=e[n]["@_v"],r=$s(s);if(r in Ne&&o in Ne[r])return Ne[r][o]?r:Ne[r][o]}return null};return e.some(n=>n["@_k"]==="two_sided"&&n["@_v"]==="yes")?!1:t()!==null}const Vs={surface:{paved:!0,asphalt:!0,concrete:!0,chipseal:!0,"concrete:lanes":!0,"concrete:plates":!0},tracktype:{grade1:!0}},qs=new Set(["motorway","trunk","primary","secondary","tertiary","residential","motorway_link","trunk_link","primary_link","secondary_link","tertiary_link","unclassified","road","service","track","living_street","bus_guideway","busway"]),Te=new Set(["abandoned","construction","demolished","destroyed","dismantled","disused","intermittent","obliterated","planned","proposed","razed","removed","was"]),Xs=new RegExp("^("+Array.from(Te).join("|")+"):"),at={DEFAULTS:{fill:{width:2,color:11184810,alpha:.3},casing:{width:5,color:4473924,alpha:1,cap:"round",join:"round"},stroke:{width:3,color:13421772,alpha:1,cap:"round",join:"round"}},LIFECYCLE:{casing:{alpha:0},stroke:{dash:[7,3],cap:"butt"}},red:{fill:{color:14708319,alpha:.3}},green:{fill:{color:9228383,alpha:.3}},blue:{fill:{color:7853278,alpha:.3}},yellow:{fill:{color:16777108,alpha:.25}},gold:{fill:{color:12893721,alpha:.3}},orange:{fill:{color:14059546,alpha:.3}},pink:{fill:{color:14918901,alpha:.3}},teal:{fill:{color:10084778,alpha:.3}},lightgreen:{fill:{color:12511295,alpha:.3}},tan:{fill:{color:16112826,alpha:.3}},darkgray:{fill:{color:9211020,alpha:.5}},lightgray:{fill:{color:11184810,alpha:.3}},motorway:{casing:{width:10,color:7354159},stroke:{width:8,color:13574273}},trunk:{casing:{width:10,color:7354159},stroke:{width:8,color:14495522}},primary:{casing:{width:10,color:7354159},stroke:{width:8,color:16357382}},secondary:{casing:{width:10,color:7354159},stroke:{width:8,color:15987474}},tertiary:{casing:{width:10,color:7354159},stroke:{width:8,color:16775603}},unclassified:{casing:{width:10,color:4473924},stroke:{width:8,color:14535850}},residential:{casing:{width:10,color:4473924},stroke:{width:8,color:16777215}},living_street:{casing:{width:7,color:16777215},stroke:{width:5,color:13421772}},service:{casing:{width:7,color:4473924},stroke:{width:5,color:16777215}},special_service:{casing:{width:7,color:4473924},stroke:{width:5,color:14535850}},track:{casing:{width:7,color:7630703},stroke:{width:5,color:12957087}},pedestrian:{casing:{width:7,color:16777215},stroke:{width:5,color:10061960,dash:[8,8],cap:"butt"}},path:{casing:{width:5,color:14535850},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},footway:{casing:{width:5,color:16777215},stroke:{width:3,color:10061960,dash:[6,6],cap:"butt"}},crossing_marked:{casing:{width:5,color:14535850},stroke:{width:3,color:4998212,dash:[6,3],cap:"butt"}},crossing_unmarked:{casing:{width:5,color:14535850},stroke:{width:3,color:7826026,dash:[6,4],cap:"butt"}},cycleway:{casing:{width:5,color:16777215},stroke:{width:3,color:5810669,dash:[6,6],cap:"butt"}},bridleway:{casing:{width:5,color:16777215},stroke:{width:3,color:14708063,dash:[6,6],cap:"butt"}},corridor:{casing:{width:5,color:16777215},stroke:{width:3,color:9228383,dash:[2,8],cap:"round"}},steps:{casing:{width:5,color:16777215},stroke:{width:3,color:8507996,dash:[3,3],cap:"butt"}},river:{fill:{color:7853278,alpha:.3},casing:{width:10,color:4473924},stroke:{width:8,color:7855581}},stream:{fill:{color:7853278,alpha:.3},casing:{width:7,color:4473924},stroke:{width:5,color:7855581}},ridge:{stroke:{width:2,color:9228383}},runway:{casing:{width:10,color:0,cap:"butt"},stroke:{width:8,color:16777215,dash:[24,48],cap:"butt"}},taxiway:{casing:{width:7,color:4473924},stroke:{width:5,color:16776960}},railway:{casing:{width:7,color:5592405,cap:"butt"},stroke:{width:2,color:15658734,dash:[12,12],cap:"butt"}},ferry:{casing:{alpha:0},stroke:{width:3,color:5810669,dash:[12,8],cap:"butt"}},boundary:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:16777215,dash:[20,5,5,5],cap:"butt"}},boundary_park:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:11592344,dash:[20,5,5,5],cap:"butt"}},barrier:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_wall:{casing:{alpha:0},stroke:{width:3,color:14540253,dash:[10,5,2,5],cap:"round"}},barrier_hedge:{fill:{color:9228383,alpha:.3},casing:{alpha:0},stroke:{width:3,color:9228383,dash:[10,5,2,5],cap:"round"}},tree_row:{casing:{width:7,color:4473924},stroke:{width:5,color:9228383}},construction:{casing:{width:10,color:16777215},stroke:{width:8,color:16542740,dash:[10,10],cap:"butt"}},pipeline:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[80,2],cap:"butt"}},roller_coaster:{casing:{width:7,color:4473924},stroke:{width:5,color:14540253,dash:[10,1],cap:"butt"}}},Ks={aeroway:{runway:"runway",taxiway:"taxiway"},amenity:{childcare:"yellow",college:"yellow",fountain:"blue",kindergarten:"yellow",parking:"darkgray",research_institute:"yellow",school:"yellow",university:"yellow"},building:{"*":"red"},barrier:{city_wall:"barrier_wall",hedge:"barrier_hedge",retaining_wall:"barrier_wall",wall:"barrier_wall","*":"barrier"},boundary:{protected_area:"boundary_park",national_park:"boundary_park","*":"boundary"},crossing:{marked:"crossing_marked",traffic_signals:"crossing_marked",uncontrolled:"crossing_marked",zebra:"crossing_marked","*":"crossing_unmarked"},golf:{green:"lightgreen"},highway:{bridleway:"bridleway",bus_guideway:"railway",busway:"special_service",corridor:"corridor",construction:"construction",cycleway:"cycleway",footway:"footway",living_street:"living_street",living_street_link:"living_street",motorway:"motorway",motorway_link:"motorway",path:"path",pedestrian:"pedestrian",primary:"primary",primary_link:"primary",residential:"residential",residential_link:"residential",secondary:"secondary",secondary_link:"secondary",service:"service",service_link:"service",steps:"steps",tertiary:"tertiary",tertiary_link:"tertiary",track:"track",trunk:"trunk",trunk_link:"trunk",unclassified:"unclassified",unclassified_link:"unclassified"},landuse:{cemetery:"lightgreen",commercial:"orange",construction:"gold",farmland:"lightgreen",farmyard:"tan",flowerbed:"green",forest:"green",grass:"green",industrial:"pink",landfill:"orange",meadow:"lightgreen",military:"orange",orchard:"lightgreen",quarry:"darkgray",railway:"darkgray",recreation_ground:"green",residential:"gold",retail:"orange",village_green:"green",vineyard:"lightgreen"},leisure:{garden:"green",golf_course:"green",nature_reserve:"green",park:"green",pitch:"green",swimming_pool:"blue",track:"yellow"},man_made:{adit:"darkgray",breakwater:"barrier_wall",groyne:"barrier_wall",pipeline:"pipeline"},military:{"*":"orange"},natural:{bare_rock:"darkgray",bay:"blue",beach:"yellow",cave_entrance:"darkgray",cliff:"darkgray",glacier:"lightgray",ridge:"ridge",rock:"darkgray",sand:"yellow",scree:"darkgray",scrub:"yellow",shingle:"darkgray",stone:"darkgray",strait:"blue",tree_row:"tree_row",water:"blue",wetland:"teal","*":"green"},power:{plant:"pink"},railway:{platform:"footway","*":"railway"},roller_coaster:{track:"roller_coaster"},route:{ferry:"ferry"},sport:{baseball:"yellow",basketball:"darkgray",beachvolleyball:"yellow",skateboard:"darkgray",softball:"yellow"},type:{waterway:"river"},waterway:{river:"river",dam:"DEFAULTS",weir:"DEFAULTS","*":"stream"},service:{alley:"special_service",driveway:"special_service","drive-through":"special_service",parking_aisle:"special_service","*":"special_service"}};function zs(e){var g,m,b,y,k,v,C,I,N,E,U,D;const t=at.DEFAULTS,n={};for(const S of e)n[S["@_k"]]=S["@_v"];let s=t,o=999,r;for(const[S,T]of Object.entries(n)){const P=Ks[S];if(!P||!T||S==="service"&&n.highway===void 0)continue;const F=P[T]??P["*"];let X=Object.keys(P).length;if(Te.has(T)&&(X=999),F&&X<=o){const z=at[F];if(!z){console.error(`invalid styleID: ${F}`);continue}if(s=z,o=X,r=S,o===1)break}}let i=!1;for(const[S,T]of Object.entries(n))if(Te.has(S)&&T!=="no"){i=!0;break}else if((!r||S===r)&&Te.has(T)){i=!0;break}else if(!r&&Xs.test(S)&&T!=="no"){i=!0;break}const l={};for(const S of["fill","casing","stroke"]){l[S]={};const T=(g=s[S])==null?void 0:g.width;if(T!==void 0&&typeof T=="number")l[S].width=T;else{const B=(m=t[S])==null?void 0:m.width;B!==void 0&&(l[S].width=B)}const P=(b=s[S])==null?void 0:b.color;if(P!==void 0&&typeof P=="number")l[S].color=P;else{const B=(y=t[S])==null?void 0:y.color;B!==void 0&&(l[S].color=B)}const F=(k=s[S])==null?void 0:k.alpha;if(F!==void 0&&typeof F=="number")l[S].alpha=F;else{const B=(v=t[S])==null?void 0:v.alpha;B!==void 0&&(l[S].alpha=B)}const X=(C=s[S])==null?void 0:C.cap;if(X!==void 0&&typeof X=="string")l[S].cap=X;else{const B=(I=t[S])==null?void 0:I.cap;B!==void 0&&(l[S].cap=B)}const z=(N=s[S])==null?void 0:N.join;if(z!==void 0&&typeof z=="string")l[S].join=z;else{const B=(E=t[S])==null?void 0:E.join;B!==void 0&&(l[S].join=B)}const Q=(U=s[S])==null?void 0:U.dash;if(Q!==void 0&&Array.isArray(Q))l[S].dash=Q;else{const B=(D=t[S])==null?void 0:D.dash;B!==void 0&&(l[S].dash=B)}}const c=n.bridge,d=n.cutting,f=n.embankment,u=n.highway,p=n.tracktype,x=n.tunnel;let w=n.surface;if(u==="track"&&p!=="grade1"&&(w=w||"dirt"),(c||f||d)&&(l.casing.width=(l.casing.width||0)+7,l.casing.color=0,l.casing.cap="butt",(f||d)&&(l.casing.dash=[2,4])),x&&(l.stroke.alpha=.5),w&&u&&qs.has(u)&&!Vs.surface[w]&&(c||(l.casing.color=13421772),l.casing.cap="butt",l.casing.dash=[4,4]),i){const S=at.LIFECYCLE;for(const T of["fill","casing","stroke"])if(S[T])for(const[P,F]of Object.entries(S[T]))l[T][P]=F}return l}const Ot=35;function Gs({line:e,nodePath:t,mapViewStatus:{viewpoint:n,zoom:s,width:o,height:r},status:{visible:i,hovered:l,selected:c,highlighted:d},layerRef:f,...u}){const p=s>=16&&i,x=t.map(N=>xt({lon:N["@_lon"],lat:N["@_lat"]},n,s,o,r)),w=h.useRef(null),g=h.useRef(null),m=zs(L(e.tag)),b=h.useMemo(()=>{var D;const N=Math.max(3,((D=m==null?void 0:m.casing)==null?void 0:D.width)||0),E=x.flatMap(S=>[S.x,S.y]),U={alignment:.5,color:0,width:N+10,alpha:1,join:Ce.BEVEL,cap:ke.BUTT};return Fs(E,U)},[x,m]),y=h.useCallback(N=>{N.clear();const E=m.casing||{};E.dash?N=new xe(N,{dash:E.dash,color:E.color,width:E.width,alpha:E.alpha||1,join:Se(E.join),cap:je(E.cap)}):N.lineStyle({color:E.color,width:E.width,alpha:E.alpha||1,join:Se(E.join),cap:je(E.cap)});const[U,...D]=x;N.moveTo(U.x,U.y),D.forEach(S=>{N.lineTo(S.x,S.y)})},[x,m.casing]),k=h.useCallback(N=>{N.clear();const E=m.stroke||{};E.dash?N=new xe(N,{dash:E.dash,color:E.color,width:E.width,alpha:E.alpha||1,join:Se(E.join),cap:je(E.cap)}):N.lineStyle({color:E.color,width:E.width,alpha:E.alpha||1,join:Se(E.join),cap:je(E.cap)});const[U,...D]=x;N.moveTo(U.x,U.y),D.forEach(S=>{N.lineTo(S.x,S.y)})},[x,m]),v=h.useCallback(()=>{w.current&&b.perimeter&&(w.current.hitArea=new sn(b.perimeter))},[w,b]);h.useEffect(()=>{const N=w.current;if(N!==null){const E=()=>{v()},U=()=>{const D=p&&l,S=p&&c,T=p&&d;if(D){if(!N.filters){const P=new Ae({distance:15,outerStrength:3,color:16776960});P.resolution=2,N.filters=[P]}}else if(T){if(!N.filters){const P=new Ae({distance:15,outerStrength:3,color:7377663});P.resolution=2,N.filters=[P]}}else N.filters&&(N.filters=null);if(S&&f.current){g.current||(g.current=new an,f.current.addChild(g.current));const P={alpha:.9,dash:[6,3],width:2,color:16711680};g.current.clear();const F=new xe(g.current,P);b&&(b.outer&&b.inner?(F.drawPolygon(b.outer),F.drawPolygon(b.inner)):F.drawPolygon(b.perimeter))}else g.current&&(g.current.destroy({children:!0}),g.current=null)};E(),U()}},[d,l,c,p,v,b,f]),h.useEffect(()=>()=>{g.current&&(g.current.destroy({children:!0}),g.current=null)},[]);const C=Ws(L(e.tag)),I=Us(L(e.tag));return a.jsxs(G.Container,{visible:p,position:{x:0,y:0},ref:w,...u,children:[a.jsx(G.Graphics,{draw:y}),a.jsx(G.Graphics,{draw:k}),C&&Dt(x.map(N=>[N.x,N.y]),Ot,!1,!0).map((N,E)=>N.coords.map(([U,D],S)=>a.jsx(G.Sprite,{eventMode:"none",width:8,height:8,texture:Lt,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:U,y:D},rotation:N.angle,tint:0},`${E}-${S}`))).flat(),I&&Dt(x.map(N=>[N.x,N.y]),Ot,!0,!0).map((N,E)=>N.coords.map(([U,D],S)=>a.jsx(G.Sprite,{eventMode:"none",width:8,height:8,texture:Lt,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:U,y:D},rotation:N.angle,tint:0},`${E}-${S}`))).flat()]})}var De=(e=>(e.BUS_STOP="bus stop",e.STOP_POSITION="stop posistion",e))(De||{}),_n=(e=>e)(_n||{}),Le=(e=>(e.ROUTE="route",e.ROUTE_MASTER="route master",e.STOP_AREA="stop area",e))(Le||{});({...De,..._n,...Le});function we(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="platform")&&e.some(t=>t["@_k"]==="highway"&&t["@_v"]==="bus_stop")}function bt(e){return e=e||[],e.some(t=>t["@_k"]==="public_transport"&&t["@_v"]==="stop_position")}function ee(e){var t;return e=e||[],(t=e.find(n=>n["@_k"]==="name"))==null?void 0:t["@_v"]}function Xe(e){if(e){if(we(e))return De.BUS_STOP;if(bt(e))return De.STOP_POSITION}}function Ys({node:e,mapViewStatus:{width:t,height:n,viewpoint:s,zoom:o},status:{visible:r,hovered:i,selected:l,highlighted:c},layerRef:d,...f}){const u=o>=16&&r,p=h.useRef(null),x=h.useRef(null),w=we(L(e.tag)),g="dot",m=xt({lon:e["@_lon"],lat:e["@_lat"]},s,o,t,n),b=h.useMemo(()=>ee(e.tag),[e.tag]),y=h.useMemo(()=>w?16:8,[w]),k=11;return h.useEffect(()=>{const v=p.current;if(v){const C=()=>{if(!u)return;const N=20,E=new Rt(0,0,Math.max(N/2,y/2+5));v.hitArea=E},I=()=>{const N=u&&i,E=u&&c,U=u&&l;if(N){if(!v.filters){const D=new Ae({distance:15,outerStrength:3,color:16776960});D.resolution=2,v.filters=[D]}}else if(E){if(!v.filters){const D=new Ae({distance:15,outerStrength:3,color:7377663});D.resolution=2,v.filters=[D]}}else v.filters&&(v.filters=null);if(U&&d.current){console.log("show select"),x.current||(x.current=new an,d.current.addChild(x.current));const D={alpha:.9,dash:[6,3],width:3,color:16711680};x.current.clear();const S=v.hitArea;S instanceof Rt?(new xe(x.current,D).drawCircle(S.x+m.x,S.y+m.y,S.radius,20),console.log(x.current)):S instanceof Do&&new xe(x.current,D).drawRect(S.x+m.x,S.y+m.y,S.width,S.height)}else x.current&&(x.current.destroy({children:!0}),x.current=null)};C(),I()}},[o,c,i,u,g,l,d,m]),h.useEffect(()=>()=>{x.current&&(x.current.destroy({children:!0}),x.current=null)},[]),h.useEffect(()=>{const v=p.current;v&&(o<16||(o<17?v.scale.set(.8,.8):v.scale.set(1,1)))},[o]),o<16?null:a.jsxs(G.Container,{...f,position:m,visible:u,ref:p,children:[a.jsx(G.Sprite,{eventMode:"none",sortableChildren:!1,visible:!0,texture:Os,anchor:{x:.5,y:.5},width:y,height:y}),w&&a.jsx(G.Sprite,{eventMode:"none",texture:Bs,anchor:{x:.5,y:.5},width:k,height:k}),b&&o>16&&a.jsx(G.Text,{text:b,anchor:.5,x:0,y:w?24:16,style:new Io({align:"center",fontFamily:'"Source Sans Pro", Helvetica, sans-serif',fontSize:12,fontWeight:"400",fill:"#ffffff",stroke:"#000000",strokeThickness:2,dropShadow:!0,dropShadowColor:"#ccced2",dropShadowBlur:3,dropShadowAngle:Math.PI/6,dropShadowDistance:2,wordWrap:!0,wordWrapWidth:440})})]})}const Js=h.forwardRef(function({view:{width:t,height:n,viewpoint:s,zoom:o},meta:{node:r,way:i},pointRenderer:l,wayRenderer:c,...d},f){const{left:u,bottom:p,right:x,top:w}=h.useMemo(()=>dn(s,o,t,n),[s,o,t,n]),g=h.useCallback(({"@_lon":m,"@_lat":b})=>u<=m&&m<=x&&p<=b&&b<=w,[u,p,x,w]);return o<16?null:a.jsxs(G.Container,{ref:f,...d,children:[Object.values(i).filter(m=>m.nd.map(b=>r[b["@_ref"]]).some(g)).map(c),Object.values(r).filter(g).map(l)]})});function Zs({selectionRect:e}){if(!e)return null;const{from:t,to:n}=e,s=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);return a.jsx(G.Graphics,{draw:l=>{l.clear(),l.beginFill(16753920,.5),l.drawRect(s,o,r,i),l.endFill()}})}function Qs({node:e,stateMachine:t,...n}){const s=e["@_localStates"],o=e["@_id"];return a.jsx(Ys,{...n,node:e,status:s,eventMode:"static",mousedown:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),mouseup:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerover:r=>t.transform({...r,componentTarget:{id:o,type:"node"}}),pointerout:r=>t.transform({...r,componentTarget:{id:o,type:"node"}})})}function ea({way:e,node:t,stateMachine:n,...s}){const o=e["@_localStates"],r=e["@_id"],i=h.useMemo(()=>e.nd.map(l=>t[l["@_ref"]]),[t,e.nd]);return a.jsx(Gs,{...s,line:e,nodePath:i,status:o,eventMode:"static",pointerover:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),pointerout:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mousedown:l=>n.transform({...l,componentTarget:{id:r,type:"way"}}),mouseup:l=>n.transform({...l,componentTarget:{id:r,type:"way"}})})}function Ke({width:e,height:t,stateMachine:n}){const[s,o,r]=K(H(d=>[d.viewpoint,d.zoom,d.selectionRect])),{node:i,way:l}=_(d=>d.meta),c=h.useRef(null);return a.jsxs(a.Fragment,{children:[a.jsx(Js,{view:{viewpoint:s,zoom:o,width:e,height:t},meta:{node:i,way:l},ref:c,wayRenderer:d=>a.jsx(ea,{way:d,node:i,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:c},d["@_id"]),pointRenderer:d=>a.jsx(Qs,{node:d,stateMachine:n,mapViewStatus:{width:e,height:t,viewpoint:s,zoom:o},layerRef:c},d["@_id"])}),a.jsx(Zs,{selectionRect:r})]})}function jn(e,t,n){const s={"?xml":{"@_version":"1.0","@_encoding":"UTF-8"},osm:{bounds:{"@_minlat":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlat"]),1/0),"@_minlon":n.reduce((i,l)=>Math.min(i,l.osm.bounds["@_minlon"]),1/0),"@_maxlat":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlat"]),-1/0),"@_maxlon":n.reduce((i,l)=>Math.max(i,l.osm.bounds["@_maxlon"]),-1/0),"@_origin":"v0.0.2-BusFensi"},node:Object.values({...e.node,...t.node}),way:Object.values({...e.way,...t.way}),relation:Object.values({...e.relation,...t.relation}),"@_version":.6,"@_generator":"BusFensi"}};console.log(s,e);const r=new on.XMLBuilder({ignoreAttributes:["localStates"],attributeNamePrefix:"@_",suppressBooleanAttributes:!1}).build(s);return console.log(r),r}function ta({stateMachine:e}){const{createLocalWay:t,createLocalRelation:n,deleteFeature:s,selectFeature:o,clearSelect:r,selectedRef:i,meta:l,bbox:c,deletedMeta:d}=_(H(C=>C)),{updateSettingsAction:f,...u}=ne(),[p,x]=h.useState(!1),[w,g]=h.useState(u),m=()=>{const C=i.filter(N=>N.type==="node").map(N=>({"@_ref":N.id})),I=t(C);o("way",I,!1)},b=()=>{const C=i.map(N=>({"@_ref":N.id,"@_type":N.type})),I=n(C);o("relation",I,!1)},y=()=>{const C=le(i);r(),C.forEach(I=>{if(I.type==="node"||I.type==="way"||I.type==="relation")s(I.type,I.id);else throw new Error(`Type not found ${I.type} for id ${I.id}`)})},k=()=>{const C=jn(l,d,c),I=new Blob([C],{type:"application/xml"}),N=document.createElement("a");N.href=URL.createObjectURL(I),N.download="exported_data.osm",N.click(),URL.revokeObjectURL(N.href)},v=()=>{f(w),x(!1)};return a.jsxs("div",{className:"join",children:[a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node"}),children:"Create Node"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"add-node-on-way"}),children:"Create node on way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>e.transform({type:"split-way"}),children:"Split way"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:m,children:"Create way with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:b,children:"Create relation with select"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:y,children:"Delete selected"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:k,children:"export josm"}),a.jsx("button",{className:"btn btn-sm join-item",onMouseDown:()=>x(!0),children:"Change Settings"}),p&&a.jsx("div",{className:"modal modal-open",children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:w.osmAPI.BASEURL,onChange:C=>g({...w,osmAPI:{...w.osmAPI,BASEURL:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:w.osmAPI.TILE_SOURCE,onChange:C=>g({...w,osmAPI:{...w.osmAPI,TILE_SOURCE:C.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"py-4",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:w.view.MAX_ZOOM,onChange:C=>g({...w,view:{...w.view,MAX_ZOOM:parseFloat(C.target.value)}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn",onClick:v,children:"Save"}),a.jsx("button",{className:"btn btn-ghost",onClick:()=>x(!1),children:"Cancel"})]})]})})]})}const na=({id:e="drag-bar",dir:t,isDragging:n,...s})=>{const[o,r]=h.useState(!1);return a.jsx("div",{id:e,"data-testid":e,tabIndex:0,className:J("flex-shrink-0 bg-base-300 transition-colors",t==="horizontal"?"cursor-row-resize h-1":"cursor-col-resize w-1",(n||o)&&"bg-accent"),onFocus:()=>r(!0),onBlur:()=>r(!1),...s})},Fe=({width:e,height:t,children:n,...s})=>{const{axis:o}=s,r=s.initial||(o==="x"?e/2:t/2),{position:i,separatorProps:l,setPosition:c}=In({...s,initial:r}),d=h.useRef(o==="x"?e:t);let f={},u={};return o==="x"?(f={width:i,height:t},u={width:e-i,height:t}):(f={width:e,height:i},u={width:e,height:t-i}),h.useEffect(()=>{o==="x"&&e!==d.current?(c(i*(e/d.current)),d.current=e):o==="y"&&t!==d.current&&(c(i*(t/d.current)),d.current=t)},[e,t,d,o,c,i]),a.jsxs("div",{style:{width:e,height:t,display:"flex",flexDirection:o==="x"?"row":"column",position:"relative"},children:[a.jsx("div",{style:f,children:n[0]({width:f.width,height:f.height})}),a.jsx(na,{...l,dir:o==="x"?"vertical":"horizontal",isDragging:!1}),a.jsx("div",{style:u,children:n[1]({width:u.width,height:u.height})})]})};function ze({id:e,filter:t}){const n=_(H(p=>p.meta.node[e])),s=_(H(p=>{var x;return(x=p.meta.node[e])==null?void 0:x["@_localStates"]})),o=_(p=>p.selectFeature);if(!n||!t(n,"node")||!s)return null;const{visible:r,selected:i}=s;let l=`node-${e}`,c=mt;const d=L(n.tag);d.forEach(p=>{p["@_k"]==="name"&&(l=p["@_v"])}),we(d)&&(c=Yn);const f=`outline-list-item
    ${r?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,u=p=>{o("node",e,!p.shiftKey)};return a.jsx("li",{className:f,children:a.jsxs("span",{className:i?"active":"",onClick:u,children:[a.jsx(M,{icon:c}),l]})})}function yt({id:e,filter:t}){const n=_(H(m=>Object.keys(m.meta.node))),s=_(H(m=>m.meta.way[e])),o=_(m=>m.selectFeature),r=_(H(m=>{var b;return(b=m.meta.way[e])==null?void 0:b["@_localStates"]})),[i,l]=h.useState(!0);if(!t(s,"way")||!s||!r)return null;const{visible:c,selected:d}=r,f=L(s.tag);let u=`way-${e}`;f.forEach(m=>{m["@_k"]==="name"&&(u=m["@_v"])});const p=L(s.nd).filter(m=>n.includes(m["@_ref"])),x=`outline-list-item
    ${d?"active":c?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,w=m=>{o("way",e,!m.shiftKey)},g=m=>{m.stopPropagation(),l(!i)};return a.jsxs("li",{className:x,children:[a.jsxs("span",{className:`flex flex-row ${d?"bg-neutral text-neutral-content ":""}`,onClick:w,children:[a.jsx(M,{icon:i?Be:He,onClick:g}),a.jsx(M,{icon:qt,className:"ml-2 "}),a.jsx("span",{className:"ml-0 mr-auto",children:u})]}),!i&&a.jsx("ul",{className:"menu menu-xs pl-4",children:p.map(m=>a.jsx(ze,{id:m["@_ref"],filter:t},m["@_ref"]))})]})}function wt({id:e,filter:t}){const n=_(H(y=>y.meta.relation[e])),s=_(y=>y.selectFeature),o=_(H(y=>{var k;return(k=y.meta.relation[e])==null?void 0:k["@_localStates"]})),[r,i]=h.useState(!0);if(!t(n,"relation")||!n||!o)return null;const{visible:l,selected:c}=o;let d=`relation-${e}`;L(n.tag).forEach(y=>{y["@_k"]==="name"&&(d=y["@_v"])});const u=`outline-list-item
    ${c?"active":l?"bg-base-200 text-base-content":"bg-base-100 text-gray-400"}`,p=L(n.member),x=p.filter(y=>y["@_type"]==="node"),w=p.filter(y=>y["@_type"]==="way"),g=p.filter(y=>y["@_type"]==="relation"),m=y=>{s("relation",e,!y.shiftKey)},b=y=>{y.stopPropagation(),i(!r)};return a.jsxs("li",{className:u,children:[a.jsxs("span",{className:`flex flex-row ${c?"bg-neutral text-neutral-content ":""}`,onClick:m,children:[a.jsx(M,{icon:r?Be:He,onClick:b}),a.jsx(M,{className:"ml-2",icon:Jn}),d]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[x.map(y=>a.jsx(ze,{id:y["@_ref"],filter:t},y["@_ref"])),w.map(y=>a.jsx(yt,{id:y["@_ref"],filter:t},y["@_ref"])),g.map(y=>a.jsx(wt,{id:y["@_ref"],filter:t},y["@_ref"]))]})]})}function rt({collecion:e,name:t,filterFun:n}){const{node:s,way:o,relation:r}=e,{roots:i}=_(u=>u.tree),[l,c]=h.useState(!0),d=u=>{u.stopPropagation(),c(!l)},f=(u,p)=>u&&(p==="node"&&s[u["@_id"]]||p==="way"&&o[u["@_id"]]||p==="relation"&&r[u["@_id"]])&&n(u,p);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(M,{icon:l?Be:He,onClick:d}),a.jsx(M,{icon:Xt,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:t})]}),!l&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...ae(i.node)].map(u=>a.jsx(ze,{id:u,filter:f},u)),[...ae(i.way)].map(u=>a.jsx(yt,{id:u,filter:f},u)),[...ae(i.relation)].map(u=>a.jsx(wt,{id:u,filter:f},u))]})]})}function oa({name:e,filterFun:t}){const{node:n,way:s,relation:o}=_(d=>d.collections.global),[r,i]=h.useState(!0),l=d=>{d.stopPropagation(),i(!r)},c=(d,f)=>d&&t(d,f)&&(f==="node"&&n[d["@_id"]]||f==="way"&&s[d["@_id"]]||f==="relation"&&o[d["@_id"]]);return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",children:[a.jsx(M,{icon:r?Be:He,onClick:l}),a.jsx(M,{icon:Xt,className:"ml-1 "}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),!r&&a.jsxs("ul",{className:"menu menu-xs pl-4",children:[[...ae(n)].map(d=>a.jsx(ze,{id:d,filter:c},d)),[...ae(s)].map(d=>a.jsx(yt,{id:d,filter:c},d)),[...ae(o)].map(d=>a.jsx(wt,{id:d,filter:c},d))]})]})}function sa({width:e,height:t}){const{ptv2:n,highway:s,created:o}=_(c=>c.collections),[r,i]=h.useState(""),l=(c,d)=>r===""||`${d}-${JSON.stringify(c)}`.includes(r);return a.jsxs("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"outline-view flex flex-col p-1 rounded bg-base-100 overflow-x-scroll",children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2",children:[a.jsx(M,{icon:Zn}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:r,onChange:c=>i(c.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 overflow-scroll mt-1 rounded",children:a.jsxs("ul",{className:"menu menu-xs bg-base-200",children:[a.jsx(rt,{name:"Public Transport",collecion:n,filterFun:l}),a.jsx(rt,{name:"Highway",collecion:s,filterFun:l}),a.jsx(rt,{name:"Created",collecion:o,filterFun:l}),a.jsx(oa,{name:"Global",filterFun:l})]})})]})}const Bt=h.memo(({initialValue:e,onCommit:t,...n})=>{const[s,o]=h.useState(e||"");return h.useEffect(()=>{o(e||"")},[e]),a.jsx("input",{...n,value:s,onChange:r=>o(r.target.value),onKeyDown:r=>{r.key==="Enter"&&r.currentTarget.blur(),r.stopPropagation()},onBlur:()=>{t(s)}})});function Ge({tags:e,setTags:t,commitChange:n}){const s=le(e),o=(c,d)=>{n(),s[c]["@_k"]=d,t([...s])},r=(c,d)=>{n(),s[c]["@_v"]=d,t([...s])},i=c=>{const d=s.filter((f,u)=>u!==c);n(),t(d)},l=()=>{n(),t([...s,{"@_k":"","@_v":""}])};return a.jsxs("table",{className:"table table-xs w-full max-w-full overflow-x-scroll",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Key"}),a.jsx("th",{children:"Value"}),a.jsx("th",{children:"Actions"})]})}),a.jsx("tbody",{children:s.map((c,d)=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsx(Bt,{type:"text",initialValue:c["@_k"],onCommit:f=>o(d,f),className:"input input-bordered input-xs rounded-md border max-w-xs"})}),a.jsx("td",{children:a.jsx(Bt,{type:"text",initialValue:c["@_v"],onCommit:f=>r(d,f),className:"input input-bordered input-xs rounded-md border max-w-xs w-fit"})}),a.jsx("td",{children:a.jsx("button",{onClick:()=>i(d),className:"btn btn-error btn-xs",children:a.jsx(M,{icon:Qn})})})]},d))}),a.jsx("tfoot",{children:a.jsx("tr",{children:a.jsx("td",{colSpan:3,className:"flex gap-2",children:a.jsx("button",{onClick:l,className:"btn btn-primary btn-sm",children:"Add"})})})})]})}function _t({meta:e}){const t=ae(e).filter(n=>{const s=e[n];return n.startsWith("@_")&&(typeof s=="string"||typeof s=="number")});return a.jsx("ul",{className:"menu menu-xs bg-200 rounded-box",children:t.map(n=>{const s=e[n];return a.jsx("li",{children:a.jsxs("span",{className:"select-text",children:[a.jsx("span",{className:"font-semibold",children:String(n).substring(2)}),a.jsx("span",{className:"ml-auto text-base-content",children:s.toString()})]})},n)})})}function re({featuretype:e,metatype:t,fullname:n,id:s,created:o,deleted:r,modified:i,children:l}){let c;switch(e){case"node":c=oo;break;case"way":c=qt;break;case"relation":c=no;break;default:c=to}return a.jsxs(a.Fragment,{children:[a.jsx("span",{children:a.jsx(M,{icon:c})}),a.jsx("span",{className:"font-semibold",children:n||"[untitled]"}),t&&a.jsx("span",{className:"badge badge-xs h-fit badge-outline text-nowrap",children:t}),a.jsx("div",{className:"badge badge-xs h-fit badge-outline",children:s}),a.jsxs("div",{className:"flex space-x-1",children:[o&&a.jsx("div",{className:"badge badge-xs badge-success tooltip tooltip-bottom","data-tip":"Created",children:a.jsx(M,{icon:ct})}),i&&a.jsx("div",{className:"badge badge-xs badge-warning tooltip tooltip-bottom","data-tip":"Modified",children:a.jsx(M,{icon:eo})}),r&&a.jsx("div",{className:"badge badge-xs badge-error tooltip tooltip-bottom","data-tip":"Deleted",children:a.jsx(M,{icon:Kt})})]}),a.jsx("span",{className:"flex items-center ml-auto",children:l})]})}function aa(e){return a.jsxs("li",{children:[" ",a.jsx("span",{className:"flex select-text justify-between items-center rounded",children:a.jsx(re,{...e})})]})}function Sn(e){return e=e||[],Y("public_transport",e)==="stop_area"&&Y("type",e)==="public_transport"}function jt(e){return e=e||[],Y("type",e)==="route"}function Nn(e){return e=e||[],Y("type",e)==="route_master"}function Ye(e){if(e&&!Sn(e)){if(jt(e))return Le.ROUTE;if(Nn(e))return Le.ROUTE_MASTER}}function ie({type:e,id:t,showMetaType:n,children:s}){var b,y,k;const[o,r,i,l]=_(H(v=>[v.meta[e][t],v.selectFeatureWithoutActive,v.unSelectFeature,v.loadFeature])),c=ne(v=>v.osmAPI.BASEURL),d=K(v=>v.setViewpoint),f=h.useMemo(()=>{var v;if(n&&((v=o==null?void 0:o.tag)!=null&&v.length)){if(e==="node")return Xe(o.tag);if(e==="relation")return Ye(o.tag)}},[n,o==null?void 0:o.tag,e]),[u,p]=h.useState(!1),x=h.useCallback(async()=>{p(!0),await l(e,t,c),p(!1)},[l,e,t,c]),w=h.useCallback(v=>{if(v.stopPropagation(),e==="node"){const C=o;d({lat:C["@_lat"],lon:C["@_lon"]})}},[o,d,e]),g=h.useCallback(v=>{var C;v.stopPropagation(),(C=o["@_localStates"])!=null&&C.selected?i(e,t):r(e,t,!1)},[t,o,r,e,i]),m=h.useCallback(v=>{v.stopPropagation(),x()},[x]);return o?a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(re,{featuretype:e,id:t,metatype:f,fullname:ee(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:w,children:a.jsx(M,{icon:zt.faLocationDot})}),a.jsx("button",{className:J("btn btn-xs btn-square tooltip tooltip-bottom",((b=o["@_localStates"])==null?void 0:b.selected)&&"btn-accent"),"data-tip":(y=o["@_localStates"])!=null&&y.selected?"Unselect":"Select",onClick:g,children:a.jsx(M,{icon:(k=o["@_localStates"])!=null&&k.selected?Gt.faXmarkCircle:Yt.faCheckCircle})}),s&&s({type:e,id:t})]})}):a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsxs(re,{featuretype:e,id:t,fullname:"[not downloaded]",children:[u?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx("button",{className:"btn btn-square btn-xs btn-success tooltip tooltip-bottom","data-tip":"Download feature",onMouseDown:m,children:a.jsx(M,{icon:so})}),s&&s({type:e,id:t})]})})}function vn({id:e,type:t}){const n=_(l=>l.selectFeature),{relation:s,way:o}=_(H(l=>l.meta)),r=ae(s).filter(l=>Object.prototype.hasOwnProperty.call(s,l)).map(l=>s[l]),i=l=>{n("relation",l,!1)};return a.jsx("ul",{className:"menu menu-xs",children:r.filter(l=>L(l.member).some(c=>c["@_ref"]===e&&c["@_type"]===t||t==="node"&&(c["@_type"]==="way"&&o[c["@_ref"]]&&L(o[c["@_ref"]].nd).some(d=>String(d["@_ref"])===e)||c["@_type"]==="relation"&&s[c["@_ref"]]&&L(s[c["@_ref"]].member).some(d=>d["@_ref"]===e)))).map(l=>a.jsx("li",{children:a.jsx("span",{onClick:()=>i(l["@_id"]),children:a.jsx(ie,{id:l["@_id"],type:"relation",showMetaType:!0})})},l["@_id"]))})}function St({id:e,type:t}){const n=_(H(s=>s.meta[t][e]["@_localStates"]));return a.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(n).filter(([,s])=>s).map(([s])=>a.jsx("span",{className:"badge badge-info badge-xs",children:s},s))})}function ra({id:e}){const t=_(H(o=>o.meta.node[e])),n=_(o=>o.modifyFeatureMetaNC),s=_(o=>o.commit);return t?a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Node] ",ee(t.tag)||t["@_id"]]}),a.jsx(St,{id:e,type:"node"}),a.jsx(_t,{meta:t}),a.jsx(Ge,{tags:L(t.tag),setTags:o=>{n("node",e,r=>r.tag=o)},commitChange:s}),a.jsx(vn,{id:e,type:"node"})]}):null}function kn({member:e,memberToId:t,children:n,slotSelection:s}){const[o,r]=h.useState(new Set);h.useEffect(()=>{r(c=>{const d=new Set;return e.forEach(f=>{c.has(t(f))&&d.add(t(f))}),d})},[e,t]);const i=()=>{o.size===e.length?r(new Set):r(new Set(e.map(t)))},l=h.useMemo(()=>{const c=d=>{r(f=>{const u=new Set(f);return u.has(d)?u.delete(d):u.add(d),u})};return({m:d})=>a.jsx(a.Fragment,{children:a.jsx("input",{type:"checkbox",className:"checkbox ml-2",checked:o.has(t(d)),onChange:()=>c(t(d))})})},[o,t]);return a.jsxs(a.Fragment,{children:[s({selected:o,children:a.jsx("input",{type:"checkbox",checked:o.size===e.length,onChange:i,className:"checkbox ml-2"})}),n({member:e,memberToId:t,slot:l})]})}function ia({id:e,type:t}){const n=_(o=>o.meta[t][e]),s=h.useMemo(()=>{var o;if((o=n==null?void 0:n.tag)!=null&&o.length){if(t==="node")return Xe(n.tag);if(t==="relation")return Ye(n.tag)}},[n==null?void 0:n.tag,t]);return a.jsx(re,{featuretype:t,id:e,metatype:s,fullname:ee(n.tag),created:Number(n["@_id"])<0,deleted:n["@_action"]==="delete",modified:n["@_action"]==="modify"})}function Nt({handelInsertTop:e,handelIntertBottom:t,handelInsertAtActive:n}){const s=_(H(c=>c.selectedRef)),o=h.useCallback(c=>`${c.type}-${c.id}`,[]),r=h.useRef(new Set),i=()=>s.filter(c=>r.current.has(o(c))),l=h.useCallback(({member:c,memberToId:d,slot:f})=>c.map(u=>a.jsxs("div",{className:"flex flex-row gap-1 px-2 mt-1",children:[a.jsx(ia,{...u}),f({m:u})]},d(u))),[]);return a.jsxs("div",{className:"flex flex-row justify-center p-2 rounded-md",children:[a.jsxs("div",{className:"join join-vertical mr-2",children:[a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{e(i())},children:"InsTop"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{n(i())},children:"InsAct"}),a.jsx("button",{className:"btn btn-xs join-item",onClick:()=>{t(i())},children:"InsBtm"})]}),a.jsx("div",{className:"bg-base-200 text-xs rounded max-h-full",children:a.jsx(kn,{member:s,memberToId:o,slotSelection:({selected:c,children:d})=>(r.current=c,a.jsxs("div",{className:"flex flex-row px-2 py-1",children:[a.jsx("h3",{className:"text text-sm font-semibold",children:"selected Items to insert"}),a.jsx("div",{className:"ml-auto"}),d]})),children:l})})]})}function la({id:e,element:t="div",children:n,style:s,...o}){const{attributes:r,listeners:i,setNodeRef:l,transform:c,transition:d}=Dn({id:e}),f={transform:Ln.Transform.toString(c),transition:d,...s};return a.jsxs(t,{ref:l,className:"flex flex-row bg-base-200 rounded border pl-1",style:f,...o,children:[a.jsx("button",{...i,...r,className:"btn btn-ghost btn-xs my-auto inline-block",children:a.jsx(M,{icon:Jt.faGripVertical})}),n]})}function ca({memberToId:e,member:t,onDragEnd:n,onDragStart:s,children:o}){const r=Fn(Et(qn),Et(Vn,{coordinateGetter:Un})),[i,l]=h.useState(),c=h.useMemo(()=>t.map(p=>({id:e(p),member:p})),[t,e]);function d(p){var g;const{active:x}=p;console.debug("drag memeber start:",x);const w=(g=c.find(m=>m.id===x.id))==null?void 0:g.member;if(!w)throw new Error(`in Drag list got invalid active object ${JSON.stringify(x)}`);l(w),s(w)}function f(p){const{active:x,over:w}=p;if(console.debug("drag memeber end:",x,w),w&&x.id!==w.id){const g=c.findIndex(b=>b.id===x.id),m=c.findIndex(b=>b.id===w.id);n(Xn(c,g,m).map(b=>b.member))}l(void 0)}const u=h.useCallback(({id:p,member:x,index:w})=>a.jsx(la,{id:p,children:o({member:x,index:w})},p),[o]);return a.jsxs(On,{sensors:r,collisionDetection:Bn,onDragStart:d,onDragEnd:f,children:[a.jsx(Hn,{items:c,strategy:$n,children:c.map((p,x)=>u({id:p.id,member:p.member,index:x}))}),a.jsx(Wn,{children:i?a.jsxs("div",{className:"flex bg-base-200 rounded-sm pl-1",children:[a.jsx("button",{className:"btn btn-ghost btn-xs my-auto",children:a.jsx(M,{icon:Jt.faGripVertical})}),o({member:i,isDragOverlay:!0,index:-1})]}):null})]})}function da({member:e,isDragOverlay:t,slot:n,index:s,children:o}){return a.jsx(a.Fragment,{children:o({member:e,children:n({m:e}),overlay:t,index:s})})}function Cn({member:e,memberToId:t,children:n,slotSelection:s,...o}){const r=h.useCallback(({member:i,memberToId:l,slot:c})=>a.jsx(ca,{...o,member:i,memberToId:l,children:d=>a.jsx(da,{...d,slot:c,children:n})}),[n,o]);return a.jsx(kn,{member:e,memberToId:t,slotSelection:s,children:r})}function Je({onDelete:e,member:t,memberToId:n,...s}){const o=_(x=>x.loadFeatureBatch),r=ne(x=>x.osmAPI.BASEURL),[i,l]=h.useState(!1),c=h.useRef(1),d=h.useCallback(()=>c.current++,[c]),f=h.useMemo(()=>t.map(x=>({...x,uniqueIdentifier:d()})),[d,t]),u=h.useCallback(x=>`${n(x)}_AT_LIST_${x.uniqueIdentifier}`,[n]),p=h.useCallback(({selected:x,children:w})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:g=>{g.stopPropagation();const m=f.filter(b=>!x.has(u(b)));e(f,m)},children:a.jsx(M,{icon:Zt.faDeleteLeft})}),a.jsx("button",{className:"btn btn-square btn-xs btn-accent tooltip tooltip-bottom","data-tip":"Download selected member of this list",disabled:i,onMouseDown:async g=>{g.stopPropagation(),l(!0),await o(f.filter(m=>x.has(u(m))).map(m=>m["@_type"]?{type:m["@_type"],id:m["@_ref"]}:{type:"node",id:m["@_ref"]}),r),l(!1)},children:i?a.jsx("span",{className:"loading loading-spinner loading-xs"}):a.jsx(M,{icon:ao.faDownload})}),w]}),[r,o,f,u,e,i,l]);return a.jsx(Cn,{...s,member:f,memberToId:u,slotSelection:p})}function ua({id:e}){const t=_(H(g=>g.meta.way[e])),n=_(g=>g.modifyFeatureMetaNC),s=_(g=>g.commit),[o,r]=h.useState(void 0),i=h.useCallback(({member:g,children:m})=>a.jsx(ie,{id:g["@_ref"],type:"node",children:()=>{const b=(o==null?void 0:o.id)===g["@_ref"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:J("btn btn-square btn-xs tooltip tooltip-bottom",b&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:y=>{y.stopPropagation(),r(b?void 0:{id:g["@_ref"],type:"node"})},children:a.jsx(M,{icon:b?Qt.faCircle:ft.faCircle})}),m]})}}),[o==null?void 0:o.id]),l=h.useCallback(g=>`nd-${g["@_ref"]}`,[]);if(!t)return null;function c(){s()}function d(g){n("way",e,m=>{m.nd=g})}function f(g){n("way",e,m=>{m.nd=g})}const u=g=>g.filter(m=>m.type==="node").map(m=>({"@_ref":m.id})),p=g=>{console.log("Insert at Top: ",g),s(),n("way",e,m=>{m.nd=[...u(g),...L(t.nd)]})},x=g=>{console.log("Insert at Bottom: ",g),s(),n("way",e,m=>{m.nd=[...L(t.nd),...u(g)]})},w=g=>{if(console.log("Insert at Active: ",g),!o)x(g);else{const m=[...L(t.nd)],b=m.findIndex(y=>y["@_ref"]===o.id);m.splice(b+1,0,...u(g)),s(),n("way",e,y=>{y.nd=m})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Way] ",ee(t.tag)||t["@_id"]]}),a.jsx(St,{id:e,type:"way"}),a.jsx(_t,{meta:t}),a.jsx(Ge,{tags:L(t.tag),setTags:g=>{n("way",e,m=>m.tag=g)},commitChange:s}),a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Je,{member:t.nd,memberToId:l,onDragStart:c,onDragEnd:d,onDelete:(g,m)=>f(m),children:i})}),a.jsx("div",{className:"",children:a.jsx(Nt,{handelInsertTop:p,handelIntertBottom:x,handelInsertAtActive:w})})]}),a.jsx(vn,{id:e,type:"way"})]})}const vt=h.memo(({initialValue:e,onCommit:t})=>{const[n,s]=h.useState(e||"");return h.useEffect(()=>{s(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:n,onChange:o=>s(o.target.value),onKeyDown:o=>{o.key==="Enter"&&o.currentTarget.blur(),o.stopPropagation()},onBlur:()=>{t(n)}})});function Ht(e,t){return e["@_ref"]===t["@_ref"]}function En({member:e,index:t}){var c,d;const n=_(f=>f.meta.way),s=n[e[t]["@_ref"]],o=n[(c=e[t-1])==null?void 0:c["@_ref"]]||void 0,r=n[(d=e[t+1])==null?void 0:d["@_ref"]]||void 0,i=o&&s&&Ht(o.nd[o.nd.length-1],s.nd[0]),l=r&&s&&Ht(s.nd[s.nd.length-1],r.nd[0]);return i&&l?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to both sides",children:a.jsx(M,{icon:ro.faArrowsUpDown})}):i?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to previous way",children:a.jsx(M,{icon:io.faArrowUp})}):l?a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to next way",children:a.jsx(M,{icon:lo.faArrowDown})}):a.jsx("div",{className:"tooltip tooltip-bottom","data-tip":"Not connected to any way, or not downloaded",children:a.jsx(M,{icon:co.faMinus})})}function pa({id:e}){const t=_(H(m=>m.meta.relation[e])),n=_(m=>m.modifyFeatureMetaNC),s=_(m=>m.commit),[o,r]=h.useState(void 0),i=h.useCallback((m,b,y)=>{console.debug("edit",m,b,y),s(),n("relation",e,k=>{k.member=L(t.member).map(v=>{if(v["@_type"]===m&&v["@_ref"]===b){const C=le(v);return C["@_role"]=y,C}return v})})},[s,e,t.member,n]),l=h.useCallback(m=>`${m["@_type"]}-${m["@_ref"]}`,[]),c=h.useCallback(({member:m,children:b,overlay:y,index:k})=>a.jsx(ie,{id:m["@_ref"],type:m["@_type"],children:()=>{const v=(o==null?void 0:o.id)===m["@_ref"]&&o.type===m["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:J("btn btn-square btn-xs tooltip tooltip-bottom",v&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:C=>{C.stopPropagation(),r(v?void 0:{id:m["@_ref"],type:m["@_type"]})},children:a.jsx(M,{icon:v?mt:ft.faCircle})}),a.jsx("div",{className:"w-3",children:!y&&m["@_type"]==="way"&&a.jsx(En,{member:t.member,index:k})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(vt,{initialValue:m["@_role"],onCommit:C=>i(m["@_type"],m["@_ref"],C)})]}),b]})}}),[i,o,t.member]);if(!t)return null;function d(){s()}function f(m){n("relation",e,b=>{b.member=m})}function u(m){s(),n("relation",e,b=>{b.member=m})}const p=m=>m.map(b=>({"@_ref":b.id,"@_type":b.type})),x=m=>{console.log("Insert at Top: ",m),s(),n("relation",e,b=>{b.member=[...p(m),...L(b.member)]})},w=m=>{console.log("Insert at Bottom: ",m),s(),n("relation",e,b=>{b.member=[...L(b.member),...p(m)]})},g=m=>{if(console.log("Insert at Active: ",m),!o)w(m);else{const b=[...L(t.member)],y=b.findIndex(k=>k["@_ref"]===o.id&&k["@_type"]===o.type);b.splice(y+1,0,...p(m)),s(),n("relation",e,k=>{k.member=b})}};return a.jsxs("div",{className:"p-2 overflow-scroll",children:[a.jsxs("h3",{className:"text-base font-semibold mb-2",children:["[Relation] ",ee(t.tag)||t["@_id"]]}),a.jsx(St,{id:e,type:"relation"}),a.jsx(_t,{meta:t}),a.jsx(Ge,{tags:L(t.tag),setTags:m=>{n("relation",e,b=>b.tag=m)},commitChange:s}),a.jsxs("div",{className:"flex flex-row relative",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Je,{member:t.member,memberToId:l,onDragStart:d,onDragEnd:f,onDelete:(m,b)=>u(b),children:c})}),a.jsx("div",{className:"",children:a.jsx(Nt,{handelInsertTop:x,handelIntertBottom:w,handelInsertAtActive:g})})]})]})}function Mn({width:e,height:t}){const n=_(s=>s.activeRef);return a.jsx("div",{style:{width:e,height:t,maxWidth:e,maxHeight:t},className:"property-view flex flex-col rounded bg-base-100",children:n?n.type==="node"?a.jsx(ra,{id:n.id}):n.type==="way"?a.jsx(ua,{id:n.id}):n.type==="relation"?a.jsx(pa,{id:n.id}):a.jsxs("div",{children:["Unknown type for item ",JSON.stringify(n)]}):a.jsx("div",{children:"Please active some component to show prop edit view"})})}function ma(){const e=G.useApp(),t=K(n=>n.setStageApp);return h.useEffect(()=>(globalThis.__PIXI_APP__=e,e.stage.hitArea=e.screen,t(e),()=>{globalThis.__PIXI_APP__=void 0,t(void 0)}),[e,t]),null}function Ze({width:e,height:t,children:n,...s}){const o=K(r=>r.setStage);return h.useEffect(()=>{o(e,t)},[e,t,o]),a.jsxs(G.Stage,{width:e,height:t,options:{background:"#1099bb"},...s,children:[n,a.jsx(ma,{})]})}function Qe({width:e}){return a.jsx("div",{className:"slot-bottom absolute inset-x-0 bottom-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx("span",{className:"text-base-content bg-base-300 px-2 rounded",children:"dataÂ©openstreetmap contributor"})})}function fa({width:e,height:t}){const n=h.useRef(new Go({meta:_,view:K,settings:ne}));return h.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(Ze,{width:e,height:t,options:{background:"#1099bb"},onContextMenu:s=>s.preventDefault(),onMouseDown:s=>{n.current.transform(s)},onPointerMove:s=>{n.current.transform(s)},onMouseUp:s=>{n.current.transform(s)},onWheel:s=>{n.current.transform(s)},children:[a.jsx(qe,{width:e,height:t}),a.jsx(Ke,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Qe,{width:e}),a.jsx("div",{className:"slot-top absolute inset-x-0 top-0 flex flex-row align-middle justify-center",style:{width:e},children:a.jsx(ta,{stateMachine:n.current})})]})}function ha({width:e,height:t}){return a.jsxs(Fe,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(fa,{...n}),n=>a.jsxs(Fe,{...n,axis:"y",children:[s=>a.jsx(sa,{...s}),s=>a.jsx(Mn,{...s})]})]})}function xa({open:e,onClose:t}){const{updateSettingsAction:n,...s}=ne(),[o,r]=h.useState(s),i=_(c=>c.reset),l=()=>{n(o),t()};return a.jsx("div",{className:J("modal",e&&"modal-open"),children:a.jsxs("div",{className:"modal-box",children:[a.jsx("h3",{className:"font-bold text-lg",children:"Change Settings"}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Base URL"})}),a.jsx("input",{type:"text",value:o.osmAPI.BASEURL,onChange:c=>r({...o,osmAPI:{...o.osmAPI,BASEURL:c.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"OSM API Tile Source"})}),a.jsx("input",{type:"text",value:o.osmAPI.TILE_SOURCE,onChange:c=>r({...o,osmAPI:{...o.osmAPI,TILE_SOURCE:c.target.value}}),className:"input input-bordered w-full"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Max Zoom Level"})}),a.jsx("input",{type:"number",value:o.view.MAX_ZOOM,onChange:c=>r({...o,view:{...o.view,MAX_ZOOM:parseFloat(c.target.value)}}),className:"input input-bordered w-full"})]}),a.jsx("button",{className:"btn btn-error mt-4",onClick:i,children:"Reast All Data (All data will lost)"}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{className:"btn btn-ghost",onClick:t,children:"Cancel"}),a.jsx("button",{className:"btn",onClick:l,children:"Save"})]})]})})}function ga(){const[e,t]=_(H(s=>[s.autoload,s.setAutoloadNC])),n=h.useCallback(()=>t(()=>!e),[e,t]);return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Auto load OSM data on drag: "+(e?"Enabled":"Disabled"),children:a.jsx("a",{onClick:n,className:J(e&&"active"),children:a.jsx(M,{icon:uo.faA})})})}function ba(){const{viewpoint:e,zoom:t,height:n,width:s}=K(),o=_(H(d=>d.loadbbox)),r=ne(d=>d.osmAPI.BASEURL),[i,l]=h.useState(!1),c=h.useCallback(async()=>{i||(l(!0),await o({width:s,height:n,zoom:t,viewpoint:e},r),l(!1))},[r,n,o,e,s,t,i,l]);return a.jsx("li",{className:J("tooltip tooltip-left",i&&"disabled"),"data-tip":"Load OSM data on current screen",children:a.jsx("a",{onClick:c,children:i?a.jsx("span",{className:"loading loading-spinner loading-xs h-[14px]"}):a.jsx(M,{icon:po.faDownLong})})})}function ya(){return a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Export with JSOM format",children:a.jsx("a",{onClick:()=>{const{meta:e,deletedMeta:t,bbox:n}=_.getState(),s=jn(e,t,n),o=new Blob([s],{type:"application/xml"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download="exported_data.osm",r.click(),URL.revokeObjectURL(r.href)},children:a.jsx(M,{icon:mo.faFileExport})})})}function wa(){const[e,t]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx("li",{className:"tooltip tooltip-left","data-tip":"Change settings",onClick:()=>t(!0),children:a.jsx("a",{children:a.jsx(M,{icon:fo.faGear})})}),a.jsx(xa,{open:e,onClose:()=>t(!1)})]})}function _a(){return a.jsxs("ul",{className:"menu menu-horizontal",children:[a.jsx(ga,{}),a.jsx(ba,{}),a.jsx(ya,{}),a.jsx(wa,{})]})}function ja({height:e,leftSlot:t}){return a.jsxs("nav",{className:"navbar p-0 bg-base-100 overflow-hidden border-b-2 border-b-base-300",style:{height:e,maxHeight:e,minHeight:e},children:[a.jsx("div",{className:"flex-1",children:t}),a.jsx("div",{className:"flex-none",children:a.jsx(_a,{})})]})}function Sa({children:e}){return a.jsx("ul",{className:"menu menu-xs",children:e})}function Na({show:e,proceed:t,title:n,message:s}){const o=h.useRef(null);h.useEffect(()=>{const l=o.current;l&&(e?l.showModal():l.close())},[e]);const r=()=>{t(!1)},i=()=>{console.debug("clicking delete ok: "),t(!0)};return a.jsxs("dialog",{ref:o,className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box",children:[n&&a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsx("p",{children:s}),a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn btn-md",onClick:r,children:"Cancel"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:i,children:"OK"})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})}const va=e=>a.jsx(Na,{...e}),Rn=fe.confirmable(va);Rn.displayName="ConfirmableSimpleConfirmation";function it({type:e,meta:t,showMetaType:n,children:s}){var w,g,m;const o=t["@_id"],[r,i,l]=_(H(b=>[b.selectFeature,b.unSelectFeature,b.deleteFeature])),c=K(b=>b.setViewpoint),d=fe.createConfirmation(Rn),f=h.useMemo(()=>{var b;if(n&&((b=t.tag)!=null&&b.length)){if(e==="node")return Xe(t.tag);if(e==="relation")return Ye(t.tag)}},[n,t.tag,e]),u=h.useCallback(b=>{if(b.stopPropagation(),e==="node"){const y=t;c({lat:y["@_lat"],lon:y["@_lon"]})}},[t,c,e]),p=h.useCallback(b=>{var y;b.stopPropagation(),(y=t["@_localStates"])!=null&&y.selected?i(e,o):r(e,o,!1)},[o,t,r,e,i]),x=h.useCallback(async b=>{b.stopPropagation(),console.debug("deleting: ",e,o);const y=await d({title:"Confirm delete feature",message:`Are you sure you want delete this feature?
`+(ee(t.tag||[])||o)});console.debug("confirmed deleting: ",y,e,o),y&&l(e,o)},[d,l,o,t.tag,e]);return a.jsxs(aa,{featuretype:e,id:o,metatype:f,fullname:ee(t.tag),created:Number(t["@_id"])<0,deleted:t["@_action"]==="delete",modified:t["@_action"]==="modify",children:[e==="node"&&a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:u,children:a.jsx(M,{icon:zt.faLocationDot})}),a.jsx("button",{className:J("btn btn-xs btn-square tooltip tooltip-bottom",((w=t["@_localStates"])==null?void 0:w.selected)&&"btn-accent"),"data-tip":(g=t["@_localStates"])!=null&&g.selected?"Unselect":"Select",onClick:p,children:a.jsx(M,{icon:(m=t["@_localStates"])!=null&&m.selected?Gt.faXmarkCircle:Yt.faCheckCircle})}),a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Delete",onClick:x,children:a.jsx(M,{icon:ho.faTrash})}),s&&s({type:e,meta:t})]})}function de({node:e,way:t,relation:n,filter:s,...o}){return s=s||(()=>!0),a.jsxs(Sa,{children:[(e||[]).filter(r=>s(r,"node")).map(r=>h.createElement(it,{...o,key:r["@_id"],meta:r,type:"node"})),(t||[]).filter(r=>s(r,"way")).map(r=>h.createElement(it,{...o,key:r["@_id"],meta:r,type:"way"})),(n||[]).filter(r=>s(r,"relation")).map(r=>h.createElement(it,{...o,key:r["@_id"],meta:r,type:"relation"}))]})}function ue({name:e,defaultOpen:t,forceOpen:n,forceClose:s,children:o}){const[r,i]=h.useState(!t),l=d=>{d.stopPropagation(),s||n||i(!r)},c=n?!0:s?!1:!r;return a.jsxs("li",{className:"outline-list-item",children:[a.jsxs("span",{className:"flex flex-row",onClick:l,children:[a.jsx(M,{icon:n?Qt.faCircle:s?xo.faX:c?ht.faChevronDown:go.faChevronRight}),a.jsx(M,{icon:bo.faBars,className:"ml-1"}),a.jsx("span",{className:"ml-0 mr-auto",children:e})]}),c&&o]})}function ka(e){const t=_(n=>n.meta.node);return a.jsx(ue,{name:"bus stop",children:a.jsx(de,{...e,node:Object.values(t).filter(n=>we(n.tag))})})}function Ca(e){const t=_(n=>n.meta.relation);return a.jsx(ue,{name:"stop area",children:a.jsx(de,{...e,relation:Object.values(t).filter(n=>Sn(n.tag))})})}function Ea(e){const t=_(n=>n.meta.node);return a.jsx(ue,{name:"stop position",children:a.jsx(de,{...e,node:Object.values(t).filter(n=>bt(n.tag))})})}function kt({children:e}){const[t,n]=h.useState(""),s=(o,r)=>t===""||`${r}-${JSON.stringify(o)}`.includes(t);return a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered flex items-center gap-2 w-full mt-1 mx-auto",children:[a.jsx(M,{icon:yo.faSearch}),a.jsx("input",{type:"text",className:"grow",placeholder:"Search",value:t,onChange:o=>n(o.target.value)})]}),a.jsx("div",{className:"outline-list flex-1 rounded overflow-scroll",children:a.jsx("ul",{className:"menu menu-xs",children:L(e).map(o=>o({filter:s}))})})]})}function Ma(){return a.jsxs(kt,{children:[({filter:e})=>a.jsx(ka,{filter:e}),({filter:e})=>a.jsx(Ea,{filter:e}),({filter:e})=>a.jsx(Ca,{filter:e})]})}const Ra=({left:e,right:t,bottom:n,top:s})=>o=>{const r=({"@_lon":l,"@_lat":c})=>e<=l&&l<=t&&n<=c&&c<=s,i=l=>o.meta.node[l["@_ref"]];return{node:Object.entries(o.meta.node).filter(([,l])=>r(l)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{}),way:Object.entries(o.meta.way).filter(([,l])=>l.nd.map(i).some(r)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{}),relation:Object.entries(o.meta.relation).filter(([,l])=>l.member.filter(c=>c["@_type"]==="node"&&i(c)).map(i).some(r)).reduce((l,c)=>({...l,[c[0]]:c[1]}),{})}};function Ta(e){const t=e.activeRef;return t?{type:t.type,meta:e.meta[t.type][t.id]}:null}const lt=e=>t=>{const n=t.selectedRef;return n.length?n.filter(s=>s.type===e).map(s=>t.meta[e][s.id]):[]};function Aa(e){const t=_(H(Ta));return a.jsx(ue,{name:"active",forceOpen:!0,children:a.jsx(de,{...e,node:(t==null?void 0:t.type)==="node"?[t.meta]:void 0,way:(t==null?void 0:t.type)==="way"?[t.meta]:void 0,relation:(t==null?void 0:t.type)==="relation"?[t.meta]:void 0,showMetaType:!0})})}function Pa(e){const t=_(H(lt("node"))),n=_(H(lt("way"))),s=_(H(lt("relation"))),o=_(i=>i.selectFeature),r=h.useCallback(({type:i,meta:l})=>a.jsx("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Active",onClick:async c=>{c.stopPropagation(),console.debug("activating: ",i,l["@_id"]),o(i,l["@_id"],!1)},children:a.jsx(M,{icon:wo.faStarOfLife})}),[o]);return a.jsx(ue,{name:"selected",defaultOpen:!0,children:a.jsx(de,{...e,node:t,way:n,relation:s,showMetaType:!0,children:r})})}function Ia(){return a.jsxs(kt,{children:[({filter:e})=>a.jsx(Aa,{filter:e}),({filter:e})=>a.jsx(Pa,{filter:e})]})}class Da extends Z{constructor(n,s){super(n);R(this,"idle");R(this,"mousedown");R(this,"draging");this.idle=new W("select-idle"),this.mousedown=new W("select-mousedown"),this.draging=new W("select-dragging"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mousedown,{transform:o=>{const r=this.context,i=o;return o.type==="mousedown"&&o.shiftKey?(console.debug("BatchSelectStateMachine: transition from idle to mousedown"),r.from=pe(i.clientX,i.clientY,r),!0):!1}}),this.mousedown.appendNext(this.idle,{transform:o=>{const r=this.context;return["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)?(console.debug("BatchSelectStateMachine: transition from mousedown to idle"),r.from=void 0,!0):!1}}),this.mousedown.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: start dragging");const{clientX:i,clientY:l}=o;return K.getState().setSelectionRect({from:r.from,to:pe(i,l,r)}),!0}return!1}}),this.draging.appendNext(this.idle,{transform:o=>{if(["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(o.type)){if(console.debug("BatchSelectStateMachine: drag canceled, back to idle"),K.getState().setSelectionRect(),s!=null&&s.onSelectRect){const{clientX:r,clientY:i}=o;s.onSelectRect({from:this.context.from,to:pe(r,i,this.context)},o)}return this.context.from=void 0,!0}return!1}}),this.draging.appendNext(this.draging,{transform:o=>{const r=this.context;if(o.type==="pointermove"){console.debug("BatchSelectStateMachine: continue dragging");const{clientX:i,clientY:l}=o;return K.getState().setSelectionRect({from:r.from,to:pe(i,l,r)}),!0}return!1}})}}class Ct extends Z{constructor(n,{onRightClick:s,onLeftClick:o,onHoverExit:r,onHoverStart:i,hoverable:l,clickable:c,dragable:d,selectable:f}){super(n);R(this,"idle");R(this,"componentHover");R(this,"componentMousedown");R(this,"pointDrag");this.idle=new W("pt-bus-component-idle"),this.componentHover=new W("pt-bus-component-hover"),this.componentMousedown=new W("pt-bus-component-mousedown"),this.pointDrag=new W("pt-bus-component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:u=>{const p=this.context;if(["pointerover","pointerenter"].includes(u.type)&&"componentTarget"in u&&u.componentTarget&&l(u.componentTarget,this.context)){p.componentTarget=u.componentTarget;const{id:x,type:w}=p.componentTarget;console.log("BusComponentStateMachine: component hover triggered",w,x);const{modifyFeatureStateNC:g}=p.store.meta.getState();return g(w,x,m=>m.hovered=!0),i&&i(p.componentTarget,u),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:u=>{const p=this.context;if(u.type==="mousedown"&&p.componentTarget&&c(p.componentTarget,p)){console.log("BusComponentStateMachine: transition to "+this.componentMousedown.name);const{id:x,type:w}=p.componentTarget,{modifyFeatureStateNC:g}=p.store.meta.getState();return g(w,x,m=>m.hovered=!1),r&&r(p.componentTarget,u),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:u=>{const p=this.context;if(["pointerleave","pointerout"].includes(u.type)&&p.componentTarget){console.log("BusComponentStateMachine: transition to idle");const{id:x,type:w}=p.componentTarget,{modifyFeatureStateNC:g}=p.store.meta.getState();return g(w,x,m=>m.hovered=!1),r&&r(p.componentTarget,u),p.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:u=>{var x;const p=this.context;if(u.type==="pointermove"&&((x=p.componentTarget)==null?void 0:x.type)==="node"&&d(p.componentTarget,p)){console.log("BusComponentStateMachine: start dragging");const{clientX:w,clientY:g}=u,{commit:m}=p.store.meta.getState();return m(),Pe(w,g,p),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:u=>{const p=this.context;if((u.type==="mouseup"||u.type==="mouseupoutside")&&p.componentTarget){if(u.button===be.RIGHT&&s?s(p.componentTarget,u):u.button===be.LEFT&&o&&o(p.componentTarget,u),f(p.componentTarget,p)){const{selectFeature:x}=p.store.meta.getState(),{id:w,type:g}=p.componentTarget;if(typeof w=="string")x(g,w,!u.shiftKey),console.log("selected id",w,p.store.meta.getState().selectFeature);else throw new Error(`id ${w} is invalid for component`)}return p.componentTarget=void 0,!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:u=>u.type==="mouseupoutside"||u.type==="mouseup"?(console.log("BusComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0):!1}),this.pointDrag.appendNext(this.pointDrag,{transform:u=>{if(u.type==="pointermove"){const{clientX:p,clientY:x}=u;return Pe(p,x,this.context),!0}return!1}})}}class La extends Z{constructor(n,s){super(n);R(this,"idle");R(this,"mapViewSubMachine");R(this,"busStopEditSubMachine");R(this,"undoRedo");R(this,"batchSelect");R(this,"menus");this.menus=s;const o=c=>c.type==="way"||c.type==="node",r=c=>c.type==="way"||c.type==="node",i=(c,d)=>{const f=d.store.meta.getState().meta[c.type][c.id].tag||[];return c.type==="node"&&(we(f)||bt(f))},l=c=>c.type==="node";this.idle=new W("pt-edit-idle"),this.mapViewSubMachine=new Ue(n,{rightClickHandeler:c=>{this.menus.busStop({...pe(c.clientX,c.clientY,this.context),open:!0}),this.menus.stopPosition({x:0,y:0,open:!1})}}),this.busStopEditSubMachine=new Ct(n,{onRightClick:(c,d)=>{this.menus.stopPosition({...pe(d.clientX,d.clientY,this.context),feature:c,open:!0})},hoverable:o,clickable:r,dragable:i,selectable:l}),this.undoRedo=new Ve(n),this.batchSelect=new Da(n,{onSelectRect:(c,d)=>{const{viewpoint:f,zoom:u,width:p,height:x}=this.context.store.view.getState(),w=Vo(f,u,p,x,c),g=this.context.store.meta.getState(),m=Ra(w)(g);console.debug("get feature group ",m),d.ctrlKey||g.clearSelect(),Object.entries(m.node).filter(([,b])=>l({id:b["@_id"],type:"node"},this.context)).forEach(([,b])=>g.selectFeature("node",b["@_id"],!1))}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}transform(n){n.type==="mousedown"&&(this.menus.busStop({x:0,y:0,open:!1}),this.menus.stopPosition({x:0,y:0,open:!1})),super.transform(n)}}function Fa({type:e,id:t,showMetaType:n,children:s}){const o=_(H(i=>i.meta[e][t])),r=h.useMemo(()=>{var i;if(n&&((i=o==null?void 0:o.tag)!=null&&i.length)){if(e==="node")return Xe(o.tag);if(e==="relation")return Ye(o.tag)}},[n,o==null?void 0:o.tag,e]);return a.jsx("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:a.jsx(re,{featuretype:e,id:t,metatype:r,fullname:ee(o.tag),created:Number(o["@_id"])<0,deleted:o["@_action"]==="delete",modified:o["@_action"]==="modify",children:s&&s({type:e,id:t})})})}function Oa({onDelete:e,member:t,memberToId:n,...s}){const o=h.useRef(1),r=h.useCallback(()=>o.current++,[o]),i=h.useMemo(()=>t.map(d=>({...d,uniqueIdentifier:r()})),[r,t]),l=h.useCallback(d=>`${n(d)}_AT_LIST_${d.uniqueIdentifier}`,[n]),c=h.useCallback(({selected:d,children:f})=>a.jsxs("div",{className:"flex flex-row p-1 rounded",children:[a.jsx("div",{className:"mr-auto",children:"Members"}),a.jsx("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:u=>{u.stopPropagation();const p=i.filter(x=>!d.has(l(x)));e(i,p)},children:a.jsx(M,{icon:Zt.faDeleteLeft})}),f]}),[i,l,e]);return a.jsx(Cn,{...s,member:i,memberToId:l,slotSelection:c})}const Ba=h.memo(({initialValue:e,onCommit:t,onFocus:n,onBlur:s})=>{const[o,r]=h.useState(e||"");return h.useEffect(()=>{r(e||"")},[e]),a.jsx("input",{className:"grow",type:"text",placeholder:"role of member",value:o,onChange:i=>r(i.target.value),onKeyDown:i=>{i.key==="Enter"&&i.currentTarget.blur()},onBlur:i=>{s&&s(i),t(o)},onFocus:n})});function Ha({preset:e,existing:t,title:n,onSubmit:s,open:o,onClose:r,createMembers:i}){const[l,c]=h.useState({});h.useEffect(()=>{c(()=>e.tag.reduce((j,A)=>(t!=null&&t.some(O=>A["@_k"]===O["@_k"])||(j[A["@_k"]]=A["@_v"]||""),j),{}))},[t,e]);const d=h.useMemo(()=>e.tag.filter(j=>!(t!=null&&t.some(A=>j["@_k"]===A["@_k"]))),[e,t]),[f,u]=h.useState((t==null?void 0:t.map(j=>({key:j["@_k"],value:j["@_v"]})))||[]),[p,x]=h.useState("");h.useEffect(()=>{const j=document.getElementById("create-node-modal");o?j==null||j.showModal():j==null||j.close()},[o]);const w=(j,A)=>{c(O=>({...O,[j]:A}))},g=h.useCallback(()=>{p.trim()!==""&&(u(j=>[...j,{key:p.trim(),value:""}]),x(""))},[p]),m=(j,A)=>{u(O=>O.map(($,q)=>q===j?{...$,value:A}:$))},b=j=>{u(A=>A.filter((O,$)=>$!==j))},y=h.useMemo(()=>a.jsxs(a.Fragment,{children:[t&&a.jsx("div",{className:"divider",children:"Needed preset tags"}),d.map(j=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1 tooltip tooltip-top","data-tip":j.description||"",children:[a.jsxs("span",{className:"font-semibold",children:[j["@_k"]," ",j.importance==="required"&&a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:j.example||"Enter value",value:l[j["@_k"]],onChange:A=>w(j["@_k"],A.target.value),required:j.importance==="required",disabled:j.importance==="not-recommened",className:"grow"}),a.jsx("span",{className:"badge",children:j.importance})]},j["@_k"])),a.jsx("div",{className:"divider",children:t?"Exsisting or created tags":"Created tags"}),f.map((j,A)=>a.jsxs("label",{className:"input input-bordered input-sm flex items-center gap-x-1",children:[a.jsxs("span",{className:"font-semibold",children:[j.key," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",placeholder:"Enter value",value:j.value,onChange:O=>m(A,O.target.value),required:!0,className:"grow"}),!t&&a.jsx("span",{className:"badge",children:"created"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-error",onClick:()=>b(A),children:a.jsx(M,{icon:Kt})})]},j.key)),a.jsxs("label",{className:"input input-sm input-bordered flex items-center gap-2",children:[a.jsx("input",{type:"text",placeholder:"New tag key",value:p,onChange:j=>x(j.target.value),onKeyDown:j=>{j.key==="Enter"&&(j.preventDefault(),g())},className:"grow"}),a.jsx("button",{type:"button",className:"btn btn-xs btn-outline",onClick:g,children:"+ add tag"})]})]}),[g,t,d,p,f,l]),[k,v]=h.useState([]),[C,I]=h.useState(void 0),N=h.useCallback((j,A,O)=>{console.log("edit",j,A,O),v($=>$.map(q=>{if(q["@_type"]===j&&q["@_ref"]===A){const se=le(q);return se["@_role"]=O,se}return q}))},[]),E=h.useCallback(j=>`${j["@_type"]}-${j["@_ref"]}`,[]),U=h.useCallback(({member:j,children:A})=>a.jsx(Fa,{id:j["@_ref"],type:j["@_type"],children:()=>{const O=(C==null?void 0:C.id)===j["@_ref"]&&C.type===j["@_type"];return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:J("btn btn-square btn-xs tooltip tooltip-bottom",O&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:$=>{$.stopPropagation(),I(O?void 0:{id:j["@_ref"],type:j["@_type"]})},children:a.jsx(M,{icon:O?mt:ft.faCircle})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(Ba,{initialValue:j["@_role"],onCommit:$=>N(j["@_type"],j["@_ref"],$)})]}),A]})}}),[N,C]);function D(){}function S(j){v(()=>j)}function T(j){v(()=>j)}const P=j=>j.map(A=>({"@_ref":A.id,"@_type":A.type})),F=h.useCallback(j=>{console.log("Insert at Top: ",j),v(A=>[...P(j),...A])},[]),X=h.useCallback(j=>{console.log("Insert at Bottom: ",j),v(A=>[...A,...P(j)])},[]),z=h.useCallback(j=>{console.log("Insert at Active: ",j),C?v(A=>{const O=[...A],$=O.findIndex(q=>q["@_ref"]===C.id&&q["@_type"]===C.type);return O.splice($+1,0,...P(j)),O}):X(j)},[X,C]),Q=h.useMemo(()=>i?a.jsxs("div",{className:"flex flex-row",children:[a.jsx("div",{className:"bg-base-200",children:a.jsx(Oa,{member:k,memberToId:E,onDragStart:D,onDragEnd:S,onDelete:(j,A)=>T(A),children:U})}),a.jsx("div",{className:"",children:a.jsx(Nt,{handelInsertTop:F,handelIntertBottom:X,handelInsertAtActive:z})})]}):null,[i,z,X,F,k,U,E]),B=j=>{j.preventDefault();const A=Object.entries(l).filter(([,$])=>$.length).map(([$,q])=>({"@_k":$,"@_v":q})),O=f.map($=>({"@_k":$.key,"@_v":$.value}));s({tag:[...A,...O],member:k}),u([]),x(""),r()};return a.jsx(a.Fragment,{children:a.jsxs("dialog",{id:"create-node-modal",className:"modal",onClose:r,children:[a.jsxs("div",{className:"modal-box w-11/12 max-w-5xl",children:[a.jsx("h3",{className:"font-bold text-lg mb-2",children:n}),a.jsxs("form",{onSubmit:B,className:"space-y-2",children:[y,Q,a.jsxs("div",{className:"modal-action",children:[a.jsx("button",{type:"button",className:"btn",onClick:()=>r(),children:"Cancel"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Submit"})]})]})]}),a.jsx("form",{method:"dialog",className:"modal-backdrop",children:a.jsx("button",{children:"close"})})]})})}function $a({show:e,proceed:t,...n}){return a.jsx(Ha,{open:e,...n,onClose:()=>t(null),onSubmit:t})}const Wa=e=>a.jsx($a,{...e}),et=fe.confirmable(Wa);et.displayName="CreateFeatureTagConform";const Ua={tag:[{"@_k":"highway","@_v":"bus_stop",importance:"required",description:"å°è¯¥å¤å®ä¹ä¸ºå¬äº¤ç«ç¹ãæå¸¸ç¨çæ ç­¾ã",example:"bus_stop"},{"@_k":"public_transport","@_v":"platform",importance:"required",description:"ç¨äºæè¿°è¯¥åè½æ¯ä¸ä¸ªå¬å±äº¤éæå°ï¼æå¡äºå¬å±äº¤éè·¯çº¿ãç¨äºç¬¦åptv2çæ ç­¾ã",example:"platform"},{"@_k":"name",importance:"required",description:"å¬äº¤ç«ç¹çåç§°ã",example:"æµ·å£è·¯æµ·æ¸¸è·¯"},{"@_k":"name:zh",importance:"recommened",description:"å¬äº¤ç«ç¹çåç§°ã(ä¸­æ)",example:"æµ·å£è·¯æµ·æ¸¸è·¯"},{"@_k":"bus",importance:"required",description:"å¨ptv2ä¸­æ³¨æè¿ä¸ªç«ç¹ä¸ºå¬äº¤ç«ç¹ã",example:"yes"},{"@_k":"ref",importance:"optional",description:"å¬äº¤ç«ç¹çåèä»£ç ãï¼å¸¸ç¨äºåé¨å®ä½åç»´æ¤ï¼",example:"ref=3154"},{"@_k":"local_ref",importance:"recommened",description:"å¬äº¤ç«ç¹çåèä»£ç ãå¦æå¬äº¤ç«å°æå¤§éå¬äº¤è½¦åé ï¼æ¯ä¸ªå°ç«ç¹å¯æç¬ç« local_refã",example:"16"},{"@_k":"network",importance:"not-recommened",description:"å¬äº¤ç«ç¹çç½ç»ãå¯ä½¿ç¨å¨ç§°æç¼©åï¼ä¾æ®éè¿çº¿è·¯æ æ³¨æåµç¡®å®ã",example:"å¤ç°å¬äº¤"},{"@_k":"operator",importance:"not-recommened",description:"å¨å¬äº¤ç«ç¹åé çå¬äº¤è½¦çè¿è¥å¬å¸åç§°ãè¥å¤å®¶è¿è¥ï¼ä½¿ç¨åå·ï¼;ï¼åéã",example:"æµé³èè¾¾å¬å±äº¤éæéå¬å¸"},{"@_k":"shelter",importance:"recommened",description:"è¥å¬äº¤ç«ç¹æä¾åè½¦äº­åä¸ºâyesâï¼å¦åä¸ºânoâã",example:"no"},{"@_k":"departures_board",importance:"recommened",description:"è¡¨æå¬äº¤ç«ç¹ä½¿ç¨çå°ç«æ¾ç¤ºå±/çç±»åãå¼å¯ä¸ºçº¸è´¨æ¶å»è¡¨ãå®æ¶æ¾ç¤ºç­ï¼departures_board=no è¡¨ç¤ºæ æ¾ç¤ºå±/çã",example:"timetable"},{"@_k":"bench",importance:"recommened",description:"è¥å¬äº¤ç«ç¹æä¾é¿å³åä¸ºâyesâï¼å¦åä¸ºânoâã",example:"yes"},{"@_k":"bin",importance:"recommened",description:"è¥å¬äº¤ç«ç¹å·å¤åå¾ç®±åä¸ºâyesâï¼å¦åä¸ºânoâã",example:"no"},{"@_k":"tactile_paving",importance:"recommened",description:"è¥å¬äº¤ç«ç¹è®¾æè§éå¼å¯¼è®¾æ½ï¼æç¤ºè§éäººå£«æå°è¾¹ç¼ï¼åä¸ºâyesâï¼å¦åä¸ºânoâã",example:"no"},{"@_k":"layer",importance:"optional",description:"éç¨äºå¤å±å¬äº¤ç«å°ãå¯¹äºéå°é¢å¬äº¤ç«ç¹ï¼å¤å±ä¿¡æ¯æ¯å¿éçä»¥é¿åçé®ã",example:"-1"},{"@_k":"lit",importance:"recommened",description:"è¥å¬äº¤ç«ç¹å¤é´äº®ç¯åä¸ºâyesâï¼å¦åä¸ºânoâã",example:"yes"},{"@_k":"surface",importance:"recommened",description:"æè¿°å¬äº¤è½¦ç«æå¨çå°é¢ã",example:"concrete"}]},$t={tag:[{"@_k":"public_transport","@_v":"stop_position",importance:"required",description:"ç¨äºæè¿°è¯¥åè½æ¯ä¸ä¸ªå¬å±äº¤éåè½¦ç¹ãæ¬æ ç­¾æ¯ç¨äºç¬¦åptv2çæ ç­¾ã",example:"stop_position"},{"@_k":"name",importance:"required",description:"å¬äº¤ç«ç¹çåç§°ãå·ä½æè¿°è§ä¸æè¡¥åè¯´æã",example:"é£ç¨èå¸åº"},{"@_k":"name:zh",importance:"recommened",description:"å¬äº¤ç«ç¹çåç§°(ä¸­æ)ãå·ä½æè¿°è§ä¸æè¡¥åè¯´æã",example:"é£ç¨èå¸åº"},{"@_k":"bus",importance:"required",description:"å¨ptv2ä¸­æ³¨æè¿ä¸ªç«ç¹ä¸ºå¬äº¤ç«ç¹",example:"yes"}]},Va={tag:[{"@_k":"public_transport","@_v":"stop_area",importance:"required",description:"ç¨äºæè¿°è¯¥åè½æ¯ä¸ä¸ªåè½¦åºå³ç³»ãæ¬æ ç­¾æ¯ç¨äºç¬¦åptv2çæ ç­¾ã",example:"stop_position"},{"@_k":"name",importance:"required",description:"è¯¥ç«ç»çåç§°ï¼ä½¿ç¨ä¸»åç§°ææ¨å¹¿åç§°ï¼å³æååä¸ä½ç½®çåååç«å°åå¹¶äºæ­¤å³ç³»ä¸­",example:"ç»åè·¯èèè·¯"},{"@_k":"name:zh",importance:"recommened",description:"è¯¥ç«ç»çåç§°(ä¸­æ)ï¼ä½¿ç¨ä¸»åç§°ææ¨å¹¿åç§°ï¼å³æååä¸ä½ç½®çåååç«å°åå¹¶äºæ­¤å³ç³»ä¸­",example:"ç»åè·¯èèè·¯"},{"@_k":"type",importance:"required",description:"","@_v":"public_transport"}]},qa={tag:[{"@_k":"type","@_v":"route",importance:"required",description:"å°è¯¥å³ç³»å®ä¹ä¸ºä¸æ¡çº¿è·¯ã",example:"route"},{"@_k":"route",importance:"required",description:"å°è¯¥å³ç³»çº¿è·¯è®¾ä¸ºä¸æ¡å¬äº¤/æè½¨çµè½¦çº¿è·¯ã(bus/trolleybus)",example:"bus"},{"@_k":"ref","@_v":"*",importance:"required",description:"çº¿è·¯ç¼å·ï¼å»ºè®®ä½¿ç¨çµæ¾ãç«çæå¬äº¤å®ç½ç»åºçåç§°ï¼å»ºè®®å¨åä¸åå¸åï¼åºå¿å¬äº¤å¨åç¼ä¸­ä½ç°åºå¿åç§°ï¼å¦ï¼ç« ä¸4ï¼æªæ³¨æï¼ãçª1ï¼å·²æ³¨æ",example:"çª1"},{"@_k":"public_transport:version","@_v":"2",importance:"recommened",description:"æ­¤æ ç­¾å¯¹ OSM äº¤éæ°æ®çç¨æ·ååæç¨ï¼æ­¤æ ç­¾å¯ä»¥è®©ç¨æ·ç¥éçº¿è·¯æ¯æ ¹æ®æ°ç³»ç» PTv2 æ·»å ãæ­¤æ ç­¾å¯ä½¿åæåéªè¯æ´å å®¹æã",example:"2"},{"@_k":"operator",importance:"recommened",description:"è¥è¿è¯¥çº¿è·¯å¬äº¤å¬å¸æè½¦éçåç§°ãè¯·ä½¿ç¨è§èçä¼ä¸åç§°ï¼è¥å¤å®¶å¬å¸å±åè¿è¥ï¼è¯·å¨ä¸¤å®¶å¬å¸ä¹é´å ä¸â;âã",example:"ä¸æµ·æ¾æ±å¬å±äº¤éæéå¬å¸"},{"@_k":"network",importance:"required",description:"è¯¥çº¿è·¯æå±çç½ç»ï¼ä½¿ç¨è¯¥ç½ç»å³ç³»ç¸åçåç§°",example:"é»æ±å¬äº¤"},{"@_k":"opening_hours",importance:"recommened",description:"å¬äº¤è·¯çº¿çè¿è¥æ¶é´ï¼åå«é¦ç­è½¦åæ«ç­è½¦åè½¦æ¶é´ï¼ç»è®°åºä½¿ç¨è±æä¸¤å­æ¯å¼æææ è®°ï¼å¹¶éç¨24å°æ¶å¶ã",example:"Jan 1-May 31 06:00-21:45; Jun 1-Oct 7 06:00-22:15; Oct 8-Dec 31 06:00-21:45"},{"@_k":"interval",importance:"recommened",description:"å¬äº¤è½¦éå¾ä»»æç«ç¹å°è¾¾æ¶çé´éæ¶é´ï¼ä¹ç§°ä¸ºåè½¦é´éãæ ¼å¼å¯ä¸º HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM æ Mã",example:"00:06:30"},{"@_k":"duration",importance:"recommened",description:"å¬äº¤çº¿è·¯çæç»­æ¶é´ï¼ä»åè½¦å°æµè¾¾ç»ç¹ãæ ¼å¼ä¸º HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM æ Mã",example:"00:31"},{"@_k":"fee",importance:"recommened",description:"å¦æä¹åè¯¥å¬äº¤éæ¯ä»è´¹ç¨åä¸ºâyesâï¼éå¡« charge è¯´æä¹è½¦è´¹ç¨ï¼è¥æ éæ¯ä»è´¹ç¨åä¸ºânoâã",example:"yes+charge=3.00 CNY"},{"@_k":"payment",importance:"recommened",description:"è¯¦ç»åè¡¨è¯·è§ï¼æ¯ä»æ¹å¼ï¼å¸¸ç¨çæ payment:cash, payment:coins, payment:ic, payment:unionpay, payment:city_union, payment:china_t-union, payment:e-cny, payment:alipay, payment:wechat, payment:mipay, payment:samsung_pay, payment:huawei_pay, payment:apple_payã",example:""},{"@_k":"bicycle",importance:"recommened",description:"å¦æè¯¥å¬äº¤åè®¸æºå¸¦èªè¡è½¦ä¹è½¦åä¸ºâyesâã",example:"yes"},{"@_k":"wheelchair",importance:"recommened",description:"å¦æåè®¸ä½¿ç¨è½®æ¤çä¹å®¢ææºå¸¦è½®æ¤çä¹å®¢ä¸è½¦ï¼è¯·æ è®°ä¸º 'yes'ï¼å¦åæ è®°ä¸º 'no'ã",example:"yes"},{"@_k":"from",importance:"required",description:"å¬äº¤è½¦åè½¦æ¹åçä½ç½®åç§°ï¼ä¸ä¸å®æ¯å¬äº¤è½¦ç«çåç§°ã",example:"éå¸¸æ±½æ¸¡"},{"@_k":"via",importance:"optional",description:"å¨ååç¯çº¿æèµ·ç»ç¹åç§°ç¸åççº¿è·¯ä¸­æ³¨æä¸­é´ç«ç¹ã",example:"æ¶å¯è·¯ç»¿åº­å°å"},{"@_k":"to",importance:"required",description:"å¬äº¤çº¿è·¯ç®çå°çåç§°ï¼éå¸¸æ¾ç¤ºå¨å¬äº¤è½¦é¡¶é¨ä½ä¸ºç»å°ç«ã",example:"åå®å"},{"@_k":"name",importance:"required",description:"å»ºè®®ä½¿ç¨æ ¼å¼ï¼<åç¼><ç¼å·>è·¯: <èµ·ç¹ç«> => <ç»ç¹ç«>ï¼è¯¦æåèç¸å³æ åã",example:"K37è·¯: è§£æ¾æ¡¥ä¸ -> éååè·¯å¬äº¤è½¦åº"},{"@_k":"name:zh",importance:"recommened",description:"å»ºè®®ä½¿ç¨æ ¼å¼ï¼<åç¼><ç¼å·>è·¯: <èµ·ç¹ç«> => <ç»ç¹ç«>ï¼è¯¦æåèç¸å³æ åã",example:"K37è·¯: è§£æ¾æ¡¥ä¸ -> éååè·¯å¬äº¤è½¦åº"},{"@_k":"official_name",importance:"optional",description:"ç¨äºæè¿°å®æ¹å°å¾ä¸æç¨å¬äº¤è·¯çº¿çåç§°ãå¤§å¤æ°çº¿è·¯ä»ä¾åèï¼å æ­¤è¯·å¿ä½¿ç¨æ­¤æ è®°ã",example:"è¹æ¡¥æ¢çº½10è·¯åºé´"},{"@_k":"colour",importance:"optional",description:"å®æ¹å°å¾ä¸å¬äº¤çº¿è·¯çé¢è²ï¼ä½¿ç¨åå­è¿å¶æ HTML é¢è²ä»£ç ã",example:"#58912F"},{"@_k":"roundtrip",importance:"optional",description:"æå®å³ç³»æ¯å¦ä¸ºç¯è·¯ãå¯¹äºå¤§å¤æ°çº¿è·¯ï¼è¯¥å¼ä¸º 'no'.",example:"no"},{"@_k":"description",importance:"optional",description:"å¶ä»å³äºè¯¥çº¿è·¯çæªå°½äºå®ï¼å¯ä»¥å¨æ­¤ç¨ä¸­æè¡¨è¿°ï¼å¦ï¼æ¥èæé´çº¿è·¯æåå¨ãæ¬å°å¬äº¤å¡7æä¼æ ",example:"æµåå¬äº¤å·å¡æ åææ£"}]};function Tn({x:e,y:t,open:n,children:s}){return n?a.jsx("ul",{className:"absolute rounded-lg bg-base-100 menu shadow p-0",onMouseDown:o=>o.stopPropagation(),style:{top:t,left:e},children:h.Children.map(s,(o,r)=>h.isValidElement(o)?o.type==="a"?a.jsx("li",{children:o},r):a.jsx("li",{children:a.jsx("a",{children:o})},r):null)}):null}const Xa=h.memo(function(e){const t=K(H(un(e))),n=_(l=>l.createBusStopSel),s=_(l=>l.createStopAreaSel),o=fe.createConfirmation(et),r=async()=>{e.onClose();const l=await o({title:"Create Bus stop (Preset CN)",preset:Ua});l!=null&&l.tag&&(console.debug("created bus stop",l),t&&n(t,l.tag))},i=async()=>{e.onClose();const l=await o({title:"Create Stop Area (Preset CN)",preset:Va,createMembers:!0});l!=null&&l.tag&&s(l.tag,l.member)};return a.jsxs(Tn,{...e,children:[a.jsx("a",{onClick:r,children:"New bus stop"}),a.jsx("a",{onClick:i,children:"New stop area relation"})]})}),Ka=h.memo(function(e){var l,c;const t=K(H(un(e))),n=_(d=>d.createStopPositionSel),s=_(d=>d.modifyFeatureMetaNC),o=fe.createConfirmation(et),r=async()=>{var f;e.onClose();const d=await o({preset:$t,title:"Create Stop position (Preset CN)"});d!=null&&d.tag&&t&&((f=e.feature)!=null&&f.id)&&n(t,d.tag,e.feature.id)},i=async()=>{var f;if(e.onClose(),!((f=e.feature)!=null&&f.id))return;const d=await o({preset:$t,existing:_.getState().meta.node[e.feature.id].tag,title:"Add tags to existing point (Stop position preset CN)"});d!=null&&d.tag&&s("node",e.feature.id,u=>{u.tag=d.tag})};return a.jsx(Tn,{...e,children:((l=e.feature)==null?void 0:l.type)==="way"?a.jsx("a",{onClick:r,children:"New stop position"}):((c=e.feature)==null?void 0:c.type)==="node"?a.jsx("a",{onClick:i,children:"Set point as stop position"}):a.jsx("a",{children:"relation is not allowed here"})})}),za=({width:e,height:t})=>{const[n,s]=h.useState({x:0,y:0,open:!1}),[o,r]=h.useState({x:0,y:0,open:!1}),i=h.useRef(new La({meta:_,view:K,settings:ne},{busStop:s,stopPosition:r})).current;return h.useEffect(()=>{const l=c=>i.transform(c);return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[i]),a.jsxs("div",{className:"relative",style:{width:e,height:t},children:[a.jsxs(Ze,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:l=>i.transform(l),onPointerMove:l=>i.transform(l),onMouseUp:l=>i.transform(l),onWheel:l=>i.transform(l),children:[a.jsx(qe,{width:e,height:t}),a.jsx(Ke,{width:e,height:t,stateMachine:i})]}),a.jsx(Qe,{width:e}),a.jsx(Xa,{...n,onClose:()=>s({x:0,y:0,open:!1})}),a.jsx(Ka,{...o,onClose:()=>r({x:0,y:0,open:!1})})]})};class Ga extends Z{constructor(n){super(n);R(this,"idle");R(this,"mapViewSubMachine");R(this,"busStopEditSubMachine");R(this,"undoRedo");const s=l=>l.type==="node",o=l=>l.type==="node",r=()=>!1,i=()=>!1;this.idle=new W("pt-edit-idle"),this.mapViewSubMachine=new Ue(n),this.busStopEditSubMachine=new Ct(n,{onRightClick:l=>{const{routeEdit:c,setRouteStop:d}=_.getState(),f=u=>u["@_ref"]===l.id&&u["@_type"]===l.type;c.stops.some(f)?d(c.stops.filter(u=>!f(u))):d([...c.stops,{"@_ref":l.id,"@_type":l.type}])},onLeftClick:l=>{const{toggleFeature:c}=_.getState();c(l.type,l.id,!0)},hoverable:s,clickable:o,dragable:r,selectable:i}),this.undoRedo=new Ve(n),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0})}transform(n){super.transform(n)}}class Ya extends Z{constructor(n){super(n);R(this,"manualAddPathMode");R(this,"mpView");R(this,"mpComponent");R(this,"mpUndoRedo");this.manualAddPathMode=new W("path-add-manual-mode"),this.entry=this.manualAddPathMode,this.current=this.manualAddPathMode,this.accept=[this.manualAddPathMode];const s=l=>l.type==="way",o=l=>l.type==="way",r=()=>!1,i=()=>!1;this.mpView=new Ue(n),this.mpComponent=new Ct(n,{onRightClick:l=>{console.debug(`Add path: right click at ${l}`);const{routeEdit:c,setRoutePath:d}=_.getState(),f=u=>u["@_ref"]===l.id&&u["@_type"]===l.type;c.path.some(f)?d(c.path.filter(u=>!f(u))):d([...c.path,{"@_ref":l.id,"@_type":l.type}])},onLeftClick:l=>{const{toggleFeature:c}=_.getState();c(l.type,l.id,!0)},hoverable:s,clickable:o,dragable:r,selectable:i}),this.mpUndoRedo=new Ve(n),this.manualAddPathMode.appendNext(this.mpComponent,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpView,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpUndoRedo,{isEpsilon:!0}),this.mpView.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpComponent.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpUndoRedo.appendNext(this.manualAddPathMode,{isEpsilon:!0})}transform(n){super.transform(n)}}const ve=72,Ja=()=>{const e=_(c=>c.createEditRoute),t=_(c=>c.setEditRoute),n=_(c=>c.cancelEditRoute),s=_(c=>c.routeEdit.editing),o=_(c=>c.meta.relation)||{},r=fe.createConfirmation(et),i=async()=>{const c=await r({title:"Create Bus stop (Preset CN)",preset:qa});c!=null&&c.tag&&(console.debug("created route",c),e([{"@_k":"type","@_v":"bus_route"}],[]))},l=c=>{t(c)};if(s){const c=o[s],d=ee(c.tag)||"[no name]";return a.jsxs("div",{className:"bg-base-100 max-w-xl h-full mx-auto py-4",children:["Selected Route:",a.jsx("div",{className:"flex flex-row gap-2 text-base items-center",children:a.jsx(re,{featuretype:"relation",fullname:d,id:c["@_id"],created:Number(c["@_id"])<0,modified:c["@_action"]==="modify",deleted:c["@_action"]==="delete",children:a.jsx("button",{onClick:n,className:"btn btn-error btn-square btn-sm",children:a.jsx(M,{icon:_o})})})}),"Please jump to step 2"]})}return a.jsx("div",{className:"bg-base-100 max-w-xl h-full mx-auto",children:a.jsxs("div",{className:"card-body",children:[a.jsx("h2",{className:"card-title text-lg mb-4",children:"Create or Select Route"}),a.jsxs("button",{className:"btn btn-primary w-full mb-6",onClick:i,children:["Create New Route",a.jsx(M,{icon:ct,className:"h-5 w-5 ml-2"})]}),a.jsx("div",{className:"divider mb-4",children:"OR"}),a.jsxs("div",{className:"space-y-4",children:[a.jsx("h3",{className:"font-medium text-base",children:"Existing Routes"}),Object.keys(o).length===0?a.jsxs("div",{className:"alert alert-info",children:[a.jsx(M,{icon:jo,className:"stroke-current shrink-0 h-6 w-6"}),a.jsx("span",{children:"No routes available"})]}):a.jsx("div",{className:"h-full overflow-y-auto",children:Object.values(o).filter(c=>jt(c.tag)).map(c=>{const d=ee(c.tag)||"[no name]";return a.jsx("div",{className:"flex items-center px-4 py-2 gap-2 text-sm bg-white rounded hover:bg-base-300",children:a.jsx(re,{featuretype:"relation",fullname:d,id:c["@_id"],created:Number(c["@_id"])<0,modified:c["@_action"]==="modify",deleted:c["@_action"]==="delete",children:a.jsx("button",{onClick:()=>l(c["@_id"]),className:"btn btn-primary btn-square btn-sm",children:a.jsx(M,{icon:ct})})})},c["@_id"])})})]})]})})},Za=()=>{const{stops:e}=_(n=>n.routeEdit),t=_(n=>n.modifyFeatureStateBatchNC);return h.useEffect(()=>{const n=_.getState().meta,s=e.filter(r=>n[r["@_type"]][r["@_ref"]]),o=s.map(r=>({type:r["@_type"],id:r["@_ref"],modify:i=>{i.highlighted=!0}}));return t(o),()=>{const r=s.map(i=>({type:i["@_type"],id:i["@_ref"],modify:l=>{l.highlighted=!1}}));t(r)}},[t,e]),null},Qa=()=>{const[e,t]=h.useState(!0),{stops:n}=_(i=>i.routeEdit),s=_(i=>i.setRouteStop),o=h.useCallback((i,l,c)=>{console.debug("edit",i,l,c),s(n.map(d=>{if(d["@_type"]===i&&d["@_ref"]===l){const f=le(d);return f["@_role"]=c,f}return d}))},[s,n]),r=h.useCallback(({member:i,children:l})=>a.jsx(ie,{id:i["@_ref"],type:i["@_type"],children:()=>a.jsxs(a.Fragment,{children:[a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(vt,{initialValue:i["@_role"],onCommit:c=>o(i["@_type"],i["@_ref"],c)})]}),l]})}),[o]);return a.jsxs("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{children:"Bus stops members (click to show/hide)"}),a.jsx("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:a.jsx(M,{icon:e?en.faChevronUp:ht.faChevronDown,className:"w-4 h-4"})})]}),e&&a.jsx(Je,{member:n,memberToId:i=>`${i["@_type"]}-${i["@_ref"]}`,onDelete:(i,l)=>s(l),onDragStart:()=>{},onDragEnd:i=>s(i),children:r}),a.jsx(Za,{})]})},er=()=>{const{path:e}=_(n=>n.routeEdit),t=_(n=>n.modifyFeatureStateBatchNC);return h.useEffect(()=>{const n=_.getState().meta,s=e.filter(r=>n[r["@_type"]][r["@_ref"]]),o=s.map(r=>({type:r["@_type"],id:r["@_ref"],modify:i=>{i.highlighted=!0}}));return t(o),()=>{const r=s.map(i=>({type:i["@_type"],id:i["@_ref"],modify:l=>{l.highlighted=!1}}));t(r)}},[t,e]),null},tr=()=>{const[e,t]=h.useState(!0),{path:n}=_(i=>i.routeEdit),s=_(i=>i.setRoutePath),o=h.useCallback((i,l,c)=>{console.debug("edit",i,l,c),s(n.map(d=>{if(d["@_type"]===i&&d["@_ref"]===l){const f=le(d);return f["@_role"]=c,f}return d}))},[s,n]),r=h.useCallback(({member:i,children:l,index:c,overlay:d})=>a.jsx(ie,{id:i["@_ref"],type:i["@_type"],children:()=>a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-3",children:!d&&a.jsx(En,{member:n,index:c})}),a.jsxs("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",a.jsx(vt,{initialValue:i["@_role"],onCommit:f=>o(i["@_type"],i["@_ref"],f)})]}),l]})}),[o,n]);return a.jsxs("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{children:"Path members (click to show/hide)"}),a.jsx("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:a.jsx(M,{icon:e?en.faChevronUp:ht.faChevronDown,className:"w-4 h-4"})})]}),e&&a.jsx(Je,{member:n,memberToId:i=>`${i["@_type"]}-${i["@_ref"]}`,onDelete:(i,l)=>s(l),onDragStart:()=>{},onDragEnd:i=>s(i),children:r}),a.jsx(er,{})]})},nr=({width:e,height:t})=>{const n=h.useRef(new Ga({meta:_,view:K,settings:ne}));return h.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(Ze,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>n.current.transform(s),onPointerMove:s=>n.current.transform(s),onMouseUp:s=>n.current.transform(s),onWheel:s=>n.current.transform(s),children:[a.jsx(qe,{width:e,height:t}),a.jsx(Ke,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Qe,{width:e}),a.jsx(Qa,{})]})},or=({width:e,height:t})=>{const n=h.useRef(new Ya({meta:_,view:K,settings:ne}));return h.useEffect(()=>{const s=o=>n.current.transform(o);return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]),a.jsxs(a.Fragment,{children:[a.jsxs(Ze,{width:e,height:t,options:{background:"#1099bb"},onMouseDown:s=>n.current.transform(s),onPointerMove:s=>n.current.transform(s),onMouseUp:s=>n.current.transform(s),onWheel:s=>n.current.transform(s),children:[a.jsx(qe,{width:e,height:t}),a.jsx(Ke,{width:e,height:t,stateMachine:n.current})]}),a.jsx(Qe,{width:e}),a.jsx(tr,{})]})},sr=()=>{const{editing:e,stops:t,path:n}=_(u=>u.routeEdit),s=_(u=>u.saveEditRoute),o=_(u=>u.modifyFeatureMetaNC),r=_(u=>u.setEditStepNC),i=_(u=>e&&u.meta.relation[e]),[l,c]=h.useState((i==null?void 0:i.tag)||[]),{undo:d}=_.temporal.getState(),f=()=>{s()};return e?a.jsxs("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[a.jsx("h2",{className:"text-lg font-bold mb-4",children:"Finalize Route Edits"}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h3",{className:"font-medium mb-2",children:"Route Tags"}),a.jsx(Ge,{tags:l,setTags:c,commitChange:()=>o("relation",e,u=>u.tag=l)})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h3",{className:"font-medium mb-2",children:"Route Members"}),a.jsxs("div",{className:"bg-base-200 p-2 rounded text-xs",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Stops"}),t.map((u,p)=>a.jsx(ie,{id:u["@_ref"],type:u["@_type"],showMetaType:!0},`${u["@_type"]}-${u["@_ref"]}-${p}`))]}),a.jsxs("div",{className:"",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Path"}),n.map((u,p)=>a.jsx(ie,{id:u["@_ref"],type:u["@_type"],showMetaType:!0},`${u["@_type"]}-${u["@_ref"]}-${p}`))]})]})]}),a.jsx("div",{className:"flex gap-2 justify-end",children:a.jsx("button",{onClick:f,className:"btn btn-primary",children:"Save Changes"})})]}):a.jsxs("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[a.jsx("div",{className:"alert alert-success mb-4 mx-auto",children:a.jsx("span",{children:"â Changes have been saved"})}),a.jsxs("div",{className:"flex gap-2 justify-end",children:[a.jsx("button",{onClick:()=>d(),className:"btn btn-primary",children:"Undo"}),a.jsx("button",{onClick:()=>r(0),className:"btn btn-primary",children:"Proceed"})]})]})},ar=({width:e,height:t})=>{const{step:n,editing:s}=_(l=>l.routeEdit),o=_(l=>l.setEditStepNC),r=l=>{o(s?l:0)},i=h.useMemo(()=>[{label:"Create or select route",component:a.jsx(Ja,{})},{label:"Add bus stops",component:a.jsx(nr,{width:e,height:t-ve})},{label:"Edit route path",component:a.jsx(or,{width:e,height:t-ve})},{label:"Save changes",component:a.jsx(sr,{})}],[e,t]);return a.jsxs("div",{style:{width:e,height:t},children:[a.jsx("div",{className:"relative",style:{width:e,height:t-ve},children:i[n].component}),a.jsx("div",{style:{width:e,height:ve},children:a.jsx("div",{className:"absolute bottom-0 left-0 right-0 flex flex-row pt-[8px] bg-base-200",children:a.jsx("ul",{className:"steps steps-horizontal mx-auto",children:i.map(({label:l},c)=>a.jsx("li",{onClick:()=>r(c),className:J("step cursor-pointer",c<=n?"step-primary":"",!s&&"disabled"),children:l},c))})})})]})};function rr(e){const t=_(n=>n.meta.relation);return a.jsx(ue,{name:"route",children:a.jsx(de,{...e,relation:Object.values(t).filter(n=>jt(n.tag))})})}function ir(e){const t=_(n=>n.meta.relation);return a.jsx(ue,{name:"route master",children:a.jsx(de,{...e,relation:Object.values(t).filter(n=>Nn(n.tag))})})}function lr(){return a.jsxs(kt,{children:[({filter:e})=>a.jsx(rr,{filter:e}),({filter:e})=>a.jsx(ir,{filter:e})]})}function cr({width:e,height:t,children:n}){return a.jsx("div",{className:"bg-base-100 border-r-2 border-r-base-300 flex flex-col",style:{width:e,height:t,maxWidth:e,maxHeight:t},children:n})}function dr({width:e,height:t}){const s=h.useMemo(()=>[{tooltip:"Bus stop edit tab",icon:a.jsx(M,{icon:So.faBusSimple}),stage:()=>a.jsx(za,{width:e-42,height:t})},{tooltip:"Route edit tab",icon:a.jsx(M,{icon:No.faRoute}),stage:()=>a.jsx(ar,{width:e-42,height:t})},{tooltip:"Edit bus relation",icon:a.jsx(M,{icon:vo.faCodeCommit}),stage:()=>a.jsx("div",{className:"p-2",children:"Bus Relation Edit Placeholder"})}],[e,t]),[o,r]=h.useState(0);return a.jsxs("div",{className:"flex flex-row",style:{height:t,width:e,maxHeight:t,maxWidth:e},onContextMenu:i=>i.preventDefault(),children:[a.jsx(cr,{width:42,height:t,children:s.map((i,l)=>a.jsx("div",{className:"tooltip tooltip-right mx-auto mt-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(l),className:J("btn btn-ghost btn-square btn-sm",l===o&&"btn-active"),children:i.icon})}))}),a.jsx("div",{className:"relative",style:{height:t,width:e-42},children:s[o].stage()})]})}function ur({width:e,height:t}){const n=[{title:"Bus stop",tab:()=>a.jsx(Ma,{})},{title:"Route",tab:()=>a.jsx(lr,{})},{title:"Selected",tab:()=>a.jsx(Ia,{})}],[s,o]=h.useState(0);return a.jsxs("div",{style:{width:e,height:t},className:"flex flex-col",children:[a.jsx("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs",children:n.map((r,i)=>a.jsx("a",{onClick:()=>o(i),role:"tab",className:J("tab",i===s&&"tab-active"),children:r.title},i))}),a.jsx("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:n[s].tab()})]})}function pr({width:e,height:t}){return a.jsxs(Fe,{width:e,height:t,axis:"x",initial:e/4*3,children:[n=>a.jsx(dr,{...n}),n=>a.jsxs(Fe,{...n,axis:"y",children:[s=>a.jsx(ur,{...s}),s=>a.jsx(Mn,{...s})]})]})}function mr({width:e,height:t}){const s=h.useMemo(()=>[{title:a.jsx(M,{icon:ko.faBus}),tooltip:"Public transport edit mode",component:()=>a.jsx(pr,{width:e,height:t-42})},{title:a.jsx(M,{icon:Co.faMap}),tooltip:"Map edit mode",component:()=>a.jsx(ha,{width:e,height:t-42})}],[e,t]),[o,r]=h.useState(0);return a.jsxs("div",{style:{width:e,height:t,position:"relative"},children:[a.jsx(ja,{height:42,leftSlot:a.jsx(a.Fragment,{children:s.map((i,l)=>a.jsx("div",{className:"tooltip tooltip-right ml-1","data-tip":i.tooltip,children:a.jsx("button",{onClick:()=>r(l),className:J("btn btn-ghost btn-square btn-sm",o===l&&"btn-active"),children:i.title})},l))})}),a.jsx("div",{className:"relative",children:s[o].component()})]})}function fr(){const[{width:e,height:t},n]=h.useState({width:window.innerWidth,height:window.innerHeight});return h.useEffect(()=>{const s=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}}),a.jsx("div",{className:"wrapper h-screen w-screen overflow-hidden",style:{width:e},children:a.jsx(mr,{width:e,height:t})})}function hr(){return a.jsx(fr,{})}function xr(){return a.jsx(a.Fragment,{children:a.jsx(hr,{})})}const Wt=document.getElementById("root");Wt?Kn.createRoot(Wt).render(a.jsx(h.StrictMode,{children:a.jsx(xr,{})})):console.error("Root element not found. Ensure there is an element with the ID 'root' in your HTML.");
