(()=>{"use strict";var e={9487:function(e,t,n){let o;var i,a,r,l=n(5893),s=n(7294),d=n(745),c=n(1621);let u={viewpoint:{lon:-122.431297,lat:37.773972},zoom:17};var m=n(5407);let p=e=>({setViewpoint:t=>e(()=>({viewpoint:t})),setZoom:t=>e(()=>({zoom:t})),setStage:(t,n)=>e({width:t,height:n}),setStageApp:t=>e({stage:t}),setSelectionRect:t=>e({selectionRect:t})}),h=()=>new URLSearchParams(window.location.search),f=e=>{let t=e.toString();window.history.replaceState(null,"",`${location.pathname}${t?"?":""}${t}`)},x=(0,m.U)()((0,c.mW)((o=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{...u,...p(...t)}},(e,t,n)=>{let i=o(e,t,n),a={},r=h(),l=r.get("lat"),s=r.get("lon"),d=r.get("zoom");l&&s&&(a.viewpoint={lat:parseFloat(l),lon:parseFloat(s)}),d&&(a.zoom=parseFloat(d));let c={...i,...a};return e(c,!0,"mapViewURLPersist/hydrate"),n.subscribe((e,t)=>{var n,o,i,a,r,l,s,d,c;let u=h(),m=!1;(null===(n=e.viewpoint)||void 0===n?void 0:n.lat)!==(null===(o=t.viewpoint)||void 0===o?void 0:o.lat)&&(u.set("lat",(null===(l=e.viewpoint)||void 0===l?void 0:null===(r=l.lat)||void 0===r?void 0:r.toString())||""),m=!0),(null===(i=e.viewpoint)||void 0===i?void 0:i.lon)!==(null===(a=t.viewpoint)||void 0===a?void 0:a.lon)&&(u.set("lon",(null===(d=e.viewpoint)||void 0===d?void 0:null===(s=d.lon)||void 0===s?void 0:s.toString())||""),m=!0),e.zoom!==t.zoom&&(u.set("zoom",(null===(c=e.zoom)||void 0===c?void 0:c.toString())||""),m=!0),m&&f(u)}),c}),{name:"MapView"}));var b=n(3399);g({lon:-122.431297,lat:37.773972});function g(e){let[t,n]=(0,b.Z)("EPSG:4326","EPSG:3857",[e.lon,e.lat]);return{x:t,y:n}}function y(e,t){let n=40075016.68/(256*Math.pow(2,t));return{x:(e.x- -20037508.34)/n,y:(20037508.34-e.y)/n}}function v(e,t,n,o,i){let a=y(g(t),n);return{x:Math.floor(e.x+(o?o/2:0)-a.x),y:Math.floor(e.y+(i?i/2:0)-a.y)}}function w(e,t,n,o,i){return v(y(g(e),n),t,n,o,i)}function j(e,t,n,o,i){let a=40075016.68/(256*Math.pow(2,n)),r=g(t),l=Math.floor(o/2),s=Math.floor(i/2),d=(e.x-l)*a,c=(e.y-s)*a;return function(e){let[t,n]=(0,b.Z)("EPSG:3857","EPSG:4326",[e.x,e.y]);return{lon:t,lat:n}}({x:r.x+d,y:r.y-c})}function _(e,t,n,o){let{lon:i,lat:a}=j({x:0,y:0},e,t,n,o),{lon:r,lat:l}=j({x:n,y:o},e,t,n,o);return{left:i,bottom:l,right:r,top:a}}function N(e,t,n,o,i){let{from:a,to:r}=i,l={x:Math.min(a.x,r.x),y:Math.min(a.y,r.y)},s={x:Math.max(a.x,r.x),y:Math.max(a.y,r.y)};console.debug("getBoundsByRect, p1 p2",l,s,"vp zoom w h",e,t,n,o,{from:a,to:r});let{lon:d,lat:c}=j(l,e,t,n,o),{lon:u,lat:m}=j(s,e,t,n,o);return{left:d,bottom:m,right:u,top:c}}let S=e=>t=>0!==e.x&&0!==e.y?j(e,t.viewpoint,t.zoom,t.width,t.height):void 0;var k=n(7412);function M(e){return JSON.parse(JSON.stringify(e))}let E=e=>Object.keys(e);class C{debounce(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];var i=this;return function(){for(var a=arguments.length,r=Array(a),l=0;l<a;l++)r[l]=arguments[l];let s=o&&!i.timers.has(n);i.timers.has(n)&&clearTimeout(i.timers.get(n));let d=setTimeout(()=>{i.timers.delete(n),o||e(...r)},t);i.timers.set(n,d),s&&e(...r)}}cancel(e){this.timers.has(e)&&(clearTimeout(this.timers.get(e)),this.timers.delete(e))}cancelAll(){for(let e of this.timers.values())clearTimeout(e);this.timers.clear()}constructor(){(0,k._)(this,"timers",new Map)}}function R(e){return e?Array.isArray(e)?e:[e]:[]}let T=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.filter(Boolean).join(" ")};class O{appendNext(e,t){let n=e instanceof O?e:e.entry;if(t.isEpsilon)this.next.push({isEpsilon:!0,state:n});else{if(!t.transform)throw Error("Non-ε transition requires a transform function.");this.next.push({isEpsilon:!1,transform:t.transform,state:n})}}constructor(e){(0,k._)(this,"name",void 0),(0,k._)(this,"next",[]),this.name=e}}class A{appendNext(e,t){this.accept.forEach(n=>n.appendNext(e,t))}computeEpsilonClosure(e){let t=new Set,n=[e];for(;n.length;){let e=n.pop();if(!t.has(e))for(let{state:o,isEpsilon:i}of(t.add(e),e.next))i&&n.push(o)}return Array.from(t)}transform(e){for(let t of this.computeEpsilonClosure(this.current))for(let n of t.next)if(!n.isEpsilon&&n.transform(e)){this.current=n.state;return}}debouncedTransform(e){this.debouncer.debounce(this.transform.bind(this),A.DEBOUNCE_DELAY,e.type,!0)(e)}constructor(e){(0,k._)(this,"name",void 0),(0,k._)(this,"entry",void 0),(0,k._)(this,"current",void 0),(0,k._)(this,"accept",void 0),(0,k._)(this,"debouncer",void 0),(0,k._)(this,"context",void 0),this.name="base",this.context={store:e},this.debouncer=new C}}function P(e,t,n){let{stage:o}=n.store.view.getState(),i=o.view.getBoundingClientRect(),a=e-i.x,r=t-i.y;return console.debug("getLocalPosistion, x y",e,t," convert to ",a,r),{x:a,y:r}}(0,k._)(A,"DEBOUNCE_DELAY",20);let D=(e,t,n)=>{var o;let{height:i,width:a,viewpoint:r,zoom:l,stage:s}=n.store.view.getState();if(!i||!a||!s)return;let d=s.view.getBoundingClientRect(),c=e-d.x,u=t-d.y,{modifyFeatureMetaNC:m}=n.store.meta.getState(),p=j({x:c,y:u},r,l,a,i);if(console.log("on component drag",{x:e,y:t},{x:c,y:u},w(p,r,l,a,i)),(null===(o=n.componentTarget)||void 0===o?void 0:o.id)&&"node"===n.componentTarget.type){let{type:e,id:t}=n.componentTarget;m(e,t,e=>{e["@_lon"]=p.lon,e["@_lat"]=p.lat})}else throw Error(`context.componentTarget should not be ${JSON.stringify(n.componentTarget)} at point move`)};class I extends A{constructor(e){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"componentHover",void 0),(0,k._)(this,"componentMousedown",void 0),(0,k._)(this,"pointDrag",void 0),this.idle=new O("component-idle"),this.componentHover=new O("component-hover"),this.componentMousedown=new O("component-mousedown"),this.pointDrag=new O("component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:e=>{let t=this.context;if(["pointerover","pointerenter"].includes(e.type)&&"componentTarget"in e&&e.componentTarget){t.componentTarget=e.componentTarget;let{id:n,type:o}=t.componentTarget;console.log("ComponentStateMachine: component hover triggered",o,n);let{modifyFeatureStateNC:i}=t.store.meta.getState();return i(o,n,e=>e.hovered=!0),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:e=>{let t=this.context;if("mousedown"===e.type&&t.componentTarget){console.log("ComponentStateMachine: transition to mousedown");let{id:e,type:n}=t.componentTarget,{modifyFeatureStateNC:o}=t.store.meta.getState();return o(n,e,e=>e.hovered=!1),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:e=>{let t=this.context;if(["pointerleave","pointerout"].includes(e.type)&&t.componentTarget){console.log("ComponentStateMachine: transition to idle");let{id:e,type:n}=t.componentTarget,{modifyFeatureStateNC:o}=t.store.meta.getState();return o(n,e,e=>e.hovered=!1),t.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:e=>{var t;let n=this.context;if("pointermove"===e.type&&"node"===(null===(t=n.componentTarget)||void 0===t?void 0:t.type)){console.log("ComponentStateMachine: start dragging");let{clientX:t,clientY:o}=e,{commit:i}=n.store.meta.getState();return i(),D(t,o,n),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:e=>{let t=this.context;if(("mouseup"===e.type||"mouseupoutside"===e.type)&&t.componentTarget){let{selectFeature:n,unSelectFeature:o}=t.store.meta.getState(),{id:i,type:a}=t.componentTarget;if("string"==typeof i)e.ctrlKey?o(a,i):(n(a,i,!e.shiftKey),console.log("selected id",i,t.store.meta.getState().selectFeature)),t.componentTarget=void 0;else throw Error(`id ${i} is invalid for component`);return!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:e=>("mouseup"===e.type||"mouseuppoutside"===e.type)&&(console.log("ComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0)}),this.pointDrag.appendNext(this.pointDrag,{transform:e=>{if("pointermove"===e.type){let{clientX:t,clientY:n}=e;return D(t,n,this.context),!0}return!1}})}}var L=((i={})[i.LEFT=0]="LEFT",i[i.MIDDLE=1]="MIDDLE",i[i.RIGHT=2]="RIGHT",i[i.BACK=3]="BACK",i[i.FORWARD=4]="FORWARD",i);class F extends A{constructor(e,t){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"rightMousedown",void 0),(0,k._)(this,"mapDrag",void 0),this.idle=new O("mapview-idle"),this.mapDrag=new O("mapview-mapDrag"),this.rightMousedown=new O("mapview-right-mousedown"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:e=>{let t=this.context;if("wheel"===e.type){let n=e.deltaY<0,{zoom:o,setZoom:i}=t.store.view.getState(),a=o+(n?1:-1),r=t.store.settings.getState();return a>=0&&a<=r.view.MAX_ZOOM&&i(a),!0}return!1}}),this.idle.appendNext(this.mapDrag,{transform:e=>{let t=this.context;if(e.componentTarget)return!1;if("mousedown"===e.type&&!e.shiftKey&&e.button===L.LEFT){let{clientX:n,clientY:o}=e;return t.startPoint={x:n,y:o},t.viewpointBeforeDrag=t.store.view.getState().viewpoint,console.log("MapViewStateMachine: 开始地图拖拽",t.startPoint),!0}return!1}}),this.idle.appendNext(this.rightMousedown,{transform:e=>{if(e.componentTarget)return!1;if("mousedown"===e.type&&!e.shiftKey&&e.button===L.RIGHT){let{clientX:t,clientY:n}=e;return this.context.startPoint={x:t,y:n},this.context.viewpointBeforeDrag=this.context.store.view.getState().viewpoint,!0}return!1}}),this.rightMousedown.appendNext(this.idle,{transform:e=>"mouseup"===e.type&&(t&&t.rightClickHandeler(e),this.context.startPoint=void 0,this.context.viewpointBeforeDrag=void 0,!0)});let n=e=>{let t=this.context;if("pointermove"===e.type){var n,o;let{clientX:i,clientY:a}=e,[r,l]=[i,a];if("number"!=typeof(null===(n=t.startPoint)||void 0===n?void 0:n.x)||"number"!=typeof(null===(o=t.startPoint)||void 0===o?void 0:o.y))throw Error("context.startPoint.x must be number when map drag");let[s,d]=[t.startPoint.x-r,t.startPoint.y-l];console.log("moving to",s,d);let{zoom:c,setViewpoint:u,width:m,height:p}=t.store.view.getState();return u(j({x:s+m/2,y:d+p/2},t.viewpointBeforeDrag,c,m,p)),!0}return!1};this.rightMousedown.appendNext(this.mapDrag,{transform:n}),this.mapDrag.appendNext(this.mapDrag,{transform:n}),this.mapDrag.appendNext(this.idle,{transform:e=>{let t=this.context;if("mouseup"===e.type||"mouseupoutside"===e.type){if(t.startPoint=void 0,t.viewpointBeforeDrag=void 0,t.store.meta.getState().autoload){let{viewpoint:e,zoom:n,width:o,height:i}=t.store.view.getState(),{loadbbox:a}=t.store.meta.getState();a({width:o,height:i,zoom:n,viewpoint:e},t.store.settings.getState().osmAPI.BASEURL)}return!0}return!1}})}}var $=n(1525);function B(e,t){let n=null,o=null,i=1/0,a=$.al(e.lon,e.lat);for(let e=0;e<t.length-1;e++){let r=function(e,t,n){let o=$.Ue();$.$X(o,n,t);let i=$.x9(o);if(0===i)return $.d9(t);let a=$.Ue();$.$X(a,e,t);let r=Math.max(0,Math.min(1,$.AK(a,o)/i)),l=$.Ue();return $.od(l,t,o,r),l}(a,$.al(t[e]["@_lon"],t[e]["@_lat"]),$.al(t[e+1]["@_lon"],t[e+1]["@_lat"])),l=$.TE(a,r);l<i&&(i=l,n=$.d9(r),o=t[e])}if(null===o)throw Error("point is not insertable for polyline");return{nearestPoint:n?{lon:n[0],lat:n[1]}:e,insertAfter:o}}class U extends A{constructor(e){super(e),(0,k._)(this,"idle",void 0),this.idle=new O("undo-redo-idle"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.idle,{transform:e=>{if("keydown"===e.type){let{undo:t,redo:n}=this.context.store.meta.temporal.getState();if("KeyZ"===e.code){if(e.shiftKey&&e.ctrlKey)return console.log("redo"),n(),!0;if(e.ctrlKey)return console.log("undo"),t(),!0}}if("utils-undo"===e.type){let{undo:e}=this.context.store.meta.temporal.getState();return console.log("undo"),e(),!0}if("utils-redo"===e.type){let{redo:e}=this.context.store.meta.temporal.getState();return console.log("redo"),e(),!0}return!1}})}}class G extends A{constructor(e){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"undoRedo",void 0),(0,k._)(this,"addNode",void 0),(0,k._)(this,"addNodeOnWay",void 0),(0,k._)(this,"splitWay",void 0),this.idle=new O("node-idle"),this.addNode=new O("add-node"),this.addNodeOnWay=new O("add-node-on-way"),this.splitWay=new O("split-way"),this.undoRedo=new U(e),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.idle.appendNext(this.idle,{transform:e=>{if("keydown"===e.type){let{undo:t,redo:n}=this.context.store.meta.temporal.getState();if("KeyZ"===e.code){if(e.shiftKey&&e.ctrlKey)return console.log("redo"),n(),!0;if(e.ctrlKey)return console.log("undo"),t(),!0}}if("utils-undo"===e.type){let{undo:e}=this.context.store.meta.temporal.getState();return console.log("undo"),e(),!0}if("utils-redo"===e.type){let{redo:e}=this.context.store.meta.temporal.getState();return console.log("redo"),e(),!0}return!1}}),this.idle.appendNext(this.addNode,{transform:e=>"add-node"===e.type&&(console.log("to addnode way state"),!0)}),this.idle.appendNext(this.addNodeOnWay,{transform:e=>"add-node-on-way"===e.type&&(console.log("to addnode way state"),!0)}),this.idle.appendNext(this.splitWay,{transform:e=>"split-way"===e.type&&(console.log("to split way state"),!0)}),this.addNode.appendNext(this.idle,{transform:e=>{if("mousedown"===e.type){if(0===e.button){let{viewpoint:t,zoom:n,width:o,height:i}=this.context.store.view.getState(),{clientX:a,clientY:r}=e,l=j({x:a,y:r},t,n,o,i);this.context.store.meta.getState().createLocalNode(l),console.log("added node")}return!0}return!1}}),this.addNodeOnWay.appendNext(this.idle,{transform:e=>{if("mousedown"===e.type){if(0===e.button&&e.componentTarget&&"way"===e.componentTarget.type){let{viewpoint:t,zoom:n,width:o,height:i}=this.context.store.view.getState(),{meta:a,createLocalNode:r,modifyFeatureMetaNC:l,commit:s}=this.context.store.meta.getState(),{clientX:d,clientY:c}=e,u=j({x:d,y:c},t,n,o,i),m=a.way[e.componentTarget.id],{nearestPoint:p,insertAfter:h}=B(u,m.nd.map(e=>a.node[e["@_ref"]])),f=r(p),x=Array.from(m.nd);x.splice(m.nd.findIndex(e=>e["@_ref"]===h["@_id"])+1,0,{"@_ref":f}),s(),l(e.componentTarget.type,e.componentTarget.id,e=>e.nd=x),console.log("nodeid",f,x),console.log("added node")}return!0}return!1}}),this.splitWay.appendNext(this.idle,{transform:e=>{if("mousedown"===e.type){if(0===e.button&&e.componentTarget&&"node"===e.componentTarget.type){let{meta:t,splitWay:n}=this.context.store.meta.getState();n(t.node[e.componentTarget.id]["@_id"]),console.log("splited way")}return!0}return!1}})}}class q extends A{constructor(e){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"componentSubMachine",void 0),(0,k._)(this,"mapViewSubMachine",void 0),(0,k._)(this,"uiStateSubMachine",void 0),this.idle=new O("common-edit-idle"),this.componentSubMachine=new I(e),this.mapViewSubMachine=new F(e),this.uiStateSubMachine=new G(e),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.uiStateSubMachine,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.uiStateSubMachine.appendNext(this.idle,{isEpsilon:!0})}}let V={commitCounter:1,selectedRef:[],activeRef:void 0,meta:{node:{},way:{},relation:{}},deletedMeta:{node:{},way:{},relation:{}},_create_feature_counter:-1,bbox:[],autoload:!0,routeEdit:{step:0,stops:[],path:[]}};function W(e){e.commitCounter++}let H=e=>({commit:()=>e(e=>W(e))});var z=n(4522),K=n(6622),X=n(4639);let Z=e=>{let{node:t,way:n,relation:o}=e,i={elems:{node:{},way:{},relation:{}},roots:{node:{},way:{},relation:{}}},a=(e,t)=>{Object.keys(t).forEach(t=>{i.elems[e][t]={id:t,type:e,fathers:{node:[],way:[],relation:[]},childs:{node:[],way:[],relation:[]}},i.roots[e][t]=!0})};return a("node",t),a("way",n),a("relation",o),Object.values(n).forEach(e=>{let t=i.elems.way[e["@_id"]];if(!t)throw Error(`${e["@_id"]} !`);e.nd.forEach(e=>{let n=i.elems.node[e["@_ref"]];n&&(n.fathers.way.push(t.id),t.childs.node.push(n.id),delete i.roots.node[n.id])})}),Object.values(o).forEach(e=>{let t=i.elems.relation[e["@_id"]];if(!t)throw Error(`${e["@_id"]} !`);e.member.forEach(e=>{let n=i.elems[e["@_type"]][e["@_ref"]];n&&(n.fathers.relation.push(t.id),t.childs[e["@_type"]].push(n.id),delete i.roots[e["@_type"]][n.id])})}),i},J=(0,X.createComputed)(e=>({tree:Z(e.meta)}));function Y(e,t,n,o){let i=e.meta[t][n]["@_localStates"];i&&o(i)}function Q(e,t,n){e.meta[t][n]["@_localStates"]={visible:!0,highlighted:!1,hovered:!1,selected:!1,active:!1}}function ee(e,t,n){if(e.activeRef){let{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1)}e.activeRef={type:t,id:n},e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!0)}function et(e,t,n){!e.selectedRef.some(e=>e.type===t&&e.id===n)&&(e.selectedRef.push({type:t,id:n}),e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].selected=!0))}function en(e){if(e.activeRef){let{type:t,id:n}=e.activeRef;e.meta[t][n]["@_localStates"]&&(e.meta[t][n]["@_localStates"].active=!1),e.activeRef=void 0}e.selectedRef.forEach(t=>{let{id:n,type:o}=t;return e.meta[o][n]["@_localStates"]&&(e.meta[o][n]["@_localStates"].selected=!1)}),e.selectedRef=[]}function eo(e,t,n){et(e,t,n),ee(e,t,n)}function ei(e,t,n){let o=e.meta[t][n]["@_localStates"];if((null==o?void 0:o.active)&&(o.active=!1,e.activeRef=void 0),(null==o?void 0:o.selected)&&(o.selected=!1,e.selectedRef=e.selectedRef.filter(e=>e.id!==n||e.type!==t)),!e.activeRef&&e.selectedRef.length>0){let{type:t,id:n}=e.selectedRef[0];ee(e,t,n)}}let ea=(e,t)=>({"@_id":`${e._create_feature_counter--}`,"@_lat":t.lat,"@_lon":t.lon,"@_visible":"true"}),er=(e,t)=>({"@_id":`${e._create_feature_counter--}`,nd:[...t],"@_visible":"true"}),el=(e,t)=>({"@_id":`${e._create_feature_counter--}`,member:[...t],"@_visible":"true"});function es(e,t,n){let o=n["@_id"];e.meta[t][o]&&console.debug(`Can't add feature ${t} ${o}: already exsits! Ignoring this attempt`),"node"===t&&(n["@_lon"]=Number(n["@_lon"]),n["@_lat"]=Number(n["@_lat"])),e.meta[t][o]=n,Q(e,t,o)}function ed(e,t){let n=ea(e,t);return e.meta.node[n["@_id"]]=n,Q(e,"node",n["@_id"]),n["@_id"]}function ec(e,t){let n=el(e,t);return e.meta.relation[n["@_id"]]=n,Q(e,"relation",n["@_id"]),n["@_id"]}let eu=(e,t,n,o)=>{let i=e.meta[t][n];i&&(o(i),i["@_action"]="modify")};function em(e,t,n){if(!e.meta[t][n])throw Error(`Can't delete feature ${t} ${n}: not exsit!`);e.deletedMeta[t][n]=e.meta[t][n],e.deletedMeta[t][n]["@_action"]="delete",function(e,t,n){let o=e=>e.type===t&&e.id===n;e.selectedRef.some(o)&&(e.selectedRef=e.selectedRef.filter(e=>!o(e))),e.activeRef&&o(e.activeRef)&&(e.activeRef=void 0),delete e.meta[t][n]["@_localStates"]}(e,t,n),delete e.meta[t][n]}function ep(e,t,n){e.meta.way[n].nd.forEach(n=>{let o=n["@_ref"],{way:i,relation:a}=t.elems.node[o].fathers;!(i.length>1)&&!(a.length>0)&&em(e,"node",o)});let{relation:o}=t.elems.way[n].fathers;o.forEach(t=>{eu(e,"relation",t,e=>{e.member=e.member.filter(e=>"way"===e["@_type"]&&e["@_ref"]===n)})}),em(e,"way",n)}var eh=n(6932);let ef=["tag","nd","member","node","way","relation"];async function ex(e,t){let n=`${e}${t}`,o=await fetch(n);if(!o.ok)throw Error(`Error on fetching ${n}: ${o.statusText}`);let i=await o.text(),a=new eh.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",isArray:(e,t,n,o)=>!o&&ef.includes(e)}).parse(i);return console.log(`Get ${n}`,JSON.stringify(a),a),a}async function eb(e,t,n,o,i){let a=await ex(e,`/api/0.6/map?bbox=${t},${n},${o},${i}`);return a.osm.bounds["@_maxlat"]=Number(a.osm.bounds["@_maxlat"]),a.osm.bounds["@_minlat"]=Number(a.osm.bounds["@_minlat"]),a.osm.bounds["@_maxlon"]=Number(a.osm.bounds["@_maxlon"]),a.osm.bounds["@_minlon"]=Number(a.osm.bounds["@_minlon"]),a.osm.node=R(a.osm.node).map(e=>(e["@_lat"]=Number(e["@_lat"]),e["@_lon"]=Number(e["@_lon"]),e.tag&&(e.tag=R(e.tag)),e)),a}async function eg(e,t){let n=(await ex(e,`/api/0.6/node/${t}`)).osm.node;return n["@_lon"]=Number(n["@_lon"]),n["@_lat"]=Number(n["@_lat"]),n}async function ey(e,t){return(await ex(e,`/api/0.6/way/${t}`)).osm.way}async function ev(e,t){return(await ex(e,`/api/0.6/relation/${t}`)).osm.relation}async function ew(e,t){if(0===t.length)return[];let n=t.join(","),o=`/api/0.6/nodes?nodes=${n}`;return R((await ex(e,o)).osm.node).map(e=>(e["@_lat"]=Number(e["@_lat"]),e["@_lon"]=Number(e["@_lon"]),e))}async function ej(e,t){if(0===t.length)return[];let n=t.join(","),o=`/api/0.6/ways?ways=${n}`;return R((await ex(e,o)).osm.way)}async function e_(e,t){if(0===t.length)return[];let n=t.join(","),o=`/api/0.6/relations?relations=${n}`;return R((await ex(e,o)).osm.relation)}async function eN(e,t,n){let{viewpoint:o,zoom:i,width:a,height:r}=t,{left:l,bottom:s,right:d,top:c}=_(o,i,a,r);return e.some(e=>e.osm.bounds["@_minlon"]<=l+1e-7&&e.osm.bounds["@_minlat"]<=s+1e-7&&e.osm.bounds["@_maxlon"]>=d-1e-7&&e.osm.bounds["@_maxlat"]>=c-1e-7)?(console.log("requested bbox is already cached"),null):(console.log(`osm load data, faild to get cache: ${l} ${s} ${d} ${c}`,o,i),console.log("state bboxs",e),await eb(n,l,s,d,c))}function eS(e,t,n){let o=ed(e,t);return eu(e,"node",o,n),o}function ek(e,t,n,o){let i="0";return eu(e,"way",o,o=>{let{nearestPoint:a,insertAfter:r}=B(t,o.nd.map(t=>e.meta.node[t["@_ref"]]));i=eS(e,a,n),o.nd.splice(o.nd.findIndex(e=>e["@_ref"]===r["@_id"])+1,0,{"@_ref":i})}),i}let eM=e=>({modifyFeatureStateNC:(t,n,o)=>e(e=>{Y(e,t,n,o)}),modifyFeatureStateBatchNC:t=>e(e=>{t.forEach(t=>{let{type:n,id:o,modify:i}=t;Y(e,n,o,i)})}),selectFeature:(t,n,o)=>e(e=>{W(e),o&&en(e),eo(e,t,n)}),selectFeatureWithoutActive:(t,n,o)=>e(e=>{W(e),o&&en(e),et(e,t,n)}),unSelectFeature:(t,n)=>e(e=>{W(e),ei(e,t,n)}),toggleFeature:(t,n,o)=>e(e=>{var i;W(e),(null===(i=e.meta[t][n]["@_localStates"])||void 0===i?void 0:i.selected)?ei(e,t,n):(o&&en(e),eo(e,t,n))}),toggleFeatureWithoutActive:(t,n,o)=>e(e=>{var i;(W(e),null===(i=e.meta[t][n]["@_localStates"])||void 0===i?void 0:i.selected)?ei(e,t,n):(o&&en(e),et(e,t,n))}),clearSelect:()=>e(e=>{W(e),en(e)})}),eE=(e,t)=>({addFeatureMetaBatch:(t,n)=>e(e=>R(n).forEach(n=>es(e,t,n))),createLocalNode:t=>{let n="0";return e(e=>{W(e),n=ed(e,t)}),n},createLocalWay:t=>{let n="0";return e(e=>{W(e),n=function(e,t){let n=er(e,t);return e.meta.way[n["@_id"]]=n,Q(e,"way",n["@_id"]),n["@_id"]}(e,t)}),n},createLocalRelation:t=>{let n="0";return e(e=>{W(e),n=ec(e,t)}),n},modifyFeatureMetaNC:(t,n,o)=>e(e=>{eu(e,t,n,o)}),deleteFeature:(n,o)=>e(e=>{W(e),function(e,t,n,o){if("node"===n)!function(e,t,n){let{way:o,relation:i}=t.elems.node[n].fathers;o.forEach(o=>{eu(e,"way",o,e=>{e.nd=e.nd.filter(e=>e["@_ref"]!==n)}),e.meta.way[o].nd.length<=1&&ep(e,t,o)}),i.forEach(t=>{eu(e,"relation",t,e=>{e.member=e.member.filter(e=>"node"===e["@_type"]&&e["@_ref"]===n)})}),em(e,"node",n)}(e,t,o);else if("way"===n)ep(e,t,o);else if("relation"===n)!function(e,t,n){let{relation:o}=t.elems.relation[n].fathers;o.forEach(t=>{eu(e,"relation",t,e=>{e.member=e.member.filter(e=>"relation"===e["@_type"]&&e["@_ref"]===n)})}),em(e,"relation",n)}(e,t,o);else throw Error(`Type ${n} not allowed.`)}(e,t().tree,n,o)}),splitWay:n=>e(e=>{W(e);let o=function(e,t,n){let o=t.elems.node[n].fathers.way.map(t=>e.meta.way[t]),i=null;return null==o||o.forEach(o=>{let a=o.nd,r=a.findIndex(e=>e["@_ref"]===n);if(0!==r&&r!==a.length-1){if(-1===r)throw Error(`way ${o} must contain node ${n}, the feature tree is broken.`);let l=a.slice(r);o.nd=a.slice(0,r+1),o["@_action"]="modify";let s=er(e,l);i=s["@_id"],s.tag=o.tag&&[...o.tag],e.meta.way[s["@_id"]]=s,Q(e,"way",s["@_id"]);let d=t.elems.way[o["@_id"]].fathers.relation.map(t=>e.meta.relation[t]);null==d||d.forEach(e=>{let t=e.member,n=t.findIndex(e=>e["@_ref"]===o["@_id"]);if(-1===n)throw Error(`relation ${e} must contain way ${o}, the feature tree is broken.`);t.splice(n+1,0,{"@_ref":s["@_id"],"@_type":"way","@_role":t[n]["@_role"]}),e.member=t,e["@_action"]="modify"})}}),i}(e,t().tree,n);o&&eo(e,"way",o)}),restoreDeletedFeature:(t,n)=>e(e=>{let o=e.deletedMeta[t][n];o&&(e.meta[t][n]={...o},delete e.deletedMeta[t][n],Q(e,t,n))})});function eC(e,t){if(!t)return null;let n=R(t);for(let t=0;t<n.length;t++){let o=n[t];if(o["@_k"]===e)return o["@_v"]}return null}let eR=(e,t,n,o,i,a)=>{let r=(l,s)=>{if("relation"===s){let s=a[l];s&&(n[l]||(n[l]=!0),R(s.member).forEach(l=>{let s=l["@_ref"],d=l["@_type"];"node"===d?!e[s]&&o[s]&&(e[s]=!0):"way"===d?!t[s]&&i[s]&&r(s,"way"):"relation"===d&&!n[s]&&a[s]&&r(s,"relation")}))}else if("way"===s){let n=i[l];if(!n)return;t[l]||(t[l]=!0),R(n.nd).forEach(t=>{let n=t["@_ref"];!e[n]&&o[n]&&(e[n]=!0)})}else if("node"===s){if(!o[l])return;e[l]||(e[l]=!0)}};return r},eT=e=>{let{node:t,way:n,relation:o}=e,i=function(e,t,n){let o={},i={},a={},r=eR(o,i,a,e,t,n);return Object.values(n).forEach(e=>{let t=eC("type",e.tag),n=eC("route_master",e.tag),o=eC("public_transport:version",e.tag);"route_master"===t&&"bus"===n?r(e["@_id"],"relation"):"route"===t&&"2"===o&&r(e["@_id"],"relation")}),{node:o,way:i,relation:a}}(t,n,o),a=function(e,t,n){let o={},i={},a={},r=eR(o,i,a,e,t,n);return Object.values(n).forEach(e=>{eC("highway",e.tag)&&r(e["@_id"],"relation")}),Object.values(t).forEach(e=>{eC("highway",e.tag)&&r(e["@_id"],"way")}),Object.values(e).forEach(e=>{eC("highway",e.tag)&&r(e["@_id"],"node")}),{node:o,way:i,relation:a}}(t,n,o);return{ptv2:i,highway:a,created:function(e,t,n){let o={},i={},a={},r=eR(o,i,a,e,t,n);return Object.values(n).forEach(e=>{0>Number(e["@_id"])&&r(e["@_id"],"relation")}),Object.values(t).forEach(e=>{0>Number(e["@_id"])&&r(e["@_id"],"way")}),Object.values(e).forEach(e=>{0>Number(e["@_id"])&&r(e["@_id"],"node")}),{node:o,way:i,relation:a}}(t,n,o),global:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce((e,t)=>(Object.assign(e.node,t.node),Object.assign(e.way,t.way),Object.assign(e.relation,t.relation),e),{node:{},way:{},relation:{}})}(i,a)}};function eO(e,t){let n={};for(let[o,i]of Object.entries(e))t(i)&&(n[o]=i);return n}let eA=(e,t)=>({loadbbox:async(n,o)=>{let{bbox:i,meta:a}=t();if(!(n.zoom<=16))try{let t=await eN(i||[],n,o);if(null===t)return;let{node:r,way:l,relation:s}=M(a),d=[],c=[],u=[];t.osm.node.forEach(e=>{let t=e["@_id"];r[t]||(r[t]=e,d.push(e))}),t.osm.way.forEach(e=>{let t=e["@_id"];l[t]||(l[t]=e,c.push(e))}),t.osm.relation.forEach(e=>{let t=e["@_id"];s[t]||(s[t]=e,u.push(e))});let m=eT({node:r,way:l,relation:s}),p={nodesId:new Set(Object.keys(m.global.node)),waysId:new Set(Object.keys(m.global.way)),relationsId:new Set(Object.keys(m.global.relation))},h=d.filter(e=>p.nodesId.has(e["@_id"])),f=c.filter(e=>p.waysId.has(e["@_id"])),x=u.filter(e=>p.relationsId.has(e["@_id"]));e(e=>{W(e),h.forEach(t=>{e.meta.node[t["@_id"]]||es(e,"node",t)}),f.forEach(t=>{e.meta.way[t["@_id"]]||es(e,"way",t)}),x.forEach(t=>{e.meta.relation[t["@_id"]]||es(e,"relation",t)}),e.bbox.push({...t,osm:{...t.osm,node:[],way:[],relation:[]}})})}catch(e){console.log(e)}},loadFeature:async(e,n,o)=>{let{meta:i,addFeatureMetaBatch:a}=t();if("node"===e)i.node[n]||a("node",await eg(o,n));else if("way"===e){let e=await ey(o,n);a("node",(await ew(o,e.nd.map(e=>e["@_ref"]))).filter(e=>!i.node[e["@_id"]])),i.way[n]||a("way",e)}else"relation"!==e||i.relation[n]||a("relation",await ev(o,n))},loadFeatureBatch:async(e,n)=>{let{meta:o,addFeatureMetaBatch:i}=t(),a=e.filter(e=>"node"===e.type&&!o.node[e.id]).map(e=>e.id),r=e.filter(e=>"way"===e.type&&!o.way[e.id]).map(e=>e.id),l=e.filter(e=>"relation"===e.type&&!o.relation[e.id]).map(e=>e.id);if(r.length>0){let e=await ej(n,r),t=e.map(e=>e.nd.map(e=>e["@_ref"]).filter(e=>!o.node[e])).flat();i("node",await ew(n,t)),i("way",e)}a.length>0&&i("node",await ew(n,a)),l.length>0&&i("relation",await e_(n,l))},setAutoloadNC:t=>e(e=>{e.autoload="function"==typeof t?t():t})}),eP=e=>{var t,n;return"node"===e["@_type"]||(null===(t=e["@_role"])||void 0===t?void 0:t.startsWith("stop"))||(null===(n=e["@_role"])||void 0===n?void 0:n.startsWith("platform"))},eD=e=>({createBusStopSel:(t,n)=>e(e=>{W(e);let o=eS(e,t,e=>{e.tag=n});eo(e,"node",o)}),createStopPositionSel:(t,n,o)=>e(e=>{W(e);let i=ek(e,t,e=>{e.tag=n},o);eo(e,"node",i)}),createNodeOnWay:(t,n,o)=>e(e=>{W(e),ek(e,t,e=>{e.tag=n},o)}),createStopAreaSel:(t,n)=>e(e=>{W(e);let o=ec(e,n||[]);eu(e,"relation",o,e=>{e.tag=t}),eo(e,"relation",o)}),createEditRoute:(t,n)=>e(e=>{W(e);let o=ec(e,n||[]);eu(e,"relation",o,e=>{e.tag=t}),eo(e,"relation",o);let i=n||[],a=i.map((e,t)=>eP(e)?t:-1),r=a.lastIndexOf(Math.max(...a));e.routeEdit.editing=o,e.routeEdit.step=0,e.routeEdit.stops=i.slice(0,r+1),e.routeEdit.path=i.slice(r+1,i.length)}),setEditRoute:t=>e(e=>{var n;W(e);let o=(null===(n=e.meta.relation)||void 0===n?void 0:n[t].member)||[],i=o.map((e,t)=>eP(e)?t:-1),a=i.lastIndexOf(Math.max(...i));e.routeEdit.editing=t,e.routeEdit.step=0,e.routeEdit.stops=o.slice(0,a+1),e.routeEdit.path=o.slice(a+1,o.length)}),cancelEditRoute:()=>e(e=>{W(e),e.routeEdit.editing=void 0,e.routeEdit.step=0,e.routeEdit.stops=[],e.routeEdit.path=[]}),setRouteStop:t=>e(e=>{W(e),e.routeEdit.stops=t}),setRoutePath:t=>e(e=>{W(e),e.routeEdit.path=t}),setEditStepNC:t=>e(e=>{e.routeEdit.step=t}),saveEditRoute:()=>e(e=>{let{editing:t,stops:n,path:o}=e.routeEdit;t&&(W(e),eu(e,"relation",t,e=>{e.tag=[...e.tag||[]],e.member=[...n,...o]}),e.routeEdit.editing=void 0,e.routeEdit.stops=[],e.routeEdit.path=[],e.routeEdit.selectedMaster=void 0)}),setSelectedMaster:t=>e(e=>{e.routeEdit.selectedMaster=t}),clearSelectedMaster:()=>e(e=>{e.routeEdit.selectedMaster=void 0})}),eI=e=>({reset:()=>{e({...V})}}),eL=(0,m.U)()((0,c.mW)((0,c.tJ)(J((0,K.O)((0,z.n)(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{...V,...H(...t),...eM(...t),...eE(...t),...eA(...t),...eD(...t),...eI(...t)}}),{partialize:e=>{let{tree:t,...n}=e;return n},equality:(e,t)=>e.commitCounter===t.commitCounter})),{name:"OSMMapStateStore",storage:(0,c.FL)(()=>localStorage),partialize:e=>{let{tree:t,...n}=e;return n}}),{name:"OSMMapState"})),eF=e=>({updateSettingsAction:t=>e(()=>t)}),e$={osmAPI:{BASEURL:"https://api.openstreetmap.org",TILE_SOURCE:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"},view:{MAX_ZOOM:19},pixiRender:{zIndex:{LINE:10,POINT:20,MASK:30}}},eB={name:"settingStore",storage:(0,c.FL)(()=>localStorage)},eU=(0,m.U)()((0,c.mW)((0,c.tJ)(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{...e$,...eF(...t)}},eB),{name:"Settings"}));var eG=n(8810);let eq=function(e){let{source:t,x:n,y:o,mapViewStatus:{zoom:i,width:a,height:r,viewpoint:s}}=e,d=t.replace("{z}",String(i)).replace("{x}",String(n)).replace("{y}",String(o)),c=v({x:256*n,y:256*o},s,i,a,r);return(0,l.jsx)(eG.jy,{image:d,position:c})};function eV(e){let{width:t,height:n}=e,o=eU(e=>e.osmAPI.TILE_SOURCE),i=x(),{viewpoint:a,zoom:r}=i;return(0,l.jsx)(eG.W2,{children:(()=>{let{x:s,y:d}=y(g(a),r),[c,u,m,p]=[s-(t>>1),d-(n>>1),s+(t>>1),d+(n>>1)].map(e=>Math.floor(e/256)),h=[];for(let t=c;t<=m;t++)for(let n=u;n<=p;n++)h.push((0,l.jsx)(eq,{source:o,x:t,y:n,mapViewStatus:{...e,...i}},`${t}-${n}`));return h})()})}var eW=n(7130),eH=n(1839),ez=n(6124);function eK(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Math.abs(e[0]-t[0])<=n&&Math.abs(e[1]-t[1])<=n}function eX(e,t){let n=t[0]-e[0],o=t[1]-e[1];return Math.sqrt(n*n+o*o)}function eZ(e,t){let n,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=t,r=[];for(let c=0;c<e.length;c++){let u=e[c];if(n){let e=eX(n,u)-a;if(e>=0){var l,s,d;let c=(l=n,Math.atan2(u[1]-l[1],u[0]-l[0])),m=t*Math.cos(c),p=t*Math.sin(c),h=0,f=0;o&&(h=7*Math.cos(c+Math.PI/2),f=7*Math.sin(c+Math.PI/2));let x=[n[0]+a*Math.cos(c)+h,n[1]+a*Math.sin(c)+f],b=[n,x];for(i&&e>=100*t&&(t=Math.floor(e/100)),e-=t;e>=0;e-=t)s=x,d=[m,p],x=[s[0]+d[0],s[1]+d[1]],b.push(x);b.push(u),r.push({coords:b.slice(1,-1),angle:c+(o?Math.PI/2:0)})}a=-e}n=u}return r}function eJ(e){return"butt"===e?eH.$oy.BUTT:"square"===e?eH.$oy.SQUARE:eH.$oy.ROUND}function eY(e){return"bevel"===e?eH.Sat.BEVEL:"miter"===e?eH.Sat.MITER:eH.Sat.ROUND}let eQ=eH.xEZ.from("src/location-pin.svg"),e0=eH.xEZ.from("src/circle.svg"),e1=eH.xEZ.from("src/bus.svg"),e2=eH.xEZ.from("src/arrow-right-long.svg"),e3={proposed:!0,planned:!0,construction:!0,disused:!0,abandoned:!0,was:!0,dismantled:!0,razed:!0,demolished:!0,destroyed:!0,removed:!0,obliterated:!0,intermittent:!0},e4={aerialway:{chair_lift:!0,drag_lift:!0,"j-bar":!0,magic_carpet:!0,mixed_lift:!0,platter:!0,rope_tow:!0,"t-bar":!0,zip_line:!0},highway:{motorway:!0},junction:{circular:!0,roundabout:!0},man_made:{goods_conveyor:!0,"piste:halfpipe":!0},"piste:type":{downhill:!0,sled:!0,yes:!0},roller_coaster:{track:!0},"seamark:type":{"two-way_route":!0,recommended_traffic_lane:!0,separation_lane:!0,separation_roundabout:!0},waterway:{canal:!0,ditch:!0,drain:!0,fish_pass:!0,flowline:!0,pressurised:!0,river:!0,spillway:!0,stream:!0,tidal_channel:!0}},e5={natural:{cliff:!0,coastline:!0},barrier:{retaining_wall:!0,kerb:!0,guard_rail:!0,city_wall:!0},man_made:{embankment:!0},waterway:{weir:!0}},e7={surface:{paved:!0,asphalt:!0,concrete:!0,chipseal:!0,"concrete:lanes":!0,"concrete:plates":!0}},e8=new Set(["motorway","trunk","primary","secondary","tertiary","residential","motorway_link","trunk_link","primary_link","secondary_link","tertiary_link","unclassified","road","service","track","living_street","bus_guideway","busway"]),e9=new Set(["abandoned","construction","demolished","destroyed","dismantled","disused","intermittent","obliterated","planned","proposed","razed","removed","was"]),e6=RegExp("^("+Array.from(e9).join("|")+"):"),te={DEFAULTS:{fill:{width:2,color:0xaaaaaa,alpha:.3},casing:{width:5,color:4473924,alpha:1,cap:"round",join:"round"},stroke:{width:3,color:0xcccccc,alpha:1,cap:"round",join:"round"}},LIFECYCLE:{casing:{alpha:0},stroke:{dash:[7,3],cap:"butt"}},red:{fill:{color:0xe06e5f,alpha:.3}},green:{fill:{color:9228383,alpha:.3}},blue:{fill:{color:7853278,alpha:.3}},yellow:{fill:{color:0xffff94,alpha:.25}},gold:{fill:{color:0xc4be19,alpha:.3}},orange:{fill:{color:0xd6881a,alpha:.3}},pink:{fill:{color:0xe3a4f5,alpha:.3}},teal:{fill:{color:0x99e1aa,alpha:.3}},lightgreen:{fill:{color:0xbee83f,alpha:.3}},tan:{fill:{color:0xf5dcba,alpha:.3}},darkgray:{fill:{color:9211020,alpha:.5}},lightgray:{fill:{color:0xaaaaaa,alpha:.3}},motorway:{casing:{width:10,color:7354159},stroke:{width:8,color:0xcf2081}},trunk:{casing:{width:10,color:7354159},stroke:{width:8,color:0xdd2f22}},primary:{casing:{width:10,color:7354159},stroke:{width:8,color:0xf99806}},secondary:{casing:{width:10,color:7354159},stroke:{width:8,color:0xf3f312}},tertiary:{casing:{width:10,color:7354159},stroke:{width:8,color:0xfff9b3}},unclassified:{casing:{width:10,color:4473924},stroke:{width:8,color:0xddccaa}},residential:{casing:{width:10,color:4473924},stroke:{width:8,color:0xffffff}},living_street:{casing:{width:7,color:0xffffff},stroke:{width:5,color:0xcccccc}},service:{casing:{width:7,color:4473924},stroke:{width:5,color:0xffffff}},special_service:{casing:{width:7,color:4473924},stroke:{width:5,color:0xddccaa}},track:{casing:{width:7,color:7630703},stroke:{width:5,color:0xc5b59f}},pedestrian:{casing:{width:7,color:0xffffff},stroke:{width:5,color:0x998888,dash:[8,8],cap:"butt"}},path:{casing:{width:5,color:0xddccaa},stroke:{width:3,color:0x998888,dash:[6,6],cap:"butt"}},footway:{casing:{width:5,color:0xffffff},stroke:{width:3,color:0x998888,dash:[6,6],cap:"butt"}},crossing_marked:{casing:{width:5,color:0xddccaa},stroke:{width:3,color:4998212,dash:[6,3],cap:"butt"}},crossing_unmarked:{casing:{width:5,color:0xddccaa},stroke:{width:3,color:7826026,dash:[6,4],cap:"butt"}},cycleway:{casing:{width:5,color:0xffffff},stroke:{width:3,color:5810669,dash:[6,6],cap:"butt"}},bridleway:{casing:{width:5,color:0xffffff},stroke:{width:3,color:0xe06d5f,dash:[6,6],cap:"butt"}},corridor:{casing:{width:5,color:0xffffff},stroke:{width:3,color:9228383,dash:[2,8],cap:"round"}},steps:{casing:{width:5,color:0xffffff},stroke:{width:3,color:8507996,dash:[3,3],cap:"butt"}},river:{fill:{color:7853278,alpha:.3},casing:{width:10,color:4473924},stroke:{width:8,color:7855581}},stream:{fill:{color:7853278,alpha:.3},casing:{width:7,color:4473924},stroke:{width:5,color:7855581}},ridge:{stroke:{width:2,color:9228383}},runway:{casing:{width:10,color:0,cap:"butt"},stroke:{width:8,color:0xffffff,dash:[24,48],cap:"butt"}},taxiway:{casing:{width:7,color:4473924},stroke:{width:5,color:0xffff00}},railway:{casing:{width:7,color:5592405,cap:"butt"},stroke:{width:2,color:0xeeeeee,dash:[12,12],cap:"butt"}},ferry:{casing:{alpha:0},stroke:{width:3,color:5810669,dash:[12,8],cap:"butt"}},boundary:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:0xffffff,dash:[20,5,5,5],cap:"butt"}},boundary_park:{casing:{width:6,color:8566270,cap:"butt"},stroke:{width:2,color:0xb0e298,dash:[20,5,5,5],cap:"butt"}},barrier:{casing:{alpha:0},stroke:{width:3,color:0xdddddd,dash:[10,5,2,5],cap:"round"}},barrier_wall:{casing:{alpha:0},stroke:{width:3,color:0xdddddd,dash:[10,5,2,5],cap:"round"}},barrier_hedge:{fill:{color:9228383,alpha:.3},casing:{alpha:0},stroke:{width:3,color:9228383,dash:[10,5,2,5],cap:"round"}},tree_row:{casing:{width:7,color:4473924},stroke:{width:5,color:9228383}},construction:{casing:{width:10,color:0xffffff},stroke:{width:8,color:0xfc6c14,dash:[10,10],cap:"butt"}},pipeline:{casing:{width:7,color:4473924},stroke:{width:5,color:0xdddddd,dash:[80,2],cap:"butt"}},roller_coaster:{casing:{width:7,color:4473924},stroke:{width:5,color:0xdddddd,dash:[10,1],cap:"butt"}}},tt={aeroway:{runway:"runway",taxiway:"taxiway"},amenity:{childcare:"yellow",college:"yellow",fountain:"blue",kindergarten:"yellow",parking:"darkgray",research_institute:"yellow",school:"yellow",university:"yellow"},building:{"*":"red"},barrier:{city_wall:"barrier_wall",hedge:"barrier_hedge",retaining_wall:"barrier_wall",wall:"barrier_wall","*":"barrier"},boundary:{protected_area:"boundary_park",national_park:"boundary_park","*":"boundary"},crossing:{marked:"crossing_marked",traffic_signals:"crossing_marked",uncontrolled:"crossing_marked",zebra:"crossing_marked","*":"crossing_unmarked"},golf:{green:"lightgreen"},highway:{bridleway:"bridleway",bus_guideway:"railway",busway:"special_service",corridor:"corridor",construction:"construction",cycleway:"cycleway",footway:"footway",living_street:"living_street",living_street_link:"living_street",motorway:"motorway",motorway_link:"motorway",path:"path",pedestrian:"pedestrian",primary:"primary",primary_link:"primary",residential:"residential",residential_link:"residential",secondary:"secondary",secondary_link:"secondary",service:"service",service_link:"service",steps:"steps",tertiary:"tertiary",tertiary_link:"tertiary",track:"track",trunk:"trunk",trunk_link:"trunk",unclassified:"unclassified",unclassified_link:"unclassified"},landuse:{cemetery:"lightgreen",commercial:"orange",construction:"gold",farmland:"lightgreen",farmyard:"tan",flowerbed:"green",forest:"green",grass:"green",industrial:"pink",landfill:"orange",meadow:"lightgreen",military:"orange",orchard:"lightgreen",quarry:"darkgray",railway:"darkgray",recreation_ground:"green",residential:"gold",retail:"orange",village_green:"green",vineyard:"lightgreen"},leisure:{garden:"green",golf_course:"green",nature_reserve:"green",park:"green",pitch:"green",swimming_pool:"blue",track:"yellow"},man_made:{adit:"darkgray",breakwater:"barrier_wall",groyne:"barrier_wall",pipeline:"pipeline"},military:{"*":"orange"},natural:{bare_rock:"darkgray",bay:"blue",beach:"yellow",cave_entrance:"darkgray",cliff:"darkgray",glacier:"lightgray",ridge:"ridge",rock:"darkgray",sand:"yellow",scree:"darkgray",scrub:"yellow",shingle:"darkgray",stone:"darkgray",strait:"blue",tree_row:"tree_row",water:"blue",wetland:"teal","*":"green"},power:{plant:"pink"},railway:{platform:"footway","*":"railway"},roller_coaster:{track:"roller_coaster"},route:{ferry:"ferry"},sport:{baseball:"yellow",basketball:"darkgray",beachvolleyball:"yellow",skateboard:"darkgray",softball:"yellow"},type:{waterway:"river"},waterway:{river:"river",dam:"DEFAULTS",weir:"DEFAULTS","*":"stream"},service:{alley:"special_service",driveway:"special_service","drive-through":"special_service",parking_aisle:"special_service","*":"special_service"}},tn=function(e){var t;let{line:n,nodePath:o,mapViewStatus:{viewpoint:i,zoom:a,width:r,height:d},status:{visible:c,hovered:u,selected:m,highlighted:p},layerRef:h,...f}=e,x=a>=16&&c,b=o.map(e=>w({lon:e["@_lon"],lat:e["@_lat"]},i,a,r,d)),g=(0,s.useRef)(null),y=(0,s.useRef)(null),v=function(e){let t;let n=te.DEFAULTS,o={};for(let t of e)o[t["@_k"]]=t["@_v"];let i=n,a=999;for(let[e,n]of Object.entries(o)){let r=tt[e];if(!r||!n||"service"===e&&void 0===o.highway)continue;let l=r[n]??r["*"],s=Object.keys(r).length;if(e9.has(n)&&(s=999),l&&s<=a){let n=te[l];if(!n){console.error(`invalid styleID: ${l}`);continue}if(i=n,a=s,t=e,1===a)break}}let r=!1;for(let[e,n]of Object.entries(o)){if(e9.has(e)&&"no"!==n){r=!0;break}if((!t||e===t)&&e9.has(n)){r=!0;break}if(!t&&e6.test(e)&&"no"!==n){r=!0;break}}let l={};for(let e of["fill","casing","stroke"]){var s,d,c,u,m,p,h,f,x,b,g,y;l[e]={};let t=null===(s=i[e])||void 0===s?void 0:s.width;if(void 0!==t&&"number"==typeof t)l[e].width=t;else{let t=null===(h=n[e])||void 0===h?void 0:h.width;void 0!==t&&(l[e].width=t)}let o=null===(d=i[e])||void 0===d?void 0:d.color;if(void 0!==o&&"number"==typeof o)l[e].color=o;else{let t=null===(f=n[e])||void 0===f?void 0:f.color;void 0!==t&&(l[e].color=t)}let a=null===(c=i[e])||void 0===c?void 0:c.alpha;if(void 0!==a&&"number"==typeof a)l[e].alpha=a;else{let t=null===(x=n[e])||void 0===x?void 0:x.alpha;void 0!==t&&(l[e].alpha=t)}let r=null===(u=i[e])||void 0===u?void 0:u.cap;if(void 0!==r&&"string"==typeof r)l[e].cap=r;else{let t=null===(b=n[e])||void 0===b?void 0:b.cap;void 0!==t&&(l[e].cap=t)}let v=null===(m=i[e])||void 0===m?void 0:m.join;if(void 0!==v&&"string"==typeof v)l[e].join=v;else{let t=null===(g=n[e])||void 0===g?void 0:g.join;void 0!==t&&(l[e].join=t)}let w=null===(p=i[e])||void 0===p?void 0:p.dash;if(void 0!==w&&Array.isArray(w))l[e].dash=w;else{let t=null===(y=n[e])||void 0===y?void 0:y.dash;void 0!==t&&(l[e].dash=t)}}let v=o.bridge,w=o.cutting,j=o.embankment,_=o.highway,N=o.tracktype,S=o.tunnel,k=o.surface;if("track"===_&&"grade1"!==N&&(k=k||"dirt"),(v||j||w)&&(l.casing.width=(l.casing.width||0)+7,l.casing.color=0,l.casing.cap="butt",(j||w)&&(l.casing.dash=[2,4])),S&&(l.stroke.alpha=.5),k&&_&&e8.has(_)&&!e7.surface[k]&&(v||(l.casing.color=0xcccccc),l.casing.cap="butt",l.casing.dash=[4,4]),r){let e=te.LIFECYCLE;for(let t of["fill","casing","stroke"])if(e[t])for(let[n,o]of Object.entries(e[t]))l[t][n]=o}return l}(R(n.tag)),j=(0,s.useMemo)(()=>{var e;let t=Math.max(3,(null==v?void 0:null===(e=v.casing)||void 0===e?void 0:e.width)||0);return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=eK([e[0],e[1]],[e[e.length-2],e[e.length-1]],1e-4),o=new eH.mgq(e);t.native=!1,o.closeStroke=!1;let i={closePointEps:1e-4,indices:[],points:[],uvs:[]};eH.yRe.buildLine({shape:o,lineStyle:t},i);let a=i.points,r=i.indices,l=new Map,s=[],d=[],c=[NaN,NaN],u=[NaN,NaN],m=0,p=0,h=[NaN,NaN],f=[NaN,NaN],x=[NaN,NaN],b=NaN,g=NaN,y=NaN;for(let e=0;e<r.length;e+=3){let t=r[e],n=r[e+1],o=r[e+2],i=[a[2*t],a[2*t+1]],v=[a[2*n],a[2*n+1]],w=[a[2*o],a[2*o+1]];if(0===e)l.set(t,!0),l.set(n,!1),l.set(o,!0),s.push(i),d.push(v),s.push(w),u=v,c=w,m=eX(i,w);else{let e,a,r,j=l.get(t),_=l.get(n),N=l.get(o);void 0===j&&eK(i,h,1e-4)&&(j=l.get(b),l.set(t,j)),void 0===_&&eK(v,f,1e-4)&&(_=l.get(g),l.set(n,_)),void 0===N&&eK(w,x,1e-4)&&(N=l.get(y),l.set(o,N)),void 0===j&&(e=t,a=i,r=!N),void 0===_&&(e=n,a=v,r=!j),void 0===N&&(e=o,a=w,r=!_),void 0!==e&&(l.set(e,r),!0===r?(s.push(a),m+=eX(c,a),c=a):(d.push(a),p+=eX(u,a),u=a))}h=i,f=v,x=w,b=t,g=n,y=o}let v={},w=Array(2*(s.length+d.length+1)),j=0;for(let e=0;e<s.length;++j,++e)w[2*j]=s[e][0],w[2*j+1]=s[e][1];for(let e=d.length-1;e>=0;++j,--e)w[2*j]=d[e][0],w[2*j+1]=d[e][1];if(w[2*j]=s[0][0],w[2*j+1]=s[0][1],v.perimeter=w,n){let e=p>m?d:s,t=Array((e.length+1)*2);for(let n=0;n<e.length;++n)t[2*n]=e[n][0],t[2*n+1]=e[n][1];t[2*e.length]=e[0][0],t[2*e.length+1]=e[0][1],v.outer=t}return v}(b.flatMap(e=>[e.x,e.y]),{alignment:.5,color:0,width:t+10,alpha:1,join:eH.Sat.BEVEL,cap:eH.$oy.BUTT})},[b,v]),_=(0,s.useCallback)(e=>{e.clear();let t=v.casing||{};t.dash?e=new eW.d(e,{dash:t.dash,color:t.color,width:t.width,alpha:t.alpha||1,join:eY(t.join),cap:eJ(t.cap)}):e.lineStyle({color:t.color,width:t.width,alpha:t.alpha||1,join:eY(t.join),cap:eJ(t.cap)});let[n,...o]=b;e.moveTo(n.x,n.y),o.forEach(t=>{e.lineTo(t.x,t.y)})},[b,v.casing]),N=(0,s.useCallback)(e=>{e.clear();let t=v.stroke||{};t.dash?e=new eW.d(e,{dash:t.dash,color:t.color,width:t.width,alpha:t.alpha||1,join:eY(t.join),cap:eJ(t.cap)}):e.lineStyle({color:t.color,width:t.width,alpha:t.alpha||1,join:eY(t.join),cap:eJ(t.cap)});let[n,...o]=b;e.moveTo(n.x,n.y),o.forEach(t=>{e.lineTo(t.x,t.y)})},[b,v]),S=(0,s.useCallback)(()=>{g.current&&j.perimeter&&(g.current.hitArea=new eH.mgq(j.perimeter))},[g,j]);(0,s.useEffect)(()=>{let e=g.current;null!==e&&(S(),(()=>{let t=x&&u,n=x&&m,o=x&&p;if(t){if(!e.filters){let t=new ez.Vw({distance:15,outerStrength:3,color:0xffff00});t.resolution=2,e.filters=[t]}}else if(o){if(!e.filters){let t=new ez.Vw({distance:15,outerStrength:3,color:7377663});t.resolution=2,e.filters=[t]}}else e.filters&&(e.filters=null);if(n&&h.current){y.current||(y.current=new eH.TCu,h.current.addChild(y.current)),y.current.clear();let e=new eW.d(y.current,{alpha:.9,dash:[6,3],width:2,color:0xff0000});j&&(j.outer&&j.inner?(e.drawPolygon(j.outer),e.drawPolygon(j.inner)):e.drawPolygon(j.perimeter))}else y.current&&(y.current.destroy({children:!0}),y.current=null)})())},[p,u,m,x,S,j,h]),(0,s.useEffect)(()=>()=>{y.current&&!y.current.destroyed&&(y.current.destroy({children:!0}),y.current=null)},[]);let k=function(e){let t={yes:!0,1:!0,"-1":!0,reversible:!0,alternating:!0,no:!1,0:!1},n=null;return(e.forEach(e=>{"oneway"===e["@_k"]&&t[e["@_v"]]&&(n=t[e["@_v"]])}),null!==n)?n:(e.forEach(e=>{e["@_k"]in e4&&e["@_v"]in e4[e["@_k"]]&&(n=!0)}),!!n)}(R(n.tag)),M=!(t=R(n.tag)).some(e=>"two_sided"===e["@_k"]&&"yes"===e["@_v"])&&null!==(()=>{for(let e=0;e<t.length;e++){let n=t[e]["@_k"],o=t[e]["@_v"],i=function(e){let t=e.split(":");return 1===t.length?e:t[0]in e3?e.slice(t[0].length+1):e}(n);if(i in e5&&o in e5[i]){if(e5[i][o])return i;return e5[i][o]}}return null})();return(0,l.jsxs)(eG.W2,{visible:x,position:{x:0,y:0},ref:g,...f,children:[(0,l.jsx)(eG.TC,{draw:_}),(0,l.jsx)(eG.TC,{draw:N}),k&&eZ(b.map(e=>[e.x,e.y]),35,!1,!0).map((e,t)=>e.coords.map((n,o)=>{let[i,a]=n;return(0,l.jsx)(eG.jy,{eventMode:"none",width:8,height:8,texture:e2,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:i,y:a},rotation:e.angle,tint:0},`${t}-${o}`)})).flat(),M&&eZ(b.map(e=>[e.x,e.y]),35,!0,!0).map((e,t)=>e.coords.map((n,o)=>{let[i,a]=n;return(0,l.jsx)(eG.jy,{eventMode:"none",width:8,height:8,texture:e2,sortableChildren:!1,anchor:{x:.5,y:.5},position:{x:i,y:a},rotation:e.angle,tint:0},`${t}-${o}`)})).flat()]})};var to=((a={}).BUS_STOP="bus stop",a.STOP_POSITION="stop posistion",a),ti=((r={}).ROUTE="route",r.ROUTE_MASTER="route master",r.STOP_AREA="stop area",r);function ta(e){return(e=e||[]).some(e=>"public_transport"===e["@_k"]&&"platform"===e["@_v"])&&e.some(e=>"highway"===e["@_k"]&&"bus_stop"===e["@_v"])}function tr(e){return(e=e||[]).some(e=>"public_transport"===e["@_k"]&&"stop_position"===e["@_v"])}function tl(e){var t;return null===(t=(e=e||[]).find(e=>"name"===e["@_k"]))||void 0===t?void 0:t["@_v"]}function ts(e){return e?ta(e)?to.BUS_STOP:tr(e)?to.STOP_POSITION:void 0:void 0}({...to,...ti});let td=function(e){let{node:t,mapViewStatus:{width:n,height:o,viewpoint:i,zoom:a},status:{visible:r,hovered:d,selected:c,highlighted:u},layerRef:m,...p}=e,h=a>=16&&r,f=(0,s.useRef)(null),x=(0,s.useRef)(null),b=ta(R(t.tag)),g=w({lon:t["@_lon"],lat:t["@_lat"]},i,a,n,o),y=(0,s.useMemo)(()=>tl(t.tag),[t.tag]),v=(0,s.useMemo)(()=>b?16:8,[b]);return((0,s.useEffect)(()=>{let e=f.current;e&&((()=>{if(!h)return;let t=new eH.Cdc(0,0,Math.max(10,v/2+5));e.hitArea=t})(),(()=>{let t=h&&d,n=h&&u,o=h&&c;if(t){if(!e.filters){let t=new ez.Vw({distance:15,outerStrength:3,color:0xffff00});t.resolution=2,e.filters=[t]}}else if(n){if(!e.filters){let t=new ez.Vw({distance:15,outerStrength:3,color:7377663});t.resolution=2,e.filters=[t]}}else e.filters&&(e.filters=null);if(o&&m.current){console.log("show select"),x.current||(x.current=new eH.TCu,m.current.addChild(x.current));let t={alpha:.9,dash:[6,3],width:3,color:0xff0000};x.current.clear();let n=e.hitArea;n instanceof eH.Cdc?(new eW.d(x.current,t).drawCircle(n.x+g.x,n.y+g.y,n.radius,20),console.log(x.current)):n instanceof eH.AeJ&&new eW.d(x.current,t).drawRect(n.x+g.x,n.y+g.y,n.width,n.height)}else x.current&&(x.current.destroy({children:!0}),x.current=null)})())},[a,u,d,h,"dot",c,m,g]),(0,s.useEffect)(()=>()=>{x.current&&!x.current.destroyed&&(x.current.destroy({children:!0}),x.current=null)},[]),(0,s.useEffect)(()=>{let e=f.current;e&&(a<16||(a<17?e.scale.set(.8,.8):e.scale.set(1,1)))},[a]),a<16)?null:(0,l.jsxs)(eG.W2,{...p,position:g,visible:h,ref:f,children:[(0,l.jsx)(eG.jy,{eventMode:"none",sortableChildren:!1,visible:!0,texture:e0,anchor:{x:.5,y:.5},width:v,height:v}),b&&(0,l.jsx)(eG.jy,{eventMode:"none",texture:e1,anchor:{x:.5,y:.5},width:11,height:11}),y&&a>16&&(0,l.jsx)(eG.xv,{text:y,anchor:.5,x:0,y:b?24:16,style:new eH.pn8({align:"center",fontFamily:'"Source Sans Pro", Helvetica, sans-serif',fontSize:12,fontWeight:"400",fill:"#ffffff",stroke:"#000000",strokeThickness:2,dropShadow:!0,dropShadowColor:"#ccced2",dropShadowBlur:3,dropShadowAngle:Math.PI/6,dropShadowDistance:2,wordWrap:!0,wordWrapWidth:440})})]})};var tc=n(3475);let tu=(0,s.forwardRef)(function(e,t){let{view:{width:n,height:o,viewpoint:i,zoom:a},meta:{node:r,way:d},pointRenderer:c,wayRenderer:u,...m}=e,{left:p,bottom:h,right:f,top:x}=(0,s.useMemo)(()=>_(i,a,n,o),[i,a,n,o]),b=(0,s.useCallback)(e=>{let{"@_lon":t,"@_lat":n}=e;return p<=t&&t<=f&&h<=n&&n<=x},[p,h,f,x]);return a<16?null:(0,l.jsxs)(eG.W2,{ref:t,...m,children:[Object.values(d).filter(e=>e.nd.map(e=>r[e["@_ref"]]).some(b)).map(u),Object.values(r).filter(b).map(c)]})});function tm(e){let{selectionRect:t}=e;if(!t)return null;let{from:n,to:o}=t,i=Math.min(n.x,o.x),a=Math.min(n.y,o.y),r=Math.abs(o.x-n.x),s=Math.abs(o.y-n.y);return(0,l.jsx)(eG.TC,{draw:e=>{e.clear(),e.beginFill(0xffa500,.5),e.drawRect(i,a,r,s),e.endFill()}})}function tp(e){let{node:t,stateMachine:n,...o}=e,i=t["@_localStates"],a=t["@_id"];return(0,l.jsx)(td,{...o,node:t,status:i,eventMode:"static",mousedown:e=>n.transform({...e,componentTarget:{id:a,type:"node"}}),mouseup:e=>n.transform({...e,componentTarget:{id:a,type:"node"}}),pointerover:e=>n.transform({...e,componentTarget:{id:a,type:"node"}}),pointerout:e=>n.transform({...e,componentTarget:{id:a,type:"node"}})})}function th(e){let{way:t,node:n,stateMachine:o,...i}=e,a=t["@_localStates"],r=t["@_id"],d=(0,s.useMemo)(()=>t.nd.map(e=>n[e["@_ref"]]),[n,t.nd]);return(0,l.jsx)(tn,{...i,line:t,nodePath:d,status:a,eventMode:"static",pointerover:e=>o.transform({...e,componentTarget:{id:r,type:"way"}}),pointerout:e=>o.transform({...e,componentTarget:{id:r,type:"way"}}),mousedown:e=>o.transform({...e,componentTarget:{id:r,type:"way"}}),mouseup:e=>o.transform({...e,componentTarget:{id:r,type:"way"}})})}let tf=function(e){let{width:t,height:n,stateMachine:o}=e,[i,a,r]=x((0,tc.N)(e=>[e.viewpoint,e.zoom,e.selectionRect])),{node:d,way:c}=eL(e=>e.meta),u=(0,s.useRef)(null);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(tu,{view:{viewpoint:i,zoom:a,width:t,height:n},meta:{node:d,way:c},ref:u,wayRenderer:e=>(0,l.jsx)(th,{way:e,node:d,stateMachine:o,mapViewStatus:{width:t,height:n,viewpoint:i,zoom:a},layerRef:u},e["@_id"]),pointRenderer:e=>(0,l.jsx)(tp,{node:e,stateMachine:o,mapViewStatus:{width:t,height:n,viewpoint:i,zoom:a},layerRef:u},e["@_id"])}),(0,l.jsx)(tm,{selectionRect:r})]})};function tx(e,t,n){let o={"?xml":{"@_version":"1.0","@_encoding":"UTF-8"},osm:{bounds:{"@_minlat":n.reduce((e,t)=>Math.min(e,t.osm.bounds["@_minlat"]),1/0),"@_minlon":n.reduce((e,t)=>Math.min(e,t.osm.bounds["@_minlon"]),1/0),"@_maxlat":n.reduce((e,t)=>Math.max(e,t.osm.bounds["@_maxlat"]),-1/0),"@_maxlon":n.reduce((e,t)=>Math.max(e,t.osm.bounds["@_maxlon"]),-1/0),"@_origin":"v0.0.2-BusFensi"},node:Object.values({...e.node,...t.node}),way:Object.values({...e.way,...t.way}),relation:Object.values({...e.relation,...t.relation}),"@_version":.6,"@_generator":"BusFensi"}};console.log(o,e);let i=new eh.XMLBuilder({ignoreAttributes:["localStates"],attributeNamePrefix:"@_",suppressBooleanAttributes:!1}).build(o);return console.log(i),i}function tb(e){let{stateMachine:t}=e,{createLocalWay:n,createLocalRelation:o,deleteFeature:i,selectFeature:a,clearSelect:r,selectedRef:d,meta:c,bbox:u,deletedMeta:m}=eL((0,tc.N)(e=>e)),{updateSettingsAction:p,...h}=eU(),[f,x]=(0,s.useState)(!1),[b,g]=(0,s.useState)(h);return(0,l.jsxs)("div",{className:"join",children:[(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>t.transform({type:"add-node"}),children:"Create Node"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>t.transform({type:"add-node-on-way"}),children:"Create node on way"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>t.transform({type:"split-way"}),children:"Split way"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>{a("way",n(d.filter(e=>"node"===e.type).map(e=>({"@_ref":e.id}))),!1)},children:"Create way with select"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>{a("relation",o(d.map(e=>({"@_ref":e.id,"@_type":e.type}))),!1)},children:"Create relation with select"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>{let e=M(d);r(),e.forEach(e=>{if("node"===e.type||"way"===e.type||"relation"===e.type)i(e.type,e.id);else throw Error(`Type not found ${e.type} for id ${e.id}`)})},children:"Delete selected"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>{let e=new Blob([tx(c,m,u)],{type:"application/xml"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="exported_data.osm",t.click(),URL.revokeObjectURL(t.href)},children:"export josm"}),(0,l.jsx)("button",{className:"btn btn-sm join-item",onMouseDown:()=>x(!0),children:"Change Settings"}),f&&(0,l.jsx)("div",{className:"modal modal-open",children:(0,l.jsxs)("div",{className:"modal-box",children:[(0,l.jsx)("h3",{className:"font-bold text-lg",children:"Change Settings"}),(0,l.jsxs)("div",{className:"py-4",children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"OSM API Base URL"})}),(0,l.jsx)("input",{type:"text",value:b.osmAPI.BASEURL,onChange:e=>g({...b,osmAPI:{...b.osmAPI,BASEURL:e.target.value}}),className:"input input-bordered w-full"})]}),(0,l.jsxs)("div",{className:"py-4",children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"OSM API Tile Source"})}),(0,l.jsx)("input",{type:"text",value:b.osmAPI.TILE_SOURCE,onChange:e=>g({...b,osmAPI:{...b.osmAPI,TILE_SOURCE:e.target.value}}),className:"input input-bordered w-full"})]}),(0,l.jsxs)("div",{className:"py-4",children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"Max Zoom Level"})}),(0,l.jsx)("input",{type:"number",value:b.view.MAX_ZOOM,onChange:e=>g({...b,view:{...b.view,MAX_ZOOM:parseFloat(e.target.value)}}),className:"input input-bordered w-full"})]}),(0,l.jsxs)("div",{className:"modal-action",children:[(0,l.jsx)("button",{className:"btn",onClick:()=>{p(b),x(!1)},children:"Save"}),(0,l.jsx)("button",{className:"btn btn-ghost",onClick:()=>x(!1),children:"Cancel"})]})]})})]})}var tg=n(5706);let ty=e=>{let{id:t="drag-bar",dir:n,isDragging:o,...i}=e,[a,r]=(0,s.useState)(!1);return(0,l.jsx)("div",{id:t,"data-testid":t,tabIndex:0,className:T("flex-shrink-0 bg-base-300 transition-colors","horizontal"===n?"cursor-row-resize h-1":"cursor-col-resize w-1",(o||a)&&"bg-accent"),onFocus:()=>r(!0),onBlur:()=>r(!1),...i})},tv=e=>{let{width:t,height:n,children:o,...i}=e,{axis:a}=i,r=i.initial||("x"===a?t/2:n/2),{position:d,separatorProps:c,setPosition:u}=(0,tg.L)({...i,initial:r}),m=(0,s.useRef)("x"===a?t:n),p={},h={};return"x"===a?(p={width:d,height:n},h={width:t-d,height:n}):(p={width:t,height:d},h={width:t,height:n-d}),(0,s.useEffect)(()=>{"x"===a&&t!==m.current?(u(d*(t/m.current)),m.current=t):"y"===a&&n!==m.current&&(u(d*(n/m.current)),m.current=n)},[t,n,m,a,u,d]),(0,l.jsxs)("div",{style:{width:t,height:n,display:"flex",flexDirection:"x"===a?"row":"column",position:"relative"},children:[(0,l.jsx)("div",{style:p,children:o[0]({width:p.width,height:p.height})}),(0,l.jsx)(ty,{...c,dir:"x"===a?"vertical":"horizontal",isDragging:!1}),(0,l.jsx)("div",{style:h,children:o[1]({width:h.width,height:h.height})})]})};function tw(e){let{children:t}=e;return(0,l.jsx)("ul",{className:"menu menu-xs",children:t})}var tj=n(2163),t_=n(7596);function tN(e){let t,{featuretype:n,metatype:o,fullname:i,id:a,created:r,deleted:s,modified:d,children:c}=e;switch(n){case"node":t=t_.W3K;break;case"way":t=t_.KJ_;break;case"relation":t=t_.Hw7;break;default:t=t_.Psp}return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("span",{children:(0,l.jsx)(tj.G,{icon:t})}),(0,l.jsx)("span",{className:"font-semibold",children:i||"[untitled]"}),o&&(0,l.jsx)("span",{className:"badge badge-xs h-fit badge-outline text-nowrap",children:o}),(0,l.jsx)("div",{className:"badge badge-xs h-fit badge-outline",children:a}),(0,l.jsxs)("div",{className:"flex space-x-1",children:[r&&(0,l.jsx)("div",{className:"badge badge-xs badge-success tooltip tooltip-bottom","data-tip":"Created",children:(0,l.jsx)(tj.G,{icon:t_.r8p})}),d&&(0,l.jsx)("div",{className:"badge badge-xs badge-warning tooltip tooltip-bottom","data-tip":"Modified",children:(0,l.jsx)(tj.G,{icon:t_.Xcf})}),s&&(0,l.jsx)("div",{className:"badge badge-xs badge-error tooltip tooltip-bottom","data-tip":"Deleted",children:(0,l.jsx)(tj.G,{icon:t_.$aW})})]}),(0,l.jsx)("span",{className:"flex items-center ml-auto",children:c})]})}function tS(e){return(0,l.jsxs)("li",{children:[" ",(0,l.jsx)("span",{className:"flex select-text justify-between items-center rounded",children:(0,l.jsx)(tN,{...e})})]})}var tk=n(9467),tM=n(9814),tE=n(2619),tC=n(1908);function tR(e){let{show:t,proceed:n,title:o,message:i}=e,a=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=a.current;e&&(t?e.showModal():e.close())},[t]);let r=()=>{n(!1)};return(0,l.jsxs)("dialog",{ref:a,className:"modal",onClose:r,children:[(0,l.jsxs)("div",{className:"modal-box",children:[o&&(0,l.jsx)("h3",{className:"font-bold text-lg mb-2",children:o}),(0,l.jsx)("p",{children:i}),(0,l.jsxs)("div",{className:"modal-action",children:[(0,l.jsx)("button",{type:"button",className:"btn btn-md",onClick:r,children:"Cancel"}),(0,l.jsx)("button",{type:"button",className:"btn btn-primary",onClick:()=>{console.debug("clicking delete ok: "),n(!0)},children:"OK"})]})]}),(0,l.jsx)("form",{method:"dialog",className:"modal-backdrop",children:(0,l.jsx)("button",{children:"close"})})]})}let tT=(0,tC.confirmable)(e=>(0,l.jsx)(tR,{...e}));tT.displayName="ConfirmableSimpleConfirmation";var tO=n(5509);function tA(e){return"stop_area"===eC("public_transport",e=e||[])&&"public_transport"===eC("type",e)}function tP(e){return"route"===eC("type",e=e||[])}function tD(e){return"route_master"===eC("type",e=e||[])}function tI(e){if(e){if(!tA(e)){if(tP(e))return ti.ROUTE;if(tD(e))return ti.ROUTE_MASTER}}}var tL=n(3805);function tF(e){var t,n,o;let{type:i,meta:a,showMetaType:r,children:d}=e,c=a["@_id"],[u,m,p,h]=eL((0,tc.N)(e=>[e.selectFeature,e.unSelectFeature,e.deleteFeature,e.restoreDeletedFeature])),f=x(e=>e.setViewpoint),b=(0,tC.createConfirmation)(tT),g=(0,s.useMemo)(()=>{var e;if(r&&(null===(e=a.tag)||void 0===e?void 0:e.length)){if("node"===i)return ts(a.tag);if("relation"===i)return tI(a.tag)}},[r,a.tag,i]),y=(0,s.useCallback)(e=>{e.stopPropagation(),"node"===i&&f({lat:a["@_lat"],lon:a["@_lon"]})},[a,f,i]),v=(0,s.useCallback)(e=>{var t;e.stopPropagation(),(null===(t=a["@_localStates"])||void 0===t?void 0:t.selected)?m(i,c):u(i,c,!1)},[c,a,u,i,m]),w=(0,s.useCallback)(async e=>{e.stopPropagation(),console.debug("deleting: ",i,c);let t=await b({title:"Confirm delete feature",message:"Are you sure you want delete this feature?\n"+(tl(a.tag||[])||c)});console.debug("confirmed deleting: ",t,i,c),t&&p(i,c)},[b,p,c,a.tag,i]),j="delete"===a["@_action"];return(0,l.jsxs)(tS,{featuretype:i,id:c,metatype:g,fullname:tl(a.tag),created:0>Number(a["@_id"]),deleted:j,modified:"modify"===a["@_action"],children:[!j&&(0,l.jsxs)(l.Fragment,{children:["node"===i&&(0,l.jsx)("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:y,children:(0,l.jsx)(tj.G,{icon:tk.faLocationDot})}),(0,l.jsx)("button",{className:T("btn btn-xs btn-square tooltip tooltip-bottom",(null===(t=a["@_localStates"])||void 0===t?void 0:t.selected)&&"btn-accent"),"data-tip":(null===(n=a["@_localStates"])||void 0===n?void 0:n.selected)?"Unselect":"Select",onClick:v,children:(0,l.jsx)(tj.G,{icon:(null===(o=a["@_localStates"])||void 0===o?void 0:o.selected)?tO.faXmarkCircle:tM.faCheckCircle})}),(0,l.jsx)("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Delete",onClick:w,children:(0,l.jsx)(tj.G,{icon:tE.faTrash})})]}),j&&(0,l.jsx)("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Restore",onClick:()=>h(i,c),children:(0,l.jsx)(tj.G,{icon:tL.faClockRotateLeft})}),d&&d({type:i,meta:a})]})}var t$=n(774),tB=n(1145),tU=n(5394),tG=n(9970),tq=n(6767);function tV(e){let{node:t,way:n,relation:o,filter:i,...a}=e;return i=i||(()=>!0),(0,l.jsxs)(tw,{children:[(t||[]).filter(e=>i(e,"node")).map(e=>(0,s.createElement)(tF,{...a,key:e["@_id"],meta:e,type:"node"})),(n||[]).filter(e=>i(e,"way")).map(e=>(0,s.createElement)(tF,{...a,key:e["@_id"],meta:e,type:"way"})),(o||[]).filter(e=>i(e,"relation")).map(e=>(0,s.createElement)(tF,{...a,key:e["@_id"],meta:e,type:"relation"}))]})}function tW(e){let{name:t,defaultOpen:n,forceOpen:o,forceClose:i,children:a}=e,[r,d]=(0,s.useState)(!n),c=!!o||!i&&!r;return(0,l.jsxs)("li",{className:"outline-list-item",children:[(0,l.jsxs)("span",{className:"flex flex-row",onClick:e=>{e.stopPropagation(),i||o||d(!r)},children:[(0,l.jsx)(tj.G,{icon:o?tq.faMinus:i?tG.faX:c?tB.faChevronDown:tU.faChevronRight}),(0,l.jsx)(tj.G,{icon:t$.faBars,className:"ml-1"}),(0,l.jsx)("span",{className:"ml-0 mr-auto",children:t})]}),c&&a]})}function tH(e){let t=eL(e=>e.meta.node);return(0,l.jsx)(tW,{name:"bus stop",children:(0,l.jsx)(tV,{...e,node:Object.values(t).filter(e=>ta(e.tag))})})}function tz(e){let t=eL(e=>e.meta.relation);return(0,l.jsx)(tW,{name:"stop area",children:(0,l.jsx)(tV,{...e,relation:Object.values(t).filter(e=>tA(e.tag))})})}function tK(e){let t=eL(e=>e.meta.node);return(0,l.jsx)(tW,{name:"stop position",children:(0,l.jsx)(tV,{...e,node:Object.values(t).filter(e=>tr(e.tag))})})}var tX=n(7724);function tZ(e){let{children:t}=e,[n,o]=(0,s.useState)(""),i=(e,t)=>""===n||`${t}-${JSON.stringify(e)}`.toLocaleLowerCase().includes(n.toLocaleLowerCase());return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("label",{className:"input input-xs input-bordered flex items-center gap-2 w-full mt-1 mx-auto",children:[(0,l.jsx)(tj.G,{icon:tX.faSearch}),(0,l.jsx)("input",{type:"text",className:"grow",placeholder:"Search",value:n,onChange:e=>o(e.target.value)})]}),(0,l.jsx)("div",{className:"outline-list flex-1 rounded overflow-scroll",children:(0,l.jsx)("ul",{className:"menu menu-xs",children:R(t).map((e,t)=>(0,l.jsxs)("div",{children:[" ",e({filter:i})]},t))})})]})}function tJ(){return(0,l.jsxs)(tZ,{children:[e=>{let{filter:t}=e;return(0,l.jsx)(tH,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(tK,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(tz,{filter:t})}]})}function tY(e){return 0>Number(e["@_id"])}function tQ(e){let{relation:t,way:n,node:o}=eL(e=>e.meta),i=(0,s.useMemo)(()=>Object.values(eO(t,tY)),[t]),a=(0,s.useMemo)(()=>Object.values(eO(n,tY)),[n]),r=(0,s.useMemo)(()=>Object.values(eO(o,tY)),[o]);return(0,l.jsx)(tW,{name:"created",children:(0,l.jsx)(tV,{...e,relation:i,way:a,node:r})})}let t0=e=>{let{left:t,right:n,bottom:o,top:i}=e;return e=>{let a=e=>{let{"@_lon":a,"@_lat":r}=e;return t<=a&&a<=n&&o<=r&&r<=i},r=t=>e.meta.node[t["@_ref"]];return{node:Object.entries(e.meta.node).filter(e=>{let[,t]=e;return a(t)}).reduce((e,t)=>({...e,[t[0]]:t[1]}),{}),way:Object.entries(e.meta.way).filter(e=>{let[,t]=e;return t.nd.map(r).some(a)}).reduce((e,t)=>({...e,[t[0]]:t[1]}),{}),relation:Object.entries(e.meta.relation).filter(e=>{let[,t]=e;return t.member.filter(e=>"node"===e["@_type"]&&r(e)).map(r).some(a)}).reduce((e,t)=>({...e,[t[0]]:t[1]}),{})}}};function t1(e){let t=e.activeRef;return t?{type:t.type,meta:e.meta[t.type][t.id]}:null}let t2=e=>t=>{let n=t.selectedRef;return n.length?n.filter(t=>t.type===e).map(n=>t.meta[e][n.id]):[]},t3=e=>e.deletedMeta;function t4(e){let{relation:t,way:n,node:o}=eL((0,tc.N)(t3)),i=(0,s.useMemo)(()=>Object.values(t),[t]),a=(0,s.useMemo)(()=>Object.values(n),[n]),r=(0,s.useMemo)(()=>Object.values(o),[o]);return(0,l.jsx)(tW,{name:"deleted",children:(0,l.jsx)(tV,{...e,relation:i,way:a,node:r})})}function t5(e){return"modify"===e["@_action"]}function t7(e){let{relation:t,way:n,node:o}=eL(e=>e.meta),i=(0,s.useMemo)(()=>Object.values(eO(t,t5)),[t]),a=(0,s.useMemo)(()=>Object.values(eO(n,t5)),[n]),r=(0,s.useMemo)(()=>Object.values(eO(o,t5)),[o]);return(0,l.jsx)(tW,{name:"modified",children:(0,l.jsx)(tV,{...e,relation:i,way:a,node:r})})}function t8(){return(0,l.jsxs)(tZ,{children:[e=>{let{filter:t}=e;return(0,l.jsx)(tQ,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(t7,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(t4,{filter:t})}]})}function t9(e){let t=eL(e=>e.meta.relation);return(0,l.jsx)(tW,{name:"route",children:(0,l.jsx)(tV,{...e,relation:Object.values(t).filter(e=>tP(e.tag))})})}function t6(e){let t=eL(e=>e.meta.relation);return(0,l.jsx)(tW,{name:"route master",children:(0,l.jsx)(tV,{...e,relation:Object.values(t).filter(e=>tD(e.tag))})})}function ne(){return(0,l.jsxs)(tZ,{children:[e=>{let{filter:t}=e;return(0,l.jsx)(t9,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(t6,{filter:t})}]})}function nt(e){let t=eL((0,tc.N)(t1));return(0,l.jsx)(tW,{name:"active",forceOpen:!0,children:(0,l.jsx)(tV,{...e,node:(null==t?void 0:t.type)==="node"?[t.meta]:void 0,way:(null==t?void 0:t.type)==="way"?[t.meta]:void 0,relation:(null==t?void 0:t.type)==="relation"?[t.meta]:void 0,showMetaType:!0})})}var nn=n(7886);function no(e){let t=eL((0,tc.N)(t2("node"))),n=eL((0,tc.N)(t2("way"))),o=eL((0,tc.N)(t2("relation"))),i=eL(e=>e.selectFeature),a=(0,s.useCallback)(e=>{let{type:t,meta:n}=e;return(0,l.jsx)("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Active",onClick:async e=>{e.stopPropagation(),console.debug("activating: ",t,n["@_id"]),i(t,n["@_id"],!1)},children:(0,l.jsx)(tj.G,{icon:nn.faStarOfLife})})},[i]);return(0,l.jsx)(tW,{name:"selected",defaultOpen:!0,children:(0,l.jsx)(tV,{...e,node:t,way:n,relation:o,showMetaType:!0,children:a})})}function ni(){return(0,l.jsxs)(tZ,{children:[e=>{let{filter:t}=e;return(0,l.jsx)(nt,{filter:t})},e=>{let{filter:t}=e;return(0,l.jsx)(no,{filter:t})}]})}function na(e){let{width:t,height:n}=e,o=[{title:"Bus stop",tab:()=>(0,l.jsx)(tJ,{})},{title:"Route",tab:()=>(0,l.jsx)(ne,{})},{title:"Changes",tab:()=>(0,l.jsx)(t8,{})},{title:"Selected",tab:()=>(0,l.jsx)(ni,{})}],[i,a]=(0,s.useState)(0);return(0,l.jsxs)("div",{style:{width:t,height:n},className:"flex flex-col",children:[(0,l.jsx)("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs",children:o.map((e,t)=>(0,l.jsx)("a",{onClick:()=>a(t),role:"tab",className:T("tab",t===i&&"tab-active"),children:e.title},t))}),(0,l.jsx)("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:o[i].tab()})]})}let nr=(0,s.memo)(e=>{let{initialValue:t,onCommit:n,...o}=e,[i,a]=(0,s.useState)(t||"");return(0,s.useEffect)(()=>{a(t||"")},[t]),(0,l.jsx)("input",{...o,value:i,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur(),e.stopPropagation()},onBlur:()=>{n(i)}})}),nl=function(e){let{tags:t,setTags:n,commitChange:o}=e,i=M(t),a=(e,t)=>{o(),i[e]["@_k"]=t,n([...i])},r=(e,t)=>{o(),i[e]["@_v"]=t,n([...i])},s=e=>{let t=i.filter((t,n)=>n!==e);o(),n(t)};return(0,l.jsxs)("table",{className:"table table-xs w-full max-w-full overflow-x-scroll",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"Key"}),(0,l.jsx)("th",{children:"Value"}),(0,l.jsx)("th",{children:"Actions"})]})}),(0,l.jsx)("tbody",{children:i.map((e,t)=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:(0,l.jsx)(nr,{type:"text",initialValue:e["@_k"],onCommit:e=>a(t,e),className:"input input-bordered input-xs rounded-md border max-w-xs"})}),(0,l.jsx)("td",{children:(0,l.jsx)(nr,{type:"text",initialValue:e["@_v"],onCommit:e=>r(t,e),className:"input input-bordered input-xs rounded-md border max-w-xs w-fit"})}),(0,l.jsx)("td",{children:(0,l.jsx)("button",{onClick:()=>s(t),className:"btn btn-error btn-xs",children:(0,l.jsx)(tj.G,{icon:t_.bLj})})})]},t))}),(0,l.jsx)("tfoot",{children:(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:3,className:"flex gap-2",children:(0,l.jsx)("button",{onClick:()=>{o(),n([...i,{"@_k":"","@_v":""}])},className:"btn btn-primary btn-sm",children:"Add"})})})})]})},ns=function(e){let{meta:t}=e,n=E(t).filter(e=>{let n=t[e];return e.startsWith("@_")&&("string"==typeof n||"number"==typeof n)});return(0,l.jsx)("ul",{className:"menu menu-xs bg-200 rounded-box",children:n.map(e=>{let n=t[e];return(0,l.jsx)("li",{children:(0,l.jsxs)("span",{className:"select-text",children:[(0,l.jsx)("span",{className:"font-semibold",children:String(e).substring(2)}),(0,l.jsx)("span",{className:"ml-auto text-base-content",children:n.toString()})]})},e)})})};function nd(e){var t,n,o;let{type:i,id:a,showMetaType:r,children:d}=e,[c,u,m,p]=eL((0,tc.N)(e=>[e.meta[i][a],e.selectFeatureWithoutActive,e.unSelectFeature,e.loadFeature])),h=eU(e=>e.osmAPI.BASEURL),f=x(e=>e.setViewpoint),b=(0,s.useMemo)(()=>{var e;if(r&&(null==c?void 0:null===(e=c.tag)||void 0===e?void 0:e.length)){if("node"===i)return ts(c.tag);if("relation"===i)return tI(c.tag)}},[r,null==c?void 0:c.tag,i]),[g,y]=(0,s.useState)(!1),v=(0,s.useCallback)(async()=>{y(!0),await p(i,a,h),y(!1)},[p,i,a,h]),w=(0,s.useCallback)(e=>{e.stopPropagation(),"node"===i&&f({lat:c["@_lat"],lon:c["@_lon"]})},[c,f,i]),j=(0,s.useCallback)(e=>{var t;e.stopPropagation(),(null===(t=c["@_localStates"])||void 0===t?void 0:t.selected)?m(i,a):u(i,a,!1)},[a,c,u,i,m]),_=(0,s.useCallback)(e=>{e.stopPropagation(),v()},[v]);return c?(0,l.jsx)("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:(0,l.jsxs)(tN,{featuretype:i,id:a,metatype:b,fullname:tl(c.tag),created:0>Number(c["@_id"]),deleted:"delete"===c["@_action"],modified:"modify"===c["@_action"],children:["node"===i&&(0,l.jsx)("button",{className:"btn btn-xs btn-square tooltip tooltip-bottom","data-tip":"Switch to position",onClick:w,children:(0,l.jsx)(tj.G,{icon:tk.faLocationDot})}),(0,l.jsx)("button",{className:T("btn btn-xs btn-square tooltip tooltip-bottom",(null===(t=c["@_localStates"])||void 0===t?void 0:t.selected)&&"btn-accent"),"data-tip":(null===(n=c["@_localStates"])||void 0===n?void 0:n.selected)?"Unselect":"Select",onClick:j,children:(0,l.jsx)(tj.G,{icon:(null===(o=c["@_localStates"])||void 0===o?void 0:o.selected)?tO.faXmarkCircle:tM.faCheckCircle})}),d&&d({type:i,id:a})]})}):(0,l.jsx)("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:(0,l.jsxs)(tN,{featuretype:i,id:a,fullname:"[not downloaded]",children:[g?(0,l.jsx)("span",{className:"loading loading-spinner loading-xs"}):(0,l.jsx)("button",{className:"btn btn-square btn-xs btn-success tooltip tooltip-bottom","data-tip":"Download feature",onMouseDown:_,children:(0,l.jsx)(tj.G,{icon:t_.q7m})}),d&&d({type:i,id:a})]})})}let nc=function(e){let{id:t,type:n}=e,o=eL(e=>e.selectFeature),{relation:i,way:a}=eL((0,tc.N)(e=>e.meta)),r=E(i).filter(e=>Object.prototype.hasOwnProperty.call(i,e)).map(e=>i[e]),s=e=>{o("relation",e,!1)};return(0,l.jsx)("ul",{className:"menu menu-xs",children:r.filter(e=>R(e.member).some(e=>e["@_ref"]===t&&e["@_type"]===n||"node"===n&&("way"===e["@_type"]&&a[e["@_ref"]]&&R(a[e["@_ref"]].nd).some(e=>String(e["@_ref"])===t)||"relation"===e["@_type"]&&i[e["@_ref"]]&&R(i[e["@_ref"]].member).some(e=>e["@_ref"]===t)))).map(e=>(0,l.jsx)("li",{children:(0,l.jsx)("span",{onClick:()=>s(e["@_id"]),children:(0,l.jsx)(nd,{id:e["@_id"],type:"relation",showMetaType:!0})})},e["@_id"]))})},nu=function(e){let{id:t,type:n}=e,o=eL((0,tc.N)(e=>e.meta[n][t]["@_localStates"]));return(0,l.jsx)("div",{className:"flex flex-wrap gap-1",children:Object.entries(o).filter(e=>{let[,t]=e;return t}).map(e=>{let[t]=e;return(0,l.jsx)("span",{className:"badge badge-info badge-xs",children:t},t)})})},nm=function(e){let{id:t}=e,[n,o]=(0,s.useState)(0),i=eL((0,tc.N)(e=>e.meta.node[t])),a=eL(e=>e.modifyFeatureMetaNC),r=eL(e=>e.commit),d=(0,s.useMemo)(()=>[{title:"Info",tab:()=>(0,l.jsx)(ns,{meta:i})},{title:"Tags",tab:()=>(0,l.jsx)(nl,{tags:R(i.tag),setTags:e=>{a("node",t,t=>t.tag=e)},commitChange:r})},{title:"Members",tab:()=>(0,l.jsx)(nc,{id:t,type:"node"})}],[i,t,a,R,r]);return i?(0,l.jsxs)("div",{className:"p-2 overflow-scroll",children:[(0,l.jsxs)("h3",{className:"text-base font-semibold mb-2",children:["[Node] ",tl(i.tag)||i["@_id"]]}),(0,l.jsx)(nu,{id:t,type:"node"}),(0,l.jsx)("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs py-4",children:d.map((e,t)=>(0,l.jsx)("a",{onClick:()=>o(t),role:"tab",className:T("tab",t===n&&"tab-active"),children:e.title},t))}),(0,l.jsx)("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:d[n].tab()})]}):null};function np(e){let{member:t,memberToId:n,children:o,slotSelection:i}=e,[a,r]=(0,s.useState)(new Set);(0,s.useEffect)(()=>{r(e=>{let o=new Set;return t.forEach(t=>{e.has(n(t))&&o.add(n(t))}),o})},[t,n]);let d=(0,s.useMemo)(()=>{let e=e=>{r(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})};return t=>{let{m:o}=t;return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)("input",{type:"checkbox",className:"checkbox ml-2",checked:a.has(n(o)),onChange:()=>e(n(o))})})}},[a,n]);return(0,l.jsxs)(l.Fragment,{children:[i({selected:a,children:(0,l.jsx)("input",{type:"checkbox",checked:a.size===t.length,onChange:()=>{a.size===t.length?r(new Set):r(new Set(t.map(n)))},className:"checkbox ml-2"})}),o({member:t,memberToId:n,slot:d})]})}function nh(e){let{id:t,type:n}=e,o=eL(e=>e.meta[n][t]),i=(0,s.useMemo)(()=>{var e;if(null==o?void 0:null===(e=o.tag)||void 0===e?void 0:e.length){if("node"===n)return ts(o.tag);if("relation"===n)return tI(o.tag)}},[null==o?void 0:o.tag,n]);return(0,l.jsx)(tN,{featuretype:n,id:t,metatype:i,fullname:tl(o.tag),created:0>Number(o["@_id"]),deleted:"delete"===o["@_action"],modified:"modify"===o["@_action"]})}let nf=function(e){let{handelInsertTop:t,handelIntertBottom:n,handelInsertAtActive:o}=e,i=eL((0,tc.N)(e=>e.selectedRef)),a=(0,s.useCallback)(e=>`${e.type}-${e.id}`,[]),r=(0,s.useRef)(new Set),d=()=>i.filter(e=>r.current.has(a(e))),c=(0,s.useCallback)(e=>{let{member:t,memberToId:n,slot:o}=e;return t.map(e=>(0,l.jsxs)("div",{className:"flex flex-row gap-1 px-2 mt-1",children:[(0,l.jsx)(nh,{...e}),o({m:e})]},n(e)))},[]);return(0,l.jsxs)("div",{className:"flex flex-row justify-center p-2 rounded-md",children:[(0,l.jsxs)("div",{className:"join join-vertical mr-2",children:[(0,l.jsx)("button",{className:"btn btn-xs join-item",onClick:()=>{t(d())},children:"InsTop"}),(0,l.jsx)("button",{className:"btn btn-xs join-item",onClick:()=>{o(d())},children:"InsAct"}),(0,l.jsx)("button",{className:"btn btn-xs join-item",onClick:()=>{n(d())},children:"InsBtm"})]}),(0,l.jsx)("div",{className:"bg-base-200 text-xs rounded max-h-full",children:(0,l.jsx)(np,{member:i,memberToId:a,slotSelection:e=>{let{selected:t,children:n}=e;return r.current=t,(0,l.jsxs)("div",{className:"flex flex-row px-2 py-1",children:[(0,l.jsx)("h3",{className:"text text-sm font-semibold",children:"selected Items to insert"}),(0,l.jsx)("div",{className:"ml-auto"}),n]})},children:c})})]})};var nx=n(6513),nb=n(5684),ng=n(5587),ny=n(4285),nv=n(8252);let nw=function(e){let{id:t,element:n="div",children:o,style:i,...a}=e,{attributes:r,listeners:s,setNodeRef:d,transform:c,transition:u}=(0,ng.nB)({id:t}),m={transform:ny.ux.Transform.toString(c),transition:u,...i};return(0,l.jsxs)(n,{ref:d,className:"flex flex-row bg-base-200 rounded border pl-1",style:m,...a,children:[(0,l.jsx)("button",{...s,...r,className:"btn btn-ghost btn-xs my-auto inline-block",children:(0,l.jsx)(tj.G,{icon:nv.faGripVertical})}),o]})},nj=function(e){let{memberToId:t,member:n,onDragEnd:o,onDragStart:i,children:a}=e,r=(0,nb.Dy)((0,nb.VT)(nb.we),(0,nb.VT)(nb.Lg,{coordinateGetter:ng.is})),[d,c]=(0,s.useState)(),u=(0,s.useMemo)(()=>n.map(e=>({id:t(e),member:e})),[n,t]),m=(0,s.useCallback)(e=>{let{id:t,member:n,index:o}=e;return(0,l.jsx)(nw,{id:t,children:a({member:n,index:o})},t)},[a]);return(0,l.jsxs)(nb.LB,{sensors:r,collisionDetection:nb.pE,onDragStart:function(e){var t;let{active:n}=e;console.debug("drag memeber start:",n);let o=null===(t=u.find(e=>e.id===n.id))||void 0===t?void 0:t.member;if(!o)throw Error(`in Drag list got invalid active object ${JSON.stringify(n)}`);c(o),i(o)},onDragEnd:function(e){let{active:t,over:n}=e;if(console.debug("drag memeber end:",t,n),n&&t.id!==n.id){let e=u.findIndex(e=>e.id===t.id),i=u.findIndex(e=>e.id===n.id);o((0,ng.Rp)(u,e,i).map(e=>e.member))}c(void 0)},children:[(0,l.jsx)(ng.Fo,{items:u,strategy:ng.qw,children:u.map((e,t)=>m({id:e.id,member:e.member,index:t}))}),(0,l.jsx)(nb.y9,{children:d?(0,l.jsxs)("div",{className:"flex bg-base-200 rounded-sm pl-1",children:[(0,l.jsx)("button",{className:"btn btn-ghost btn-xs my-auto",children:(0,l.jsx)(tj.G,{icon:nv.faGripVertical})}),a({member:d,isDragOverlay:!0,index:-1})]}):null})]})};function n_(e){let{member:t,isDragOverlay:n,slot:o,index:i,children:a}=e;return(0,l.jsx)(l.Fragment,{children:a({member:t,children:o({m:t}),overlay:n,index:i})})}function nN(e){let{member:t,memberToId:n,children:o,slotSelection:i,...a}=e,r=(0,s.useCallback)(e=>{let{member:t,memberToId:n,slot:i}=e;return(0,l.jsx)(nj,{...a,member:t,memberToId:n,children:e=>(0,l.jsx)(n_,{...e,slot:i,children:o})})},[o,a]);return(0,l.jsx)(np,{member:t,memberToId:n,slotSelection:i,children:r})}var nS=n(767);function nk(e){let{onDelete:t,member:n,memberToId:o,...i}=e,a=eL(e=>e.loadFeatureBatch),r=eU(e=>e.osmAPI.BASEURL),[d,c]=(0,s.useState)(!1),u=(0,s.useRef)(1),m=(0,s.useCallback)(()=>u.current++,[u]),p=(0,s.useMemo)(()=>n.map(e=>({...e,uniqueIdentifier:m()})),[m,n]),h=(0,s.useCallback)(e=>`${o(e)}_AT_LIST_${e.uniqueIdentifier}`,[o]),f=(0,s.useCallback)(e=>{let{selected:n,children:o}=e;return(0,l.jsxs)("div",{className:"flex flex-row p-1 rounded",children:[(0,l.jsx)("div",{className:"mr-auto",children:"Members"}),(0,l.jsx)("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:e=>{e.stopPropagation();let o=p.filter(e=>!n.has(h(e)));t(p,o)},children:(0,l.jsx)(tj.G,{icon:nx.faDeleteLeft})}),(0,l.jsx)("button",{className:"btn btn-square btn-xs btn-accent tooltip tooltip-bottom","data-tip":"Download selected member of this list",disabled:d,onMouseDown:async e=>{e.stopPropagation(),c(!0),await a(p.filter(e=>n.has(h(e))).map(e=>e["@_type"]?{type:e["@_type"],id:e["@_ref"]}:{type:"node",id:e["@_ref"]}),r),c(!1)},children:d?(0,l.jsx)("span",{className:"loading loading-spinner loading-xs"}):(0,l.jsx)(tj.G,{icon:nS.faDownload})}),o]})},[r,a,p,h,t,d,c]);return(0,l.jsx)(nN,{...i,member:p,memberToId:h,slotSelection:f})}var nM=n(1746),nE=n(7319);let nC=function(e){let{id:t}=e,[n,o]=(0,s.useState)(0),i=eL((0,tc.N)(e=>e.meta.way[t])),a=eL(e=>e.modifyFeatureMetaNC),r=eL(e=>e.commit),[d,c]=(0,s.useState)(void 0),u=(0,s.useCallback)(e=>{let{member:t,children:n}=e;return(0,l.jsx)(nd,{id:t["@_ref"],type:"node",children:()=>{let e=(null==d?void 0:d.id)===t["@_ref"];return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:T("btn btn-square btn-xs tooltip tooltip-bottom",e&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:n=>{n.stopPropagation(),e?c(void 0):c({id:t["@_ref"],type:"node"})},children:(0,l.jsx)(tj.G,{icon:e?nE.faCircle:nM.faCircle})}),n]})}})},[null==d?void 0:d.id]),m=(0,s.useCallback)(e=>`nd-${e["@_ref"]}`,[]);if(!i)return null;function p(){r()}function h(e){a("way",t,t=>{t.nd=e})}function f(e){a("way",t,t=>{t.nd=e})}let x=e=>e.filter(e=>"node"===e.type).map(e=>({"@_ref":e.id})),b=e=>{console.log("Insert at Top: ",e),r(),a("way",t,t=>{t.nd=[...x(e),...R(i.nd)]})},g=e=>{console.log("Insert at Bottom: ",e),r(),a("way",t,t=>{t.nd=[...R(i.nd),...x(e)]})},y=e=>{if(console.log("Insert at Active: ",e),d){let n=[...R(i.nd)],o=n.findIndex(e=>e["@_ref"]===d.id);n.splice(o+1,0,...x(e)),r(),a("way",t,e=>{e.nd=n})}else g(e)},v=(0,s.useMemo)(()=>[{title:"Info",tab:()=>(0,l.jsx)(ns,{meta:i})},{title:"Tags",tab:()=>(0,l.jsx)(nl,{tags:R(i.tag),setTags:e=>{a("way",t,t=>t.tag=e)},commitChange:r})},{title:"Members",tab:()=>(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"flex flex-row",children:[(0,l.jsx)("div",{className:"bg-base-200",children:(0,l.jsx)(nk,{member:i.nd,memberToId:m,onDragStart:p,onDragEnd:h,onDelete:(e,t)=>f(t),children:u})}),(0,l.jsx)("div",{className:"",children:(0,l.jsx)(nf,{handelInsertTop:b,handelIntertBottom:g,handelInsertAtActive:y})})]}),(0,l.jsx)(nc,{id:t,type:"way"})]})}],[i,t,r,a,R,m,p,h,f,u,b,g,y]);return(0,l.jsxs)("div",{className:"p-2 overflow-scroll",children:[(0,l.jsxs)("h3",{className:"text-base font-semibold mb-2",children:["[Way] ",tl(i.tag)||i["@_id"]]}),(0,l.jsx)(nu,{id:t,type:"way"}),(0,l.jsx)("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs py-4",children:v.map((e,t)=>(0,l.jsx)("a",{onClick:()=>o(t),role:"tab",className:T("tab",t===n&&"tab-active"),children:e.title},t))}),(0,l.jsx)("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:v[n].tab()})]})},nR=(0,s.memo)(e=>{let{initialValue:t,onCommit:n}=e,[o,i]=(0,s.useState)(t||"");return(0,s.useEffect)(()=>{i(t||"")},[t]),(0,l.jsx)("input",{className:"grow",type:"text",placeholder:"role of member",value:o,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur(),e.stopPropagation()},onBlur:()=>{n(o)}})});var nT=n(1329),nO=n(9323),nA=n(1730);function nP(e,t){return e["@_ref"]===t["@_ref"]}function nD(e){var t,n;let{member:o,index:i}=e,a=eL(e=>e.meta.way),r=a[o[i]["@_ref"]],s=a[null===(t=o[i-1])||void 0===t?void 0:t["@_ref"]]||void 0,d=a[null===(n=o[i+1])||void 0===n?void 0:n["@_ref"]]||void 0,c=s&&r&&nP(s.nd[s.nd.length-1],r.nd[0]),u=d&&r&&nP(r.nd[r.nd.length-1],d.nd[0]);return c&&u?(0,l.jsx)("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to both sides",children:(0,l.jsx)(tj.G,{icon:nT.faArrowsUpDown})}):c?(0,l.jsx)("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to previous way",children:(0,l.jsx)(tj.G,{icon:nO.faArrowUp})}):u?(0,l.jsx)("div",{className:"tooltip tooltip-bottom","data-tip":"Connected to next way",children:(0,l.jsx)(tj.G,{icon:nA.faArrowDown})}):(0,l.jsx)("div",{className:"tooltip tooltip-bottom","data-tip":"Not connected to any way, or not downloaded",children:(0,l.jsx)(tj.G,{icon:tq.faMinus})})}let nI=function(e){let{id:t}=e,[n,o]=(0,s.useState)(0),i=eL((0,tc.N)(e=>e.meta.relation[t])),a=eL(e=>e.modifyFeatureMetaNC),r=eL(e=>e.commit),[d,c]=(0,s.useState)(void 0),u=(0,s.useCallback)((e,n,o)=>{console.debug("edit",e,n,o),r(),a("relation",t,t=>{t.member=R(i.member).map(t=>{if(t["@_type"]===e&&t["@_ref"]===n){let e=M(t);return e["@_role"]=o,e}return t})})},[r,t,i.member,a]),m=(0,s.useCallback)(e=>`${e["@_type"]}-${e["@_ref"]}`,[]),p=(0,s.useCallback)(e=>{let{member:t,children:n,overlay:o,index:a}=e;return(0,l.jsx)(nd,{id:t["@_ref"],type:t["@_type"],children:()=>{let e=(null==d?void 0:d.id)===t["@_ref"]&&d.type===t["@_type"];return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:T("btn btn-square btn-xs tooltip tooltip-bottom",e&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:n=>{n.stopPropagation(),e?c(void 0):c({id:t["@_ref"],type:t["@_type"]})},children:(0,l.jsx)(tj.G,{icon:e?t_.diR:nM.faCircle})}),(0,l.jsx)("div",{className:"w-3",children:!o&&"way"===t["@_type"]&&(0,l.jsx)(nD,{member:i.member,index:a})}),(0,l.jsxs)("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",(0,l.jsx)(nR,{initialValue:t["@_role"],onCommit:e=>u(t["@_type"],t["@_ref"],e)})]}),n]})}})},[u,d,i.member]);if(!i)return null;function h(){r()}function f(e){a("relation",t,t=>{t.member=e})}function x(e){r(),a("relation",t,t=>{t.member=e})}let b=e=>e.map(e=>({"@_ref":e.id,"@_type":e.type})),g=e=>{console.log("Insert at Top: ",e),r(),a("relation",t,t=>{t.member=[...b(e),...R(t.member)]})},y=e=>{console.log("Insert at Bottom: ",e),r(),a("relation",t,t=>{t.member=[...R(t.member),...b(e)]})},v=e=>{if(console.log("Insert at Active: ",e),d){let n=[...R(i.member)],o=n.findIndex(e=>e["@_ref"]===d.id&&e["@_type"]===d.type);n.splice(o+1,0,...b(e)),r(),a("relation",t,e=>{e.member=n})}else y(e)},w=(0,s.useMemo)(()=>[{title:"Info",tab:()=>(0,l.jsx)(ns,{meta:i})},{title:"Tags",tab:()=>(0,l.jsx)(nl,{tags:R(i.tag),setTags:e=>{a("relation",t,t=>t.tag=e)},commitChange:r})},{title:"Members",tab:()=>(0,l.jsxs)("div",{className:"flex flex-row relative",children:[(0,l.jsx)("div",{className:"bg-base-200",children:(0,l.jsx)(nk,{member:i.member,memberToId:m,onDragStart:h,onDragEnd:f,onDelete:(e,t)=>x(t),children:p})}),(0,l.jsx)("div",{className:"",children:(0,l.jsx)(nf,{handelInsertTop:g,handelIntertBottom:y,handelInsertAtActive:v})})]})}],[i,t,r,a,R,m,h,f,x,p,g,y,v]);return(0,l.jsxs)("div",{className:"p-2 overflow-scroll",children:[(0,l.jsxs)("h3",{className:"text-base font-semibold mb-2",children:["[Relation] ",tl(i.tag)||i["@_id"]]}),(0,l.jsx)(nu,{id:t,type:"relation"}),(0,l.jsx)("div",{role:"tablist",className:"tabs tabs-lifted tabs-xs py-4",children:w.map((e,t)=>(0,l.jsx)("a",{onClick:()=>o(t),role:"tab",className:T("tab",t===n&&"tab-active"),children:e.title},t))}),(0,l.jsx)("div",{className:"outline-view flex flex-col bg-base-100 w-full px-1 flex-1 overflow-auto",children:w[n].tab()})]})},nL=function(e){let{width:t,height:n}=e,o=eL(e=>e.activeRef);return(0,l.jsx)("div",{style:{width:t,height:n,maxWidth:t,maxHeight:n},className:"property-view flex flex-col rounded bg-base-100",children:o?"node"===o.type?(0,l.jsx)(nm,{id:o.id}):"way"===o.type?(0,l.jsx)(nC,{id:o.id}):"relation"===o.type?(0,l.jsx)(nI,{id:o.id}):(0,l.jsxs)("div",{children:["Unknown type for item ",JSON.stringify(o)]}):(0,l.jsx)("div",{children:"Please active some component to show prop edit view"})})};function nF(){let e=(0,eG.Y0)(),t=x(e=>e.setStageApp);return(0,s.useEffect)(()=>(globalThis.__PIXI_APP__=e,e.stage.hitArea=e.screen,t(e),()=>{globalThis.__PIXI_APP__=void 0,t(void 0)}),[e,t]),null}let n$=function(e){let{width:t,height:n,children:o,...i}=e,a=x(e=>e.setStage);return(0,s.useEffect)(()=>{a(t,n)},[t,n,a]),(0,l.jsxs)(eG.Hf,{width:t,height:n,options:{background:"#1099bb"},...i,children:[o,(0,l.jsx)(nF,{})]})};function nB(e){let{width:t}=e;return(0,l.jsx)("div",{className:"slot-bottom absolute inset-x-0 bottom-0 flex flex-row align-middle justify-center",style:{width:t},children:(0,l.jsx)("span",{className:"text-base-content bg-base-300 px-2 rounded",children:"data\xa9openstreetmap contributor"})})}function nU(e){let{width:t,height:n}=e,o=(0,s.useRef)(new q({meta:eL,view:x,settings:eU}));return(0,s.useEffect)(()=>{let e=e=>o.current.transform(e);return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n$,{width:t,height:n,options:{background:"#1099bb"},onContextMenu:e=>e.preventDefault(),onMouseDown:e=>{o.current.transform(e)},onPointerMove:e=>{o.current.transform(e)},onMouseUp:e=>{o.current.transform(e)},onWheel:e=>{o.current.transform(e)},children:[(0,l.jsx)(eV,{width:t,height:n}),(0,l.jsx)(tf,{width:t,height:n,stateMachine:o.current})]}),(0,l.jsx)(nB,{width:t}),(0,l.jsx)("div",{className:"slot-top absolute inset-x-0 top-0 flex flex-row align-middle justify-center",style:{width:t},children:(0,l.jsx)(tb,{stateMachine:o.current})})]})}let nG=function(e){let{width:t,height:n}=e;return(0,l.jsxs)(tv,{width:t,height:n,axis:"x",initial:t/4*3,children:[e=>(0,l.jsx)(nU,{...e}),e=>(0,l.jsxs)(tv,{...e,axis:"y",children:[e=>(0,l.jsx)(na,{...e}),e=>(0,l.jsx)(nL,{...e})]})]})};var nq=n(9416),nV=n(6349),nW=n(2148),nH=n(2731);function nz(e){let{open:t,onClose:n}=e,{updateSettingsAction:o,...i}=eU(),[a,r]=(0,s.useState)(i),d=eL(e=>e.reset);return(0,l.jsx)("div",{className:T("modal",t&&"modal-open"),children:(0,l.jsxs)("div",{className:"modal-box",children:[(0,l.jsx)("h3",{className:"font-bold text-lg",children:"Change Settings"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"OSM API Base URL"})}),(0,l.jsx)("input",{type:"text",value:a.osmAPI.BASEURL,onChange:e=>r({...a,osmAPI:{...a.osmAPI,BASEURL:e.target.value}}),className:"input input-bordered w-full"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"OSM API Tile Source"})}),(0,l.jsx)("input",{type:"text",value:a.osmAPI.TILE_SOURCE,onChange:e=>r({...a,osmAPI:{...a.osmAPI,TILE_SOURCE:e.target.value}}),className:"input input-bordered w-full"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"label",children:(0,l.jsx)("span",{className:"label-text",children:"Max Zoom Level"})}),(0,l.jsx)("input",{type:"number",value:a.view.MAX_ZOOM,onChange:e=>r({...a,view:{...a.view,MAX_ZOOM:parseFloat(e.target.value)}}),className:"input input-bordered w-full"})]}),(0,l.jsx)("button",{className:"btn btn-error mt-4",onClick:d,children:"Reast All Data (All data will lost)"}),(0,l.jsxs)("div",{className:"modal-action",children:[(0,l.jsx)("button",{className:"btn btn-ghost",onClick:n,children:"Cancel"}),(0,l.jsx)("button",{className:"btn",onClick:()=>{o(a),n()},children:"Save"})]})]})})}function nK(){let[e,t]=eL((0,tc.N)(e=>[e.autoload,e.setAutoloadNC])),n=(0,s.useCallback)(()=>t(()=>!e),[e,t]);return(0,l.jsx)("li",{className:"tooltip tooltip-left","data-tip":"Auto load OSM data on drag: "+(e?"Enabled":"Disabled"),children:(0,l.jsx)("a",{onClick:n,className:T(e&&"active"),children:(0,l.jsx)(tj.G,{icon:nq.faA})})})}function nX(){let{viewpoint:e,zoom:t,height:n,width:o}=x(),i=eL((0,tc.N)(e=>e.loadbbox)),a=eU(e=>e.osmAPI.BASEURL),[r,d]=(0,s.useState)(!1),c=(0,s.useCallback)(async()=>{r||(d(!0),await i({width:o,height:n,zoom:t,viewpoint:e},a),d(!1))},[a,n,i,e,o,t,r,d]);return(0,l.jsx)("li",{className:T("tooltip tooltip-left",r&&"disabled"),"data-tip":"Load OSM data on current screen",children:(0,l.jsx)("a",{onClick:c,children:r?(0,l.jsx)("span",{className:"loading loading-spinner loading-xs h-[14px]"}):(0,l.jsx)(tj.G,{icon:nV.faDownLong})})})}function nZ(){return(0,l.jsx)("li",{className:"tooltip tooltip-left","data-tip":"Export with JSOM format",children:(0,l.jsx)("a",{onClick:()=>{let{meta:e,deletedMeta:t,bbox:n}=eL.getState(),o=new Blob([tx(e,t,n)],{type:"application/xml"}),i=document.createElement("a");i.href=URL.createObjectURL(o),i.download="exported_data.osm",i.click(),URL.revokeObjectURL(i.href)},children:(0,l.jsx)(tj.G,{icon:nW.faFileExport})})})}function nJ(){let[e,t]=(0,s.useState)(!1);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("li",{className:"tooltip tooltip-left","data-tip":"Change settings",onClick:()=>t(!0),children:(0,l.jsx)("a",{children:(0,l.jsx)(tj.G,{icon:nH.faGear})})}),(0,l.jsx)(nz,{open:e,onClose:()=>t(!1)})]})}function nY(){return(0,l.jsxs)("ul",{className:"menu menu-horizontal",children:[(0,l.jsx)(nK,{}),(0,l.jsx)(nX,{}),(0,l.jsx)(nZ,{}),(0,l.jsx)(nJ,{})]})}function nQ(e){let{height:t,leftSlot:n}=e;return(0,l.jsxs)("nav",{className:"navbar p-0 bg-base-100 overflow-hidden border-b-2 border-b-base-300",style:{height:t,maxHeight:t,minHeight:t},children:[(0,l.jsx)("div",{className:"flex-1",children:n}),(0,l.jsx)("div",{className:"flex-none",children:(0,l.jsx)(nY,{})})]})}var n0=n(6031),n1=n(8409),n2=n(7267),n3=n(468);class n4 extends A{constructor(e,t){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"mousedown",void 0),(0,k._)(this,"draging",void 0),this.idle=new O("select-idle"),this.mousedown=new O("select-mousedown"),this.draging=new O("select-dragging"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mousedown,{transform:e=>{let t=this.context;return"mousedown"===e.type&&!!e.shiftKey&&(console.debug("BatchSelectStateMachine: transition from idle to mousedown"),t.from=P(e.clientX,e.clientY,t),!0)}}),this.mousedown.appendNext(this.idle,{transform:e=>{let t=this.context;return!!["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(e.type)&&(console.debug("BatchSelectStateMachine: transition from mousedown to idle"),t.from=void 0,!0)}}),this.mousedown.appendNext(this.draging,{transform:e=>{let t=this.context;if("pointermove"===e.type){console.debug("BatchSelectStateMachine: start dragging");let{clientX:n,clientY:o}=e;return x.getState().setSelectionRect({from:t.from,to:P(n,o,t)}),!0}return!1}}),this.draging.appendNext(this.idle,{transform:e=>{if(["mouseup","mouseupoutside","pointerup","pointerupoutside"].includes(e.type)){if(console.debug("BatchSelectStateMachine: drag canceled, back to idle"),x.getState().setSelectionRect(),null==t?void 0:t.onSelectRect){let{clientX:n,clientY:o}=e;t.onSelectRect({from:this.context.from,to:P(n,o,this.context)},e)}return this.context.from=void 0,!0}return!1}}),this.draging.appendNext(this.draging,{transform:e=>{let t=this.context;if("pointermove"===e.type){console.debug("BatchSelectStateMachine: continue dragging");let{clientX:n,clientY:o}=e;return x.getState().setSelectionRect({from:t.from,to:P(n,o,t)}),!0}return!1}})}}class n5 extends A{constructor(e,{onRightClick:t,onLeftClick:n,onHoverExit:o,onHoverStart:i,hoverable:a,clickable:r,dragable:l,selectable:s}){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"componentHover",void 0),(0,k._)(this,"componentMousedown",void 0),(0,k._)(this,"pointDrag",void 0),this.idle=new O("pt-bus-component-idle"),this.componentHover=new O("pt-bus-component-hover"),this.componentMousedown=new O("pt-bus-component-mousedown"),this.pointDrag=new O("pt-bus-component-drag"),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.componentHover,{transform:e=>{let t=this.context;if(["pointerover","pointerenter"].includes(e.type)&&"componentTarget"in e&&e.componentTarget&&a(e.componentTarget,this.context)){t.componentTarget=e.componentTarget;let{id:n,type:o}=t.componentTarget;console.log("BusComponentStateMachine: component hover triggered",o,n);let{modifyFeatureStateNC:a}=t.store.meta.getState();return a(o,n,e=>e.hovered=!0),i&&i(t.componentTarget,e),!0}return!1}}),this.componentHover.appendNext(this.componentMousedown,{transform:e=>{let t=this.context;if("mousedown"===e.type&&t.componentTarget&&r(t.componentTarget,t)){console.log("BusComponentStateMachine: transition to "+this.componentMousedown.name);let{id:n,type:i}=t.componentTarget,{modifyFeatureStateNC:a}=t.store.meta.getState();return a(i,n,e=>e.hovered=!1),o&&o(t.componentTarget,e),!0}return!1}}),this.componentHover.appendNext(this.idle,{transform:e=>{let t=this.context;if(["pointerleave","pointerout"].includes(e.type)&&t.componentTarget){console.log("BusComponentStateMachine: transition to idle");let{id:n,type:i}=t.componentTarget,{modifyFeatureStateNC:a}=t.store.meta.getState();return a(i,n,e=>e.hovered=!1),o&&o(t.componentTarget,e),t.componentTarget=void 0,!0}return!1}}),this.componentMousedown.appendNext(this.pointDrag,{transform:e=>{var t;let n=this.context;if("pointermove"===e.type&&"node"===(null===(t=n.componentTarget)||void 0===t?void 0:t.type)&&l(n.componentTarget,n)){console.log("BusComponentStateMachine: start dragging");let{clientX:t,clientY:o}=e,{commit:i}=n.store.meta.getState();return i(),D(t,o,n),!0}return!1}}),this.componentMousedown.appendNext(this.idle,{transform:e=>{let o=this.context;if(("mouseup"===e.type||"mouseupoutside"===e.type)&&o.componentTarget){if(e.button===L.RIGHT&&t?t(o.componentTarget,e):e.button===L.LEFT&&n&&n(o.componentTarget,e),s(o.componentTarget,o)){let{selectFeature:t}=o.store.meta.getState(),{id:n,type:i}=o.componentTarget;if("string"==typeof n)t(i,n,!e.shiftKey),console.log("selected id",n,o.store.meta.getState().selectFeature);else throw Error(`id ${n} is invalid for component`)}return o.componentTarget=void 0,!0}return!1}}),this.pointDrag.appendNext(this.idle,{transform:e=>("mouseupoutside"===e.type||"mouseup"===e.type)&&(console.log("BusComponentStateMachine: drag canceled, back to idle"),this.context.componentTarget=void 0,!0)}),this.pointDrag.appendNext(this.pointDrag,{transform:e=>{if("pointermove"===e.type){let{clientX:t,clientY:n}=e;return D(t,n,this.context),!0}return!1}})}}class n7 extends A{transform(e){"mousedown"===e.type&&(this.menus.busStop({x:0,y:0,open:!1}),this.menus.stopPosition({x:0,y:0,open:!1})),super.transform(e)}constructor(e,t){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"mapViewSubMachine",void 0),(0,k._)(this,"busStopEditSubMachine",void 0),(0,k._)(this,"undoRedo",void 0),(0,k._)(this,"batchSelect",void 0),(0,k._)(this,"menus",void 0),this.menus=t;let n=e=>"node"===e.type;this.idle=new O("pt-edit-idle"),this.mapViewSubMachine=new F(e,{rightClickHandeler:e=>{this.menus.busStop({...P(e.clientX,e.clientY,this.context),open:!0}),this.menus.stopPosition({x:0,y:0,open:!1})}}),this.busStopEditSubMachine=new n5(e,{onRightClick:(e,t)=>{this.menus.stopPosition({...P(t.clientX,t.clientY,this.context),feature:e,open:!0})},hoverable:e=>"way"===e.type||"node"===e.type,clickable:e=>"way"===e.type||"node"===e.type,dragable:(e,t)=>{let n=t.store.meta.getState().meta[e.type][e.id].tag||[];return"node"===e.type&&(ta(n)||tr(n))},selectable:n}),this.undoRedo=new U(e),this.batchSelect=new n4(e,{onSelectRect:(e,t)=>{let{viewpoint:o,zoom:i,width:a,height:r}=this.context.store.view.getState(),l=N(o,i,a,r,e),s=this.context.store.meta.getState(),d=t0(l)(s);console.debug("get feature group ",d),t.ctrlKey||s.clearSelect(),Object.entries(d.node).filter(e=>{let[,t]=e;return n({id:t["@_id"],type:"node"},this.context)}).forEach(e=>{let[,t]=e;return s.selectFeature("node",t["@_id"],!1)})}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}}function n8(e){let{type:t,id:n,showMetaType:o,children:i}=e,a=eL((0,tc.N)(e=>e.meta[t][n])),r=(0,s.useMemo)(()=>{var e;if(o&&(null==a?void 0:null===(e=a.tag)||void 0===e?void 0:e.length)){if("node"===t)return ts(a.tag);if("relation"===t)return tI(a.tag)}},[o,null==a?void 0:a.tag,t]);return(0,l.jsx)("div",{className:"flex text-xs flex-1 flex-row items-center px-1 ml-1 gap-1",children:(0,l.jsx)(tN,{featuretype:t,id:n,metatype:r,fullname:tl(a.tag),created:0>Number(a["@_id"]),deleted:"delete"===a["@_action"],modified:"modify"===a["@_action"],children:i&&i({type:t,id:n})})})}function n9(e){let{onDelete:t,member:n,memberToId:o,...i}=e,a=(0,s.useRef)(1),r=(0,s.useCallback)(()=>a.current++,[a]),d=(0,s.useMemo)(()=>n.map(e=>({...e,uniqueIdentifier:r()})),[r,n]),c=(0,s.useCallback)(e=>`${o(e)}_AT_LIST_${e.uniqueIdentifier}`,[o]),u=(0,s.useCallback)(e=>{let{selected:n,children:o}=e;return(0,l.jsxs)("div",{className:"flex flex-row p-1 rounded",children:[(0,l.jsx)("div",{className:"mr-auto",children:"Members"}),(0,l.jsx)("button",{className:"btn btn-square btn-xs btn-error tooltip tooltip-bottom","data-tip":"Remove Selected member from list",onMouseDown:e=>{e.stopPropagation();let o=d.filter(e=>!n.has(c(e)));t(d,o)},children:(0,l.jsx)(tj.G,{icon:nx.faDeleteLeft})}),o]})},[d,c,t]);return(0,l.jsx)(nN,{...i,member:d,memberToId:c,slotSelection:u})}let n6=(0,s.memo)(e=>{let{initialValue:t,onCommit:n,onFocus:o,onBlur:i}=e,[a,r]=(0,s.useState)(t||"");return(0,s.useEffect)(()=>{r(t||"")},[t]),(0,l.jsx)("input",{className:"grow",type:"text",placeholder:"role of member",value:a,onChange:e=>r(e.target.value),onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()},onBlur:e=>{i&&i(e),n(a)},onFocus:o})});function oe(e){let{preset:t,existing:n,title:o,onSubmit:i,open:a,onClose:r,createMembers:d}=e,[c,u]=(0,s.useState)({});(0,s.useEffect)(()=>{u(()=>t.tag.reduce((e,t)=>((null==n?void 0:n.some(e=>t["@_k"]===e["@_k"]))||(e[t["@_k"]]=t["@_v"]||""),e),{}))},[n,t]);let m=(0,s.useMemo)(()=>t.tag.filter(e=>!(null==n?void 0:n.some(t=>e["@_k"]===t["@_k"]))),[t,n]),[p,h]=(0,s.useState)((null==n?void 0:n.map(e=>({key:e["@_k"],value:e["@_v"]})))||[]),[f,x]=(0,s.useState)("");(0,s.useEffect)(()=>{let e=document.getElementById("create-node-modal");a?null==e||e.showModal():null==e||e.close()},[a]);let b=(e,t)=>{u(n=>({...n,[e]:t}))},g=(0,s.useCallback)(()=>{""!==f.trim()&&(h(e=>[...e,{key:f.trim(),value:""}]),x(""))},[f]),y=(e,t)=>{h(n=>n.map((n,o)=>o===e?{...n,value:t}:n))},v=e=>{h(t=>t.filter((t,n)=>n!==e))},w=(0,s.useMemo)(()=>(0,l.jsxs)(l.Fragment,{children:[n&&(0,l.jsx)("div",{className:"divider",children:"Needed preset tags"}),m.map(e=>(0,l.jsxs)("label",{className:"input input-bordered input-sm flex items-center gap-x-1 tooltip tooltip-top","data-tip":e.description||"",children:[(0,l.jsxs)("span",{className:"font-semibold",children:[e["@_k"]," ","required"===e.importance&&(0,l.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,l.jsx)("input",{type:"text",placeholder:e.example||"Enter value",value:c[e["@_k"]],onChange:t=>b(e["@_k"],t.target.value),required:"required"===e.importance,disabled:"not-recommened"===e.importance,className:"grow"}),(0,l.jsx)("span",{className:"badge",children:e.importance})]},e["@_k"])),(0,l.jsx)("div",{className:"divider",children:n?"Exsisting or created tags":"Created tags"}),p.map((e,t)=>(0,l.jsxs)("label",{className:"input input-bordered input-sm flex items-center gap-x-1",children:[(0,l.jsxs)("span",{className:"font-semibold",children:[e.key," ",(0,l.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,l.jsx)("input",{type:"text",placeholder:"Enter value",value:e.value,onChange:e=>y(t,e.target.value),required:!0,className:"grow"}),!n&&(0,l.jsx)("span",{className:"badge",children:"created"}),(0,l.jsx)("button",{type:"button",className:"btn btn-xs btn-error",onClick:()=>v(t),children:(0,l.jsx)(tj.G,{icon:t_.$aW})})]},e.key)),(0,l.jsxs)("label",{className:"input input-sm input-bordered flex items-center gap-2",children:[(0,l.jsx)("input",{type:"text",placeholder:"New tag key",value:f,onChange:e=>x(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),g())},className:"grow"}),(0,l.jsx)("button",{type:"button",className:"btn btn-xs btn-outline",onClick:g,children:"+ add tag"})]})]}),[g,n,m,f,p,c]),[j,_]=(0,s.useState)([]),[N,S]=(0,s.useState)(void 0),k=(0,s.useCallback)((e,t,n)=>{console.log("edit",e,t,n),_(o=>o.map(o=>{if(o["@_type"]===e&&o["@_ref"]===t){let e=M(o);return e["@_role"]=n,e}return o}))},[]),E=(0,s.useCallback)(e=>`${e["@_type"]}-${e["@_ref"]}`,[]),C=(0,s.useCallback)(e=>{let{member:t,children:n}=e;return(0,l.jsx)(n8,{id:t["@_ref"],type:t["@_type"],children:()=>{let e=(null==N?void 0:N.id)===t["@_ref"]&&N.type===t["@_type"];return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{className:T("btn btn-square btn-xs tooltip tooltip-bottom",e&&"btn-accent"),"data-tip":"Mark as local active place to insert",onMouseDown:n=>{n.stopPropagation(),e?S(void 0):S({id:t["@_ref"],type:t["@_type"]})},children:(0,l.jsx)(tj.G,{icon:e?t_.diR:nM.faCircle})}),(0,l.jsxs)("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",(0,l.jsx)(n6,{initialValue:t["@_role"],onCommit:e=>k(t["@_type"],t["@_ref"],e)})]}),n]})}})},[k,N]);function R(){}function O(e){_(()=>e)}let A=e=>e.map(e=>({"@_ref":e.id,"@_type":e.type})),P=(0,s.useCallback)(e=>{console.log("Insert at Top: ",e),_(t=>[...A(e),...t])},[]),D=(0,s.useCallback)(e=>{console.log("Insert at Bottom: ",e),_(t=>[...t,...A(e)])},[]),I=(0,s.useCallback)(e=>{console.log("Insert at Active: ",e),N?_(t=>{let n=[...t],o=n.findIndex(e=>e["@_ref"]===N.id&&e["@_type"]===N.type);return n.splice(o+1,0,...A(e)),n}):D(e)},[D,N]),L=(0,s.useMemo)(()=>d?(0,l.jsxs)("div",{className:"flex flex-row",children:[(0,l.jsx)("div",{className:"bg-base-200",children:(0,l.jsx)(n9,{member:j,memberToId:E,onDragStart:R,onDragEnd:O,onDelete:(e,t)=>{_(()=>t)},children:C})}),(0,l.jsx)("div",{className:"",children:(0,l.jsx)(nf,{handelInsertTop:P,handelIntertBottom:D,handelInsertAtActive:I})})]}):null,[d,I,D,P,j,C,E]);return(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)("dialog",{id:"create-node-modal",className:"modal",onClose:r,children:[(0,l.jsxs)("div",{className:"modal-box w-11/12 max-w-5xl",children:[(0,l.jsx)("h3",{className:"font-bold text-lg mb-2",children:o}),(0,l.jsxs)("form",{onSubmit:e=>{e.preventDefault(),i({tag:[...Object.entries(c).filter(e=>{let[,t]=e;return t.length}).map(e=>{let[t,n]=e;return{"@_k":t,"@_v":n}}),...p.map(e=>({"@_k":e.key,"@_v":e.value}))],member:j}),h([]),x(""),r()},className:"space-y-2",children:[w,L,(0,l.jsxs)("div",{className:"modal-action",children:[(0,l.jsx)("button",{type:"button",className:"btn",onClick:()=>r(),children:"Cancel"}),(0,l.jsx)("button",{type:"submit",className:"btn btn-primary",children:"Submit"})]})]})]}),(0,l.jsx)("form",{method:"dialog",className:"modal-backdrop",children:(0,l.jsx)("button",{children:"close"})})]})})}function ot(e){let{show:t,proceed:n,...o}=e;return(0,l.jsx)(oe,{open:t,...o,onClose:()=>n(null),onSubmit:n})}let on=(0,tC.confirmable)(e=>(0,l.jsx)(ot,{...e}));on.displayName="CreateFeatureTagConform";let oo={tag:[{"@_k":"highway","@_v":"bus_stop",importance:"required",description:"将该处定义为公交站点。最常用的标签。",example:"bus_stop"},{"@_k":"public_transport","@_v":"platform",importance:"required",description:"用于描述该功能是一个公共交通月台，服务于公共交通路线。用于符合ptv2的标签。",example:"platform"},{"@_k":"name",importance:"required",description:"公交站点的名称。",example:"海口路海游路"},{"@_k":"name:zh",importance:"recommened",description:"公交站点的名称。(中文)",example:"海口路海游路"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点。",example:"yes"},{"@_k":"ref",importance:"optional",description:"公交站点的参考代码。（常用于内部定位和维护）",example:"ref=3154"},{"@_k":"local_ref",importance:"recommened",description:"公交站点的参考代码。如果公交站台有大量公交车停靠，每个小站点可有独立 local_ref。",example:"16"},{"@_k":"network",importance:"not-recommened",description:"公交站点的网络。可使用全称或缩写，依据附近线路标注情况确定。",example:"古田公交"},{"@_k":"operator",importance:"not-recommened",description:"在公交站点停靠的公交车的运营公司名称。若多家运营，使用分号（;）分隔。",example:"济阳舜达公共交通有限公司"},{"@_k":"shelter",importance:"recommened",description:"若公交站点提供候车亭则为“yes”，否则为“no”。",example:"no"},{"@_k":"departures_board",importance:"recommened",description:"表明公交站点使用的到站显示屏/牌类型。值可为纸质时刻表、实时显示等；departures_board=no 表示无显示屏/牌。",example:"timetable"},{"@_k":"bench",importance:"recommened",description:"若公交站点提供长凳则为“yes”，否则为“no”。",example:"yes"},{"@_k":"bin",importance:"recommened",description:"若公交站点具备垃圾箱则为“yes”，否则为“no”。",example:"no"},{"@_k":"tactile_paving",importance:"recommened",description:"若公交站点设有视障引导设施（提示视障人士月台边缘）则为“yes”，否则为“no”。",example:"no"},{"@_k":"layer",importance:"optional",description:"适用于多层公交站台。对于非地面公交站点，多层信息是必需的以避免疑问。",example:"-1"},{"@_k":"lit",importance:"recommened",description:"若公交站点夜间亮灯则为“yes”，否则为“no”。",example:"yes"},{"@_k":"surface",importance:"recommened",description:"描述公交车站所在的地面。",example:"concrete"}]},oi={tag:[{"@_k":"public_transport","@_v":"stop_position",importance:"required",description:"用于描述该功能是一个公共交通停车点。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"公交站点的名称。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"name:zh",importance:"recommened",description:"公交站点的名称(中文)。具体描述见下文补充说明。",example:"食用菌市场"},{"@_k":"bus",importance:"required",description:"在ptv2中注明这个站点为公交站点",example:"yes"}]},oa={tag:[{"@_k":"public_transport","@_v":"stop_area",importance:"required",description:"用于描述该功能是一个停车区关系。本标签是用于符合ptv2的标签。",example:"stop_position"},{"@_k":"name",importance:"required",description:"该站组的名称，使用主名称或推广名称，即指向同一位置的同名分站台合并于此关系中",example:"经十路舜耕路"},{"@_k":"name:zh",importance:"recommened",description:"该站组的名称(中文)，使用主名称或推广名称，即指向同一位置的同名分站台合并于此关系中",example:"经十路舜耕路"},{"@_k":"type",importance:"required",description:"","@_v":"public_transport"}]},or={tag:[{"@_k":"type","@_v":"route",importance:"required",description:"将该关系定义为一条线路。",example:"route"},{"@_k":"route",importance:"required",description:"将该关系线路设为一条公交/有轨电车线路。(bus/trolleybus)",example:"bus"},{"@_k":"ref","@_v":"*",importance:"required",description:"线路编号，建议使用电显、站牌或公交官网给出的名称；建议在同一城市内，区县公交在前缀中体现区县名称，如：章丘4（未注明）、番1（已注明",example:"番1"},{"@_k":"public_transport:version","@_v":"2",importance:"recommened",description:"此标签对 OSM 交通数据的用户十分有用，此标签可以让用户知道线路是根据新系统 PTv2 添加。此标签可使分析和验证更加容易。",example:"2"},{"@_k":"operator",importance:"recommened",description:"营运该线路公交公司或车队的名称。请使用规范的企业名称；若多家公司共同运营，请在两家公司之间加上“;”。",example:"上海松江公共交通有限公司"},{"@_k":"network",importance:"required",description:"该线路所属的网络，使用该网络关系相同的名称",example:"黔江公交"},{"@_k":"opening_hours",importance:"recommened",description:"公交路线的运营时间，包含首班车和末班车发车时间，登记应使用英文两字母式星期标记，并采用24小时制。",example:"Jan 1-May 31 06:00-21:45; Jun 1-Oct 7 06:00-22:15; Oct 8-Dec 31 06:00-21:45"},{"@_k":"interval",importance:"recommened",description:"公交车途径任意站点到达时的间隔时间，也称为发车间隔。格式可为 HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM 或 M。",example:"00:06:30"},{"@_k":"duration",importance:"recommened",description:"公交线路的持续时间，从发车到抵达终点。格式为 HH:MM:SS, H:MM:SS, HH:MM, H:MM, MM 或 M。",example:"00:31"},{"@_k":"fee",importance:"recommened",description:"如果乘坐该公交需支付费用则为“yes”，选填 charge 说明乘车费用；若无需支付费用则为“no”。",example:"yes+charge=3.00 CNY"},{"@_k":"payment",importance:"recommened",description:"详细列表请见：支付方式，常用的有 payment:cash, payment:coins, payment:ic, payment:unionpay, payment:city_union, payment:china_t-union, payment:e-cny, payment:alipay, payment:wechat, payment:mipay, payment:samsung_pay, payment:huawei_pay, payment:apple_pay。",example:""},{"@_k":"bicycle",importance:"recommened",description:"如果该公交允许携带自行车乘车则为“yes”。",example:"yes"},{"@_k":"wheelchair",importance:"recommened",description:"如果允许使用轮椅的乘客或携带轮椅的乘客上车，请标记为 'yes'；否则标记为 'no'。",example:"yes"},{"@_k":"from",importance:"required",description:"公交车发车方向的位置名称，不一定是公交车站的名称。",example:"通常汽渡"},{"@_k":"via",importance:"optional",description:"在双向环线或起终点名称相同的线路中注明中间站点。",example:"涞寅路绿庭尚城"},{"@_k":"to",importance:"required",description:"公交线路目的地的名称，通常显示在公交车顶部作为终到站。",example:"北官厅"},{"@_k":"name",importance:"required",description:"建议使用格式：<前缀><编号>路: <起点站> => <终点站>，详情参考相关标准。",example:"K37路: 解放桥东 -> 铁厂北路公交车场"},{"@_k":"name:zh",importance:"recommened",description:"建议使用格式：<前缀><编号>路: <起点站> => <终点站>，详情参考相关标准。",example:"K37路: 解放桥东 -> 铁厂北路公交车场"},{"@_k":"official_name",importance:"optional",description:"用于描述官方地图上所用公交路线的名称。大多数线路仅供参考，因此请勿使用此标记。",example:"虹桥枢纽10路区间"},{"@_k":"colour",importance:"optional",description:"官方地图上公交线路的颜色，使用十六进制或 HTML 颜色代码。",example:"#58912F"},{"@_k":"roundtrip",importance:"optional",description:"指定关系是否为环路。对于大多数线路，该值为 'no'.",example:"no"},{"@_k":"description",importance:"optional",description:"其他关于该线路的未尽事宜，可以在此用中文表述，如：春节期间线路有变动、本地公交卡7折优惠",example:"济南公交刷卡标准折扣"}]},ol={tag:[{"@_k":"type","@_v":"route_master",importance:"required",description:"将该关系定义为路线主关系",example:"route_master"},{"@_k":"route_master","@_v":"bus",importance:"required",description:"将该线路主关系为一条公交线路主关系",example:"bus"},{"@_k":"ref",importance:"required",description:"线路代码（若无官方代码请使用official_name标签）",example:"金青线"},{"@_k":"name",importance:"required",description:"路线名称，格式：<所在路网><编号>路（例：济南公交K10路支线）",example:"大足公交204路"},{"@_k":"network",importance:"required",description:"所属运输网络名称（需与网络关系一致）",example:"北京公交"},{"@_k":"operator",importance:"recommended",description:"运营公司名称（多家公司用分号分隔）",example:"上海众兴汽车旅游客运有限公司"},{"@_k":"wheelchair",importance:"optional",description:"是否允许轮椅上车（yes/no）",example:"yes"},{"@_k":"bicycle",importance:"optional",description:"是否允许携带自行车（yes/no）",example:"yes"},{"@_k":"official_name",importance:"optional",description:"官方地图显示名称（无正式名称时勿用）",example:"Bull City Connector"},{"@_k":"ref:OPT",importance:"conditional",description:"运营商特定参考号（根据实际情况添加）",example:"OCH"}]};function os(e){let{x:t,y:n,open:o,children:i}=e;return o?(0,l.jsx)("ul",{className:"absolute rounded-lg bg-base-100 menu shadow p-0",onMouseDown:e=>e.stopPropagation(),style:{top:n,left:t},children:s.Children.map(i,(e,t)=>(0,s.isValidElement)(e)?"a"===e.type?(0,l.jsx)("li",{children:e},t):(0,l.jsx)("li",{children:(0,l.jsx)("a",{children:e})},t):null)}):null}let od=(0,s.memo)(function(e){let t=x((0,tc.N)(S(e))),n=eL(e=>e.createBusStopSel),o=eL(e=>e.createStopAreaSel),i=(0,tC.createConfirmation)(on),a=async()=>{e.onClose();let o=await i({title:"Create Bus stop (Preset CN)",preset:oo});(null==o?void 0:o.tag)&&(console.debug("created bus stop",o),t&&n(t,o.tag))},r=async()=>{e.onClose();let t=await i({title:"Create Stop Area (Preset CN)",preset:oa,createMembers:!0});(null==t?void 0:t.tag)&&o(t.tag,t.member)};return(0,l.jsxs)(os,{...e,children:[(0,l.jsx)("a",{onClick:a,children:"New bus stop"}),(0,l.jsx)("a",{onClick:r,children:"New stop area relation"})]})}),oc=(0,s.memo)(function(e){var t,n;let o=x((0,tc.N)(S(e))),i=eL(e=>e.createStopPositionSel),a=eL(e=>e.modifyFeatureMetaNC),r=(0,tC.createConfirmation)(on),s=async()=>{var t;e.onClose();let n=await r({preset:oi,title:"Create Stop position (Preset CN)"});(null==n?void 0:n.tag)&&o&&(null===(t=e.feature)||void 0===t?void 0:t.id)&&i(o,n.tag,e.feature.id)},d=async()=>{var t;if(e.onClose(),!(null===(t=e.feature)||void 0===t?void 0:t.id))return;let n=await r({preset:oi,existing:eL.getState().meta.node[e.feature.id].tag,title:"Add tags to existing point (Stop position preset CN)"});(null==n?void 0:n.tag)&&a("node",e.feature.id,e=>{e.tag=n.tag})};return(0,l.jsx)(os,{...e,children:(null===(t=e.feature)||void 0===t?void 0:t.type)==="way"?(0,l.jsx)("a",{onClick:s,children:"New stop position"}):(null===(n=e.feature)||void 0===n?void 0:n.type)==="node"?(0,l.jsx)("a",{onClick:d,children:"Set point as stop position"}):(0,l.jsx)("a",{children:"relation is not allowed here"})})}),ou=e=>{let{width:t,height:n}=e,[o,i]=(0,s.useState)({x:0,y:0,open:!1}),[a,r]=(0,s.useState)({x:0,y:0,open:!1}),d=(0,s.useRef)(new n7({meta:eL,view:x,settings:eU},{busStop:i,stopPosition:r})).current;return(0,s.useEffect)(()=>{let e=e=>d.transform(e);return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[d]),(0,l.jsxs)("div",{className:"relative",style:{width:t,height:n},children:[(0,l.jsxs)(n$,{width:t,height:n,options:{background:"#1099bb"},onMouseDown:e=>d.transform(e),onPointerMove:e=>d.transform(e),onMouseUp:e=>d.transform(e),onWheel:e=>d.transform(e),children:[(0,l.jsx)(eV,{width:t,height:n}),(0,l.jsx)(tf,{width:t,height:n,stateMachine:d})]}),(0,l.jsx)(nB,{width:t}),(0,l.jsx)(od,{...o,onClose:()=>i({x:0,y:0,open:!1})}),(0,l.jsx)(oc,{...a,onClose:()=>r({x:0,y:0,open:!1})})]})};class om extends A{transform(e){super.transform(e)}constructor(e){super(e),(0,k._)(this,"idle",void 0),(0,k._)(this,"mapViewSubMachine",void 0),(0,k._)(this,"busStopEditSubMachine",void 0),(0,k._)(this,"undoRedo",void 0),this.idle=new O("pt-edit-idle"),this.mapViewSubMachine=new F(e),this.busStopEditSubMachine=new n5(e,{onRightClick:e=>{let{routeEdit:t,setRouteStop:n}=this.context.store.meta.getState(),o=t=>t["@_ref"]===e.id&&t["@_type"]===e.type;n(t.stops.some(o)?t.stops.filter(e=>!o(e)):[...t.stops,{"@_ref":e.id,"@_type":e.type}])},onLeftClick:(e,t)=>{let{toggleFeature:n}=this.context.store.meta.getState();n(e.type,e.id,!t.shiftKey)},hoverable:e=>"node"===e.type,clickable:e=>"node"===e.type,dragable:()=>!1,selectable:()=>!1}),this.undoRedo=new U(e),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.busStopEditSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.busStopEditSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0})}}var op=n(2228);class oh extends A{transform(e){super.transform(e)}constructor(e){super(e),(0,k._)(this,"manualAddPathMode",void 0),(0,k._)(this,"mpView",void 0),(0,k._)(this,"mpComponent",void 0),(0,k._)(this,"mpUndoRedo",void 0),this.manualAddPathMode=new O("path-add-manual-mode"),this.entry=this.manualAddPathMode,this.current=this.manualAddPathMode,this.accept=[this.manualAddPathMode],this.mpView=new F(e),this.mpComponent=new n5(e,{onRightClick:e=>{console.debug(`Add path: right click at ${e}`);let{routeEdit:t,setRoutePath:n}=eL.getState(),o=t=>t["@_ref"]===e.id&&t["@_type"]===e.type;n(t.path.some(o)?t.path.filter(e=>!o(e)):[...t.path,{"@_ref":e.id,"@_type":e.type}])},onLeftClick:e=>{let{toggleFeature:t}=eL.getState();t(e.type,e.id,!0)},hoverable:e=>"way"===e.type,clickable:e=>"way"===e.type,dragable:()=>!1,selectable:()=>!1}),this.mpUndoRedo=new U(e),this.manualAddPathMode.appendNext(this.mpComponent,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpView,{isEpsilon:!0}),this.manualAddPathMode.appendNext(this.mpUndoRedo,{isEpsilon:!0}),this.mpView.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpComponent.appendNext(this.manualAddPathMode,{isEpsilon:!0}),this.mpUndoRedo.appendNext(this.manualAddPathMode,{isEpsilon:!0})}}class of extends A{transform(e){"mousedown"===e.type&&this.menus.wayEditMenu({x:0,y:0,open:!1}),super.transform(e)}constructor(e,t){super(e),(0,k._)(this,"menus",void 0),(0,k._)(this,"idle",void 0),(0,k._)(this,"mapViewSubMachine",void 0),(0,k._)(this,"componentSubMachine",void 0),(0,k._)(this,"undoRedo",void 0),(0,k._)(this,"batchSelect",void 0),this.menus=t,this.idle=new O("route-edit-idle"),this.mapViewSubMachine=new F(e),this.componentSubMachine=new n5(e,{onRightClick:(e,n)=>{t.wayEditMenu({...P(n.clientX,n.clientY,this.context),open:!0,feature:e})},onLeftClick:(e,t)=>{if("node"===e.type||"way"===e.type){let{toggleFeature:n}=this.context.store.meta.getState();n(e.type,e.id,!t.shiftKey)}},hoverable:e=>"way"===e.type||"node"===e.type,clickable:e=>"way"===e.type||"node"===e.type,dragable:e=>"node"===e.type,selectable:()=>!1}),this.undoRedo=new U(e),this.batchSelect=new n4(e,{onSelectRect:(e,t)=>{let{viewpoint:n,zoom:o,width:i,height:a}=this.context.store.view.getState(),r=N(n,o,i,a,e),l=this.context.store.meta.getState(),s=t0(r)(l);t.ctrlKey||l.clearSelect(),Object.entries(s.node).forEach(e=>{let[,t]=e;return l.selectFeature("node",t["@_id"],!1)})}}),this.entry=this.idle,this.current=this.idle,this.accept=[this.idle],this.idle.appendNext(this.mapViewSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.componentSubMachine,{isEpsilon:!0}),this.idle.appendNext(this.undoRedo,{isEpsilon:!0}),this.idle.appendNext(this.batchSelect,{isEpsilon:!0}),this.mapViewSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.componentSubMachine.appendNext(this.idle,{isEpsilon:!0}),this.undoRedo.appendNext(this.idle,{isEpsilon:!0}),this.batchSelect.appendNext(this.idle,{isEpsilon:!0})}}let ox=()=>{let e=eL(e=>e.createEditRoute),t=eL(e=>e.setEditRoute),n=eL(e=>e.cancelEditRoute),o=eL(e=>e.routeEdit.editing),i=eL(e=>e.meta.relation)||{},a=(0,tC.createConfirmation)(on),r=async()=>{let t=await a({title:"Create Bus stop (Preset CN)",preset:or});(null==t?void 0:t.tag)&&(console.debug("created route",t),e([{"@_k":"type","@_v":"bus_route"}],[]))},d=e=>{t(e)};if((0,s.useEffect)(()=>{let e=new U({meta:eL,view:x,settings:eU}),t=t=>e.transform(t);return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[]),o){let e=i[o],t=tl(e.tag)||"[no name]";return(0,l.jsxs)("div",{className:"bg-base-100 max-w-xl h-full mx-auto py-4",children:["Selected Route:",(0,l.jsx)("div",{className:"flex flex-row gap-2 text-base items-center",children:(0,l.jsx)(tN,{featuretype:"relation",fullname:t,id:e["@_id"],created:0>Number(e["@_id"]),modified:"modify"===e["@_action"],deleted:"delete"===e["@_action"],children:(0,l.jsx)("button",{onClick:n,className:"btn btn-error btn-square btn-sm",children:(0,l.jsx)(tj.G,{icon:t_.Kl4})})})}),"Please jump to step 2"]})}return(0,l.jsx)("div",{className:"bg-base-100 max-w-xl h-full mx-auto",children:(0,l.jsxs)("div",{className:"card-body",children:[(0,l.jsx)("h2",{className:"card-title text-lg mb-4",children:"Create or Select Route"}),(0,l.jsxs)("button",{className:"btn btn-primary w-full mb-6",onClick:r,children:["Create New Route",(0,l.jsx)(tj.G,{icon:t_.r8p,className:"h-5 w-5 ml-2"})]}),(0,l.jsx)("div",{className:"divider mb-4",children:"OR"}),(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsx)("h3",{className:"font-medium text-base",children:"Existing Routes"}),0===Object.keys(i).length?(0,l.jsxs)("div",{className:"alert alert-info",children:[(0,l.jsx)(tj.G,{icon:t_.eHv,className:"stroke-current shrink-0 h-6 w-6"}),(0,l.jsx)("span",{children:"No routes available"})]}):(0,l.jsx)("div",{className:"h-full overflow-y-auto",children:Object.values(i).filter(e=>tP(e.tag)).map(e=>{let t=tl(e.tag)||"[no name]";return(0,l.jsx)("div",{className:"flex items-center px-4 py-2 gap-2 text-sm bg-white rounded hover:bg-base-300",children:(0,l.jsx)(tN,{featuretype:"relation",fullname:t,id:e["@_id"],created:0>Number(e["@_id"]),modified:"modify"===e["@_action"],deleted:"delete"===e["@_action"],children:(0,l.jsx)("button",{onClick:()=>d(e["@_id"]),className:"btn btn-primary btn-square btn-sm",children:(0,l.jsx)(tj.G,{icon:t_.r8p})})})},e["@_id"])})})]})]})})},ob=()=>{let{stops:e}=eL(e=>e.routeEdit),t=eL(e=>e.modifyFeatureStateBatchNC);return(0,s.useEffect)(()=>{let n=eL.getState().meta,o=e.filter(e=>n[e["@_type"]][e["@_ref"]]);return t(o.map(e=>({type:e["@_type"],id:e["@_ref"],modify:e=>{e.highlighted=!0}}))),()=>{t(o.map(e=>({type:e["@_type"],id:e["@_ref"],modify:e=>{e.highlighted=!1}})))}},[t,e]),null},og=()=>{let[e,t]=(0,s.useState)(!0),{stops:n}=eL(e=>e.routeEdit),o=eL(e=>e.setRouteStop),i=(0,s.useCallback)((e,t,i)=>{console.debug("edit",e,t,i),o(n.map(n=>{if(n["@_type"]===e&&n["@_ref"]===t){let e=M(n);return e["@_role"]=i,e}return n}))},[o,n]),a=(0,s.useCallback)(e=>{let{member:t,children:n}=e;return(0,l.jsx)(nd,{id:t["@_ref"],type:t["@_type"],children:()=>(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",(0,l.jsx)(nR,{initialValue:t["@_role"],onCommit:e=>i(t["@_type"],t["@_ref"],e)})]}),n]})})},[i]);return(0,l.jsxs)("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)("h3",{children:"Bus stops members (click to show/hide)"}),(0,l.jsx)("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:(0,l.jsx)(tj.G,{icon:e?op.faChevronUp:tB.faChevronDown,className:"w-4 h-4"})})]}),e&&(0,l.jsx)(nk,{member:n,memberToId:e=>`${e["@_type"]}-${e["@_ref"]}`,onDelete:(e,t)=>o(t),onDragStart:()=>{},onDragEnd:e=>o(e),children:a}),(0,l.jsx)(ob,{})]})},oy=()=>{let{path:e}=eL(e=>e.routeEdit),t=eL(e=>e.modifyFeatureStateBatchNC);return(0,s.useEffect)(()=>{let n=eL.getState().meta,o=e.filter(e=>n[e["@_type"]][e["@_ref"]]);return t(o.map(e=>({type:e["@_type"],id:e["@_ref"],modify:e=>{e.highlighted=!0}}))),()=>{t(o.map(e=>({type:e["@_type"],id:e["@_ref"],modify:e=>{e.highlighted=!1}})))}},[t,e]),null},ov=()=>{let[e,t]=(0,s.useState)(!0),{path:n}=eL(e=>e.routeEdit),o=eL(e=>e.setRoutePath),i=(0,s.useCallback)((e,t,i)=>{console.debug("edit",e,t,i),o(n.map(n=>{if(n["@_type"]===e&&n["@_ref"]===t){let e=M(n);return e["@_role"]=i,e}return n}))},[o,n]),a=(0,s.useCallback)(e=>{let{member:t,children:o,index:a,overlay:r}=e;return(0,l.jsx)(nd,{id:t["@_ref"],type:t["@_type"],children:()=>(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"w-3",children:!r&&(0,l.jsx)(nD,{member:n,index:a})}),(0,l.jsxs)("label",{className:"input input-xs input-bordered ml-1 flex items-center gap-1",children:["Role:",(0,l.jsx)(nR,{initialValue:t["@_role"],onCommit:e=>i(t["@_type"],t["@_ref"],e)})]}),o]})})},[i,n]);return(0,l.jsxs)("div",{className:"absolute top-0 right-0 card min-h-16 max-h-full overflow-auto p-2 bg-base-100 min-w-96",children:[(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)("h3",{children:"Path members (click to show/hide)"}),(0,l.jsx)("button",{onClick:()=>t(!e),className:"btn btn-sm btn-ghost btn-circle","aria-label":e?"Collapse":"Expand",children:(0,l.jsx)(tj.G,{icon:e?op.faChevronUp:tB.faChevronDown,className:"w-4 h-4"})})]}),e&&(0,l.jsx)(nk,{member:n,memberToId:e=>`${e["@_type"]}-${e["@_ref"]}`,onDelete:(e,t)=>o(t),onDragStart:()=>{},onDragEnd:e=>o(e),children:a}),(0,l.jsx)(oy,{})]})},ow=e=>{let{width:t,height:n}=e,o=(0,s.useRef)(new om({meta:eL,view:x,settings:eU}));return(0,s.useEffect)(()=>{let e=e=>o.current.transform(e);return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n$,{width:t,height:n,options:{background:"#1099bb"},onMouseDown:e=>o.current.transform(e),onPointerMove:e=>o.current.transform(e),onMouseUp:e=>o.current.transform(e),onWheel:e=>o.current.transform(e),children:[(0,l.jsx)(eV,{width:t,height:n}),(0,l.jsx)(tf,{width:t,height:n,stateMachine:o.current})]}),(0,l.jsx)(nB,{width:t}),(0,l.jsx)(og,{})]})},oj=(0,s.memo)(function(e){var t,n;let o=x((0,tc.N)(S(e))),i=eL(e=>e.splitWay),a=eL(e=>e.createNodeOnWay);return(0,l.jsx)(os,{...e,children:(null===(t=e.feature)||void 0===t?void 0:t.type)==="way"?(0,l.jsx)("a",{onClick:()=>{var t;(null===(t=e.feature)||void 0===t?void 0:t.id)&&o&&a(o,[],e.feature.id),e.onClose()},children:"New point on way"}):(null===(n=e.feature)||void 0===n?void 0:n.type)==="node"?(0,l.jsx)("a",{onClick:()=>{var t;(null===(t=e.feature)||void 0===t?void 0:t.id)&&i(e.feature.id),e.onClose()},children:"Split way by point"}):(0,l.jsx)("a",{children:"relation is not allowed here"})})}),o_=e=>{let{width:t,height:n}=e,o=(0,s.useRef)(new oh({meta:eL,view:x,settings:eU}));return(0,s.useEffect)(()=>{let e=e=>o.current.transform(e);return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]),(0,l.jsxs)("div",{className:"relative",style:{width:t,height:n},children:[(0,l.jsxs)(n$,{width:t,height:n,options:{background:"#1099bb"},onMouseDown:e=>o.current.transform(e),onPointerMove:e=>o.current.transform(e),onMouseUp:e=>o.current.transform(e),onWheel:e=>o.current.transform(e),children:[(0,l.jsx)(eV,{width:t,height:n}),(0,l.jsx)(tf,{width:t,height:n,stateMachine:o.current})]}),(0,l.jsx)(nB,{width:t}),(0,l.jsx)(ov,{})]})},oN=e=>{let{width:t,height:n}=e,[o,i]=(0,s.useState)({x:0,y:0,open:!1}),a=(0,s.useRef)(new of({meta:eL,view:x,settings:eU},{wayEditMenu:i})).current;return(0,s.useEffect)(()=>{let e=e=>a.transform(e);return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a]),(0,l.jsxs)("div",{className:"relative",style:{width:t,height:n},children:[(0,l.jsxs)(n$,{width:t,height:n,options:{background:"#1099bb"},onMouseDown:e=>a.transform(e),onPointerMove:e=>a.transform(e),onMouseUp:e=>a.transform(e),onWheel:e=>a.transform(e),children:[(0,l.jsx)(eV,{width:t,height:n}),(0,l.jsx)(tf,{width:t,height:n,stateMachine:a})]}),(0,l.jsx)(nB,{width:t}),(0,l.jsx)(oj,{...o,onClose:()=>i({x:0,y:0,open:!1})})]})},oS=e=>{let{width:t,height:n}=e,[o,i]=(0,s.useState)(0);return(0,l.jsxs)("div",{className:"relative",style:{width:t,height:n},children:[(0,l.jsx)("div",{className:"absolute top-1 left-1 z-10",children:(0,l.jsx)("div",{className:"tabs tabs-boxed gap-1 shadow-md",children:[{label:"Add Path"},{label:"Edit Way"}].map((e,t)=>(0,l.jsx)("button",{className:`tab tab-sm ${o===t?"tab-active":""}`,onClick:()=>i(t),children:e.label},t))})}),0===o?(0,l.jsx)(o_,{width:t,height:n}):(0,l.jsx)(oN,{width:t,height:n})]})},ok=()=>{let{editing:e,stops:t,path:n}=eL(e=>e.routeEdit),o=eL(e=>e.saveEditRoute),i=eL(e=>e.modifyFeatureMetaNC),a=eL(e=>e.setEditStepNC),r=eL(t=>e&&t.meta.relation[e]),[d,c]=(0,s.useState)((null==r?void 0:r.tag)||[]),{undo:u}=eL.temporal.getState();return((0,s.useEffect)(()=>{let e=new U({meta:eL,view:x,settings:eU}),t=t=>e.transform(t);return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[]),e)?(0,l.jsxs)("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[(0,l.jsx)("h2",{className:"text-lg font-bold mb-4",children:"Finalize Route Edits"}),(0,l.jsxs)("div",{className:"mb-6",children:[(0,l.jsx)("h3",{className:"font-medium mb-2",children:"Route Tags"}),(0,l.jsx)(nl,{tags:d,setTags:c,commitChange:()=>i("relation",e,e=>e.tag=d)})]}),(0,l.jsxs)("div",{className:"mb-6",children:[(0,l.jsx)("h3",{className:"font-medium mb-2",children:"Route Members"}),(0,l.jsxs)("div",{className:"bg-base-200 p-2 rounded text-xs",children:[(0,l.jsxs)("div",{className:"mb-4",children:[(0,l.jsx)("h4",{className:"text-sm font-medium mb-2",children:"Stops"}),t.map((e,t)=>(0,l.jsx)(nd,{id:e["@_ref"],type:e["@_type"],showMetaType:!0},`${e["@_type"]}-${e["@_ref"]}-${t}`))]}),(0,l.jsxs)("div",{className:"",children:[(0,l.jsx)("h4",{className:"text-sm font-medium mb-2",children:"Path"}),n.map((e,t)=>(0,l.jsx)(nd,{id:e["@_ref"],type:e["@_type"],showMetaType:!0},`${e["@_type"]}-${e["@_ref"]}-${t}`))]})]})]}),(0,l.jsx)("div",{className:"flex gap-2 justify-end",children:(0,l.jsx)("button",{onClick:()=>{o()},className:"btn btn-primary",children:"Save Changes"})})]}):(0,l.jsxs)("div",{className:"p-4 bg-base-100 max-w-xl mx-auto max-h-full overflow-scroll w-full",children:[(0,l.jsx)("div",{className:"alert alert-success mb-4 mx-auto",children:(0,l.jsx)("span",{children:"✓ Changes have been saved"})}),(0,l.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,l.jsx)("button",{onClick:()=>u(),className:"btn btn-primary",children:"Undo"}),(0,l.jsx)("button",{onClick:()=>a(0),className:"btn btn-primary",children:"Proceed"})]})]})},oM=e=>{let{width:t,height:n}=e,{step:o,editing:i}=eL(e=>e.routeEdit),a=eL(e=>e.setEditStepNC),r=e=>{i?a(e):a(0)},d=(0,s.useMemo)(()=>[{label:"Create or select route",component:(0,l.jsx)(ox,{})},{label:"Add bus stops",component:(0,l.jsx)(ow,{width:t,height:n-72})},{label:"Edit route path",component:(0,l.jsx)(oS,{width:t,height:n-72})},{label:"Save changes",component:(0,l.jsx)(ok,{})}],[t,n]);return(0,l.jsxs)("div",{style:{width:t,height:n},children:[(0,l.jsx)("div",{className:"relative",style:{width:t,height:n-72},children:d[o].component}),(0,l.jsx)("div",{style:{width:t,height:72},children:(0,l.jsx)("div",{className:"absolute bottom-0 left-0 right-0 flex flex-row pt-[8px] bg-base-200",children:(0,l.jsx)("ul",{className:"steps steps-horizontal mx-auto",children:d.map((e,t)=>{let{label:n}=e;return(0,l.jsx)("li",{onClick:()=>r(t),className:T("step cursor-pointer",t<=o?"step-primary":"",!i&&"disabled"),children:n},t)})})})})]})},oE=e=>e.routeEdit.selectedMaster;function oC(e){let{width:t,height:n}=e,o=eL(oE),i=eL(e=>e.setSelectedMaster),a=eL(e=>e.clearSelectedMaster),r=eL(e=>e.meta.relation),d=eL(e=>e.createLocalRelation),c=eL(e=>e.modifyFeatureMetaNC),u=eL(e=>e.commit),m=(0,s.useMemo)(()=>(0,tC.createConfirmation)(on),[]),p=(0,s.useMemo)(()=>Object.values(r).filter(e=>{var t;return null===(t=e.tag)||void 0===t?void 0:t.some(e=>"type"===e["@_k"]&&"route_master"===e["@_v"])}),[r]),h=(0,s.useMemo)(()=>Object.values(r).filter(e=>{var t;return null===(t=e.tag)||void 0===t?void 0:t.some(e=>"type"===e["@_k"]&&"route"===e["@_v"])}),[r]),f=(0,s.useCallback)(async()=>{let e=await m({title:"Create Route Master",preset:ol});if(null==e?void 0:e.tag){let t=d([]);c("relation",t,t=>{t.tag=e.tag}),i(t)}},[m,d,c,i]),b=(0,s.useCallback)(e=>{o&&c("relation",o,t=>{t.member.some(t=>t["@_ref"]===e)||t.member.push({"@_type":"relation","@_ref":e,"@_role":"route"})})},[o,c]),g=(0,s.useCallback)(e=>{i(e)},[i]),y=(0,s.useCallback)(()=>{a()},[a]),v=(0,s.useCallback)(e=>{o&&c("relation",o,t=>{t.member=e})},[o,c]),w=(0,s.useCallback)((e,t)=>{o&&c("relation",o,e=>{e.member=t})},[o,c]);return(0,s.useEffect)(()=>{let e=new U({meta:eL,view:x,settings:eU}),t=t=>e.transform(t);return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[]),(0,l.jsxs)("div",{className:"p-4 bg-base-100 flex flex-col gap-4",style:{width:t,height:n},children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsx)("h2",{className:"text-xl font-bold",children:"Route Masters"}),(0,l.jsxs)("button",{onClick:f,className:"btn btn-primary btn-sm",children:[(0,l.jsx)(tj.G,{icon:t_.r8p,className:"mr-2"}),"New Route Master"]})]}),(0,l.jsxs)("div",{className:"flex gap-4 flex-1 overflow-hidden",children:[(0,l.jsx)("div",{className:"w-1/2 bg-base-200 p-4 rounded-box h-full max-h-full flex flex-col",children:(0,l.jsxs)(tZ,{children:[e=>{let{filter:t}=e;return(0,l.jsx)(tW,{forceOpen:!0,name:"route masters",defaultOpen:!0,children:(0,l.jsx)(tV,{relation:Object.values(p),showMetaType:!0,filter:t,children:e=>{let{meta:t}=e;return(0,l.jsx)("button",{className:"btn btn-ghost btn-xs ml-2 tooltip tooltip-bottom","data-tip":"Select as edting route master",onClick:()=>g(t["@_id"]),children:(0,l.jsx)(tj.G,{icon:t_.r8p})})}})})},e=>{let{filter:t}=e;return(0,l.jsx)(tW,{name:"available-routes",defaultOpen:!0,children:(0,l.jsx)(tV,{relation:Object.values(h),showMetaType:!0,filter:t,children:e=>{let{meta:t}=e;return(0,l.jsx)("button",{onClick:()=>b(t["@_id"]),className:"btn btn-ghost btn-xs ml-2 btn-smtooltip tooltip-bottom","data-tip":"Append to editing",children:(0,l.jsx)(tj.G,{icon:tU.faChevronRight})})}})})}]})}),(0,l.jsx)("div",{className:"overflow-scroll bg-base-200 p-4 rounded-box h-full max-h-full",children:o?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsx)("h3",{className:"font-bold",children:tl(r[o].tag)||"Unnamed Master"}),(0,l.jsx)("button",{onClick:y,className:"btn btn-ghost btn-sm",children:(0,l.jsx)(tj.G,{icon:t_.Kl4})})]}),(0,l.jsx)(nl,{tags:r[o].tag||[],setTags:e=>c("relation",o,t=>{t.tag=e}),commitChange:u}),(0,l.jsxs)("div",{className:"mb-4",children:[(0,l.jsx)("h4",{className:"font-medium mb-2",children:"Member Routes"}),(0,l.jsx)(nk,{member:r[o].member,memberToId:e=>`${e["@_type"]}-${e["@_ref"]}`,onDelete:w,onDragStart:()=>{},onDragEnd:v,children:e=>{let{member:t,children:n}=e;return(0,l.jsx)(nd,{id:t["@_ref"],type:t["@_type"],showMetaType:!0,children:()=>n})}})]})]}):(0,l.jsx)("div",{className:"text-center text-gray-500",children:"Select or create a route master to begin"})})]})]})}function oR(e){let{width:t,height:n,children:o}=e;return(0,l.jsx)("div",{className:"bg-base-100 border-r-2 border-r-base-300 flex flex-col",style:{width:t,height:n,maxWidth:t,maxHeight:n},children:o})}function oT(e){let{width:t,height:n}=e,o=(0,s.useMemo)(()=>[{tooltip:"Bus stop edit tab",icon:(0,l.jsx)(tj.G,{icon:n1.faBusSimple}),stage:()=>(0,l.jsx)(ou,{width:t-42,height:n})},{tooltip:"Route edit tab",icon:(0,l.jsx)(tj.G,{icon:n2.faRoute}),stage:()=>(0,l.jsx)(oM,{width:t-42,height:n})},{tooltip:"Edit bus relation",icon:(0,l.jsx)(tj.G,{icon:n3.faCodeCommit}),stage:()=>(0,l.jsx)(oC,{width:t-42,height:n})}],[t,n]),[i,a]=(0,s.useState)(0);return(0,l.jsxs)("div",{className:"flex flex-row",style:{height:n,width:t,maxHeight:n,maxWidth:t},onContextMenu:e=>e.preventDefault(),children:[(0,l.jsx)(oR,{width:42,height:n,children:o.map((e,t)=>(0,l.jsx)("div",{className:"tooltip tooltip-right mx-auto mt-1","data-tip":e.tooltip,children:(0,l.jsx)("button",{onClick:()=>a(t),className:T("btn btn-ghost btn-square btn-sm",t===i&&"btn-active"),children:e.icon})},t))}),(0,l.jsx)("div",{className:"relative",style:{height:n,width:t-42},children:o[i].stage()})]})}let oO=function(e){let{width:t,height:n}=e;return(0,l.jsxs)(tv,{width:t,height:n,axis:"x",initial:t/4*3,children:[e=>(0,l.jsx)(oT,{...e}),e=>(0,l.jsxs)(tv,{...e,axis:"y",children:[e=>(0,l.jsx)(na,{...e}),e=>(0,l.jsx)(nL,{...e})]})]})};var oA=n(1903);function oP(e){let{width:t,height:n}=e,o=(0,s.useMemo)(()=>[{title:(0,l.jsx)(tj.G,{icon:oA.faBus}),tooltip:"Public transport edit mode",component:()=>(0,l.jsx)(oO,{width:t,height:n-42})},{title:(0,l.jsx)(tj.G,{icon:n0.faMap}),tooltip:"Map edit mode",component:()=>(0,l.jsx)(nG,{width:t,height:n-42})}],[t,n]),[i,a]=(0,s.useState)(0);return(0,l.jsxs)("div",{style:{width:t,height:n,position:"relative"},children:[(0,l.jsx)(nQ,{height:42,leftSlot:(0,l.jsx)(l.Fragment,{children:o.map((e,t)=>(0,l.jsx)("div",{className:"tooltip tooltip-right ml-1","data-tip":e.tooltip,children:(0,l.jsx)("button",{onClick:()=>a(t),className:T("btn btn-ghost btn-square btn-sm",i===t&&"btn-active"),children:e.title})},t))})}),(0,l.jsx)("div",{className:"relative",children:o[i].component()})]})}function oD(){let[{width:e,height:t},n]=(0,s.useState)({width:window.innerWidth,height:window.innerHeight});return(0,s.useEffect)(()=>{let e=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),(0,l.jsx)("div",{className:"wrapper h-screen w-screen overflow-hidden",style:{width:e},children:(0,l.jsx)(oP,{width:e,height:t})})}function oI(){return(0,l.jsx)(oD,{})}let oL=document.getElementById("root");oL?(0,d.createRoot)(oL).render((0,l.jsx)(s.StrictMode,{children:(0,l.jsx)(function(){return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(oI,{})})},{})})):console.error("Root element not found. Ensure there is an element with the ID 'root' in your HTML.")},8925:function(){}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var a=t[o]={id:o,loaded:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}n.m=e,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},(()=>{n.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})()})(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e=[];n.O=(t,o,i,a)=>{if(o){a=a||0;for(var r=e.length;r>0&&e[r-1][2]>a;r--)e[r]=e[r-1];e[r]=[o,i,a];return}for(var l=1/0,r=0;r<e.length;r++){for(var[o,i,a]=e[r],s=!0,d=0;d<o.length;d++)(!1&a||l>=a)&&Object.keys(n.O).every(e=>n.O[e](o[d]))?o.splice(d--,1):(s=!1,a<l&&(l=a));if(s){e.splice(r--,1);var c=i();void 0!==c&&(t=c)}}return t}})(),n.rv=()=>"1.2.8",(()=>{var e={980:0};n.O.j=t=>0===e[t];var t=(t,o)=>{var i,a,[r,l,s]=o,d=0;if(r.some(t=>0!==e[t])){for(i in l)n.o(l,i)&&(n.m[i]=l[i]);if(s)var c=s(n)}for(t&&t(o);d<r.length;d++)a=r[d],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(c)},o=self.webpackChunkbus_fensi=self.webpackChunkbus_fensi||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})(),n.ruid="bundler=rspack@1.2.8";var o=n.O(void 0,["544","333","201","642","929","223","474","133"],function(){return n(9487)});o=n.O(o)})();